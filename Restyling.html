<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restyling Production - Cloud MES</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDn9Y-g7odI5T7rD1LVRSldkRwVnIyfPMg",
    authDomain: "d40restyling.firebaseapp.com",
    databaseURL: "https://d40restyling-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "d40restyling",
    storageBucket: "d40restyling.appspot.com",
    appId: "1:1085425091704:web:4ce5ab8af47546035b998d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tareasRef = ref(db, 'tareas');
const planRef = ref(db, 'planificacion');
const productividadDiariaRef = ref(db, 'productividadDiaria');
const estadoSesionRef = ref(db, 'estadoSesion');
const preferenciasRef = ref(db, 'preferencias');
const tiempoPorTareaRef = ref(db, 'tiempoPorTarea');
const mantenimientoRef = ref(db, 'mantenimiento');
const incidenciasLogRef = ref(db, 'incidenciasLog');

const state = {
    operarios: 0,
    pausaDesayuno: false,
    incidencia: false,
    reposicion: false,
    ids: { pausa: null, incidencia: null, reposicion: null },
    modo: "entrada",
    pedidosOrdenados: [],
    chart: null,
    chartDiario: null,
    chartMensual: null,
    sortable: null,
    entradaLineaHoy: null,
    salidaLineaHoy: null,
    mesSeleccionado: null,
    fechaProdSeleccionada: null, // Ahora sincronizada con filtroFechaTareas
    anioSeleccionado: null,
    inicializado: false,
    modoEdicionGrafico: false,
    filtroFechaTareas: null, // Filtro compartido para tabla y gr√°fico de tiempo por tarea
    firebaseConectado: false,
};

// Funciones para embed
window.mostrarEmbed = (tipo) => {
    const modal = document.getElementById('modalEmbed');
    const titulo = document.getElementById('tituloModalEmbed');
    const codigo = document.getElementById('codigoEmbed');
    
    let embedCode = '';
    
    switch(tipo) {
        case 'prod':
            titulo.textContent = 'Embed - Tiempo por Tarea';
            const fechaActual = state.filtroFechaTareas || tsToFechaLocal(Date.now());
            embedCode = `<!-- Tiempo por Tarea - Restyling Production -->
<div style="position: relative; height: 400px; width: 100%; max-width: 800px; font-family: system-ui, sans-serif;">
  <canvas id="embedProd"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
  <script>
    const ctx = document.getElementById('embedProd').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: [1, 2, 3, 4, 5],
        datasets: [{
          label: 'Tiempo (min)',
          data: [20, 22, 19, 21, 20],
          borderColor: 'rgba(99, 102, 241, 1)',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.4
        }, {
          label: 'Media',
          data: [20.4, 20.4, 20.4, 20.4, 20.4],
          borderColor: 'rgba(250, 204, 21, 1)',
          borderWidth: 3,
          pointRadius: 0,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Tiempo por Tarea - ${fechaActual}',
            font: { size: 16, weight: 'bold' }
          }
        }
      }
    });
  <\/script>
</div>`;
            break;
        case 'diario':
            titulo.textContent = 'Embed - Productividad Diaria';
            const mes = state.mesSeleccionado || { year: new Date().getFullYear(), month: new Date().getMonth() };
            const mesNombre = new Date(mes.year, mes.month, 1).toLocaleString('es-ES', { month: 'long' });
            embedCode = `<!-- Productividad Diaria - ${mesNombre} ${mes.year} -->
<div style="position: relative; height: 400px; width: 100%; max-width: 900px; font-family: system-ui, sans-serif;">
  <canvas id="embedDiario"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
  <script>
    const ctx = document.getElementById('embedDiario').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array.from({length: 31}, (_, i) => i + 1),
        datasets: [{
          label: 'Productividad',
          data: Array(31).fill(0).map(() => Math.random() * 20 + 10),
          borderColor: 'rgba(99, 102, 241, 1)',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          fill: true,
          tension: 0.4
        }, {
          label: 'Objetivo (19)',
          data: Array(31).fill(19),
          borderColor: 'rgba(59, 130, 246, 1)',
          borderDash: [5, 5],
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Productividad Diaria - ${mesNombre} ${mes.year}',
            font: { size: 16, weight: 'bold' }
          }
        },
        scales: { y: { beginAtZero: true, suggestedMax: 30 } }
      }
    });
  <\/script>
</div>`;
            break;
        case 'mensual':
            titulo.textContent = 'Embed - Productividad Mensual';
            const anio = state.anioSeleccionado || new Date().getFullYear();
            embedCode = `<!-- Productividad Mensual - ${anio} -->
<div style="position: relative; height: 400px; width: 100%; max-width: 900px; font-family: system-ui, sans-serif;">
  <canvas id="embedMensual"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
  <script>
    const ctx = document.getElementById('embedMensual').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
        datasets: [{
          label: 'Media Mensual',
          data: [15, 16, 17, 18, 19, 20, 19, 18, 17, 16, 15, 16],
          borderColor: 'rgba(250, 204, 21, 1)',
          backgroundColor: 'rgba(250, 204, 21, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }, {
          label: 'Objetivo (19)',
          data: Array(12).fill(19),
          borderColor: 'rgba(239, 68, 68, 1)',
          borderDash: [5, 5],
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Productividad Mensual - ${anio}',
            font: { size: 16, weight: 'bold' }
          }
        },
        scales: { y: { beginAtZero: true, suggestedMax: 25 } }
      }
    });
  <\/script>
</div>`;
            break;
    }
    
    codigo.value = embedCode;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

window.cerrarModalEmbed = () => {
    const modal = document.getElementById('modalEmbed');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.copiarCodigoEmbed = () => {
    const codigo = document.getElementById('codigoEmbed');
    codigo.select();
    document.execCommand('copy');
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(codigo.value);
    }
    
    mostrarNotificacion('üìã C√≥digo copiado al portapapeles');
};

const mostrarNotificacion = (mensaje) => {
    const notif = document.createElement('div');
    notif.className = 'fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl z-50 font-bold text-sm animate-bounce';
    notif.textContent = mensaje;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.remove();
    }, 3000);
};

// Listener para estado de conexi√≥n con Firebase
const conexionRef = ref(db, '.info/connected');
onValue(conexionRef, (snap) => {
    const conectado = snap.val() === true;
    state.firebaseConectado = conectado;
    actualizarIndicadorConexion(conectado);
});

const actualizarIndicadorConexion = (conectado) => {
    const indicador = document.getElementById('indicadorFirebase');
    const led = document.getElementById('ledFirebase');
    const texto = document.getElementById('textoFirebase');
    if (!indicador || !led || !texto) return;
    
    if (conectado) {
        indicador.classList.remove('bg-red-100', 'border-red-300');
        indicador.classList.add('bg-emerald-100', 'border-emerald-400');
        led.classList.remove('bg-red-500', 'animate-pulse');
        led.classList.add('bg-emerald-500', 'shadow-emerald-500/60', 'led-conectado');
        texto.textContent = 'EN L√çNEA';
        texto.classList.remove('text-red-700');
        texto.classList.add('text-emerald-800');
    } else {
        indicador.classList.remove('bg-emerald-100', 'border-emerald-400');
        indicador.classList.add('bg-red-100', 'border-red-300');
        led.classList.remove('bg-emerald-500', 'shadow-emerald-500/60', 'led-conectado');
        led.classList.add('bg-red-500', 'animate-pulse');
        texto.textContent = 'SIN CONEXI√ìN';
        texto.classList.remove('text-emerald-800');
        texto.classList.add('text-red-700');
    }
};

const guardarEstadoSesion = async (datos) => {
    await update(estadoSesionRef, datos);
};

const obtenerEstadoSesion = async () => {
    const snapshot = await get(estadoSesionRef);
    return snapshot.val() || {};
};

const guardarPreferencias = async (clave, valor) => {
    await update(ref(db, `preferencias/${clave}`), { valor });
};

const obtenerPreferencias = async () => {
    const snapshot = await get(preferenciasRef);
    return snapshot.val() || {};
};

const obtenerProductividadDiaria = async () => {
    const snapshot = await get(productividadDiariaRef);
    return snapshot.val() || {};
};

const guardarTiempoPorTarea = async (fecha, serie, tiempo, finMS) => {
    const fechaKey = fechaToKey(fecha);
    await push(ref(db, `tiempoPorTarea/${fechaKey}`), {
        serie, tiempo, finMS, timestamp: Date.now()
    });
};

const obtenerTiempoPorTarea = async (fecha) => {
    const fechaKey = fechaToKey(fecha);
    const snapshot = await get(ref(db, `tiempoPorTarea/${fechaKey}`));
    return snapshot.val() || {};
};

const calcularProductividadDiaria = (t1, t2, h1, h2) => {
    const divisor = h1 + h2 * 2;
    if (divisor <= 0) return 0;
    const prod = ((t1 + t2) * 7) / divisor;
    return isFinite(prod) ? Math.round(prod * 10) / 10 : 0;
};

const guardarSesionDiaria = async (fecha, operarios, tareasEnSesion, horasEnSesion) => {
    const fechaKey = fechaToKey(fecha);
    const snapDia = await get(ref(db, `productividadDiaria/${fechaKey}`));
    const diaActual = snapDia.val() || { tareas1op: 0, tareas2op: 0, horas1op: 0, horas2op: 0 };
    
    if (operarios === 1) {
        diaActual.tareas1op = (diaActual.tareas1op || 0) + tareasEnSesion;
        diaActual.horas1op  = (diaActual.horas1op  || 0) + horasEnSesion;
    } else if (operarios === 2) {
        diaActual.tareas2op = (diaActual.tareas2op || 0) + tareasEnSesion;
        diaActual.horas2op  = (diaActual.horas2op  || 0) + horasEnSesion;
    }
    
    diaActual.productividad = calcularProductividadDiaria(
        diaActual.tareas1op, diaActual.tareas2op,
        diaActual.horas1op,  diaActual.horas2op
    );
    
    await update(ref(db, `productividadDiaria/${fechaKey}`), diaActual);
};

const festivosEspa = [
    [1, 1], [1, 6], [5, 1], [8, 15], [10, 12], [11, 1], [12, 25]
];

const esFestivo = (year, month, day) => {
    return festivosEspa.some(([m, d]) => m === (month + 1) && d === day);
};

const esFinDeSemana = (year, month, day) => {
    const fecha = new Date(year, month, day);
    const diaSemana = fecha.getDay();
    return diaSemana === 0 || diaSemana === 6;
};

const tsToFechaLocal = (ms) => {
    const d = new Date(Number(ms));
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const fechaToKey = (fecha) => fecha.replace(/-/g, '_');

// Funci√≥n para actualizar el gr√°fico de tiempo por tarea
const actualizarGraficoProd = async (fechaSeleccionada = null) => {
    const ctx = document.getElementById('graficoProd');
    const container = document.getElementById('graficoContainer');
    if (!ctx || !container) return;
    
    const fecha = fechaSeleccionada || state.filtroFechaTareas || tsToFechaLocal(Date.now());
    
    // Actualizar t√≠tulo
    const tituloFecha = document.getElementById('tituloFechaProd');
    if (tituloFecha) {
        const hoy = tsToFechaLocal(Date.now());
        tituloFecha.textContent = fecha === hoy ? 'Hoy' :
            new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }
    
    // Obtener datos de Firebase
    const datosGuardados = await obtenerTiempoPorTarea(fecha);
    const datosProd = Object.values(datosGuardados)
        .sort((a, b) => (a.finMS || 0) - (b.finMS || 0))
        .map(t => ({ serie: t.serie, tiempo: t.tiempo }));
    
    if (!datosProd || datosProd.length === 0) {
        if (state.chart) state.chart.destroy();
        const mediaIndicator = document.getElementById('mediaValor');
        if (mediaIndicator) mediaIndicator.textContent = '--';
        
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Tiempo (min)',
                    data: [],
                    borderColor: 'rgba(99, 102, 241, 1)',
                    pointBackgroundColor: 'rgba(99, 102, 241, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Sin datos para la fecha seleccionada',
                        font: { size: 12, weight: 'bold' },
                        color: '#94a3b8'
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'N√∫mero de Serie', font: { size: 11, weight: 'bold' } },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Tiempo (minutos)', font: { size: 11, weight: 'bold' } }
                    }
                }
            }
        });
        return;
    }
    
    const tiempos = datosProd.map(d => d.tiempo);
    const series = datosProd.map(d => d.serie);
    const media = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
    
    const mediaIndicator = document.getElementById('mediaValor');
    if (mediaIndicator) {
        mediaIndicator.textContent = media.toFixed(1) + ' min';
        mediaIndicator.className = 'font-black text-lg text-yellow-700';
    }
    
    if (state.chart) state.chart.destroy();
    
    state.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: series.map((s, i) => i + 1),
            datasets: [{
                label: 'Tiempo (min)',
                data: tiempos,
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                order: 1
            }, {
                label: `Media (${media.toFixed(1)} min)`,
                data: Array(series.length).fill(media),
                borderColor: 'rgba(250, 204, 21, 1)',
                borderWidth: 3,
                pointRadius: 0,
                fill: false,
                order: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        title: (items) => `Serie: ${series[items[0].dataIndex]}`,
                        label: (item) => {
                            if (item.dataset.label.includes('Media')) return item.dataset.label;
                            const tiempo = item.parsed.y;
                            const productividad = (420 / tiempo).toFixed(1);
                            return [
                                `Tiempo: ${tiempo.toFixed(1)} min`,
                                `Productividad: ${productividad}`,
                                `vs Media: ${(tiempo - media).toFixed(1)} min`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Orden de finalizaci√≥n', font: { size: 11, weight: 'bold' } },
                    grid: { display: false },
                    ticks: {
                        font: { size: 9, weight: 'bold' },
                        maxTicksLimit: 40,
                        autoSkip: true
                    }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Tiempo (minutos)', font: { size: 11, weight: 'bold' } },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                }
            }
        }
    });
};

// Funci√≥n compartida para actualizar tabla y gr√°fico de tiempo por tarea
window.aplicarFiltroFechaCompartido = async (fecha) => {
    state.filtroFechaTareas = fecha;
    state.fechaProdSeleccionada = fecha; // Sincronizar con gr√°fico de tiempo por tarea
    
    // Actualizar UI del filtro de tabla
    const btnFiltro = document.getElementById('btnFiltroFechaTareas');
    const tituloTabla = document.getElementById('tituloTablaTareas');
    
    if (fecha) {
        const hoy = new Date().toISOString().split('T')[0];
        const esHoy = fecha === hoy;
        btnFiltro.classList.replace('bg-slate-800', 'bg-emerald-600');
        btnFiltro.innerHTML = `üìÖ ${esHoy ? 'Hoy' : new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}`;
        tituloTabla.innerHTML = `Pedidos en proceso <span class="text-emerald-600">(${esHoy ? 'Hoy' : fecha})</span>`;
    }
    
    // Actualizar tabla de tareas
    await renderizarTablaTareas();
    
    // Actualizar gr√°fico de tiempo por tarea
    await actualizarGraficoProd(fecha);
    
    // Guardar preferencia
    await guardarPreferencias('fechaProdSeleccionada', fecha);
};

window.mostrarFiltroFechaTareas = () => {
    const input = document.getElementById('inputFiltroFechaTareas');
    const hoy = new Date().toISOString().split('T')[0];
    input.value = state.filtroFechaTareas || hoy;
    input.showPicker();
};

// Para el gr√°fico de tiempo por tarea - usa el mismo filtro
window.mostrarSelectorFechaProd = () => {
    const input = document.getElementById('inputFiltroFechaTareas');
    const hoy = new Date().toISOString().split('T')[0];
    input.value = state.filtroFechaTareas || hoy;
    input.showPicker();
};

window.resetFiltroFechaTareas = () => {
    const hoy = tsToFechaLocal(Date.now());
    aplicarFiltroFechaCompartido(hoy);
};

const renderizarListaPuntos = async (fecha) => {
    const lista = document.getElementById('listaPuntosTiempo');
    if (!lista || lista.classList.contains('hidden')) return;
    
    const datos = await obtenerTiempoPorTarea(fecha);
    const items = Object.entries(datos).sort((a, b) => (a[1].finMS || 0) - (b[1].finMS || 0));
    
    if (items.length === 0) {
        lista.innerHTML = '<p class="text-[10px] font-black text-red-600 uppercase mb-2 flex items-center gap-1">Modo edici√≥n ‚Äî sin puntos para este d√≠a</p>';
        return;
    }
    
    lista.innerHTML = `
        <p class="text-[10px] font-black text-red-600 uppercase mb-2">Modo edici√≥n ‚Äî pulsa üóëÔ∏è para borrar un punto</p>
        <table class="w-full text-xs">
            <thead><tr class="bg-slate-100 text-slate-500 font-black uppercase text-[9px]">
                <th class="p-1.5 text-left">#</th>
                <th class="p-1.5 text-left">Serie</th>
                <th class="p-1.5 text-center">Tiempo</th>
                <th class="p-1.5"></th>
            </tr></thead>
            <tbody>
                ${items.map(([id, t], i) => `
                    <tr class="border-b border-slate-100 hover:bg-red-50">
                        <td class="p-1.5 text-slate-400 font-bold">${i + 1}</td>
                        <td class="p-1.5 font-black text-slate-700">${t.serie || '‚Äî'}</td>
                        <td class="p-1.5 text-center"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-black">${t.tiempo} min</span></td>
                        <td class="p-1.5 text-right">
                            <button onclick="borrarPuntoTiempo('${fecha}', '${id}')" class="bg-red-100 hover:bg-red-600 text-red-500 hover:text-white p-1 rounded-lg transition-all">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
};

window.borrarPuntoTiempo = async (fecha, puntoId) => {
    const fechaKey = fechaToKey(fecha);
    await remove(ref(db, `tiempoPorTarea/${fechaKey}/${puntoId}`));
    await actualizarGraficoProd(fecha);
    renderizarListaPuntos(fecha);
};

window.toggleModoEdicionGrafico = () => {
    state.modoEdicionGrafico = !state.modoEdicionGrafico;
    const btn = document.getElementById('btnEditarGrafico');
    const lista = document.getElementById('listaPuntosTiempo');
    
    if (state.modoEdicionGrafico) {
        btn.classList.replace('bg-slate-100', 'bg-red-100');
        btn.classList.replace('text-slate-600', 'text-red-600');
        btn.classList.replace('border-slate-200', 'border-red-300');
        btn.innerHTML = '‚ùå Salir edici√≥n';
        lista.classList.remove('hidden');
        renderizarListaPuntos(state.filtroFechaTareas || tsToFechaLocal(Date.now()));
    } else {
        btn.classList.replace('bg-red-100', 'bg-slate-100');
        btn.classList.replace('text-red-600', 'text-slate-600');
        btn.classList.replace('border-red-300', 'border-slate-200');
        btn.innerHTML = '‚úèÔ∏è Editar puntos';
        lista.classList.add('hidden');
    }
};

const actualizarGraficoDiario = async (mesSeleccionado = null) => {
    const ctx = document.getElementById('graficoDiario');
    if (!ctx) return;
    
    const productividadDiaria = await obtenerProductividadDiaria();
    const hoy = new Date();
    const mesAMostrar = mesSeleccionado || { year: hoy.getFullYear(), month: hoy.getMonth() };
    const dias = Array.from({ length: 31 }, (_, i) => i + 1);
    
    const valores = dias.map(dia => {
        const mes = String(mesAMostrar.month + 1).padStart(2, '0');
        const diaStr = String(dia).padStart(2, '0');
        const fechaStr = `${mesAMostrar.year}-${mes}-${diaStr}`;
        const fechaKey = fechaStr.replace(/-/g, '_');
        return productividadDiaria[fechaKey]?.productividad || 0;
    });
    
    const valoresConDatos = valores.filter(v => v > 0);
    const media = valoresConDatos.length > 0 ? valoresConDatos.reduce((a, b) => a + b, 0) / valoresConDatos.length : 0;
    
    // Actualizar indicador de media (sin l√≠nea en el gr√°fico)
    const mediaIndicator = document.getElementById('mediaValorDiario');
    if (mediaIndicator) {
        mediaIndicator.textContent = media.toFixed(1);
    }
    
    if (state.chartDiario) state.chartDiario.destroy();
    
    const datasets = [
        {
            label: 'Productividad Diaria',
            data: valores,
            borderColor: 'rgba(99, 102, 241, 1)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            pointBackgroundColor: (ctx) => {
                const dia = dias[ctx.dataIndex];
                const val = ctx.raw;
                if (esFestivo(mesAMostrar.year, mesAMostrar.month, dia) || esFinDeSemana(mesAMostrar.year, mesAMostrar.month, dia)) {
                    return 'rgba(180, 180, 180, 0.7)';
                }
                if (val === 0) return 'rgba(203, 213, 225, 0.5)';
                return val >= 19 ? 'rgba(16, 185, 129, 1)' : 'rgba(99, 102, 241, 1)';
            },
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            order: 2
        },
        {
            label: 'Objetivo (19)',
            data: Array(31).fill(19),
            borderColor: 'rgba(59, 130, 246, 1)', // Azul para objetivo
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            order: 4
        }
    ];
    
    state.chartDiario = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dias.map(d => `${d}`),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, suggestedMax: 30 }
            }
        }
    });
};

const calcularTendencia = (valores) => {
    const n = valores.length;
    const indices = valores.map((_, i) => i);
    const sumaX = indices.reduce((a, b) => a + b, 0);
    const sumaY = valores.reduce((a, b) => a + b, 0);
    const sumaXY = indices.reduce((sum, x, i) => sum + x * valores[i], 0);
    const sumaX2 = indices.reduce((sum, x) => sum + x * x, 0);
    const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
    const intercept = (sumaY - pendiente * sumaX) / n;
    return { pendiente, datos: indices.map(x => pendiente * x + intercept) };
};

const actualizarGraficoMensual = async (anioSeleccionado = null) => {
    const ctx = document.getElementById('graficoMensual');
    if (!ctx) return;
    
    const productividadDiaria = await obtenerProductividadDiaria();
    const anio = anioSeleccionado || new Date().getFullYear();
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const valoresMensuales = [];
    
    for (let mes = 0; mes < 12; mes++) {
        const diasDelMes = new Date(anio, mes + 1, 0).getDate();
        let suma = 0, diasConDatos = 0;
        for (let dia = 1; dia <= diasDelMes; dia++) {
            const mesStr = String(mes + 1).padStart(2, '0');
            const diaStr = String(dia).padStart(2, '0');
            const fechaStr = `${anio}-${mesStr}-${diaStr}`;
            const fechaKey = fechaStr.replace(/-/g, '_');
            const prod = productividadDiaria[fechaKey]?.productividad || 0;
            if (prod > 0) { suma += prod; diasConDatos++; }
        }
        valoresMensuales.push(diasConDatos > 0 ? suma / diasConDatos : 0);
    }
    
    const mesesConDatos = valoresMensuales.filter(v => v > 0);
    const tendencia = mesesConDatos.length >= 2 ? calcularTendencia(valoresMensuales) : null;
    const esTendenciaPositiva = tendencia && tendencia.pendiente >= 0;
    
    const tendenciaPos = document.getElementById('tendenciaPositiva');
    const tendenciaNeg = document.getElementById('tendenciaNegativa');
    if (tendencia) {
        if (tendenciaPos) tendenciaPos.style.display = esTendenciaPositiva ? 'flex' : 'none';
        if (tendenciaNeg) tendenciaNeg.style.display = esTendenciaPositiva ? 'none' : 'flex';
    } else {
        if (tendenciaPos) tendenciaPos.style.display = 'none';
        if (tendenciaNeg) tendenciaNeg.style.display = 'none';
    }
    
    if (state.chartMensual) state.chartMensual.destroy();
    
    const datasets = [
        {
            label: 'Media Mensual',
            data: valoresMensuales,
            borderColor: 'rgba(250, 204, 21, 1)',
            backgroundColor: 'rgba(250, 204, 21, 0.1)',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(250, 204, 21, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            fill: true,
            tension: 0.4,
            order: 2
        },
        {
            label: 'Objetivo (19)',
            data: Array(12).fill(19),
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            order: 3
        }
    ];
    
    // A√±adir l√≠nea de tendencia en mensual (verde si crece, rojo si decrece)
    if (tendencia) {
        const colorTendencia = esTendenciaPositiva ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
        datasets.push({
            label: esTendenciaPositiva ? 'Tendencia ‚Üó' : 'Tendencia ‚Üò',
            data: tendencia.datos,
            borderColor: colorTendencia,
            backgroundColor: esTendenciaPositiva ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)',
            borderWidth: 3,
            borderDash: [10, 5],
            pointRadius: 0,
            fill: false,
            order: 1,
            tension: 0
        });
    }
    
    state.chartMensual = new Chart(ctx, {
        type: 'line',
        data: { labels: meses, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, suggestedMax: 25 }
            }
        }
    });
};

// Selector de MES y A√ëO para gr√°fico de productividad diaria
window.mostrarSelectorMesAnio = () => {
    const modal = document.getElementById('modalSelectorMesAnio');
    const mesActual = state.mesSeleccionado || { year: new Date().getFullYear(), month: new Date().getMonth() };
    
    // Poblar selects
    const selectMes = document.getElementById('selectMes');
    const selectAnio = document.getElementById('selectAnio');
    
    selectMes.value = mesActual.month;
    selectAnio.value = mesActual.year;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

window.cerrarSelectorMesAnio = () => {
    const modal = document.getElementById('modalSelectorMesAnio');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.aplicarMesAnio = async () => {
    const mes = parseInt(document.getElementById('selectMes').value);
    const anio = parseInt(document.getElementById('selectAnio').value);
    
    const mesSeleccionado = { year: anio, month: mes };
    state.mesSeleccionado = mesSeleccionado;
    
    await guardarPreferencias('mesDiarioSeleccionado', mesSeleccionado);
    await actualizarGraficoDiario(mesSeleccionado);
    actualizarTextoMiniCalendario(mesSeleccionado);
    
    cerrarSelectorMesAnio();
};

// Selector de A√ëO para gr√°fico de productividad mensual
window.mostrarSelectorAnio = () => {
    const modal = document.getElementById('modalSelectorAnio');
    const anioActual = state.anioSeleccionado || new Date().getFullYear();
    
    // Generar grid de a√±os
    const grid = document.getElementById('gridAnios');
    grid.innerHTML = '';
    
    const anioBase = anioActual - 4; // Mostrar 9 a√±os centrados en el actual
    
    for (let i = 0; i < 9; i++) {
        const anio = anioBase + i;
        const btn = document.createElement('button');
        btn.className = `h-12 rounded-xl text-sm font-black transition-all ${
            anio === anioActual
                ? 'bg-blue-600 text-white shadow-lg'
                : 'bg-slate-100 hover:bg-blue-50 text-slate-700'
        }`;
        btn.textContent = anio;
        btn.onclick = () => seleccionarAnio(anio);
        grid.appendChild(btn);
    }
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

window.cerrarSelectorAnio = () => {
    const modal = document.getElementById('modalSelectorAnio');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.seleccionarAnio = async (anio) => {
    state.anioSeleccionado = anio;
    await guardarPreferencias('anioMensualSeleccionado', anio);
    await actualizarGraficoMensual(anio);
    
    const anioEl = document.getElementById('anioMensual');
    if (anioEl) anioEl.textContent = anio;
    
    cerrarSelectorAnio();
};

const actualizarTextoMiniCalendario = (mes) => {
    const fecha = new Date(mes.year, mes.month, 1);
    const nombreMes = fecha.toLocaleString('es-ES', { month: 'long' });
    const nombreMesEl = document.getElementById('nombreMesDiario');
    const anioMesEl = document.getElementById('anioMesDiario');
    if (nombreMesEl) nombreMesEl.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);
    if (anioMesEl) anioMesEl.textContent = mes.year;
};

// Timer para tareas activas
setInterval(() => {
    document.querySelectorAll('[data-inicio-ms]').forEach(el => {
        const inicioMS = parseInt(el.getAttribute('data-inicio-ms'));
        const diff = Date.now() - inicioMS;
        const min = Math.floor(diff / 60000);
        const sec = Math.floor((diff % 60000) / 1000);
        el.innerText = `${min}m ${sec}s`;
    });
}, 1000);

let ultimoDiaCargado = tsToFechaLocal(Date.now());
setInterval(async () => {
    const diaActual = tsToFechaLocal(Date.now());
    if (diaActual !== ultimoDiaCargado) {
        ultimoDiaCargado = diaActual;
        await aplicarFiltroFechaCompartido(diaActual);
        console.log('üîÑ Filtro actualizado al nuevo d√≠a:', diaActual);
    }
}, 60000);

const actualizarEstadoLineaUI = () => {
    const indicador = document.getElementById('estadoLineaIndicador');
    const btns = {
        entrada: document.getElementById('btnEntradaLinea'),
        salida: document.getElementById('btnSalidaLinea'),
        desayuno: document.getElementById('btnDesayuno'),
        incidencia: document.getElementById('btnIncidencia'),
        reposicion: document.getElementById('btnReposicion')
    };
    
    if (state.operarios > 0) {
        indicador.innerHTML = `<span class="flex items-center gap-2 bg-emerald-100 text-emerald-700 px-4 py-1.5 rounded-full border border-emerald-300 animate-pulse"><span class="w-3 h-3 bg-emerald-600 rounded-full"></span> L√çNEA ACTIVA (${state.operarios} Op.)</span>`;
        
        if (btns.entrada) btns.entrada.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        if (btns.salida) btns.salida.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        
        if (btns.desayuno) btns.desayuno.classList.remove('opacity-50', 'cursor-not-allowed');
        if (btns.incidencia) btns.incidencia.classList.remove('opacity-50', 'cursor-not-allowed');
        if (btns.reposicion) btns.reposicion.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        indicador.innerHTML = `<span class="flex items-center gap-2 bg-slate-200 text-slate-600 px-4 py-1.5 rounded-full border border-slate-300"><span class="w-3 h-3 bg-slate-400 rounded-full"></span> L√çNEA PARADA</span>`;
        
        if (btns.entrada) btns.entrada.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        if (btns.salida) btns.salida.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        
        if (btns.desayuno) btns.desayuno.classList.add('opacity-50', 'cursor-not-allowed');
        if (btns.incidencia) btns.incidencia.classList.add('opacity-50', 'cursor-not-allowed');
        if (btns.reposicion) btns.reposicion.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    if (state.reposicion && btns.reposicion) {
        btns.reposicion.innerHTML = '‚èπÔ∏è Fin Reposici√≥n';
        btns.reposicion.classList.replace('bg-purple-600', 'bg-blue-600');
    } else if (btns.reposicion) {
        btns.reposicion.innerHTML = 'üîÑ Reposici√≥n';
        btns.reposicion.classList.replace('bg-blue-600', 'bg-purple-600');
    }
    
    if (state.pausaDesayuno && btns.desayuno) {
        btns.desayuno.innerHTML = '‚òï Fin Desayuno';
        btns.desayuno.classList.replace('bg-orange-500', 'bg-blue-600');
    } else if (btns.desayuno) {
        btns.desayuno.innerHTML = '‚òï Desayuno';
        btns.desayuno.classList.replace('bg-blue-600', 'bg-orange-500');
    }
    
    if (state.incidencia && btns.incidencia) {
        btns.incidencia.innerHTML = '‚ö†Ô∏è Fin Incidencia';
        btns.incidencia.classList.replace('bg-red-600', 'bg-blue-600');
    } else if (btns.incidencia) {
        btns.incidencia.innerHTML = '‚ö†Ô∏è Incidencia';
        btns.incidencia.classList.replace('bg-blue-600', 'bg-red-600');
    }
};

window.mostrarSelectorOperarios = async (modo = "entrada") => {
    if (modo === "entrada") {
        if (state.operarios > 0) {
            alert("‚ö†Ô∏è ATENCI√ìN: La l√≠nea ya est√° activa.");
            return;
        }
        
        const snapshot = await get(tareasRef);
        let entradaSinSalida = false;
        if (snapshot.exists()) {
            const tareas = snapshot.val();
            const entradas = Object.entries(tareas)
                .filter(([id, t]) => t.numSerie === "ENTRADA L√çNEA")
                .sort((a, b) => a[1].inicioMS - b[1].inicioMS);
            const salidas = Object.entries(tareas)
                .filter(([id, t]) => t.numSerie === "SALIDA L√çNEA")
                .sort((a, b) => a[1].inicioMS - b[1].inicioMS);
            
            if (entradas.length > salidas.length) {
                entradaSinSalida = true;
            }
        }
        
        if (entradaSinSalida) {
            alert("‚ö†Ô∏è ATENCI√ìN: Debes registrar SALIDA L√çNEA antes de una nueva entrada.");
            return;
        }
    }
    
    if (modo === "reposicion") {
        if (state.operarios > 0) {
            alert("‚ö†Ô∏è ATENCI√ìN: Solo se puede reponer con la l√≠nea parada.");
            return;
        }
        if (state.reposicion) {
            finalizarReposicion();
            return;
        }
    }
    
    state.modo = modo;
    document.getElementById('tituloModal').innerText = modo === "reposicion" ? "Operarios para Reposici√≥n" : "Seleccione Operarios en L√≠nea";
    document.getElementById('modalOperarios').classList.remove('hidden');
    document.getElementById('modalOperarios').classList.add('flex');
};

const finalizarReposicion = async () => {
    const snapshot = await get(ref(db, `tareas/${state.ids.reposicion}`));
    if (snapshot.exists()) {
        const minutos = Math.max(1, Math.round((Date.now() - snapshot.val().inicioMS) / 60000));
        await update(ref(db, `tareas/${state.ids.reposicion}`), {
            fin: new Date().toLocaleTimeString('es-ES'),
            total: minutos,
            estado: "finalizado"
        });
    }
    state.reposicion = false;
    state.ids.reposicion = null;
    actualizarEstadoLineaUI();
};

window.cerrarSelector = () => {
    document.getElementById('modalOperarios').classList.add('hidden');
    document.getElementById('modalOperarios').classList.remove('flex');
};

window.seleccionarOperarios = async (num) => {
    if (state.modo === "entrada") {
        state.operarios = num;
        const ahoraMSTime = Date.now();
        state.entradaLineaHoy = ahoraMSTime;
        await guardarEstadoSesion({ operarios: num, entradaLineaHoy: ahoraMSTime, salidaLineaHoy: null });
        await push(tareasRef, {
            numSerie: "ENTRADA L√çNEA",
            codigo: "SISTEMA",
            notas: "",
            operarios: num,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: ahoraMSTime,
            fin: "--:--",
            total: 0,
            estado: "finalizado"
        });
    } else if (state.modo === "reposicion") {
        const nuevaRep = await push(tareasRef, {
            numSerie: "REPOSICI√ìN",
            codigo: "SISTEMA",
            notas: "",
            operarios: num,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_reposicion_sistema"
        });
        state.ids.reposicion = nuevaRep.key;
        state.reposicion = true;
    }
    actualizarEstadoLineaUI();
    cerrarSelector();
};

window.registrarSalida = async () => {
    if (state.operarios === 0) {
        alert("La l√≠nea ya est√° cerrada.");
        return;
    }
    
    const ahoraMSTime = Date.now();
    const fechaHoy = tsToFechaLocal(ahoraMSTime);
    
    await push(tareasRef, {
        numSerie: "SALIDA L√çNEA",
        codigo: "SISTEMA",
        notas: "",
        operarios: state.operarios,
        inicio: new Date().toLocaleTimeString('es-ES'),
        inicioMS: ahoraMSTime,
        fin: "--:--",
        total: 0,
        estado: "finalizado"
    });
    
    const snapshot = await get(tareasRef);
    const entradaMS = state.entradaLineaHoy;
    const operariosSesion = state.operarios;
    let tareasEnSesion = 0;
    
    if (snapshot.exists()) {
        Object.values(snapshot.val()).forEach(t => {
            const fechaTarea = tsToFechaLocal(t.inicioMS);
            if (fechaTarea === fechaHoy && t.estado === 'finalizado' && t.codigo !== 'SISTEMA' && t.total > 0 && t.operarios === operariosSesion) {
                tareasEnSesion++;
            }
        });
    }
    
    const horasEnSesion = entradaMS ? (ahoraMSTime - entradaMS) / (1000 * 3600) : 0;
    await guardarSesionDiaria(fechaHoy, operariosSesion, tareasEnSesion, horasEnSesion);
    
    state.operarios = 0;
    state.entradaLineaHoy = null;
    state.salidaLineaHoy = null;
    await guardarEstadoSesion({ operarios: 0, entradaLineaHoy: null, salidaLineaHoy: null });
    
    actualizarEstadoLineaUI();
    
    if (state.inicializado) {
        await actualizarGraficoDiario(state.mesSeleccionado);
        await actualizarGraficoMensual(state.anioSeleccionado);
    }
};

window.pausaDesayuno = async () => {
    if (state.operarios === 0 || state.incidencia) return;
    
    const snapshot = await get(tareasRef);
    const updates = {};
    
    if (!state.pausaDesayuno) {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "activo") {
                    updates[`${child.key}/estado`] = "pausa";
                    updates[`${child.key}/tiempoAcumuladoMS`] = Date.now() - child.val().inicioMS;
                }
            });
        }
        const nuevaPausa = await push(tareasRef, {
            numSerie: "PAUSA DESAYUNO",
            codigo: "SISTEMA",
            notas: "",
            operarios: state.operarios,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_pausa_sistema"
        });
        state.ids.pausa = nuevaPausa.key;
        state.pausaDesayuno = true;
    } else {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "pausa") {
                    const acumulado = child.val().tiempoAcumuladoMS || 0;
                    updates[`${child.key}/inicioMS`] = Date.now() - acumulado;
                    updates[`${child.key}/estado`] = "activo";
                }
                if (child.key === state.ids.pausa) {
                    const minutos = Math.max(1, Math.round((Date.now() - child.val().inicioMS) / 60000));
                    updates[`${child.key}/fin`] = new Date().toLocaleTimeString('es-ES');
                    updates[`${child.key}/total`] = minutos;
                    updates[`${child.key}/estado`] = "finalizado";
                }
            });
        }
        state.pausaDesayuno = false;
        state.ids.pausa = null;
    }
    
    await update(tareasRef, updates);
    actualizarEstadoLineaUI();
};

window.toggleIncidencia = async () => {
    if (state.operarios === 0 || state.pausaDesayuno) return;
    
    const snapshot = await get(tareasRef);
    const updates = {};
    
    if (!state.incidencia) {
        const motivo = prompt("Indique el motivo de la incidencia:");
        if (!motivo) return;
        
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "activo") {
                    updates[`${child.key}/estado`] = "incidencia_pausa";
                    updates[`${child.key}/tiempoAcumuladoMS`] = Date.now() - child.val().inicioMS;
                }
            });
        }
        
        const nuevaInc = await push(tareasRef, {
            numSerie: "INCIDENCIA",
            codigo: "SISTEMA",
            notas: motivo,
            operarios: state.operarios,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_incidencia_sistema"
        });
        state.ids.incidencia = nuevaInc.key;
        state.incidencia = true;
        
        push(incidenciasLogRef, {
            texto: motivo,
            fecha: tsToFechaLocal(Date.now()),
            hora: new Date().toLocaleTimeString('es-ES'),
            timestamp: Date.now()
        });
    } else {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "incidencia_pausa") {
                    const acumulado = child.val().tiempoAcumuladoMS || 0;
                    updates[`${child.key}/inicioMS`] = Date.now() - acumulado;
                    updates[`${child.key}/estado`] = "activo";
                }
                if (child.key === state.ids.incidencia) {
                    const minutos = Math.max(1, Math.round((Date.now() - child.val().inicioMS) / 60000));
                    updates[`${child.key}/fin`] = new Date().toLocaleTimeString('es-ES');
                    updates[`${child.key}/total`] = minutos;
                    updates[`${child.key}/estado`] = "finalizado";
                }
            });
        }
        state.incidencia = false;
        state.ids.incidencia = null;
    }
    
    await update(tareasRef, updates);
    actualizarEstadoLineaUI();
};

window.dispararSelector = () => document.getElementById('file-input').click();

window.procesarArchivo = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
            
            if (json.length === 0) {
                alert("El archivo est√° vac√≠o");
                return;
            }
            
            let count = 0;
            json.forEach(item => {
                const cleanItem = {};
                Object.keys(item).forEach(key => {
                    cleanItem[key.trim().toLowerCase()] = String(item[key]).trim();
                });
                
                push(planRef, {
                    pedido: cleanItem["pedido"] || cleanItem["orden"] || "S/P",
                    cliente: cleanItem["cliente"] || cleanItem["client"] || "Sin cliente",
                    codigo: cleanItem["c√≥digo"] || cleanItem["codigo"] || "--",
                    serie: cleanItem["serie"] || cleanItem["n¬∫ serie"] || "--",
                    notas: cleanItem["notas"] || cleanItem["observaciones"] || "",
                    orden: Date.now() + count++
                });
            });
            
            alert(`‚úÖ ${count} series cargadas`);
        } catch (error) {
            alert("‚ùå Error: " + error.message);
        }
        e.target.value = "";
    };
    reader.readAsArrayBuffer(file);
};

window.mostrarModalExportar = () => {
    const modal = document.getElementById('modalExportar');
    const hoy = new Date().toISOString().split('T')[0];
    const hace7Dias = new Date();
    hace7Dias.setDate(hace7Dias.getDate() - 7);
    const fechaInicio = hace7Dias.toISOString().split('T')[0];
    
    document.getElementById('fechaInicioExport').value = fechaInicio;
    document.getElementById('fechaFinExport').value = hoy;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

window.cerrarModalExportar = () => {
    const modal = document.getElementById('modalExportar');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.exportarAExcelRango = async () => {
    const fechaInicio = document.getElementById('fechaInicioExport').value;
    const fechaFin = document.getElementById('fechaFinExport').value;
    
    if (!fechaInicio || !fechaFin) {
        alert("‚ö†Ô∏è Por favor selecciona ambas fechas");
        return;
    }
    
    if (fechaInicio > fechaFin) {
        alert("‚ö†Ô∏è La fecha de inicio no puede ser posterior a la fecha fin");
        return;
    }
    
    const snapshot = await get(tareasRef);
    if (!snapshot.exists()) {
        alert("‚ùå No hay datos para exportar");
        cerrarModalExportar();
        return;
    }
    
    const todasLasTareas = snapshot.val();
    const tareasFiltradas = [];
    
    Object.entries(todasLasTareas).forEach(([id, tarea]) => {
        const fechaTarea = tsToFechaLocal(tarea.inicioMS);
        if (fechaTarea >= fechaInicio && fechaTarea <= fechaFin) {
            tareasFiltradas.push({
                'Fecha': fechaTarea,
                'Hora Inicio': tarea.inicio,
                'Hora Fin': tarea.fin,
                'Serie': tarea.numSerie,
                'C√≥digo': tarea.codigo,
                'Operarios': tarea.operarios,
                'Notas': tarea.notas,
                'Total (min)': tarea.total,
                'Productividad': tarea.total > 0 ? (420 / tarea.total).toFixed(2) : '-',
                'Estado': tarea.estado
            });
        }
    });
    
    if (tareasFiltradas.length === 0) {
        alert(`‚ùå No hay tareas entre ${fechaInicio} y ${fechaFin}`);
        cerrarModalExportar();
        return;
    }
    
    const ws = XLSX.utils.json_to_sheet(tareasFiltradas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Producci√≥n");
    
    const colWidths = [
        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 20 }, { wch: 15 },
        { wch: 10 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 15 }
    ];
    ws['!cols'] = colWidths;
    
    const nombreArchivo = `Produccion_${fechaInicio}_a_${fechaFin}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
    
    alert(`‚úÖ Exportadas ${tareasFiltradas.length} tareas`);
    cerrarModalExportar();
};

window.exportarAExcel = () => {
    mostrarModalExportar();
};

window.abrirMantenimiento = () => {
    const texto = prompt("üìù Descripci√≥n de la tarea de mantenimiento:");
    if (!texto || !texto.trim()) return;
    const fecha = tsToFechaLocal(Date.now());
    push(mantenimientoRef, { texto: texto.trim(), fecha, realizado: false, timestamp: Date.now() });
};

window.toggleMantenimiento = async (id, actual) => {
    await update(ref(db, `mantenimiento/${id}`), { realizado: !actual });
};

window.borrarMantenimiento = async (id) => {
    if (confirm("¬øEliminar esta tarea de mantenimiento?")) {
        await remove(ref(db, `mantenimiento/${id}`));
    }
};

window.borrarIncidenciaLog = async (id) => {
    if (confirm("¬øEliminar este registro de incidencia?")) {
        await remove(ref(db, `incidenciasLog/${id}`));
    }
};

window.toggleGrupo = (pedidoId) => {
    const rows = document.querySelectorAll(`.grupo-${pedidoId}`);
    const icon = document.getElementById(`icon-${pedidoId}`);
    rows.forEach(row => row.classList.toggle('hidden'));
    if (icon) icon.classList.toggle('rotate-90');
};

window.borrarSeriePendiente = (id, e) => {
    e.stopPropagation();
    if (confirm("¬øEliminar serie?")) {
        remove(ref(db, `planificacion/${id}`));
    }
};

window.borrarPedidoCompleto = (ids, e) => {
    e.stopPropagation();
    if (confirm(`¬øEliminar todo el pedido (${ids.length} series)?`)) {
        ids.forEach(id => remove(ref(db, `planificacion/${id}`)));
    }
};

window.iniciarDesdePlan = (id, serie, cod, notas, pedido, cliente) => {
    if (!state.operarios || state.operarios === 0) {
        alert("‚ö†Ô∏è ATENCI√ìN: Debes pulsar 'ENTRADA L√çNEA' primero.");
        return;
    }
    remove(ref(db, `planificacion/${id}`));
    push(tareasRef, {
        numSerie: serie,
        codigo: cod,
        notas: notas,
        pedido: pedido || "",
        cliente: cliente || "",
        operarios: state.operarios,
        inicio: new Date().toLocaleTimeString('es-ES'),
        inicioMS: Date.now(),
        fin: "--:--",
        total: 0,
        estado: "activo"
    });
};

window.finalizarTarea = async (id, inicioMS) => {
    const inicioMSNum = Number(inicioMS);
    const minutos = Math.max(1, Math.round((Date.now() - inicioMSNum) / 60000));
    const finMS = Date.now();
    
    const snapshot = await get(ref(db, `tareas/${id}`));
    if (!snapshot.exists()) return;
    
    const tarea = snapshot.val();
    const fecha = tsToFechaLocal(tarea.inicioMS);
    
    if (tarea.codigo !== "SISTEMA") {
        await guardarTiempoPorTarea(fecha, tarea.numSerie, minutos, finMS);
        // Actualizar gr√°fico si la fecha coincide con el filtro actual
        if (fecha === state.filtroFechaTareas) {
            await actualizarGraficoProd(fecha);
        }
    }
    
    await update(ref(db, `tareas/${id}`), {
        fin: new Date().toLocaleTimeString('es-ES'),
        finMS,
        total: minutos,
        estado: "finalizado"
    });
};

window.borrarRegistro = (id) => {
    if (confirm("¬øEliminar?")) {
        remove(ref(db, `tareas/${id}`));
    }
};

const guardarOrdenPedidos = async () => {
    const updates = {};
    state.pedidosOrdenados.forEach((pedidoId, index) => {
        updates[`${pedidoId}/orden`] = index;
    });
    await update(planRef, updates);
};

const inicializarDragDrop = () => {
    const tbody = document.getElementById('cuerpoPlan');
    if (tbody && !state.sortable) {
        state.sortable = new Sortable(tbody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            filter: '.grupo-item',
            onEnd: async function(evt) {
                const newOrder = [];
                tbody.querySelectorAll('.pedido-header').forEach(row => {
                    const pedidoKey = row.getAttribute('data-pedido-key');
                    if (pedidoKey) newOrder.push(pedidoKey);
                });
                state.pedidosOrdenados = newOrder;
                await guardarOrdenPedidos();
            }
        });
    }
};

const renderizarTablaTareas = async () => {
    const snapshot = await get(tareasRef);
    const cuerpo = document.getElementById('cuerpoActividad');
    cuerpo.innerHTML = "";
    
    if (!snapshot.exists()) {
        cuerpo.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">No hay tareas registradas</td></tr>';
        return;
    }
    
    const data = snapshot.val();
    const tareas = Object.entries(data);
    let tareasFiltradas = tareas;
    
    if (state.filtroFechaTareas) {
        tareasFiltradas = tareas.filter(([id, t]) => {
            const fechaTarea = tsToFechaLocal(t.inicioMS);
            return fechaTarea === state.filtroFechaTareas;
        });
    }
    
    tareasFiltradas.sort((a, b) => (a[1].inicioMS || 0) - (b[1].inicioMS || 0));
    
    state.pausaDesayuno = !!tareas.find(([id, t]) => t.estado === "en_pausa_sistema");
    state.incidencia = !!tareas.find(([id, t]) => t.estado === "en_incidencia_sistema");
    state.reposicion = !!tareas.find(([id, t]) => t.estado === "en_reposicion_sistema");
    
    if (state.pausaDesayuno) state.ids.pausa = tareas.find(([id, t]) => t.estado === "en_pausa_sistema")?.[0];
    if (state.incidencia) state.ids.incidencia = tareas.find(([id, t]) => t.estado === "en_incidencia_sistema")?.[0];
    if (state.reposicion) state.ids.reposicion = tareas.find(([id, t]) => t.estado === "en_reposicion_sistema")?.[0];
    
    actualizarEstadoLineaUI();
    
    if (tareasFiltradas.length === 0 && state.filtroFechaTareas) {
        cuerpo.innerHTML = `
            <tr>
                <td colspan="7" class="p-8 text-center text-slate-400">
                    <p class="font-bold text-sm">No hay tareas para ${state.filtroFechaTareas}</p>
                    <button onclick="resetFiltroFechaTareas()" class="text-emerald-600 hover:text-emerald-700 font-black text-xs uppercase mt-2">Ver todas</button>
                </td>
            </tr>
        `;
        return;
    }
    
    tareasFiltradas.forEach(([id, t]) => {
        const esActivo = t.estado === "activo";
        const esPausado = t.estado === "pausa" || t.estado === "incidencia_pausa";
        const esPausaSistema = t.estado === "en_pausa_sistema" || t.estado === "en_incidencia_sistema" || t.estado === "en_reposicion_sistema";
        const esHito = t.codigo === "SISTEMA";
        
        let tiempoTexto = "";
        if (esActivo) {
            tiempoTexto = '<span class="animate-pulse">0m 0s</span>';
        } else if (esPausado) {
            const m = Math.floor((t.tiempoAcumuladoMS || 0) / 60000);
            const s = Math.floor(((t.tiempoAcumuladoMS || 0) % 60000) / 1000);
            tiempoTexto = `${m}m ${s}s <span class="text-[9px] text-blue-600">(PAUSA)</span>`;
        } else if (esPausaSistema) {
            tiempoTexto = "EN CURSO...";
        } else if (esHito) {
            tiempoTexto = `<span class="font-mono text-slate-600">${t.inicio}</span>`;
        } else {
            tiempoTexto = `${t.total}m`;
        }
        
        const esIncidencia = t.numSerie === "INCIDENCIA";
        const esDesayuno = t.numSerie === "PAUSA DESAYUNO";
        const esReposicion = t.numSerie === "REPOSICI√ìN";
        const esEntrada = t.numSerie === "ENTRADA L√çNEA";
        const esSalida = t.numSerie === "SALIDA L√çNEA";
        
        const filaClase = esEntrada ? "bg-emerald-50 border-emerald-200" :
            esSalida ? "bg-red-50 border-red-200" :
            esDesayuno ? "bg-orange-50 border-orange-200" :
            esIncidencia ? "bg-red-50 border-red-200" :
            esReposicion ? "bg-purple-50 border-purple-200" :
            esActivo ? "bg-red-50 border-red-100" :
            esPausado ? "bg-blue-50 border-blue-100" : "bg-white hover:bg-stone-50";
        
        const serieColorClase = esIncidencia ? "text-red-600" :
            esDesayuno ? "text-orange-500" :
            esReposicion ? "text-purple-600" :
            esEntrada ? "text-emerald-600" :
            esSalida ? "text-red-600" : "";
        
        const clienteHtml = (!esHito && t.cliente && t.cliente.trim() && t.cliente !== "Sin cliente")
            ? `<span class="ml-2 text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">üë§ ${t.cliente}</span>` : '';
        
        const pedidoHtml = (!esHito && t.pedido)
            ? `<span class="ml-1 text-[10px] text-slate-400">PED: ${t.pedido}</span>` : '';
        
        const prodHtml = (!esHito && t.total > 0)
            ? `<span class="${(420/t.total) >= 19 ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'} px-2 py-1 rounded font-black text-sm">${(420 / t.total).toFixed(1)}</span>`
            : '<span class="text-stone-300">‚Äî</span>';
        
        let accionHtml = '';
        if (esActivo) {
            accionHtml = `<button onclick="finalizarTarea('${id}', ${t.inicioMS})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase">Finalizar</button>`;
        } else if (esPausado) {
            accionHtml = '<span class="text-[10px] font-black text-blue-600 uppercase">PAUSADA</span>';
        } else if (esHito) {
            accionHtml = '<span class="text-[10px] font-bold text-stone-400 uppercase">REGISTRO</span>';
        } else {
            accionHtml = '<span class="text-[10px] font-black text-emerald-600 uppercase">‚úÖ HECHO</span>';
        }
        
        cuerpo.innerHTML += `
            <tr class="${filaClase} border-b">
                <td class="p-3 font-black text-[15px] ${serieColorClase}">${t.numSerie} ${pedidoHtml} ${clienteHtml}</td>
                <td class="p-3 font-bold text-sm">${t.codigo}</td>
                <td class="p-3 text-center"><span class="bg-slate-100 px-2 py-1 rounded font-black text-xs">${t.operarios || 0}</span></td>
                <td class="p-3">${t.notas && t.notas.trim() ? `<div class="bg-yellow-100 border-yellow-500 p-2 rounded text-[12px] font-black">‚ö†Ô∏è ${t.notas}</div>` : '<span class="text-stone-300 text-[10px]">-</span>'}</td>
                <td class="p-3 font-[1000] text-lg ${esActivo ? 'text-red-600' : esPausado || esPausaSistema ? 'text-blue-600' : ''}" ${esActivo || esPausaSistema ? `data-inicio-ms="${t.inicioMS}"` : ''}>${tiempoTexto}</td>
                <td class="p-3 text-center">${prodHtml}</td>
                <td class="p-3 text-right flex gap-3">${accionHtml} <button onclick="borrarRegistro('${id}')" class="bg-red-100 hover:bg-red-600 text-red-600 hover:text-white p-2 rounded-lg">üóëÔ∏è</button></td>
            </tr>
        `;
    });
};

onValue(tareasRef, () => {
    renderizarTablaTareas();
    // Tambi√©n actualizar gr√°fico de tiempo por tarea si hay datos nuevos
    if (state.filtroFechaTareas) {
        actualizarGraficoProd(state.filtroFechaTareas);
    }
});

onValue(planRef, (snap) => {
    const data = snap.val() || {};
    const cuerpo = document.getElementById('cuerpoPlan');
    document.getElementById('sec-plan').classList.toggle('hidden', Object.keys(data).length === 0);
    cuerpo.innerHTML = "";
    
    if (state.sortable) {
        state.sortable.destroy();
        state.sortable = null;
    }
    
    const grupos = {}, ordenMap = {};
    Object.keys(data).forEach(id => {
        const item = data[id];
        if (!grupos[item.pedido]) {
            grupos[item.pedido] = [];
            ordenMap[item.pedido] = item.orden || 999999;
        }
        grupos[item.pedido].push({ ...item, id });
    });
    
    const pedidosOrdenadosKeys = Object.keys(grupos).sort((a, b) => (ordenMap[a] || 999999) - (ordenMap[b] || 999999));
    state.pedidosOrdenados = pedidosOrdenadosKeys;
    
    pedidosOrdenadosKeys.forEach((pedido, index) => {
        const pedidoId = `pedido-${index}`;
        const items = grupos[pedido];
        const cliente = items[0].cliente || "Sin cliente";
        
        cuerpo.innerHTML += `
            <tr class="pedido-header bg-stone-50 cursor-pointer" data-pedido-key="${items[0].id}">
                <td class="p-3 flex items-center gap-3" onclick="toggleGrupo('${pedidoId}')">
                    <svg class="drag-handle w-5 h-5 text-slate-400 cursor-grab" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z"></path>
                    </svg>
                    <svg id="icon-${pedidoId}" class="w-4 h-4 transition-transform transform text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <div class="flex items-center gap-2">
                        <span class="text-xs uppercase tracking-tighter text-slate-700">PEDIDO: ${pedido}</span>
                        <span class="text-xs text-slate-400">‚Äî</span>
                        <span class="text-xs text-blue-700 font-black bg-blue-100 px-2 py-0.5 rounded">üë§ ${cliente}</span>
                    </div>
                    <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-[10px] font-bold">${items.length} UNID.</span>
                </td>
                <td colspan="3"></td>
                <td class="p-3 text-right">
                    <button onclick='borrarPedidoCompleto(${JSON.stringify(items.map(i => i.id))}, event)' class="text-stone-400 hover:text-red-600 p-1">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        
        items.forEach(item => {
            const tieneNota = item.notas && item.notas.trim() !== "";
            cuerpo.innerHTML += `
                <tr class="grupo-${pedidoId} grupo-item hidden border-b border-stone-100 bg-white hover:bg-stone-50">
                    <td class="p-2 pl-12 font-bold text-slate-500 text-base">‚Ü≥ ${item.codigo}</td>
                    <td class="p-2">
                        <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded font-mono font-black text-[15px]">${item.serie}</span>
                    </td>
                    <td class="p-2 w-1/2">
                        ${tieneNota
                            ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 p-2 rounded">
                                <p class="text-[10px] font-black uppercase text-yellow-700">‚ö†Ô∏è NOTA:</p>
                                <p class="text-sm font-bold">${item.notas}</p>
                            </div>`
                            : '<span class="text-stone-300 italic text-[10px]">Sin observaciones</span>'}
                    </td>
                    <td class="p-2 text-right" colspan="2">
                        <div class="flex items-center justify-end gap-3">
                            <button onclick="iniciarDesdePlan('${item.id}', '${item.serie}', '${item.codigo}', '${item.notas}', '${pedido}', '${item.cliente}')"
                                class="bg-red-600 hover:bg-slate-900 text-white px-4 py-1.5 rounded-lg font-black text-[10px] uppercase">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                            <button onclick="borrarSeriePendiente('${item.id}', event)" class="text-stone-300 hover:text-red-500">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        });
    });
    
    setTimeout(inicializarDragDrop, 100);
});

onValue(estadoSesionRef, (snap) => {
    const estadoSesion = snap.val() || {};
    state.operarios = estadoSesion.operarios || 0;
    state.entradaLineaHoy = estadoSesion.entradaLineaHoy || null;
    state.salidaLineaHoy = estadoSesion.salidaLineaHoy || null;
    if (state.inicializado) actualizarEstadoLineaUI();
});

onValue(preferenciasRef, (snap) => {
    const preferencias = snap.val() || {};
    state.mesSeleccionado = preferencias.mesDiarioSeleccionado?.valor || { year: new Date().getFullYear(), month: new Date().getMonth() };
    state.anioSeleccionado = preferencias.anioMensualSeleccionado?.valor || new Date().getFullYear();
    
    if (state.inicializado) {
        if (state.mesSeleccionado) actualizarTextoMiniCalendario(state.mesSeleccionado);
        const anioEl = document.getElementById('anioMensual');
        if (anioEl && state.anioSeleccionado) anioEl.textContent = state.anioSeleccionado;
    }
});

onValue(productividadDiariaRef, async () => {
    if (!state.inicializado) return;
    await actualizarGraficoDiario(state.mesSeleccionado);
    await actualizarGraficoMensual(state.anioSeleccionado);
});

onValue(mantenimientoRef, (snap) => {
    const data = snap.val() || {};
    const tbody = document.getElementById('tablaMantenimientoBody');
    if (!tbody) return;
    
    const items = Object.entries(data).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
    
    tbody.innerHTML = items.length === 0
        ? '<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs italic">Sin tareas de mantenimiento</td></tr>'
        : items.map(([id, t]) => `
            <tr class="border-b border-slate-100 ${t.realizado ? 'bg-emerald-50' : 'bg-white'} hover:bg-slate-50">
                <td class="p-2 text-[10px] text-slate-500">${t.fecha || ''}</td>
                <td class="p-2 text-xs font-bold ${t.realizado ? 'line-through text-slate-400' : 'text-slate-700'}">${t.texto || ''}</td>
                <td class="p-2 text-center">
                    <button onclick="toggleMantenimiento('${id}', ${t.realizado})" class="text-[9px] font-black px-2 py-0.5 rounded-full border ${t.realizado ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">
                        ${t.realizado ? '‚úÖ Hecho' : '‚¨ú Pendiente'}
                    </button>
                </td>
                <td class="p-2 text-right">
                    <button onclick="borrarMantenimiento('${id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
});

onValue(incidenciasLogRef, (snap) => {
    const data = snap.val() || {};
    const tbody = document.getElementById('tablaIncidenciasBody');
    if (!tbody) return;
    
    const items = Object.entries(data).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
    
    tbody.innerHTML = items.length === 0
        ? '<tr><td colspan="3" class="p-4 text-center text-slate-400 text-xs italic">Sin incidencias registradas</td></tr>'
        : items.map(([id, t]) => `
            <tr class="border-b border-slate-100 bg-white hover:bg-red-50">
                <td class="p-2 text-[10px] text-slate-500">${t.fecha || ''}</td>
                <td class="p-2 text-xs font-bold text-slate-700">${t.texto || ''}</td>
                <td class="p-2 text-right">
                    <button onclick="borrarIncidenciaLog('${id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
});

window.addEventListener('load', async () => {
    actualizarEstadoLineaUI();
    
    const preferencias = await obtenerPreferencias();
    const mesGuardado = preferencias.mesDiarioSeleccionado?.valor || { year: new Date().getFullYear(), month: new Date().getMonth() };
    state.mesSeleccionado = mesGuardado;
    
    // Inicializar filtro compartido con la fecha de hoy
    const hoy = tsToFechaLocal(Date.now());
    state.filtroFechaTareas = hoy;
    state.fechaProdSeleccionada = hoy;
    
    const anioGuardado = preferencias.anioMensualSeleccionado?.valor || new Date().getFullYear();
    state.anioSeleccionado = anioGuardado;
    
    await actualizarGraficoDiario(mesGuardado);
    await actualizarGraficoMensual(anioGuardado);
    
    // Cargar datos iniciales para tabla y gr√°fico de tiempo por tarea
    await aplicarFiltroFechaCompartido(hoy);
    
    actualizarTextoMiniCalendario(mesGuardado);
    
    const anioEl = document.getElementById('anioMensual');
    if (anioEl) anioEl.textContent = anioGuardado;
    
    state.inicializado = true;
});
</script>
<style>
.sortable-ghost { opacity: 0.4; background: #f3f4f6; }
.sortable-drag { opacity: 1; cursor: grabbing !important; }
.drag-handle { cursor: grab; }
.drag-handle:active { cursor: grabbing; }

@keyframes pulse-soft {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    50% { opacity: 0.85; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
}
.led-conectado {
    animation: pulse-soft 2s infinite;
}

/* Estilos para selectores */
.selector-mes-anio {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    border: 2px solid #c084fc;
}

.selector-anio {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border: 2px solid #60a5fa;
}

/* Mejora para bot√≥n a√±adir mantenimiento */
.btn-add-maintenance {
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn-add-maintenance:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.btn-add-maintenance:active {
    transform: translateY(0);
}
</style>
</head>
<body class="bg-stone-100 min-h-screen p-2 md:p-6 font-sans text-slate-800 pb-24">

<!-- Bot√≥n Volver a Inicio - Posicionado arriba a la izquierda -->
<div class="max-w-6xl mx-auto mb-4">
    <a href="index.html" class="inline-flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-black uppercase border transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Volver a inicio
    </a>
</div>

<!-- Modal Selector Mes y A√±o (Productividad Diaria) -->
<div id="modalSelectorMesAnio" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl border-2 border-purple-200">
        <h3 class="text-lg font-black uppercase text-purple-900 mb-6 text-center">Seleccionar Mes y A√±o</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">Mes</label>
                <select id="selectMes" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:border-purple-500 focus:outline-none">
                    <option value="0">Enero</option>
                    <option value="1">Febrero</option>
                    <option value="2">Marzo</option>
                    <option value="3">Abril</option>
                    <option value="4">Mayo</option>
                    <option value="5">Junio</option>
                    <option value="6">Julio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Septiembre</option>
                    <option value="9">Octubre</option>
                    <option value="10">Noviembre</option>
                    <option value="11">Diciembre</option>
                </select>
            </div>
            
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">A√±o</label>
                <select id="selectAnio" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:border-purple-500 focus:outline-none">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
        </div>
        
        <div class="flex gap-3 mt-6">
            <button onclick="cerrarSelectorMesAnio()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-black text-xs uppercase py-3 rounded-xl">Cancelar</button>
            <button onclick="aplicarMesAnio()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-black text-xs uppercase py-3 rounded-xl">Aplicar</button>
        </div>
    </div>
</div>

<!-- Modal Selector A√±o (Productividad Mensual) -->
<div id="modalSelectorAnio" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl border-2 border-blue-200">
        <h3 class="text-lg font-black uppercase text-blue-900 mb-6 text-center">Seleccionar A√±o</h3>
        
        <div id="gridAnios" class="grid grid-cols-3 gap-3">
            <!-- Se genera din√°micamente -->
        </div>
        
        <button onclick="cerrarSelectorAnio()" class="w-full mt-6 bg-slate-100 hover:bg-slate-200 text-slate-600 font-black text-xs uppercase py-3 rounded-xl">Cancelar</button>
    </div>
</div>

<!-- Modal Operarios -->
<div id="modalOperarios" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center border-4 border-emerald-500">
        <h3 id="tituloModal" class="text-xl font-black uppercase mb-6">Seleccione Operarios</h3>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <button onclick="seleccionarOperarios(1)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">1</button>
            <button onclick="seleccionarOperarios(2)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">2</button>
            <button onclick="seleccionarOperarios(3)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">3</button>
        </div>
        <button onclick="cerrarSelector()" class="text-slate-400 font-bold uppercase text-[10px] hover:text-red-500">Cancelar</button>
    </div>
</div>

<!-- Modal Exportar -->
<div id="modalExportar" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl border-2 border-slate-200">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-black uppercase text-slate-800">üìä Exportar a Excel</h3>
            <button onclick="cerrarModalExportar()" class="text-slate-400 hover:text-red-500">‚úï</button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-1">Fecha inicio</label>
                <input type="date" id="fechaInicioExport" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-1">Fecha fin</label>
                <input type="date" id="fechaFinExport" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold">
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="cerrarModalExportar()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-black text-xs uppercase py-3 rounded-xl">Cancelar</button>
                <button onclick="exportarAExcelRango()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black text-xs uppercase py-3 rounded-xl">üì• Exportar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Embed -->
<div id="modalEmbed" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 max-w-2xl w-full shadow-2xl border-2 border-slate-200">
        <div class="flex items-center justify-between mb-6">
            <h3 id="tituloModalEmbed" class="text-lg font-black uppercase text-slate-800">üîó C√≥digo Embed</h3>
            <button onclick="cerrarModalEmbed()" class="text-slate-400 hover:text-red-500">‚úï</button>
        </div>
        <p class="text-sm text-slate-600 mb-3">Copia este c√≥digo HTML para incrustar el gr√°fico en otra p√°gina:</p>
        <textarea id="codigoEmbed" class="w-full h-64 bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-xs font-mono text-slate-700 resize-none focus:outline-none focus:border-indigo-500" readonly></textarea>
        <div class="flex gap-3 pt-4">
            <button onclick="cerrarModalEmbed()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-black text-xs uppercase py-3 rounded-xl">Cerrar</button>
            <button onclick="copiarCodigoEmbed()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xs uppercase py-3 rounded-xl">üìã Copiar c√≥digo</button>
        </div>
    </div>
</div>

<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header con indicador EN L√çNEA -->
    <div class="flex justify-end mb-2">
        <div id="indicadorFirebase" class="flex items-center gap-2 bg-emerald-100 border-2 border-emerald-400 px-4 py-2 rounded-full shadow-md">
            <div id="ledFirebase" class="w-3 h-3 rounded-full bg-emerald-500 led-conectado shadow-lg"></div>
            <span id="textoFirebase" class="text-[11px] font-black uppercase tracking-wider text-emerald-800">EN L√çNEA</span>
        </div>
    </div>
    
    <!-- Header Principal - Sin bot√≥n de volver -->
    <div class="bg-white p-5 rounded-3xl shadow-sm flex flex-wrap items-center justify-between gap-4 border">
        <div>
            <h1 class="text-4xl font-[1000] uppercase italic"><span class="text-black">Restyling</span> <span class="text-red-600">Production</span></h1>
            <p class="text-[9px] font-bold text-slate-400 tracking-[0.2em] uppercase mt-1">Cloud MES System v2.1</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
            <button id="btnReposicion" onclick="mostrarSelectorOperarios('reposicion')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">üîÑ Reposici√≥n</button>
            <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">‚ö†Ô∏è Incidencia</button>
            <button id="btnDesayuno" onclick="pausaDesayuno()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">‚òï Desayuno</button>
        </div>
    </div>
    
    <!-- Botones Entrada/Salida -->
    <div class="flex flex-wrap items-center gap-4">
        <button id="btnEntradaLinea" onclick="mostrarSelectorOperarios('entrada')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">‚ö´ Entrada L√≠nea</button>
        <button id="btnSalidaLinea" onclick="registrarSalida()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">‚ö´ Salida L√≠nea</button>
        <div class="flex-grow"></div>
        <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(event)">
        <button onclick="dispararSelector()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-2xl font-black text-xs uppercase shadow-lg">üìÅ Cargar Excel</button>
    </div>
    
    <!-- Pedidos Pendientes -->
    <div id="sec-plan" class="hidden">
        <h2 class="text-base font-black uppercase tracking-widest text-red-600 mb-3">üìã Pedidos pendientes</h2>
        <div class="bg-white rounded-3xl shadow-sm overflow-hidden border">
            <table class="w-full text-left text-xs">
                <tbody id="cuerpoPlan"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Pedidos en Proceso - CON FILTRO COMPARTIDO -->
    <div>
        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
            <div class="flex items-center gap-3">
                <h2 id="tituloTablaTareas" class="text-base font-black uppercase tracking-widest text-emerald-600">‚úÖ Pedidos en proceso</h2>
                <!-- Filtro compartido: afecta a tabla y gr√°fico de tiempo por tarea -->
                <button id="btnFiltroFechaTareas" onclick="mostrarFiltroFechaTareas()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg font-black text-[10px] uppercase">üìÖ Filtrar fecha</button>
                <input type="date" id="inputFiltroFechaTareas" class="hidden" onchange="aplicarFiltroFechaCompartido(this.value)">
            </div>
            <div class="flex items-center gap-2">
                <div id="estadoLineaIndicador" class="text-[11px] font-black uppercase"></div>
                <button onclick="exportarAExcel()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase">üìä Exportar</button>
            </div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
            <table class="w-full text-left text-xs">
                <thead class="bg-slate-900 text-white text-[13px] font-black uppercase">
                    <tr>
                        <th class="p-4">Serie</th>
                        <th class="p-4">C√≥digo</th>
                        <th class="p-4 text-center">Op.</th>
                        <th class="p-4">Notas</th>
                        <th class="p-4">Tiempo</th>
                        <th class="p-4">Prod.</th>
                        <th class="p-4 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="cuerpoActividad"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Gr√°fico Tiempo por Tarea - COMPARTE FILTRO CON TABLA -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <div class="flex items-center gap-3">
                <h3 class="text-sm font-black uppercase tracking-widest text-indigo-600">‚è±Ô∏è Tiempo por Tarea</h3>
                <!-- Usa el mismo filtro que la tabla, solo muestra la fecha activa -->
                <div class="bg-indigo-100 border-2 border-indigo-300 rounded-xl px-4 py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span id="tituloFechaProd" class="text-sm font-black text-indigo-900">Hoy</span>
                </div>
            </div>
            <div class="flex items-center gap-4 text-[10px] font-bold">
                <div class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-200">
                    <span class="w-4 h-1 bg-yellow-400 rounded"></span>
                    <span class="text-yellow-700">Media: <span id="mediaValor">--</span></span>
                </div>
                <button id="btnEditarGrafico" onclick="toggleModoEdicionGrafico()" class="bg-slate-100 hover:bg-red-100 text-slate-600 hover:text-red-600 px-3 py-1 rounded-lg font-black text-[10px] border">‚úèÔ∏è Editar puntos</button>
                <button onclick="mostrarEmbed('prod')" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1 rounded-lg font-black text-[10px]">üîó Embed</button>
            </div>
        </div>
        <div class="relative h-64 bg-slate-50 rounded-xl p-2" id="graficoContainer">
            <canvas id="graficoProd"></canvas>
        </div>
        <div id="listaPuntosTiempo" class="hidden mt-3 border border-red-200 rounded-xl overflow-hidden bg-red-50/30 p-2"></div>
    </div>
    
    <!-- Gr√°fico Productividad Diaria - Selector de MES y A√ëO -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <div class="flex items-center gap-3">
                <h3 class="text-sm font-black uppercase tracking-widest text-purple-600">üìà Productividad Diaria</h3>
                <!-- Selector de Mes y A√±o -->
                <button onclick="mostrarSelectorMesAnio()" class="selector-mes-anio rounded-xl px-4 py-2 shadow-inner hover:shadow-md transition-all group flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-600 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <div class="flex items-center gap-1.5">
                        <span class="text-[12px] font-black text-purple-900 uppercase" id="nombreMesDiario">Febrero</span>
                        <span class="text-[10px] font-bold text-purple-500" id="anioMesDiario">2026</span>
                    </div>
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-4 text-[10px] font-bold">
                <div class="flex items-center gap-1 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-200">
                    <span class="w-4 h-1 bg-indigo-500 rounded"></span>
                    <span class="text-indigo-700">Media: <span id="mediaValorDiario">--</span></span>
                </div>
                <button onclick="mostrarEmbed('diario')" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded-lg font-black text-[10px]">üîó Embed</button>
            </div>
        </div>
        <div class="relative h-64 bg-slate-50 rounded-xl p-2">
            <canvas id="graficoDiario"></canvas>
        </div>
    </div>
    
    <!-- Gr√°fico Productividad Mensual - Selector de A√ëO -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <div class="flex items-center gap-3">
                <h3 class="text-sm font-black uppercase tracking-widest text-blue-600">üìä Productividad Mensual</h3>
                <!-- Selector de A√±o -->
                <button onclick="mostrarSelectorAnio()" class="selector-anio rounded-xl px-4 py-2 shadow-inner hover:shadow-md transition-all group flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-[14px] font-black text-blue-900" id="anioMensual">2026</span>
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-4 text-[10px] font-bold">
                <div class="flex items-center gap-1 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-200" id="tendenciaPositiva" style="display:none;">
                    <span class="w-4 h-1 bg-emerald-500 rounded"></span>
                    <span class="text-emerald-700">Tendencia ‚Üó</span>
                </div>
                <div class="flex items-center gap-1 bg-red-50 px-2 py-1 rounded-lg border border-red-200" id="tendenciaNegativa" style="display:none;">
                    <span class="w-4 h-1 bg-red-500 rounded"></span>
                    <span class="text-red-700">Tendencia ‚Üò</span>
                </div>
                <button onclick="mostrarEmbed('mensual')" class="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 rounded-lg font-black text-[10px]">üîó Embed</button>
            </div>
        </div>
        <div class="relative h-72 bg-slate-50 rounded-xl p-2">
            <canvas id="graficoMensual"></canvas>
        </div>
    </div>
</div>

<!-- Tablas Mantenimiento e Incidencias -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 max-w-6xl mx-auto">
    <div class="bg-white rounded-3xl shadow-lg border overflow-hidden">
        <div class="bg-blue-600 px-5 py-3 flex items-center justify-between">
            <h3 class="text-white font-black uppercase text-sm tracking-widest">üîß Mantenimiento</h3>
            <button onclick="abrirMantenimiento()" class="btn-add-maintenance bg-white hover:bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-black text-[11px] uppercase border-2 border-white flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                A√±adir
            </button>
        </div>
        <div class="overflow-auto max-h-64">
            <table class="w-full text-left text-xs">
                <thead class="bg-blue-50 text-blue-700 font-black uppercase text-[10px]">
                    <tr>
                        <th class="p-2">Fecha</th>
                        <th class="p-2">Descripci√≥n</th>
                        <th class="p-2 text-center">Estado</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="tablaMantenimientoBody"></tbody>
            </table>
        </div>
    </div>
    
    <div class="bg-white rounded-3xl shadow-lg border overflow-hidden">
        <div class="bg-red-600 px-5 py-3 flex items-center justify-between">
            <h3 class="text-white font-black uppercase text-sm tracking-widest">‚ö†Ô∏è Registro de Incidencias</h3>
            <span class="bg-white/20 text-white px-2 py-0.5 rounded-lg text-[10px] font-black">Autom√°tico</span>
        </div>
        <div class="overflow-auto max-h-64">
            <table class="w-full text-left text-xs">
                <thead class="bg-red-50 text-red-700 font-black uppercase text-[10px]">
                    <tr>
                        <th class="p-2">Fecha</th>
                        <th class="p-2">Motivo</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="tablaIncidenciasBody"></tbody>
            </table>
        </div>
    </div>
</div>

</body>
</html>