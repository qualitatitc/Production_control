<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dostec AC Production - Control de Tareas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get, goOffline, goOnline } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAJAp5Zx4nmf0336aucWsQy8jB2L3LIsNM",
  authDomain: "dostecac.firebaseapp.com",
  databaseURL: "https://dostecac-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dostecac",
  storageBucket: "dostecac.firebasestorage.app",
  messagingSenderId: "180048271313",
  appId: "1:180048271313:web:35bdfb8a43e35fa28ab2f0",
  measurementId: "G-JHYMPZMNCQ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let firebaseDesconectado = false;

window.toggleFirebase = function() {
  if (!firebaseDesconectado) {
    if (!confirm('‚ö†Ô∏è ¬øDesconectar Firebase?\nLos cambios NO se guardar√°n en la base de datos mientras est√© desconectado.')) return;
    goOffline(db);
    firebaseDesconectado = true;
    const btn = document.getElementById('btnDesconectar');
    btn.textContent = 'üîå Conectar';
    btn.classList.remove('text-slate-500', 'border-slate-200');
    btn.classList.add('text-red-600', 'border-red-300', 'bg-red-50');
    const led = document.getElementById('firebaseLed');
    led.classList.remove('bg-green-500');
    led.classList.add('bg-red-500');
    document.getElementById('firebaseLedPulse').classList.add('opacity-0');
    const status = document.getElementById('firebaseStatus');
    status.textContent = 'MODO PRUEBAS';
    status.classList.remove('text-green-600');
    status.classList.add('text-red-600');
  } else {
    goOnline(db);
    firebaseDesconectado = false;
    const btn = document.getElementById('btnDesconectar');
    btn.textContent = 'üîå Desconectar';
    btn.classList.remove('text-red-600', 'border-red-300', 'bg-red-50');
    btn.classList.add('text-slate-500', 'border-slate-200');
  }
};

// ‚îÄ‚îÄ Helpers Firebase que funcionan tambi√©n en modo desconectado (pruebas) ‚îÄ‚îÄ
// En modo desconectado Firebase nunca resuelve sus promesas; estos wrappers
// resuelven inmediatamente con un valor vac√≠o para que el flujo no se bloquee.
async function fbPush(r, val) {
  if (firebaseDesconectado) return { key: 'offline_' + Date.now() };
  return push(r, val);
}
async function fbUpdate(r, val) {
  if (firebaseDesconectado) return;
  return update(r, val);
}
async function fbGet(r) {
  if (firebaseDesconectado) return { val: () => null, exists: () => false };
  return get(r);
}

const tareasRef = ref(db, 'tareas');
const tareasHistorialRef = ref(db, 'historial_tareas');
const pausaRef = ref(db, 'estadoPausa');
const incidenciaRef = ref(db, 'estadoIncidencia');
const reposicionRef = ref(db, 'estadoReposicion');
const estadoLineaRef = ref(db, 'estadoLinea');
const mantenimientoRef = ref(db, 'tareas_mantenimiento');
const incidenciasTextoRef = ref(db, 'incidencias_texto');
const connectedRef = ref(db, '.info/connected');

onValue(connectedRef, (snapshot) => {
  const led = document.getElementById('firebaseLed');
  const pulse = document.getElementById('firebaseLedPulse');
  const status = document.getElementById('firebaseStatus');
  if (snapshot.val() === true) {
    led.classList.remove('bg-gray-400', 'bg-red-500');
    led.classList.add('bg-green-500');
    pulse.classList.remove('opacity-0');
    status.textContent = 'Conectado';
    status.classList.remove('text-slate-600', 'text-red-600');
    status.classList.add('text-green-600');
  } else {
    led.classList.remove('bg-gray-400', 'bg-green-500');
    led.classList.add('bg-red-500');
    pulse.classList.add('opacity-0');
    status.textContent = 'Desconectado';
    status.classList.remove('text-slate-600', 'text-green-600');
    status.classList.add('text-red-600');
  }
});

let estaPausadoGlobal = false;
let hayIncidenciaGlobal = false;
let hayReposicionGlobal = false;
let lineaIniciada = false;
let numOperariosActivos = 1;
let operarioLineaActiva = null;
let operariosEnLinea = [];
let filtroFechaTablaActual = null;
let inicioPausaMS = 0;
let inicioIncidenciaMS = 0;
let inicioReposicionMS = 0;
let desayunosActivos = {}; // { "Adrian Garc√≠a": {inicioMS, horaTexto, fecha}, "Aitor Bautista": ... }
let tareasPausadasPorDesayuno = false; // true solo si los 2 operarios est√°n desayunando
let chartInstance = null;
let chartProductividad = null;
let chartProductividadMensual = null;
let todasLasTareas = {};
let tareasActivasTemp = {};
let primeraVez = true;





function actualizarEstadoBotones() {
  const btnPausa = document.getElementById('btnPausa');
  const btnIncidencia = document.getElementById('btnIncidencia');
  const btnReposicion = document.getElementById('btnReposicion');
  const btnIniciarTarea = document.getElementById('btnIniciarTarea');
  const btnEntrada = document.getElementById('btnEntrada');
  const btnSalida = document.getElementById('btnSalida');
  const indicadorLinea = document.getElementById('indicadorLinea');

  if (lineaIniciada) {
    btnPausa.disabled = false;
    btnPausa.classList.remove('opacity-50', 'cursor-not-allowed');
    btnIncidencia.disabled = false;
    btnIncidencia.classList.remove('opacity-50', 'cursor-not-allowed');
    btnReposicion.disabled = true;
    btnReposicion.classList.add('opacity-50', 'cursor-not-allowed');
    btnIniciarTarea.disabled = false;
    btnIniciarTarea.classList.remove('opacity-50', 'cursor-not-allowed');
    btnEntrada.disabled = true;
    btnEntrada.classList.add('opacity-50', 'cursor-not-allowed');
    btnSalida.disabled = false;
    btnSalida.classList.remove('opacity-50', 'cursor-not-allowed');
    indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg animate-pulse">üü¢ L√≠nea Activa</span>';
  } else {
    if (Object.keys(desayunosActivos).length > 0) {
      btnPausa.disabled = false;
      btnPausa.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      btnPausa.disabled = true;
      btnPausa.classList.add('opacity-50', 'cursor-not-allowed');
    }
    btnIncidencia.disabled = true;
    btnIncidencia.classList.add('opacity-50', 'cursor-not-allowed');
    btnReposicion.disabled = false;
    btnReposicion.classList.remove('opacity-50', 'cursor-not-allowed');
    btnIniciarTarea.disabled = true;
    btnIniciarTarea.classList.add('opacity-50', 'cursor-not-allowed');
    btnEntrada.disabled = false;
    btnEntrada.classList.remove('opacity-50', 'cursor-not-allowed');
    btnSalida.disabled = true;
    btnSalida.classList.add('opacity-50', 'cursor-not-allowed');
    indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>';
  }
}

window.forzarParadaLinea = async function() {
  if (!confirm('‚õî ¬øForzar parada de l√≠nea?\nSe registrar√° una SALIDA ahora mismo.')) return;

  const operario = operariosEnLinea.length > 0 ? operariosEnLinea.join(' + ') : 'SISTEMA';
  const horaActual = new Date().toLocaleTimeString('es-ES');
  const fechaActual = obtenerFecha();
  const ahora = Date.now();

  const snapTareas = await fbGet(tareasRef);
  const tareas = snapTareas.val() || {};
  const updates = {};

  Object.keys(tareas).forEach(id => {
    if (tareas[id].estado === "activo") {
      const acumuladoSesion = ahora - tareas[id].inicioMS;
      updates[`tareas/${id}/estado`] = "pausa_salida_linea";
      updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
    }
  });

  if (Object.keys(updates).length > 0) await fbUpdate(ref(db), updates);

  await fbPush(tareasHistorialRef, {
    operario, numSerie: "---", codigo: "‚õî SALIDA FORZADA",
    fecha: fechaActual, inicio: horaActual, inicioMS: ahora,
    fin: "---", total: 0, tipo: "jornada", numOperarios: 0, timestamp: Date.now()
  });

  lineaIniciada = false;
  numOperariosActivos = 1;
  operarioLineaActiva = null;
  operariosEnLinea = [];
  actualizarDisplayOperario();
  await fbUpdate(estadoLineaRef, { activa: false, operario: null, operarios: [], numOperarios: 0 });
  actualizarEstadoBotones();
};

const obtenerFecha = () => {
  const hoy = new Date();
  const dia = String(hoy.getDate()).padStart(2, '0');
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const anio = hoy.getFullYear();
  return `${dia}/${mes}/${anio}`;
};

const obtenerOperarioActual = () => operariosEnLinea.length > 0 ? operariosEnLinea.join(' + ') : 'Sin operario';

function obtenerFechaHoy() {
  const hoy = new Date();
  const anio = hoy.getFullYear();
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const dia = String(hoy.getDate()).padStart(2, '0');
  return `${anio}-${mes}-${dia}`;
}

function formatTime(ms) {
  if (!ms || ms < 0) return "0m 0s";
  const min = Math.floor(ms / 60000);
  const seg = Math.floor((ms % 60000) / 1000);
  return `${min}m ${seg}s`;
}

function convertirFechaHTML(fechaHTML) {
  const partes = fechaHTML.split('-');
  return `${partes[2]}/${partes[1]}/${partes[0]}`;
}

function convertirHoraAMinutos(horaStr) {
  if (!horaStr || horaStr === '--:--' || horaStr === '---') return 0;
  if (typeof horaStr === 'number') return horaStr / 60000;
  const s = String(horaStr);
  if (!s.includes(':')) return 0;
  const [horas, minutos, segundos] = s.split(':').map(Number);
  if (isNaN(horas) || isNaN(minutos)) return 0;
  return horas * 60 + minutos + (segundos || 0) / 60;
}

function parsearFecha(fechaStr) {
  if (!fechaStr) return null;
  const s = String(fechaStr);
  if (!s.includes('/')) return null;
  const [dia, mes, anio] = s.split('/').map(Number);
  if (isNaN(dia) || isNaN(mes) || isNaN(anio)) return null;
  return new Date(anio, mes - 1, dia);
}

function sumarDiaAFecha(fechaStr, dias) {
  const f = parsearFecha(fechaStr);
  f.setDate(f.getDate() + dias);
  return `${String(f.getDate()).padStart(2, '0')}/${String(f.getMonth() + 1).padStart(2, '0')}/${f.getFullYear()}`;
}

function actualizarGraficoPuntos(fechaFiltro = null) {
  const tareasAdrian = [];
  const tareasAlberto = [];
  const tareasAmbos = [];

  if (todasLasTareas) {
    const tareasProduccion = Object.entries(todasLasTareas)
      .filter(([id, t]) => {
        const esProduccion = t.tipo === 'produccion';
        const tieneTiempo = t.total && !isNaN(parseInt(t.total)) && parseInt(t.total) > 0;
        const cumpleFecha = !fechaFiltro || t.fecha === fechaFiltro;
        return esProduccion && tieneTiempo && cumpleFecha;
      })
      .map(([id, t]) => ({
        id: id, ...t,
        tiempoNum: parseInt(t.total),
        horaMinutos: convertirHoraAMinutos(t.inicio)
      }));

    tareasProduccion.sort((a, b) => a.horaMinutos - b.horaMinutos);

    tareasProduccion.forEach((t, index) => {
      const punto = { x: index, y: t.tiempoNum, tarea: t.codigo, serie: t.numSerie, hora: t.inicio, fecha: t.fecha, firebaseId: t.id, operario: t.operario };
      const esAmbos = t.operario && t.operario.includes('+');
      if (esAmbos) tareasAmbos.push(punto);
      else if (t.operario === 'Adrian Garc√≠a') tareasAdrian.push(punto);
      else if (t.operario === 'Aitor Bautista') tareasAlberto.push(punto);
    });
  }

  const ctx = document.getElementById('graficoTareas').getContext('2d');
  if (chartInstance) chartInstance.destroy();

  const totalTareas = tareasAdrian.length + tareasAlberto.length + tareasAmbos.length;
  if (totalTareas === 0) {
    document.getElementById('contadorTareas').textContent = fechaFiltro ? `Sin datos para ${fechaFiltro}` : 'Sin tareas en el historial';
  } else {
    document.getElementById('contadorTareas').textContent = fechaFiltro ? `${totalTareas} tareas el ${fechaFiltro}` : `${totalTareas} tareas totales`;
  }

  const todosTiempos = [...tareasAdrian, ...tareasAlberto, ...tareasAmbos].map(t => t.y);
  const tiempoMedio = todosTiempos.length > 0 ? todosTiempos.reduce((a, b) => a + b, 0) / todosTiempos.length : 0;
  const maxX = totalTareas - 1;
  const lineaMedia = maxX >= 0 ? [{ x: 0, y: tiempoMedio }, { x: maxX, y: tiempoMedio }] : [];

  // Plugin para dibujar puntos mitad azul / mitad rojo
  const splitPointPlugin = {
    id: 'splitPoint',
    afterDatasetsDraw(chart) {
      const meta = chart.getDatasetMeta(2); // dataset "Ambos" es el index 2
      if (!meta || meta.hidden) return;
      const ctx = chart.ctx;
      meta.data.forEach(point => {
        const x = point.x;
        const y = point.y;
        const r = 8;
        ctx.save();
        // Mitad izquierda azul
        ctx.beginPath();
        ctx.arc(x, y, r, Math.PI * 0.5, Math.PI * 1.5);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();
        ctx.strokeStyle = '#2563eb';
        ctx.lineWidth = 2;
        ctx.stroke();
        // Mitad derecha roja
        ctx.beginPath();
        ctx.arc(x, y, r, Math.PI * 1.5, Math.PI * 0.5);
        ctx.fillStyle = '#ef4444';
        ctx.fill();
        ctx.strokeStyle = '#dc2626';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      });
    }
  };

  chartInstance = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'Adrian Garc√≠a', data: tareasAdrian, backgroundColor: '#3b82f6', borderColor: '#2563eb', borderWidth: 2, pointRadius: 8, pointHoverRadius: 12, order: 2 },
        { label: 'Aitor Bautista', data: tareasAlberto, backgroundColor: '#ef4444', borderColor: '#dc2626', borderWidth: 2, pointRadius: 8, pointHoverRadius: 12, order: 2 },
        { label: 'Ambos', data: tareasAmbos, backgroundColor: 'transparent', borderColor: 'transparent', pointRadius: 0, pointHoverRadius: 12, order: 2 },
        { label: 'Tiempo Medio', data: lineaMedia, type: 'line', borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', borderWidth: 3, borderDash: [5, 5], pointRadius: 0, fill: false, showLine: true, order: 1 }
      ]
    },
    plugins: [splitPointPlugin],
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick: (e) => {
        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
        if (points.length) {
          const firstPoint = points[0];
          const dataset = chartInstance.data.datasets[firstPoint.datasetIndex];
          if (dataset.data[firstPoint.index]?.firebaseId) mostrarModalEliminar(dataset.data[firstPoint.index]);
        }
      },
      onHover: (e, activeElements) => { e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default'; },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (ctx) => `Tarea #${ctx[0].parsed.x + 1}`,
            label: (ctx) => {
              const p = ctx.raw;
              let operario = 'Ambos';
              if (ctx.datasetIndex === 0) operario = 'Adrian';
              else if (ctx.datasetIndex === 1) operario = 'Aitor';
              return [`Operario: ${operario}`, `Tarea: ${p.tarea}`, `Serie: ${p.serie}`, `Hora: ${p.hora}`, `Tiempo: ${p.y} minutos`];
            }
          }
        }
      },
      scales: {
        x: { display: true, title: { display: true, text: 'N√∫mero de tarea (orden cronol√≥gico)', font: { weight: 'bold' } }, ticks: { callback: (v) => v + 1 }, grid: { color: '#e2e8f0' } },
        y: { beginAtZero: true, title: { display: true, text: 'Tiempo (minutos)', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } }
      }
    }
  });
}

function calcularTendencia(datos) {
  const puntos = datos.map((y, x) => ({ x, y })).filter(p => p.y !== null && !isNaN(p.y));
  if (puntos.length < 2) return { tendencia: [], pendiente: 0 };
  const n = puntos.length;
  const sumaX = puntos.reduce((sum, p) => sum + p.x, 0);
  const sumaY = puntos.reduce((sum, p) => sum + p.y, 0);
  const sumaXY = puntos.reduce((sum, p) => sum + p.x * p.y, 0);
  const sumaX2 = puntos.reduce((sum, p) => sum + p.x * p.x, 0);
  const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
  const intercept = (sumaY - pendiente * sumaX) / n;
  const tendencia = datos.map((_, x) => datos[x] === null ? null : pendiente * x + intercept);
  return { tendencia, pendiente };
}

function calcularProductividadDiaria(anio, mes) {
  const diasDelMes = new Date(anio, mes, 0).getDate();
  const datosProductividad = new Array(diasDelMes).fill(null);
  const tareasPorDiaOperario = {};
  const jornadasPorDiaOperario = {};

  if (todasLasTareas) {
    Object.values(todasLasTareas).forEach(t => {
      if (t.tipo !== 'produccion' && t.tipo !== 'jornada') return;
      let fechaBase = t.fecha;
      if (t.tipo === 'produccion' && t.fin && t.fin !== '--:--' && t.fin !== '---') {
        const hInicio = convertirHoraAMinutos(t.inicio);
        const hFin = convertirHoraAMinutos(t.fin);
        if (hFin < hInicio) {
          const fechaFin = sumarDiaAFecha(fechaBase, 1);
          tareasPorDiaOperario[`${fechaBase}-${t.operario}`] = (tareasPorDiaOperario[`${fechaBase}-${t.operario}`] || 0) + 0.5;
          tareasPorDiaOperario[`${fechaFin}-${t.operario}`] = (tareasPorDiaOperario[`${fechaFin}-${t.operario}`] || 0) + 0.5;
          return;
        }
      }
      const fechaObj = parsearFecha(fechaBase);
      if (!fechaObj || fechaObj.getFullYear() !== anio || fechaObj.getMonth() !== mes - 1) return;
      const key = `${fechaBase}-${t.operario}`;
      if (t.tipo === 'produccion') {
        tareasPorDiaOperario[key] = (tareasPorDiaOperario[key] || 0) + 1;
      } else if (t.tipo === 'jornada') {
        if (!jornadasPorDiaOperario[key]) jornadasPorDiaOperario[key] = { entradas: [], salidas: [] };
        if (t.codigo && t.codigo.includes('ENTRADA')) jornadasPorDiaOperario[key].entradas.push({ hora: t.inicio, numOperarios: t.numOperarios || 1 });
        else if (t.codigo && t.codigo.includes('SALIDA')) jornadasPorDiaOperario[key].salidas = t.inicio;
      }
    });
  }

  for (let dia = 1; dia <= diasDelMes; dia++) {
    const fechaStr = `${String(dia).padStart(2, '0')}/${String(mes).padStart(2, '0')}/${anio}`;
    const productividadesDia = [];
    ['Adrian Garc√≠a', 'Aitor Bautista'].forEach(operario => {
      const key = `${fechaStr}-${operario}`;
      const countTareas = tareasPorDiaOperario[key] || 0;
      const jornada = jornadasPorDiaOperario[key];
      if (countTareas > 0 && jornada && jornada.entradas && jornada.entradas.length > 0 && jornada.salidas) {
        const salidaMin = convertirHoraAMinutos(jornada.salidas);
        let horas1Op = 0, horas2Op = 0;
        jornada.entradas.forEach((entrada, index) => {
          const entradaMin = convertirHoraAMinutos(entrada.hora);
          const finPeriodoMin = index < jornada.entradas.length - 1 ? convertirHoraAMinutos(jornada.entradas[index + 1].hora) : salidaMin;
          const horasPeriodo = (finPeriodoMin - entradaMin) / 60;
          if (entrada.numOperarios === 1) horas1Op += horasPeriodo;
          else if (entrada.numOperarios === 2) horas2Op += horasPeriodo;
        });
        const denominador = horas1Op + (horas2Op * 2);
        if (denominador > 0) productividadesDia.push((countTareas * 7) / denominador);
      }
    });
    if (productividadesDia.length > 0) datosProductividad[dia - 1] = productividadesDia.reduce((a, b) => a + b, 0) / productividadesDia.length;
  }
  return { datosProductividad, diasDelMes };
}

function actualizarGraficoProductividadDiaria() {
  const inputMes = document.getElementById('filtroMesProductividadDiaria').value;
  if (!inputMes) return;
  const [anio, mes] = inputMes.split('-').map(Number);
  const { datosProductividad, diasDelMes } = calcularProductividadDiaria(anio, mes);
  const todosLosValores = datosProductividad.filter(v => v !== null && !isNaN(v));
  const media = todosLosValores.length > 0 ? todosLosValores.reduce((a, b) => a + b, 0) / todosLosValores.length : 0;
  const lineaMedia = new Array(diasDelMes).fill(media);
  const labels = Array.from({ length: diasDelMes }, (_, i) => i + 1);
  const ctx = document.getElementById('graficoProductividadDiaria').getContext('2d');
  if (chartProductividad) chartProductividad.destroy();

  chartProductividad = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Productividad', data: datosProductividad, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, pointRadius: 6, pointBackgroundColor: '#3b82f6', fill: true, tension: 0.3, spanGaps: true, order: 2 },
        { label: 'Media', data: lineaMedia, borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', borderWidth: 3, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0, order: 1 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      onClick: async (e) => {
        // Usar 'index' con intersect:false para detectar el punto m√°s cercano en X
        const points = chartProductividad.getElementsAtEventForMode(e, 'index', { intersect: false }, true);
        if (points.length) {
          // Buscar el punto del dataset de productividad (no la media)
          const prodPoint = points.find(p => p.datasetIndex === 0);
          if (!prodPoint) return;
          const dia = prodPoint.index + 1;
          const [anioSel, mesSel] = document.getElementById('filtroMesProductividadDiaria').value.split('-').map(Number);
          const fechaBuscar = `${String(dia).padStart(2, '0')}/${String(mesSel).padStart(2, '0')}/${anioSel}`;
          // Solo mostrar modal si ese d√≠a tiene datos de productividad
          const valorDia = chartProductividad.data.datasets[0].data[prodPoint.index];
          if (valorDia === null || valorDia === undefined || isNaN(valorDia)) return;
          mostrarModalEliminarDiaTodos(dia, mesSel, anioSel, fechaBuscar);
        }
      },
      onHover: (e, activeElements) => { e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default'; },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
        tooltip: { callbacks: { label: (ctx) => { const v = ctx.raw; return (v === null || isNaN(v)) ? `${ctx.dataset.label}: Sin datos` : `${ctx.dataset.label}: ${v.toFixed(2)} tareas/hora`; } } }
      },
      scales: {
        x: { display: true, title: { display: true, text: 'D√≠as del mes', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } },
        y: { beginAtZero: true, title: { display: true, text: 'Productividad (tareas√ó7 / (h√óop))', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } }
      }
    }
  });

  const diasConDatos = todosLosValores.length;
  const nombreMes = new Date(anio, mes - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  document.getElementById('mediaProductividadDiaria').textContent = `Media de ${nombreMes}: ${media.toFixed(2)}`;
  document.getElementById('diasConDatosDiaria').textContent = `D√≠as con datos: ${diasConDatos}`;
}

window.cambiarMesProductividadDiaria = function() { actualizarGraficoProductividadDiaria(); };

function calcularProductividadMensual(anio) {
  const datosProductividad = new Array(12).fill(null);
  Array.from({ length: 12 }, (_, i) => i + 1).forEach(mes => {
    const { datosProductividad: diasMes } = calcularProductividadDiaria(anio, mes);
    const valoresMes = diasMes.filter(v => v !== null && !isNaN(v));
    if (valoresMes.length > 0) datosProductividad[mes - 1] = valoresMes.reduce((a, b) => a + b, 0) / valoresMes.length;
  });
  return { datosProductividad };
}

function actualizarGraficoProductividadMensual() {
  const anio = parseInt(document.getElementById('selectAnioProductividadMensual').value);
  const { datosProductividad } = calcularProductividadMensual(anio);
  const todosLosValores = datosProductividad.filter(v => v !== null && !isNaN(v));
  const media = todosLosValores.length > 0 ? todosLosValores.reduce((a, b) => a + b, 0) / todosLosValores.length : 0;
  const { tendencia, pendiente } = calcularTendencia(datosProductividad);
  const esTendenciaPositiva = pendiente > 0;
  const colorTendencia = esTendenciaPositiva ? '#10b981' : '#ef4444';
  const lineaMedia = new Array(12).fill(media);
  const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

  const ctx = document.getElementById('graficoProductividadMensual').getContext('2d');
  if (chartProductividadMensual) chartProductividadMensual.destroy();

  chartProductividadMensual = new Chart(ctx, {
    type: 'scatter',
    data: {
      labels,
      datasets: [
        { label: 'Productividad Mensual', data: datosProductividad.map((val, idx) => val !== null && !isNaN(val) ? { x: idx, y: val } : null).filter(p => p !== null), backgroundColor: '#3b82f6', borderColor: '#2563eb', pointRadius: 8, pointHoverRadius: 12, showLine: false, order: 3 },
        { label: 'Media Anual', data: lineaMedia.map((val, idx) => val !== null && !isNaN(val) && val > 0 ? { x: idx, y: val } : null).filter(p => p !== null), type: 'line', borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', borderWidth: 3, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0, order: 1 },
        { label: esTendenciaPositiva ? 'Tendencia ‚Üó' : 'Tendencia ‚Üò', data: tendencia.map((val, idx) => val !== null && !isNaN(val) ? { x: idx, y: val } : null).filter(p => p !== null), type: 'line', borderColor: colorTendencia, backgroundColor: esTendenciaPositiva ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)', borderWidth: 3, pointRadius: 0, fill: false, tension: 0, order: 2 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
        tooltip: {
          callbacks: {
            label: (ctx) => { const v = ctx.raw?.y || ctx.raw; return (v === null || isNaN(v)) ? `${ctx.dataset.label}: Sin datos` : `${ctx.dataset.label}: ${v.toFixed(2)} tareas/hora`; },
            title: (ctx) => labels[ctx[0].parsed.x]
          }
        }
      },
      scales: {
        x: { type: 'linear', display: true, min: 0, max: 11, ticks: { stepSize: 1, callback: (v) => labels[v] || '' }, title: { display: true, text: 'Meses del a√±o', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } },
        y: { beginAtZero: true, title: { display: true, text: 'Productividad Media (tareas√ó7 / (h√óop))', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } }
      }
    }
  });

  document.getElementById('mediaProductividadAnual').textContent = `Media de ${anio}: ${media.toFixed(2)}`;
  const tendenciaTexto = esTendenciaPositiva ? `<span class="text-green-600">‚Üó Tendencia positiva</span>` : `<span class="text-red-600">‚Üò Tendencia negativa</span>`;
  document.getElementById('mesesConDatos').innerHTML = `Meses: ${todosLosValores.length} | ${tendenciaTexto}`;
}

window.cambiarAnioProductividadMensual = function() { actualizarGraficoProductividadMensual(); };

window.mostrarModalEliminar = function(punto) {
  const modal = document.getElementById('modalEliminar');
  const info = document.getElementById('infoTareaEliminar');
  const btnEliminar = document.getElementById('btnConfirmarEliminar');
  const colorOperario = punto.operario === 'Adrian Garc√≠a' ? 'text-blue-600' : 'text-red-600';
  info.innerHTML = `
    <div class="space-y-2">
      <p><span class="font-bold text-slate-600">Operario:</span> <span class="${colorOperario} font-bold">${punto.operario}</span></p>
      <p><span class="font-bold text-slate-600">Tarea:</span> ${punto.tarea}</p>
      <p><span class="font-bold text-slate-600">Serie:</span> ${punto.serie}</p>
      <p><span class="font-bold text-slate-600">Fecha:</span> ${punto.fecha}</p>
      <p><span class="font-bold text-slate-600">Hora:</span> ${punto.hora}</p>
      <p><span class="font-bold text-slate-600">Tiempo:</span> ${punto.y} minutos</p>
    </div>`;
  btnEliminar.onclick = () => eliminarPuntoGrafico(punto.firebaseId);
  modal.classList.remove('hidden');
};

window.mostrarModalEliminarDiaTodos = function(dia, mes, anio, fecha) {
  const modal = document.getElementById('modalEliminar');
  const info = document.getElementById('infoTareaEliminar');
  const btnEliminar = document.getElementById('btnConfirmarEliminar');
  const nombreMes = new Date(anio, mes - 1).toLocaleDateString('es-ES', { month: 'long' });

  // Calcular la fecha del d√≠a anterior (para tareas que cruzan medianoche)
  const fechaObj = parsearFecha(fecha);
  fechaObj.setDate(fechaObj.getDate() - 1);
  const fechaAnterior = `${String(fechaObj.getDate()).padStart(2, '0')}/${String(fechaObj.getMonth() + 1).padStart(2, '0')}/${fechaObj.getFullYear()}`;

  let contadorDirectas = 0;
  let contadorMedianoche = 0;
  if (todasLasTareas) {
    Object.values(todasLasTareas).forEach(t => {
      if (t.tipo !== 'produccion') return;
      if (t.fecha === fecha) {
        contadorDirectas++;
      } else if (t.fecha === fechaAnterior && t.fin && t.fin !== '--:--' && t.fin !== '---') {
        // Tarea del d√≠a anterior que cruza medianoche hacia este d√≠a
        const hInicio = convertirHoraAMinutos(t.inicio);
        const hFin = convertirHoraAMinutos(t.fin);
        if (hFin < hInicio) contadorMedianoche++;
      }
    });
  }

  const totalTareas = contadorDirectas + contadorMedianoche;
  const notaMedianoche = contadorMedianoche > 0
    ? `<p class="text-blue-600 text-xs mt-1">‚ÑπÔ∏è ${contadorMedianoche} tarea(s) del d√≠a anterior que cruzan medianoche</p>`
    : '';

  info.innerHTML = `
    <div class="space-y-2">
      <p><span class="font-bold text-slate-600">Fecha:</span> ${dia} de ${nombreMes} ${anio}</p>
      <p><span class="font-bold text-slate-600">Tareas a borrar:</span> <span class="text-red-600 font-bold">${totalTareas} tarea(s) de producci√≥n</span></p>
      ${notaMedianoche}
      <p class="text-amber-600 text-xs mt-4">‚ö†Ô∏è Esto eliminar√° las tareas que generan este punto en el gr√°fico</p>
    </div>`;
  btnEliminar.onclick = () => eliminarTareasDiaTodos(fecha, fechaAnterior);
  modal.classList.remove('hidden');
};

window.eliminarTareasDiaTodos = async function(fecha, fechaAnterior) {
  if (!confirm(`¬øEst√°s seguro de eliminar las tareas que generan el punto del ${fecha}?`)) { cerrarModalEliminar(); return; }
  try {
    const snapshot = await fbGet(tareasHistorialRef);
    const tareas = snapshot.val() || {};
    let eliminadas = 0;
    for (const [id, tarea] of Object.entries(tareas)) {
      if (tarea.tipo !== 'produccion') continue;
      // Tareas directas del d√≠a
      if (tarea.fecha === fecha) {
        await remove(ref(db, `historial_tareas/${id}`));
        eliminadas++;
        continue;
      }
      // Tareas del d√≠a anterior que cruzan medianoche hacia este d√≠a
      if (fechaAnterior && tarea.fecha === fechaAnterior && tarea.fin && tarea.fin !== '--:--' && tarea.fin !== '---') {
        const hInicio = convertirHoraAMinutos(tarea.inicio);
        const hFin = convertirHoraAMinutos(tarea.fin);
        if (hFin < hInicio) {
          await remove(ref(db, `historial_tareas/${id}`));
          eliminadas++;
        }
      }
    }
    alert(`‚úì Se eliminaron ${eliminadas} tarea(s) del historial`);
    cerrarModalEliminar();
  } catch (error) { alert('Error al eliminar: ' + error.message); }
};

window.cerrarModalEliminar = function() { document.getElementById('modalEliminar').classList.add('hidden'); };

window.eliminarPuntoGrafico = async function(firebaseId) {
  if (!confirm('¬øEst√°s seguro de eliminar este punto del historial?')) return;
  try { await remove(ref(db, `historial_tareas/${firebaseId}`)); cerrarModalEliminar(); }
  catch (error) { alert('Error al eliminar: ' + error.message); }
};

window.filtrarPorFecha = function() {
  let fechaInput = document.getElementById('filtroFecha').value;
  if (!fechaInput) {
    fechaInput = obtenerFechaHoy();
    document.getElementById('filtroFecha').value = fechaInput;
  }
  const fechaDD = convertirFechaHTML(fechaInput);
  // ‚úÖ Sincronizar filtro de la tabla con el del gr√°fico
  const filtroTabla = document.getElementById('filtroFechaTabla');
  if (filtroTabla) filtroTabla.value = fechaInput;
  filtroFechaTablaActual = fechaDD;
  actualizarGraficoPuntos(fechaDD);
  actualizarTablaTareas();
};

setInterval(() => {
  const ahora = Date.now();
  // Solo actualizar contadores vivos si NO hay pausa global de tareas (ambos desayunando)
  if (!tareasPausadasPorDesayuno && !hayIncidenciaGlobal && !hayReposicionGlobal) {
    document.querySelectorAll('.contador-vivo').forEach(el => {
      const inicioMS = parseInt(el.dataset.inicio);
      const acumuladoPrevio = parseInt(el.dataset.acumulado || 0);
      el.innerText = formatTime((ahora - inicioMS) + acumuladoPrevio);
    });
  }
  if (estaPausadoGlobal) {
    const c = document.getElementById('tiempoDesayuno');
    if (c) {
      const nombres = Object.entries(desayunosActivos).map(([nombre, info]) => {
        const t = formatTime(ahora - info.inicioMS);
        return `${nombre.split(' ')[0]}: ${t}`;
      });
      c.innerHTML = nombres.join(' &nbsp;|&nbsp; ');
    }
  }
  if (hayIncidenciaGlobal) { const c = document.getElementById('tiempoIncidencia'); if(c) c.innerText = formatTime(ahora - inicioIncidenciaMS); }
  if (hayReposicionGlobal) { const c = document.getElementById('tiempoReposicion'); if(c) c.innerText = formatTime(ahora - inicioReposicionMS); }
  // Actualizar contadores de desayuno en la tabla
  document.querySelectorAll('.contador-desayuno').forEach(el => {
    const inicioMS = parseInt(el.dataset.inicio);
    el.innerText = formatTime(ahora - inicioMS);
  });
}, 1000);

window.finalizarTarea = async function(id) {
  if (!id || id === 'undefined' || id === 'null') { 
    alert('‚ùå Error: ID no v√°lido. Recarga la p√°gina.'); 
    return; 
  }
  if (!confirm('¬øFinalizar tarea?')) return;

  try {
    const ahora = Date.now();

    // Obtener datos con fallback a cache local
    const snap = await fbGet(ref(db, `tareas/${id}`));
    let t = snap.val() || tareasActivasTemp[id] || null;
    if (!t) { alert('‚ùå No se encontr√≥ la tarea'); return; }

    let totalMS = (t.acumuladoMS || 0);
    if (t.estado === "activo") totalMS += (ahora - t.inicioMS);
    const tiempoTotal = Math.max(1, Math.round(totalMS / 60000));
    const horaFin = new Date().toLocaleTimeString('es-ES');

    // ‚úÖ Guardar en historial con el MISMO ID que en tareasRef para evitar duplicados
    await fbUpdate(ref(db, `historial_tareas/${id}`), {
      operario: t.operario, numSerie: t.numSerie, codigo: t.codigo,
      fecha: t.fecha, inicio: t.inicio, inicioMS: t.inicioMS,
      fin: horaFin, total: tiempoTotal, tipo: "produccion", timestamp: Date.now()
    });

    // ‚úÖ Borrar de tareasRef (activas) para que desaparezca de tareasActivasTemp
    await remove(ref(db, `tareas/${id}`));

  } catch (err) {
    alert('‚ùå Error al finalizar: ' + err.message);
  }
};

// ============================================
// ‚úÖ FIX 1: borrarTarea ‚Äî borra del nodo correcto
// ============================================
window.borrarTarea = async function(id, nodo) {
  if (!id) { alert('‚ùå ID no v√°lido'); return; }
  if (!confirm('¬øBorrar tarea de la tabla?')) return;
  try {
    await Promise.allSettled([
      remove(ref(db, `historial_tareas/${id}`)),
      remove(ref(db, `tareas/${id}`))
    ]);
  } catch (error) {
    alert('Error al borrar: ' + error.message);
  }
};

window.borrarTodoElRegistro = () => {
  if (confirm("¬øBORRAR TODA LA TABLA?\nLos datos de los gr√°ficos NO se borrar√°n.")) remove(tareasRef);
};

window.borrarHistorialGrafico = () => {
  if (confirm("‚ö†Ô∏è ¬øBORRAR PERMANENTEMENTE EL HISTORIAL?\nEsto borrar√° todos los datos de los gr√°ficos.")) remove(tareasHistorialRef);
};

window.toggleReposicion = async function() {
  const ahora = Date.now();
  const snapTareas = await fbGet(tareasRef);
  const tareas = snapTareas.val() || {};
  const updates = {};
  if (!hayReposicionGlobal) {
    update(reposicionRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "activo") { updates[`tareas/${id}/estado`] = "pausa_reposicion"; updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + (ahora - tareas[id].inicioMS); } });
  } else {
    const snapR = await fbGet(reposicionRef);
    const infoR = snapR.val();
    const horaFin = new Date().toLocaleTimeString('es-ES');
    const duracion = Math.round((ahora - infoR.inicioMS) / 60000) || 1;
    await fbPush(tareasHistorialRef, { operario: infoR.operario || "SISTEMA", numSerie: "---", codigo: "üì¶ REPOSICI√ìN", fecha: infoR.fecha, inicio: infoR.horaTexto, inicioMS: infoR.inicioMS, fin: horaFin, total: duracion, tipo: "reposicion", timestamp: Date.now() });
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "pausa_reposicion") { updates[`tareas/${id}/estado`] = "activo"; updates[`tareas/${id}/inicioMS`] = ahora; } });
    update(reposicionRef, { activa: false, inicioMS: 0 });
  }
  if (Object.keys(updates).length > 0) update(ref(db), updates);
};

window.toggleIncidencia = async function() {
  if (!lineaIniciada && !hayIncidenciaGlobal) { alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de reportar incidencias'); return; }
  const ahora = Date.now();
  const snapTareas = await fbGet(tareasRef);
  const tareas = snapTareas.val() || {};
  const updates = {};
  if (!hayIncidenciaGlobal) {
    const motivo = prompt("Motivo de la incidencia:");
    if (!motivo) return;
    await fbPush(incidenciasTextoRef, { descripcion: motivo.trim(), fecha: obtenerFecha(), timestamp: Date.now() });
    update(incidenciaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), motivo: motivo.trim(), operario: obtenerOperarioActual() });
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "activo") { updates[`tareas/${id}/estado`] = "pausa_incidencia"; updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + (ahora - tareas[id].inicioMS); } });
  } else {
    const snapI = await fbGet(incidenciaRef);
    const infoInc = snapI.val();
    const horaFin = new Date().toLocaleTimeString('es-ES');
    const duracion = Math.round((ahora - infoInc.inicioMS) / 60000) || 1;
    await fbPush(tareasHistorialRef, { operario: infoInc.operario || "SISTEMA", numSerie: "---", codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`, fecha: infoInc.fecha, inicio: infoInc.horaTexto, inicioMS: infoInc.inicioMS, fin: horaFin, total: duracion, tipo: "incidencia", timestamp: Date.now() });
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "pausa_incidencia") { updates[`tareas/${id}/estado`] = "activo"; updates[`tareas/${id}/inicioMS`] = ahora; } });
    update(incidenciaRef, { activa: false, inicioMS: 0 });
  }
  if (Object.keys(updates).length > 0) update(ref(db), updates);
};

let pausaEnProceso = false; // evitar doble click

window.togglePausa = async function() {
  if (pausaEnProceso) return;
  
  if (!lineaIniciada && !estaPausadoGlobal) { alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de tomar desayuno'); return; }
  
  // ===== VOLVER DEL DESAYUNO =====
  if (Object.keys(desayunosActivos).length > 0) {
    mostrarModalVolverDesayuno();
    return;
  }
  
  // ===== INICIAR DESAYUNO =====
  // Si solo hay 1 operario en l√≠nea ‚Üí ir directo
  if (operariosEnLinea.length <= 1) {
    pausaEnProceso = true;
    try {
      await iniciarDesayunoDirecto(operariosEnLinea.length === 1 ? [operariosEnLinea[0]] : [obtenerOperarioActual()]);
    } finally {
      pausaEnProceso = false;
    }
    return;
  }
  
  // Si hay 2 operarios ‚Üí mostrar modal para elegir
  document.getElementById('modalDesayuno').classList.remove('hidden');
  document.getElementById('chkAdrian').checked = false;
  document.getElementById('chkAitor').checked = false;
};

window.cerrarModalDesayuno = function() {
  document.getElementById('modalDesayuno').classList.add('hidden');
};

// ===== MODAL VOLVER DEL DESAYUNO =====
function mostrarModalVolverDesayuno() {
  const modal = document.getElementById('modalVolverDesayuno');
  const contenido = document.getElementById('volverDesayunoContenido');
  const operarios = Object.keys(desayunosActivos);
  contenido.innerHTML = '';
  operarios.forEach(nombre => {
    const esAdrian = nombre.includes('Adrian');
    const color = esAdrian ? 'blue' : 'red';
    const idChk  = esAdrian ? 'chkVolverAdrian' : 'chkVolverAitor';
    const checked = operarios.length === 1 ? 'checked' : '';
    contenido.innerHTML += `
      <label class="flex items-center gap-4 bg-${color}-50 border-2 border-${color}-200 p-5 rounded-2xl cursor-pointer hover:bg-${color}-100 transition-all">
        <input type="checkbox" id="${idChk}" ${checked} class="w-6 h-6 rounded-lg accent-${color}-600 cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <div class="text-4xl">‚òï</div>
          <div>
            <p class="font-black text-${color}-700 text-lg">${nombre}</p>
            <p class="text-xs text-${color}-400 font-bold uppercase">Vuelve al trabajo</p>
          </div>
        </div>
      </label>`;
  });
  modal.classList.remove('hidden');
}

window.cerrarModalVolverDesayuno = function() {
  document.getElementById('modalVolverDesayuno').classList.add('hidden');
};

window.confirmarVolverDesayuno = async function() {
  const chkAdrian = document.getElementById('chkVolverAdrian');
  const chkAitor  = document.getElementById('chkVolverAitor');
  const volverAdrian = chkAdrian ? chkAdrian.checked : false;
  const volverAitor  = chkAitor  ? chkAitor.checked  : false;
  if (!volverAdrian && !volverAitor) { alert('‚ö†Ô∏è Selecciona al menos un operario'); return; }
  cerrarModalVolverDesayuno();
  try {
    const ahora   = Date.now();
    const horaFin = new Date().toLocaleTimeString('es-ES');
    const quedanDesayunando = {};
    const updates = {};
    for (const [nombre, info] of Object.entries(desayunosActivos)) {
      const vuelve = (nombre.includes('Adrian') && volverAdrian) ||
                     (nombre.includes('Aitor')  && volverAitor);
      if (vuelve) {
        const duracion = Math.round((ahora - info.inicioMS) / 60000) || 1;
        await fbPush(tareasHistorialRef, {
          operario: nombre, numSerie: '---',
          codigo: `‚òï DESAYUNO (${nombre.split(' ')[0]})`,
          fecha: info.fecha, inicio: info.horaTexto, inicioMS: info.inicioMS,
          fin: horaFin, total: duracion, tipo: 'descanso', timestamp: Date.now()
        });
      } else {
        quedanDesayunando[nombre] = info;
      }
    }
    if (Object.keys(quedanDesayunando).length === 0) {
      if (tareasPausadasPorDesayuno) {
        const snapTareas = await fbGet(tareasRef);
        const tareas = snapTareas.val() || {};
        Object.keys(tareas).forEach(id => {
          if (tareas[id].estado === 'pausado_desayuno') {
            updates[`tareas/${id}/estado`]   = 'activo';
            updates[`tareas/${id}/inicioMS`] = ahora;
          }
        });
      }
      updates['estadoPausa'] = { activa: false };
    } else {
      const nuevoEstado = { activa: true, tareasPausadas: tareasPausadasPorDesayuno };
      for (const [nombre, info] of Object.entries(quedanDesayunando)) {
        nuevoEstado[nombre.replace(/\s/g, '_')] = info;
      }
      updates['estadoPausa'] = nuevoEstado;
    }
    await fbUpdate(ref(db), updates);
  } catch(e) { console.error('Error confirmarVolverDesayuno:', e); }
};

window.confirmarDesayuno = async function() {
  const adrian = document.getElementById('chkAdrian').checked;
  const aitor = document.getElementById('chkAitor').checked;
  if (!adrian && !aitor) { alert('‚ö†Ô∏è Selecciona al menos un operario'); return; }
  cerrarModalDesayuno();
  const seleccionados = [];
  if (adrian) seleccionados.push('Adrian Garc√≠a');
  if (aitor) seleccionados.push('Aitor Bautista');
  pausaEnProceso = true;
  try {
    await iniciarDesayunoDirecto(seleccionados);
  } finally {
    pausaEnProceso = false;
  }
};

async function iniciarDesayunoDirecto(operariosSeleccionados) {
  const ahora = Date.now();
  const horaTexto = new Date().toLocaleTimeString('es-ES');
  const fecha = obtenerFecha();
  
  const todosVan = operariosSeleccionados.length >= operariosEnLinea.length;
  
  const estadoDesayuno = { activa: true, tareasPausadas: todosVan };
  operariosSeleccionados.forEach(op => {
    estadoDesayuno[op.replace(/\s/g, '_')] = { inicioMS: ahora, horaTexto, fecha, operario: op };
  });
  
  await fbUpdate(ref(db), { estadoPausa: estadoDesayuno });
  
  if (todosVan) {
    const snapTareas = await fbGet(tareasRef);
    const tareas = snapTareas.val() || {};
    const updates = {};
    Object.keys(tareas).forEach(id => {
      if (tareas[id].estado === "activo") {
        updates[`tareas/${id}/estado`] = "pausado_desayuno";
        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + (ahora - tareas[id].inicioMS);
      }
    });
    if (Object.keys(updates).length > 0) await fbUpdate(ref(db), updates);
  }
}

async function finalizarTodosDesayunos() {
  const ahora = Date.now();
  const horaFin = new Date().toLocaleTimeString('es-ES');
  
  // Registrar cada operario que estaba desayunando en el historial
  for (const [nombre, info] of Object.entries(desayunosActivos)) {
    const duracion = Math.round((ahora - info.inicioMS) / 60000) || 1;
    await fbPush(tareasHistorialRef, {
      operario: nombre, numSerie: "---",
      codigo: `‚òï DESAYUNO (${nombre.split(' ')[0]})`,
      fecha: info.fecha, inicio: info.horaTexto, inicioMS: info.inicioMS,
      fin: horaFin, total: duracion, tipo: "descanso", timestamp: Date.now()
    });
  }
  
  // Reactivar tareas si estaban pausadas
  if (tareasPausadasPorDesayuno) {
    const snapTareas = await fbGet(tareasRef);
    const tareas = snapTareas.val() || {};
    const updates = {};
    Object.keys(tareas).forEach(id => {
      if (tareas[id].estado === "pausado_desayuno") {
        updates[`tareas/${id}/estado`] = "activo";
        updates[`tareas/${id}/inicioMS`] = ahora;
      }
    });
    if (Object.keys(updates).length > 0) await fbUpdate(ref(db), updates);
  }
  
  // Limpiar pausa por completo
  await fbUpdate(ref(db), { estadoPausa: { activa: false } });
}

window.registrarJornada = async (tipo) => {
  const esEntrada = tipo === 'INICIO';
  if (esEntrada && lineaIniciada) { alert('‚ö†Ô∏è ERROR: La l√≠nea ya est√° activa. No puedes registrar otra ENTRADA sin antes registrar una SALIDA.'); return; }
  if (!esEntrada && !lineaIniciada) { alert('‚ö†Ô∏è ERROR: La l√≠nea ya est√° parada. No puedes registrar SALIDA sin una ENTRADA previa.'); return; }
  if (esEntrada) {
    document.getElementById('chkEntradaAdrian').checked = false;
    document.getElementById('chkEntradaAitor').checked = false;
    document.getElementById('modalOperarios').classList.remove('hidden');
  } else {
    await ejecutarRegistroJornada('FIN', 0, []);
  }
};

window.confirmarEntradaConNombres = async function() {
  const adrian = document.getElementById('chkEntradaAdrian').checked;
  const aitor = document.getElementById('chkEntradaAitor').checked;
  if (!adrian && !aitor) { alert('‚ö†Ô∏è Selecciona al menos un operario'); return; }
  const seleccionados = [];
  if (adrian) seleccionados.push('Adrian Garc√≠a');
  if (aitor) seleccionados.push('Aitor Bautista');
  cerrarModalOperarios();
  await ejecutarRegistroJornada('INICIO', seleccionados.length, seleccionados);
};

window.confirmarEntradaOperarios = async function(numOperarios) {
  cerrarModalOperarios();
  await ejecutarRegistroJornada('INICIO', numOperarios, []);
};

window.cerrarModalOperarios = function() { document.getElementById('modalOperarios').classList.add('hidden'); };

async function ejecutarRegistroJornada(tipo, numOperarios, nombresOperarios) {
  const horaActual = new Date().toLocaleTimeString('es-ES');
  const fechaActual = obtenerFecha();
  const esEntrada = tipo === 'INICIO';
  const ahora = Date.now();

  if (esEntrada) {
    numOperariosActivos = numOperarios;
    operariosEnLinea = nombresOperarios || [];
    operarioLineaActiva = operariosEnLinea.join(' + ');
    lineaIniciada = true;
    actualizarDisplayOperario();
    await fbUpdate(estadoLineaRef, { activa: true, operario: operarioLineaActiva, operarios: operariosEnLinea, numOperarios, horaInicio: horaActual, fecha: fechaActual });
    const snapTareas = await fbGet(tareasRef);
    const tareas = snapTareas.val() || {};
    const updates = {};
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "pausa_salida_linea") { updates[`tareas/${id}/estado`] = "activo"; updates[`tareas/${id}/inicioMS`] = ahora; } });
    if (Object.keys(updates).length > 0) await fbUpdate(ref(db), updates);
  } else {
    const snapTareas = await fbGet(tareasRef);
    const tareas = snapTareas.val() || {};
    const updates = {};
    Object.keys(tareas).forEach(id => { if (tareas[id].estado === "activo") { updates[`tareas/${id}/estado`] = "pausa_salida_linea"; updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + (ahora - tareas[id].inicioMS); } });
    if (Object.keys(updates).length > 0) await fbUpdate(ref(db), updates);
    lineaIniciada = false;
    numOperariosActivos = 1;
    operarioLineaActiva = null;
    operariosEnLinea = [];
    actualizarDisplayOperario();
    await fbUpdate(estadoLineaRef, { activa: false, operario: null, operarios: [], numOperarios: 0 });
  }

  actualizarEstadoBotones();

  const operarioRegistro = esEntrada ? operariosEnLinea.join(' + ') : operarioLineaActiva || 'SISTEMA';
  const nombresCortos = esEntrada ? operariosEnLinea.map(n => n.split(' ')[0]).join(' + ') : '';

  await fbPush(tareasHistorialRef, {
    operario: operarioRegistro, numSerie: "---",
    codigo: esEntrada ? `üü¢ ENTRADA (${nombresCortos})` : "üî¥ SALIDA",
    fecha: fechaActual, inicio: horaActual, inicioMS: ahora,
    fin: "---", total: 0, tipo: "jornada",
    numOperarios: esEntrada ? numOperariosActivos : 0, timestamp: Date.now()
  });
}

function actualizarDisplayOperario() {
  const display = document.getElementById('displayOperario');
  if (!display) return;
  if (operariosEnLinea.length === 0) {
    display.textContent = 'Sin operarios';
    display.classList.remove('text-emerald-700', 'bg-emerald-50');
    display.classList.add('text-slate-400', 'bg-slate-50');
  } else if (operariosEnLinea.length === 1) {
    const color = operariosEnLinea[0] === 'Adrian Garc√≠a' ? 'blue' : 'red';
    display.textContent = operariosEnLinea[0];
    display.className = `p-4 rounded-xl font-bold border-none outline-none bg-${color}-50 text-${color}-700`;
  } else {
    display.textContent = operariosEnLinea.join(' + ');
    display.className = 'p-4 rounded-xl font-bold border-none outline-none bg-emerald-50 text-emerald-700';
  }
}

window.iniciarTarea = async function() {
  if (!lineaIniciada) { alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de iniciar tareas'); return; }
  const operario = operariosEnLinea.join(' + ');
  const serie = document.getElementById('numSerie').value.trim().toUpperCase();
  const cod = document.getElementById('codigo').value.trim().toUpperCase();
  if (!serie) { alert('‚ö†Ô∏è Introduce el N¬∫ de Serie'); document.getElementById('numSerie').focus(); return; }
  if (!cod) { alert('‚ö†Ô∏è Introduce el C√≥digo de Tarea'); document.getElementById('codigo').focus(); return; }

  const ahora = Date.now();
  const horaActual = new Date().toLocaleTimeString('es-ES');
  const fechaActual = obtenerFecha();

  const nuevaTarea = {
    operario, numSerie: serie, codigo: cod,
    fecha: fechaActual, inicio: horaActual, inicioMS: ahora,
    acumuladoMS: 0, estado: "activo", tipo: "produccion"
  };

  try {
    const tareaRef = await fbPush(tareasRef, nuevaTarea);
    if (!todasLasTareas) todasLasTareas = {};
    todasLasTareas[tareaRef.key] = { ...nuevaTarea, id: tareaRef.key, timestamp: ahora };
    actualizarTablaTareas();
  } catch (error) {
    alert('Error al guardar: ' + error.message);
    return;
  }

  document.getElementById('numSerie').value = '';
  document.getElementById('codigo').value = '';
  document.getElementById('numSerie').focus();
};

// ============================================
// ‚úÖ FIX 2 y 3: actualizarTablaTareas corregida
// ============================================
function actualizarTablaTareas() {
  const cuerpo = document.getElementById('cuerpoTabla');
  cuerpo.innerHTML = "";

  // Combinar: historial + activas, evitando duplicados
  // Si una tarea activa ya existe en el historial (por su id), prevalece el historial
  const idsHistorial = new Set(Object.keys(todasLasTareas || {}));
  
  const todasLasTareasCombinadas = {};
  
  // Primero a√±adir historial con nodo Firebase directo
  Object.entries(todasLasTareas || {}).forEach(([id, t]) => {
    todasLasTareasCombinadas[id] = { ...t, id, _nodo: 'historial_tareas' };
  });
  
  // Luego a√±adir activas SOLO si no est√°n ya en historial,
  // NO est√°n finalizadas, y NO est√°n en pausa_salida_linea (estado interno)
  Object.entries(tareasActivasTemp || {}).forEach(([id, t]) => {
    if (!idsHistorial.has(id) && t.estado !== 'finalizado' && t.estado !== 'pausa_salida_linea') {
      todasLasTareasCombinadas[id] = { ...t, id, _nodo: 'tareas' };
    }
  });

  if (Object.keys(todasLasTareasCombinadas).length === 0) {
    cuerpo.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400 italic">No hay tareas en el historial</td></tr>';
    return;
  }

  // ‚úÖ FIX: { ...t, id } garantiza que id (la key de Firebase) nunca es sobreescrito
  // ‚úÖ FIX: ordenar por inicioMS (m√°s reciente primero), con fallback a timestamp
  const tareasArray = Object.entries(todasLasTareasCombinadas)
    .map(([id, t]) => ({ ...t, id }))
    .sort((a, b) => (a.inicioMS || a.timestamp || 0) - (b.inicioMS || b.timestamp || 0));

  let tareasMostradas = 0;

  tareasArray.forEach(t => {
    // Aplicar filtro de fecha
    if (filtroFechaTablaActual && t.fecha !== filtroFechaTablaActual) return;

    tareasMostradas++;

    const activo = t.estado === "activo";
    let rowClass = "bg-white";
    let tiempoMostrado = "";

    if (t.tipo === 'jornada') {
      if (t.codigo && t.codigo.includes('ENTRADA')) {
        rowClass = "bg-green-100 border-l-4 border-green-500";
        tiempoMostrado = `<span class="text-green-700 font-black uppercase">üü¢ ENTRADA</span>`;
      } else if (t.codigo && t.codigo.includes('SALIDA')) {
        rowClass = "bg-red-100 border-l-4 border-red-500";
        tiempoMostrado = `<span class="text-red-700 font-black uppercase">üî¥ SALIDA</span>`;
      } else {
        rowClass = "bg-slate-50";
        tiempoMostrado = `<span class="text-slate-500 font-bold text-xs">REGISTRO</span>`;
      }
    } else if (activo) {
      rowClass = "bg-amber-50";
      tiempoMostrado = `<span class="contador-vivo text-amber-600 font-bold" data-inicio="${t.inicioMS}" data-acumulado="${t.acumuladoMS || 0}">...</span>`;
    } else if (t.estado === "pausa_manual") {
      rowClass = "bg-blue-50";
      tiempoMostrado = `<span class="text-blue-500 italic">‚è∏Ô∏è ${formatTime(t.acumuladoMS)}</span>`;
    } else if (t.estado === "pausa_salida_linea") {
      rowClass = "bg-purple-50";
      tiempoMostrado = `<span class="text-purple-500 italic">üö™ L√≠nea Parada</span>`;
    } else if (t.estado === "pausado_desayuno") {
      rowClass = "bg-orange-50 border-l-4 border-orange-400";
      tiempoMostrado = `<span class="text-orange-600 font-bold uppercase">‚òï DESAYUNO</span>`;
    } else if (t.estado === "pausa_incidencia") {
      rowClass = "bg-red-50 border-l-4 border-red-600";
      tiempoMostrado = `<span class="text-red-600 font-black uppercase animate-pulse">üõ†Ô∏è INCIDENCIA</span>`;
    } else if (t.estado === "pausa_reposicion") {
      rowClass = "bg-violet-100 border-l-4 border-violet-500";
      tiempoMostrado = `<span class="text-violet-700 font-bold uppercase">üì¶ REPOSICI√ìN</span>`;
    } else if (t.tipo === 'reposicion') {
      rowClass = "bg-violet-50";
      tiempoMostrado = `<span class="text-violet-600 font-bold">${t.total} min</span>`;
    } else if (t.tipo === 'incidencia') {
      rowClass = "bg-red-50";
      tiempoMostrado = `<span class="text-red-600 font-bold">${t.total} min</span>`;
    } else if (t.tipo === 'descanso') {
      rowClass = "bg-orange-50";
      tiempoMostrado = `<span class="text-orange-600 font-bold">${t.total} min</span>`;
    } else {
      tiempoMostrado = `<span class="text-slate-700 font-bold">${t.total} min</span>`;
    }

    const estaEnPausa = t.estado && t.estado.startsWith('pausa_');

    cuerpo.innerHTML += `
      <tr class="${rowClass} border-b border-slate-100 transition-all">
        <td class="p-4 font-bold text-slate-700">${t.operario}</td>
        <td class="p-4 text-slate-600 font-medium">${t.fecha || '-'}</td>
        <td class="p-4 font-mono text-slate-500">${t.numSerie}</td>
        <td class="p-4 font-bold text-slate-800">${t.codigo}</td>
        <td class="p-4 font-mono text-[10px] text-slate-400">${t.inicio}</td>
        <td class="p-4 font-mono text-[10px] text-slate-400">${t.fin || '--:--'}</td>
        <td class="p-4 font-black text-center">${tiempoMostrado}</td>
        <td class="p-4 text-right flex justify-end gap-2">
          ${activo ? `<button onclick="finalizarTarea('${t.id}')" class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">Fin</button>` : (estaEnPausa ? '‚è∏Ô∏è' : '‚úì')}
          <button onclick="borrarTarea('${t.id}', '${t._nodo}')" class="text-slate-300 hover:text-red-500 ml-2" title="Borrar tarea">üóëÔ∏è</button>
        </td>
      </tr>`;
  });

  if (tareasMostradas === 0 && Object.keys(desayunosActivos).length === 0) {
    cuerpo.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-400 italic">
      ${filtroFechaTablaActual ? `No hay tareas para la fecha ${filtroFechaTablaActual}` : 'No hay tareas'}
    </td></tr>`;
  }

  // A√±adir filas en vivo de operarios desayunando (al final de la tabla, visibles siempre)
  Object.entries(desayunosActivos).forEach(([nombre, info]) => {
    const colorOp = nombre === 'Adrian Garc√≠a' ? 'blue' : 'red';
    cuerpo.innerHTML += `
      <tr class="bg-orange-50 border-l-4 border-orange-400 border-b border-slate-100 transition-all animate-pulse">
        <td class="p-4 font-bold text-${colorOp}-700">${nombre}</td>
        <td class="p-4 text-slate-600 font-medium">${info.fecha || '-'}</td>
        <td class="p-4 font-mono text-slate-500">---</td>
        <td class="p-4 font-bold text-orange-700">‚òï DESAYUNANDO</td>
        <td class="p-4 font-mono text-[10px] text-slate-400">${info.horaTexto}</td>
        <td class="p-4 font-mono text-[10px] text-slate-400">--:--</td>
        <td class="p-4 font-black text-center"><span class="contador-desayuno text-orange-600 font-bold" data-inicio="${info.inicioMS}">...</span></td>
        <td class="p-4 text-right">‚òï</td>
      </tr>`;
  });
}

window.agregarMantenimiento = async function() {
  const descripcion = prompt("Descripci√≥n de la tarea de mantenimiento:");
  if (!descripcion || !descripcion.trim()) return;
  await fbPush(mantenimientoRef, { descripcion: descripcion.trim(), fecha: obtenerFecha(), completada: false, timestamp: Date.now() });
};

window.completarMantenimiento = async function(id) {
  if (!confirm('¬øMarcar tarea como realizada?')) return;
  await fbUpdate(ref(db, `tareas_mantenimiento/${id}`), { completada: true, fechaCompletada: obtenerFecha(), horaCompletada: new Date().toLocaleTimeString('es-ES') });
};

window.borrarMantenimiento = async function(id) {
  if (!confirm('¬øEliminar esta tarea de mantenimiento?')) return;
  await remove(ref(db, `tareas_mantenimiento/${id}`));
};

window.borrarIncidenciaTexto = async function(id) {
  if (!confirm('¬øEliminar esta incidencia?')) return;
  await remove(ref(db, `incidencias_texto/${id}`));
};

onValue(mantenimientoRef, (snapshot) => {
  const cuerpo = document.getElementById('cuerpoMantenimiento');
  cuerpo.innerHTML = "";
  const datos = snapshot.val();
  if (!datos) { cuerpo.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">No hay tareas de mantenimiento</td></tr>'; return; }
  const pendientes = [], completadas = [];
  Object.keys(datos).forEach(id => { const t = datos[id]; (t.completada ? completadas : pendientes).push({ id, ...t }); });
  pendientes.sort((a, b) => b.timestamp - a.timestamp);
  completadas.sort((a, b) => b.timestamp - a.timestamp);
  pendientes.forEach(t => {
    cuerpo.innerHTML += `<tr class="bg-white border-b border-slate-100 hover:bg-blue-50 transition-all">
      <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
      <td class="p-4 text-slate-800 font-semibold"><span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>${t.descripcion}</span></td>
      <td class="p-4 text-right flex justify-end gap-2">
        <button onclick="completarMantenimiento('${t.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase shadow-sm transition-colors">‚úì Realizada</button>
        <button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
      </td></tr>`;
  });
  completadas.forEach(t => {
    cuerpo.innerHTML += `<tr class="bg-green-50 border-b border-slate-100 opacity-60">
      <td class="p-4 text-slate-500 font-medium text-sm line-through">${t.fecha}</td>
      <td class="p-4 text-slate-600 font-semibold line-through"><span class="inline-flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span>${t.descripcion}</span><div class="text-xs text-green-600 mt-1">‚úì Completada el ${t.fechaCompletada} a las ${t.horaCompletada}</div></td>
      <td class="p-4 text-right"><button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button></td></tr>`;
  });
});

let datosIncidenciasGlobal = {};

onValue(incidenciasTextoRef, (snapshot) => {
  datosIncidenciasGlobal = snapshot.val() || {};
  renderizarIncidencias();
});

function renderizarIncidencias() {
  const cuerpo = document.getElementById('cuerpoIncidencias');
  cuerpo.innerHTML = "";
  const datos = datosIncidenciasGlobal;
  if (!datos || Object.keys(datos).length === 0) { cuerpo.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">No hay incidencias registradas</td></tr>'; return; }
  
  const filtroMes = document.getElementById('filtroMesIncidencias').value;
  let arr = Object.keys(datos).map(id => ({ id, ...datos[id] })).sort((a, b) => b.timestamp - a.timestamp);
  
  if (filtroMes) {
    const [anioF, mesF] = filtroMes.split('-').map(Number);
    arr = arr.filter(t => {
      if (!t.fecha) return false;
      const partes = t.fecha.split('/');
      if (partes.length < 3) return false;
      return parseInt(partes[1]) === mesF && parseInt(partes[2]) === anioF;
    });
  }
  
  if (arr.length === 0) { cuerpo.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">No hay incidencias en este mes</td></tr>'; return; }
  
  arr.forEach(t => {
    cuerpo.innerHTML += `<tr class="bg-white border-b border-slate-100 hover:bg-red-50 transition-all">
      <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
      <td class="p-4 text-slate-800 font-semibold">${t.descripcion}</td>
      <td class="p-4 text-right"><button onclick="borrarIncidenciaTexto('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors" title="Borrar incidencia">üóëÔ∏è</button></td></tr>`;
  });
}

window.filtrarIncidenciasPorMes = function() { renderizarIncidencias(); };

// ============================================
// LISTENER HISTORIAL ‚Äî actualiza gr√°ficos y tabla
// ============================================
onValue(tareasHistorialRef, (snapshot) => {
  const datos = snapshot.val() || {};
  todasLasTareas = datos;

  if (primeraVez) {
    const hoy = new Date();
    const anio = hoy.getFullYear();
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const dia = String(hoy.getDate()).padStart(2, '0');
    const inputFecha = document.getElementById('filtroFecha');
    if (inputFecha) inputFecha.value = `${anio}-${mes}-${dia}`;
    const inputMes = document.getElementById('filtroMesProductividadDiaria');
    if (inputMes) inputMes.value = `${anio}-${mes}`;
    const inputAnio = document.getElementById('selectAnioProductividadMensual');
    if (inputAnio) inputAnio.value = anio.toString();
    const inputFechaTabla = document.getElementById('filtroFechaTabla');
    if (inputFechaTabla) {
      inputFechaTabla.value = `${anio}-${mes}-${dia}`;
      filtroFechaTablaActual = `${dia}/${mes}/${anio}`;
    }
    primeraVez = false;
  }

  const fechaInput = document.getElementById('filtroFecha').value;
  const fechaFiltro = fechaInput ? convertirFechaHTML(fechaInput) : null;
  actualizarGraficoPuntos(fechaFiltro);
  actualizarGraficoProductividadDiaria();
  actualizarGraficoProductividadMensual();
  actualizarTablaTareas();
});

// Listener tareas activas
onValue(tareasRef, (snapshot) => {
  tareasActivasTemp = snapshot.val() || {};
  actualizarTablaTareas();
});

onValue(incidenciaRef, s => {
  const d = s.val();
  hayIncidenciaGlobal = d?.activa;
  inicioIncidenciaMS = d?.inicioMS;
  document.getElementById('btnIncidencia').innerHTML = hayIncidenciaGlobal ? "üõ†Ô∏è SOLUCIONAR" : "üö® INCIDENCIA";
  document.getElementById('cajaIncidencia').classList.toggle('hidden', !hayIncidenciaGlobal);
});

onValue(pausaRef, s => {
  const d = s.val();
  desayunosActivos = {};
  tareasPausadasPorDesayuno = false;
  
  if (d && d.activa === true) {
    if (d['Adrian_Garc√≠a'] && d['Adrian_Garc√≠a'].inicioMS) {
      desayunosActivos['Adrian Garc√≠a'] = d['Adrian_Garc√≠a'];
    }
    if (d['Aitor_Bautista'] && d['Aitor_Bautista'].inicioMS) {
      desayunosActivos['Aitor Bautista'] = d['Aitor_Bautista'];
    }
    tareasPausadasPorDesayuno = d.tareasPausadas || false;
  }
  
  const numDesayunando = Object.keys(desayunosActivos).length;
  estaPausadoGlobal = numDesayunando > 0;
  
  if (numDesayunando > 0) {
    inicioPausaMS = Math.min(...Object.values(desayunosActivos).map(i => i.inicioMS));
  }
  
  const btnPausa = document.getElementById('btnPausa');
  const cajaDesayuno = document.getElementById('cajaDesayuno');
  
  if (numDesayunando > 0) {
    const nombres = Object.keys(desayunosActivos).map(n => n.split(' ')[0]).join(' + ');
    btnPausa.innerHTML = `‚òï VOLVER (${nombres})`;
    cajaDesayuno.classList.remove('hidden');
  } else {
    btnPausa.innerHTML = "ü•ê DESAYUNO";
    cajaDesayuno.classList.add('hidden');
  }
  
  // Refrescar tabla para mostrar/ocultar filas de desayuno
  actualizarTablaTareas();
  actualizarEstadoBotones();
});

onValue(reposicionRef, s => {
  const d = s.val();
  hayReposicionGlobal = d?.activa;
  inicioReposicionMS = d?.inicioMS;
  document.getElementById('btnReposicion').innerHTML = hayReposicionGlobal ? "üì¶ LISTO" : "üì¶ REPOSICI√ìN";
  document.getElementById('cajaReposicion').classList.toggle('hidden', !hayReposicionGlobal);
});

onValue(estadoLineaRef, s => {
  const d = s.val();
  if (d) {
    lineaIniciada = d.activa || false;
    operarioLineaActiva = d.operario || null;
    numOperariosActivos = d.numOperarios || 1;
    operariosEnLinea = d.operarios || [];
    // Fallback: si no hay array operarios pero s√≠ hay operario string, reconstruir
    if (operariosEnLinea.length === 0 && operarioLineaActiva) {
      operariosEnLinea = operarioLineaActiva.split(' + ').map(s => s.trim()).filter(Boolean);
    }
  } else {
    lineaIniciada = false;
    operarioLineaActiva = null;
    numOperariosActivos = 1;
    operariosEnLinea = [];
  }
  actualizarDisplayOperario();
  actualizarEstadoBotones();
});


// ‚úÖ Limpieza autom√°tica: eliminar de tareasRef las tareas con estado "finalizado"
// Son residuos del sistema anterior que causan duplicados en la tabla
async function limpiarTareasFinalizadas() {
  const snap = await fbGet(tareasRef);
  const tareas = snap.val() || {};
  for (const [id, t] of Object.entries(tareas)) {
    if (t.estado === 'finalizado' || t.tipo === 'jornada') {
      await remove(ref(db, `tareas/${id}`));
    }
  }
}

// Limpiar tareas finalizadas legacy al arrancar
limpiarTareasFinalizadas();

get(estadoLineaRef).then(snapshot => {
  if (!snapshot.exists()) {
    get(tareasRef).then(tareasSnap => {
      const tareas = tareasSnap.val();
      if (tareas) {
        let ultimaEntrada = null, hayEntradaSinSalida = false;
        Object.values(tareas).forEach(t => {
          if (t.tipo === 'jornada') {
            if (t.codigo && t.codigo.includes('ENTRADA')) { ultimaEntrada = t; hayEntradaSinSalida = true; }
            else if (t.codigo && t.codigo.includes('SALIDA')) hayEntradaSinSalida = false;
          }
        });
        if (hayEntradaSinSalida && ultimaEntrada) {
          const ops = ultimaEntrada.operario ? ultimaEntrada.operario.split(' + ').map(s => s.trim()).filter(Boolean) : [];
          const numOp = ops.length || 1;
          update(estadoLineaRef, { activa: true, operario: ultimaEntrada.operario, operarios: ops, numOperarios: numOp, horaInicio: ultimaEntrada.inicio, fecha: ultimaEntrada.fecha });
        }
      }
    });
  }
});

window.handleKeyPress = (e, nextId) => {
  if (e.key === 'Enter') { e.preventDefault(); if (nextId) document.getElementById(nextId).focus(); else window.iniciarTarea(); }
};

window.filtrarTablaPorFecha = function() {
  const fechaInput = document.getElementById('filtroFechaTabla').value;
  if (!fechaInput) {
    filtroFechaTablaActual = null;
  } else {
    const [anio, mes, dia] = fechaInput.split('-');
    filtroFechaTablaActual = `${dia}/${mes}/${anio}`;
  }
  // ‚úÖ Sincronizar filtro del gr√°fico con el de la tabla
  const filtroFecha = document.getElementById('filtroFecha');
  if (filtroFecha) filtroFecha.value = fechaInput || '';
  actualizarTablaTareas();
  actualizarGraficoPuntos(filtroFechaTablaActual);
};

window.exportarExcel = async () => {
  const fechaInicio = prompt('üìÖ Fecha de inicio (DD/MM/YYYY):');
  if (!fechaInicio) return;
  const fechaFin = prompt('üìÖ Fecha de fin (DD/MM/YYYY):');
  if (!fechaFin) return;
  const snapshot = await fbGet(tareasHistorialRef);
  const datos = snapshot.val();
  if (!datos) { alert('‚ùå No hay datos para exportar'); return; }
  const datosFiltrados = Object.values(datos).filter(tarea => {
    if (!tarea.fecha) return false;
    const fechaTarea = parsearFecha(tarea.fecha);
    const inicio = parsearFecha(fechaInicio);
    const fin = parsearFecha(fechaFin);
    if (!fechaTarea || !inicio || !fin) return false;
    return fechaTarea >= inicio && fechaTarea <= fin;
  });
  if (datosFiltrados.length === 0) { alert('‚ùå No hay datos en el rango seleccionado'); return; }
  const datosExcel = datosFiltrados.map(t => ({
    'Operario': t.operario, 'Fecha': t.fecha, 'Serie': t.numSerie || '---',
    'Tarea': t.codigo, 'Hora Inicio': t.inicio, 'Hora Fin': t.fin || '---',
    'Tiempo (min)': t.total || '---', 'Tipo': t.tipo
  }));
  const ws = XLSX.utils.json_to_sheet(datosExcel);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Producci√≥n");
  XLSX.writeFile(wb, `Dosmart_Produccion_${fechaInicio.replace(/\//g, '-')}_${fechaFin.replace(/\//g, '-')}.xlsx`);
  alert(`‚úÖ Exportados ${datosFiltrados.length} registros`);
};
</script>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">



<div id="modalEliminar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
    <h3 class="text-xl font-black uppercase italic text-slate-800 mb-4">üóëÔ∏è Eliminar del Historial</h3>
    <div id="infoTareaEliminar" class="bg-slate-50 rounded-xl p-4 mb-6 text-sm"></div>
    <div class="flex gap-3">
      <button onclick="cerrarModalEliminar()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">Cancelar</button>
      <button id="btnConfirmarEliminar" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold uppercase transition-colors">Eliminar Permanentemente</button>
    </div>
  </div>
</div>

<div id="modalOperarios" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 transform transition-all">
    <h3 class="text-2xl font-black uppercase italic text-slate-800 mb-2 text-center">‚òÄÔ∏è Registro de Entrada</h3>
    <p class="text-slate-600 text-center mb-8">¬øQui√©n va a trabajar hoy?</p>
    <div class="space-y-4 mb-8">
      <label class="flex items-center gap-4 bg-blue-50 border-2 border-blue-200 p-5 rounded-2xl cursor-pointer hover:bg-blue-100 transition-all">
        <input type="checkbox" id="chkEntradaAdrian" class="w-6 h-6 rounded-lg text-blue-600 focus:ring-blue-400 accent-blue-600 cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <div class="text-4xl">üë§</div>
          <div>
            <p class="font-black text-blue-700 text-lg">Adrian Garc√≠a</p>
            <p class="text-xs text-blue-400 font-bold uppercase">Operario 1</p>
          </div>
        </div>
      </label>
      <label class="flex items-center gap-4 bg-red-50 border-2 border-red-200 p-5 rounded-2xl cursor-pointer hover:bg-red-100 transition-all">
        <input type="checkbox" id="chkEntradaAitor" class="w-6 h-6 rounded-lg text-red-600 focus:ring-red-400 accent-red-600 cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <div class="text-4xl">üë§</div>
          <div>
            <p class="font-black text-red-700 text-lg">Aitor Bautista</p>
            <p class="text-xs text-red-400 font-bold uppercase">Operario 2</p>
          </div>
        </div>
      </label>
    </div>
    <div class="flex gap-3">
      <button onclick="cerrarModalOperarios()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">Cancelar</button>
      <button onclick="confirmarEntradaConNombres()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-black uppercase transition-colors shadow-lg">‚òÄÔ∏è Confirmar Entrada</button>
    </div>
  </div>
</div>

<!-- Modal Volver del Desayuno -->
<div id="modalVolverDesayuno" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
    <h3 class="text-2xl font-black uppercase italic text-slate-800 mb-2 text-center">‚úÖ Vuelta del Desayuno</h3>
    <p class="text-slate-600 text-center mb-8">¬øQui√©n ha vuelto a incorporarse?</p>
    <div id="volverDesayunoContenido" class="space-y-4 mb-8"></div>
    <div class="flex gap-3">
      <button onclick="cerrarModalVolverDesayuno()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">Cancelar</button>
      <button onclick="confirmarVolverDesayuno()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-black uppercase transition-colors shadow-lg">‚úÖ Confirmar Vuelta</button>
    </div>
  </div>
</div>

<!-- Modal Seleccionar Operarios para Desayuno -->
<div id="modalDesayuno" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 transform transition-all">
    <h3 class="text-2xl font-black uppercase italic text-slate-800 mb-2 text-center">‚òï Desayuno</h3>
    <p class="text-slate-600 text-center mb-8">¬øQui√©n se va a desayunar?</p>
    <div class="space-y-4 mb-8">
      <label class="flex items-center gap-4 bg-blue-50 border-2 border-blue-200 p-5 rounded-2xl cursor-pointer hover:bg-blue-100 transition-all group">
        <input type="checkbox" id="chkAdrian" class="w-6 h-6 rounded-lg text-blue-600 focus:ring-blue-400 accent-blue-600 cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <div class="text-4xl">üë§</div>
          <div>
            <p class="font-black text-blue-700 text-lg">Adrian Garc√≠a</p>
            <p class="text-xs text-blue-400 font-bold uppercase">Operario 1</p>
          </div>
        </div>
      </label>
      <label class="flex items-center gap-4 bg-red-50 border-2 border-red-200 p-5 rounded-2xl cursor-pointer hover:bg-red-100 transition-all group">
        <input type="checkbox" id="chkAitor" class="w-6 h-6 rounded-lg text-red-600 focus:ring-red-400 accent-red-600 cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <div class="text-4xl">üë§</div>
          <div>
            <p class="font-black text-red-700 text-lg">Aitor Bautista</p>
            <p class="text-xs text-red-400 font-bold uppercase">Operario 2</p>
          </div>
        </div>
      </label>
    </div>
    <p class="text-xs text-slate-400 text-center mb-6 bg-amber-50 p-3 rounded-xl border border-amber-200">
      <span class="font-bold text-amber-600">‚ÑπÔ∏è Nota:</span> Si se van los dos, las tareas activas se pausar√°n. Si solo va uno, las tareas contin√∫an activas.
    </p>
    <div class="flex gap-3">
      <button onclick="cerrarModalDesayuno()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">Cancelar</button>
      <button onclick="confirmarDesayuno()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-black uppercase transition-colors shadow-lg">‚òï Confirmar Desayuno</button>
    </div>
  </div>
</div>



<div class="max-w-7xl mx-auto">
  <div class="flex justify-between items-center mb-4">
    <a href="index.html" class="bg-white hover:bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs uppercase transition-colors flex items-center gap-1 shadow-sm">‚Üê Volver</a>
    <div class="flex items-center gap-3">
      <button id="btnDesconectar" onclick="toggleFirebase()" class="bg-white hover:bg-slate-100 text-slate-500 px-3 py-2 rounded-xl text-[10px] font-bold uppercase shadow-sm transition-colors border border-slate-200">üîå Desconectar</button>
      <div id="firebaseIndicator" class="flex items-center gap-2 bg-white px-4 py-2 rounded-xl shadow-sm">
        <div class="relative">
          <div id="firebaseLed" class="w-3 h-3 rounded-full bg-gray-400"></div>
          <div id="firebaseLedPulse" class="absolute top-0 left-0 w-3 h-3 rounded-full bg-green-500 opacity-0 animate-ping"></div>
        </div>
        <span id="firebaseStatus" class="text-xs font-bold text-slate-600">Conectando...</span>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h1 class="text-4xl font-black uppercase italic tracking-tighter">Dostec AC <span class="text-amber-500">Production</span></h1>
      <div class="flex flex-wrap justify-center gap-3">
        <div id="cajaIncidencia" class="hidden bg-red-100 p-2 rounded-xl text-right"><span id="tiempoIncidencia" class="font-mono font-bold text-red-700"></span></div>
        <div id="cajaDesayuno" class="hidden bg-orange-100 p-2 px-4 rounded-xl text-right"><span id="tiempoDesayuno" class="font-mono font-bold text-orange-700 text-xs"></span></div>
        <div id="cajaReposicion" class="hidden bg-yellow-100 p-2 rounded-xl text-right"><span id="tiempoReposicion" class="font-mono font-bold text-yellow-700"></span></div>
        <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-rose-100 text-rose-600 px-4 py-2 rounded-xl font-bold text-xs"></button>
        <button id="btnReposicion" onclick="toggleReposicion()" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-yellow-500 transition-colors"></button>
        <button id="btnPausa" onclick="togglePausa()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs"></button>
        <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase">Exportar a Excel</button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-4 mb-6">
    <button id="btnEntrada" onclick="registrarJornada('INICIO')" class="bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-emerald-600 transition-colors">‚òÄÔ∏è Entrada</button>
    <button id="btnSalida" onclick="registrarJornada('FIN')" class="bg-rose-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-rose-600 transition-colors opacity-50 cursor-not-allowed" disabled>üåô Salida</button>
  </div>

  <div class="bg-white rounded-[2rem] shadow-xl p-6 mb-8 border-b-4 border-amber-400 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="flex flex-col">
      <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Operario(s) en L√≠nea</label>
      <div id="displayOperario" class="p-4 rounded-xl font-bold border-none outline-none bg-slate-50 text-slate-400">Sin operarios</div>
    </div>
    <div class="flex flex-col">
      <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">N¬∫ Serie</label>
      <input id="numSerie" type="text" onkeypress="handleKeyPress(event, 'codigo')" oninput="this.value = this.value.toUpperCase()" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
    </div>
    <div class="flex flex-col">
      <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Tarea</label>
      <input id="codigo" type="text" onkeypress="handleKeyPress(event, null)" oninput="this.value = this.value.toUpperCase()" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
    </div>
    <button id="btnIniciarTarea" onclick="iniciarTarea()" class="bg-amber-400 text-slate-900 font-black rounded-xl h-[56px] mt-5 hover:bg-slate-900 hover:text-white transition-all uppercase italic disabled:opacity-50 disabled:cursor-not-allowed">Iniciar</button>
  </div>

  <div id="indicadorLinea" class="flex justify-center mb-6">
    <span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>
  </div>

  <!-- TABLA DE TAREAS -->
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200 mb-8">
    <div class="bg-slate-900 p-4 flex justify-between items-center">
      <h3 class="text-amber-400 font-black uppercase text-sm">Tabla de Tareas</h3>
      <div class="flex items-center gap-3">
        <input type="date" id="filtroFechaTabla" onchange="filtrarTablaPorFecha()" class="bg-slate-700 text-white border border-slate-600 rounded-lg px-3 py-1.5 text-xs font-bold focus:outline-none focus:ring-2 focus:ring-amber-400">
      </div>
    </div>
    <table id="tablaProduccion" class="w-full text-left">
      <thead class="bg-slate-800 text-amber-400 text-[10px] font-black uppercase">
        <tr>
          <th class="p-4">Operario</th>
          <th class="p-4">Fecha</th>
          <th class="p-4">Serie</th>
          <th class="p-4">Tarea</th>
          <th class="p-4">H. Inicio</th>
          <th class="p-4">H. Fin</th>
          <th class="p-4 text-center">Tiempo</th>
          <th class="p-4 text-right">Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla" class="divide-y divide-slate-100"></tbody>
    </table>
  </div>

  <div class="flex justify-end mb-6">
    <button onclick="forzarParadaLinea()" id="btnForzarParada" class="bg-slate-700 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl font-black text-xs uppercase shadow flex items-center gap-2 transition-colors">‚õî Forzar Parada de L√≠nea</button>
  </div>

  <!-- GR√ÅFICO 1: Tiempo por Tarea -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div>
        <h2 class="text-2xl font-black uppercase italic text-slate-800">Tiempo por Tarea Individual</h2>
        <p class="text-xs text-slate-500 mt-1">Cada punto = una tarea | Eje Y = tiempo en minutos</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
          <label class="text-xs font-bold text-slate-500 uppercase">üìÖ Fecha:</label>
          <input type="date" id="filtroFecha" onchange="filtrarPorFecha()" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
        </div>

      </div>
    </div>
    <div class="h-96 w-full"><canvas id="graficoTareas"></canvas></div>
    <div class="flex justify-between items-center mt-4">
      <div class="flex justify-center gap-8">
        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-blue-500"></div><span class="font-bold text-slate-700">Adrian Garc√≠a</span></div>
        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-500"></div><span class="font-bold text-slate-700">Aitor Bautista</span></div>
        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full" style="background:linear-gradient(90deg, #3b82f6 50%, #ef4444 50%)"></div><span class="font-bold text-slate-700">Ambos</span></div>
      </div>
      <div id="contadorTareas" class="text-sm font-bold text-slate-500 bg-slate-100 px-4 py-2 rounded-lg">Cargando...</div>
    </div>
  </div>

  <!-- GR√ÅFICO 2: Productividad Diaria -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div>
        <h2 class="text-2xl font-black uppercase italic text-slate-800">üìä Productividad Diaria</h2>
        <p class="text-xs text-slate-500 mt-1">F√≥rmula: (Tareas √ó 7) / (Horas √ó N¬∫ Operarios)</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
          <label class="text-xs font-bold text-slate-500 uppercase">üìÖ Mes:</label>
          <input type="month" id="filtroMesProductividadDiaria" onchange="cambiarMesProductividadDiaria()" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
        </div>

      </div>
    </div>
    <div class="h-96 w-full"><canvas id="graficoProductividadDiaria"></canvas></div>
    <div class="flex justify-between items-center mt-4 bg-slate-50 p-4 rounded-xl">
      <div class="flex justify-center gap-8">
        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-blue-500"></div><span class="font-bold text-slate-700">Productividad</span></div>
        <div class="flex items-center gap-2"><div class="w-8 h-1 bg-yellow-400 border-2 border-yellow-400 border-dashed"></div><span class="font-bold text-slate-700">Media</span></div>
      </div>
      <div class="text-right">
        <div id="mediaProductividadDiaria" class="text-lg font-black text-amber-500">Media del mes: 0.00</div>
        <div id="diasConDatosDiaria" class="text-xs font-bold text-slate-500">D√≠as con datos: 0</div>
      </div>
    </div>
  </div>

  <!-- GR√ÅFICO 3: Productividad Mensual -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div>
        <h2 class="text-2xl font-black uppercase italic text-slate-800">üìà Productividad Mensual</h2>
        <p class="text-xs text-slate-500 mt-1">Media de productividad de cada mes</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
          <label class="text-xs font-bold text-slate-500 uppercase">A√±o:</label>
          <select id="selectAnioProductividadMensual" onchange="cambiarAnioProductividadMensual()" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
        </div>

      </div>
    </div>
    <div class="h-96 w-full"><canvas id="graficoProductividadMensual"></canvas></div>
    <div class="flex justify-between items-center mt-4 bg-slate-50 p-4 rounded-xl">
      <div class="flex justify-center gap-6">
        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-blue-500"></div><span class="font-bold text-slate-700 text-sm">Productividad</span></div>
        <div class="flex items-center gap-2"><div class="w-8 h-1 bg-yellow-400 border-2 border-yellow-400 border-dashed"></div><span class="font-bold text-slate-700 text-sm">Media</span></div>
        <div class="flex items-center gap-2"><div class="w-8 h-1 bg-gradient-to-r from-green-500 to-red-500"></div><span class="font-bold text-slate-700 text-sm">Tendencia</span></div>
      </div>
      <div class="text-right">
        <div id="mediaProductividadAnual" class="text-lg font-black text-amber-500">Media del a√±o: 0.00</div>
        <div id="mesesConDatos" class="text-xs font-bold text-slate-500">Meses con datos: 0</div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-blue-200">
      <div class="bg-blue-500 p-4 flex items-center justify-between">
        <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">üîß Mantenimiento</h3>
        <button onclick="agregarMantenimiento()" class="bg-white text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg font-black text-xs uppercase shadow-sm transition-colors flex items-center gap-1">+ A√±adir tarea</button>
      </div>
      <div class="max-h-96 overflow-y-auto">
        <table class="w-full text-left">
          <thead class="bg-blue-100 text-blue-800 text-[10px] font-black uppercase sticky top-0">
            <tr><th class="p-4 w-32">Fecha</th><th class="p-4">Descripci√≥n</th><th class="p-4 text-right w-40">Estado</th></tr>
          </thead>
          <tbody id="cuerpoMantenimiento" class="divide-y divide-slate-100">
            <tr><td colspan="3" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-orange-200">
      <div class="bg-orange-500 p-4 flex items-center justify-between">
        <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">‚ö†Ô∏è Registro de Incidencias</h3>
        <input type="month" id="filtroMesIncidencias" onchange="filtrarIncidenciasPorMes()" class="bg-orange-400 text-white border border-orange-300 rounded-lg px-2 py-1 text-xs font-bold focus:outline-none focus:ring-2 focus:ring-white placeholder-orange-200">
      </div>
      <div class="max-h-96 overflow-y-auto">
        <table class="w-full text-left">
          <thead class="bg-orange-100 text-orange-800 text-[10px] font-black uppercase sticky top-0">
            <tr><th class="p-4 w-32">Fecha</th><th class="p-4">Motivo</th><th class="p-4 text-right w-16">Borrar</th></tr>
          </thead>
          <tbody id="cuerpoIncidencias" class="divide-y divide-slate-100">
            <tr><td colspan="3" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</body>
</html>