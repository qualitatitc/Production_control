<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Central â€” ITC Production Systems</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
<style>
  body { font-family:'Inter',sans-serif; }
  @keyframes pulse-soft { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.5)}50%{box-shadow:0 0 0 6px rgba(16,185,129,0)} }
  .led-on { animation:pulse-soft 2s infinite; }
  .drop-zone { transition:all .2s; }
  .drop-zone.drag-over { background:#f0fdf4;border-color:#16a34a;transform:scale(1.01); }
  .day-tab { transition:all .15s;cursor:pointer; }
  .day-tab.active { background:#1e293b!important;color:#fff!important;border-color:#1e293b!important; }
  .mod-card { transition:all .2s;cursor:pointer; }
  .mod-card:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.1); }
  .row-agitador  { border-left:4px solid #10b981; }
  .row-dostec40  { border-left:4px solid #ef4444; }
  .row-dostec50  { border-left:4px solid #f97316; }
  .row-restyling { border-left:4px solid #0ea5e9; }
  .row-unknown   { border-left:4px solid #94a3b8; }

  /* â”€â”€ DRAG & DROP CALENDARIOS â”€â”€ */
  .pedido-pill {
    cursor: grab;
    transition: opacity .15s, transform .15s, box-shadow .15s;
    user-select: none;
  }
  .pedido-pill:active { cursor:grabbing; }
  .pedido-pill.dragging { opacity:.45; transform:scale(.95); }

  .cal-cell {
    min-height:120px;
    transition: background .15s, box-shadow .15s;
    position: relative;
  }
  .cal-cell.drop-target {
    background: #f0fdf4 !important;
    box-shadow: inset 0 0 0 2px #10b981;
  }
  .cal-cell.drop-target-red   { background:#fff1f2!important;box-shadow:inset 0 0 0 2px #ef4444; }
  .cal-cell.drop-target-orange{ background:#fff7ed!important;box-shadow:inset 0 0 0 2px #f97316; }
  .cal-cell.drop-target-sky{ background:#f0f9ff!important;box-shadow:inset 0 0 0 2px #0ea5e9; }

  #modalCal { backdrop-filter:blur(4px); }

  /* â”€â”€ ZONAS DE CAMBIO DE MES AL ARRASTRAR â”€â”€ */
  .month-nav-zone {
    position: absolute;
    top: 0; bottom: 0;
    width: 56px;
    z-index: 30;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: 900;
    color: white;
    text-shadow: 0 1px 4px rgba(0,0,0,.5);
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s, background .25s;
  }
  .month-nav-zone.left  { left: 0;  background: linear-gradient(to right, rgba(15,23,42,.6) 0%, rgba(15,23,42,.15) 70%, transparent 100%); border-radius: 0 0 0 20px; }
  .month-nav-zone.right { right: 0; background: linear-gradient(to left,  rgba(15,23,42,.6) 0%, rgba(15,23,42,.15) 70%, transparent 100%); border-radius: 0 0 20px 0; }
  body.is-dragging .month-nav-zone { opacity: .5; pointer-events: all; }
  body.is-dragging .month-nav-zone.hovering { opacity: 1; background: rgba(15,23,42,.72); }
  .cal-wrapper { position: relative; }
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- HEADER -->
<header class="bg-slate-900 text-white py-6 shadow-xl">
  <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <div>
      <h1 class="text-2xl font-black tracking-tighter uppercase">ITC Production <span class="text-yellow-400">Systems</span> <span class="text-slate-400 text-lg font-light">â€” Admin Central</span></h1>
      <p class="text-slate-400 text-xs mt-1 uppercase tracking-widest font-semibold">PlanificaciÃ³n y distribuciÃ³n centralizada de pedidos</p>
    </div>
    <a href="index.html" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl text-xs font-black uppercase border border-slate-600 transition-colors">â† Volver al Panel</a>
  </div>
</header>

<!-- MODAL CALENDARIO INDIVIDUAL -->
<div id="modalCal" class="fixed inset-0 bg-slate-900/70 z-50 hidden items-center justify-center p-2 md:p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[98vw] h-[95vh] flex flex-col overflow-hidden cal-wrapper" id="calModalOuter">
    <div class="month-nav-zone left"  id="calNavLeft"  ondragenter="onMonthNavEnter(event,'cal',-1)" ondragleave="onMonthNavLeave(event,'calNavLeft')"  ondragover="onNavDragOver(event)">â€¹</div>
    <div class="month-nav-zone right" id="calNavRight" ondragenter="onMonthNavEnter(event,'cal',1)"  ondragleave="onMonthNavLeave(event,'calNavRight')" ondragover="onNavDragOver(event)">â€º</div>
    <div id="modalCalHeader" class="px-6 py-4 flex items-center justify-between">
      <div>
        <h2 id="modalCalTitulo" class="text-xl font-black uppercase tracking-tight">Calendario</h2>
        <p id="modalCalSub" class="text-[10px] text-white/70 font-bold mt-0.5 uppercase tracking-wider">Arrastra los pedidos para cambiar su fecha</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="cambiarMesCal(-1)" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center font-black text-white text-lg">â€¹</button>
        <span id="modalCalMes" class="text-sm font-black text-white min-w-[130px] text-center"></span>
        <button onclick="cambiarMesCal(1)"  class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center font-black text-white text-lg">â€º</button>
        <button onclick="cerrarCal()" class="ml-4 w-8 h-8 rounded-full bg-white/20 hover:bg-red-400 flex items-center justify-center font-black text-white">âœ•</button>
      </div>
    </div>
    <div class="overflow-y-auto flex-1 px-4 pb-4" id="calModalWrapper">
      <div class="grid grid-cols-7 gap-0.5 mb-0.5">
        <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2">Lun</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2">Mar</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2">MiÃ©</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2">Jue</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2">Vie</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-300 py-2">SÃ¡b</div>
        <div class="text-center text-[10px] font-black uppercase text-slate-300 py-2">Dom</div>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-0.5"></div>
    </div>
  </div>
</div>

<!-- MODAL VISTA MÃ“DULO (IFRAME) -->
<div id="modalModulo" class="fixed inset-0 bg-slate-900/80 z-50 hidden items-center justify-center p-2 md:p-4">
  <div class="bg-slate-900 rounded-3xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
    <div class="px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between border-b border-slate-800">
      <div>
        <h2 id="tituloModuloIframe" class="text-sm sm:text-base font-black text-white uppercase tracking-tight">MÃ³dulo</h2>
        <p class="text-[10px] text-slate-400 font-bold mt-0.5 uppercase tracking-wider">Vista embebida del mÃ³dulo de producciÃ³n</p>
      </div>
      <div class="flex items-center gap-2">
        <a id="linkModuloNuevaPestaÃ±a" href="#" target="_blank" class="hidden sm:inline-flex items-center gap-1 text-[10px] font-bold uppercase text-slate-300 hover:text-white px-3 py-1.5 rounded-full border border-slate-600">
          <span>â†— Abrir en pestaÃ±a</span>
        </a>
        <button onclick="cerrarModuloIframe()" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-red-500 flex items-center justify-center text-white text-sm font-black">âœ•</button>
      </div>
    </div>
    <div class="flex-1 bg-slate-950">
      <iframe id="iframeModulo" class="w-full h-full border-0" src="about:blank"></iframe>
    </div>
  </div>
</div>

<div class="container mx-auto px-6 py-6">

  <!-- TARJETAS MÃ“DULOS -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div id="card-agitador"  class="mod-card bg-white rounded-2xl p-4 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-2 mb-1"><div id="led-agitador"  class="w-3 h-3 rounded-full bg-slate-300"></div><span class="text-[10px] font-black uppercase text-slate-500" id="txt-agitador">Conectando...</span></div>
      <p class="text-base font-black text-emerald-600">Agitador</p>
      <p class="text-[10px] text-slate-400 mt-0.5" id="count-agitador">â€” pendientes</p>
      <p class="text-[9px] mt-1 font-bold uppercase flex items-center justify-between">
        <button type="button" onclick="abrirCal('agitador')" class="text-emerald-500 flex items-center gap-1">
          <span>ğŸ“…</span><span class="text-[11px]">Calendario</span>
        </button>
        <button type="button" onclick="event.stopPropagation(); abrirModuloIframe('agitador')" class="text-slate-400 flex items-center gap-1">
          <span class="text-xs">ğŸ–¥</span><span class="hidden sm:inline text-[11px] text-emerald-500">MÃ“DULO</span>
        </button>
      </p>
    </div>
    <div id="card-dostec40" class="mod-card bg-white rounded-2xl p-4 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-2 mb-1"><div id="led-dostec40" class="w-3 h-3 rounded-full bg-slate-300"></div><span class="text-[10px] font-black uppercase text-slate-500" id="txt-dostec40">Conectando...</span></div>
      <p class="text-base font-black text-red-600">Dostec 40 OEM</p>
      <p class="text-[10px] text-slate-400 mt-0.5" id="count-dostec40">â€” pendientes</p>
      <p class="text-[9px] mt-1 font-bold uppercase flex items-center justify-between">
        <button type="button" onclick="abrirCal('dostec40')" class="text-red-400 flex items-center gap-1">
          <span>ğŸ“…</span><span class="text-[11px]">Calendario</span>
        </button>
        <button type="button" onclick="event.stopPropagation(); abrirModuloIframe('dostec40')" class="text-slate-400 flex items-center gap-1">
          <span class="text-xs">ğŸ–¥</span><span class="hidden sm:inline text-[11px] text-red-500">MÃ“DULO</span>
        </button>
      </p>
    </div>
    <div id="card-dostec50" class="mod-card bg-white rounded-2xl p-4 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-2 mb-1"><div id="led-dostec50" class="w-3 h-3 rounded-full bg-slate-300"></div><span class="text-[10px] font-black uppercase text-slate-500" id="txt-dostec50">Conectando...</span></div>
      <p class="text-base font-black text-orange-500">Dostec 50</p>
      <p class="text-[10px] text-slate-400 mt-0.5" id="count-dostec50">â€” pendientes</p>
      <p class="text-[9px] mt-1 font-bold uppercase flex items-center justify-between">
        <button type="button" onclick="abrirCal('dostec50')" class="text-orange-400 flex items-center gap-1">
          <span>ğŸ“…</span><span class="text-[11px]">Calendario</span>
        </button>
        <button type="button" onclick="event.stopPropagation(); abrirModuloIframe('dostec50')" class="text-slate-400 flex items-center gap-1">
          <span class="text-xs">ğŸ–¥</span><span class="hidden sm:inline text-[11px] text-orange-500">MÃ“DULO</span>
        </button>
      </p>
    </div>
    <div id="card-restyling" class="mod-card bg-white rounded-2xl p-4 border-2 border-slate-200 shadow-sm">
      <div class="flex items-center gap-2 mb-1"><div id="led-restyling" class="w-3 h-3 rounded-full bg-slate-300"></div><span class="text-[10px] font-black uppercase text-slate-500" id="txt-restyling">Conectando...</span></div>
      <p class="text-base font-black text-sky-500">Restyling</p>
      <p class="text-[10px] text-slate-400 mt-0.5" id="count-restyling">â€” pendientes</p>
      <p class="text-[9px] mt-1 font-bold uppercase flex items-center justify-between">
        <button type="button" onclick="abrirCal('restyling')" class="text-sky-400 flex items-center gap-1">
          <span>ğŸ“…</span><span class="text-[11px]">Calendario</span>
        </button>
        <button type="button" onclick="event.stopPropagation(); abrirModuloIframe('restyling')" class="text-slate-400 flex items-center gap-1">
          <span class="text-xs">ğŸ–¥</span><span class="hidden sm:inline text-[11px] text-sky-500">MÃ“DULO</span>
        </button>
      </p>
    </div>
  </div>

  <!-- CALENDARIO GLOBAL -->
  <div class="bg-white rounded-3xl border border-slate-200 shadow-sm mb-8 overflow-hidden">
    <div class="bg-slate-900 px-6 py-4 flex items-center justify-between flex-wrap gap-3">
      <div>
        <h2 class="text-white font-black uppercase tracking-widest text-sm">ğŸ“… PlanificaciÃ³n General</h2>
        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mt-0.5">Arrastra los pedidos para replanificar</p>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <div class="hidden md:flex items-center gap-3 mr-2">
          <span class="flex items-center gap-1 text-[10px] font-black text-emerald-400"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>Agitador</span>
          <span class="flex items-center gap-1 text-[10px] font-black text-red-400"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span>Dostec 40 OEM</span>
          <span class="flex items-center gap-1 text-[10px] font-black text-orange-400"><span class="w-2 h-2 rounded-full bg-orange-500 inline-block"></span>Dostec 50</span>
          <span class="flex items-center gap-1 text-[10px] font-black text-sky-400"><span class="w-2 h-2 rounded-full bg-sky-500 inline-block"></span>Restyling</span>
        </div>
        <button onclick="cambiarMesGlobal(-1)" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center font-black text-white text-lg">â€¹</button>
        <span id="globalCalMes" class="text-sm font-black text-white min-w-[130px] text-center"></span>
        <button onclick="cambiarMesGlobal(1)"  class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center font-black text-white text-lg">â€º</button>
      </div>
    </div>
    <div class="grid grid-cols-7 border-b border-slate-100">
      <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2 border-r border-slate-50">Lun</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2 border-r border-slate-50">Mar</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2 border-r border-slate-50">MiÃ©</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2 border-r border-slate-50">Jue</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-400 py-2 border-r border-slate-50">Vie</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-300 py-2 border-r border-slate-50">SÃ¡b</div>
      <div class="text-center text-[10px] font-black uppercase text-slate-300 py-2">Dom</div>
    </div>
    <div class="cal-wrapper" id="globalCalWrapper">
      <div class="month-nav-zone left"  id="globalNavLeft"  ondragenter="onMonthNavEnter(event,'global',-1)" ondragleave="onMonthNavLeave(event,'globalNavLeft')"  ondragover="onNavDragOver(event)">â€¹</div>
      <div class="month-nav-zone right" id="globalNavRight" ondragenter="onMonthNavEnter(event,'global',1)"  ondragleave="onMonthNavLeave(event,'globalNavRight')" ondragover="onNavDragOver(event)">â€º</div>
      <div id="globalCalGrid" class="grid grid-cols-7"></div>
    </div>
    <div id="globalCalDetalle" class="hidden border-t border-slate-200 bg-slate-50 px-6 py-4 max-h-64 overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h4 id="globalCalDetalleTitulo" class="text-xs font-black uppercase text-slate-600"></h4>
        <button onclick="document.getElementById('globalCalDetalle').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 text-xs font-black">âœ•</button>
      </div>
      <div id="globalCalDetalleContenido" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
    </div>
  </div>

  <!-- DROP ZONE EXCEL -->
  <div class="bg-white rounded-3xl border-2 border-dashed border-slate-300 p-10 text-center drop-zone mb-8 cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/30 transition-all"
       id="dropZone" onclick="document.getElementById('fileInput').click()"
       ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
    <div class="text-5xl mb-4">ğŸ“Š</div>
    <h2 class="text-xl font-black text-slate-700 uppercase tracking-tight">Cargar Excel de PlanificaciÃ³n</h2>
    <p class="text-slate-400 text-sm mt-2">Arrastra el archivo aquÃ­ o haz clic para seleccionar</p>
    <div class="mt-4 flex flex-wrap justify-center gap-2 text-xs">
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Pedido</span>
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Codigo</span>
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Serie</span>
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Unidades</span>
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Cliente</span>
      <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold">Notas</span>
      <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-black border border-yellow-300">Sistema</span>
      <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-black border border-blue-300">ğŸ“… Fecha</span>
    </div>
    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls" onchange="procesarExcel(event)">
  </div>

  <!-- PREVIEW -->
  <div id="seccionPreview" class="hidden">
    <div id="alertaErrores"    class="hidden bg-amber-50 border border-amber-300 rounded-2xl p-4 mb-6 text-sm text-amber-800 font-bold"></div>
    <div id="alertaDuplicados" class="hidden bg-orange-50 border-2 border-orange-300 rounded-2xl p-4 mb-6">
      <div class="flex items-start gap-3">
        <span class="text-2xl">âš ï¸</span>
        <div>
          <p class="font-black text-orange-800 text-sm uppercase mb-1">Series ya existentes â€” no se volverÃ¡n a enviar</p>
          <div id="listaDuplicados" class="text-xs text-orange-600 font-mono mt-2"></div>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="resumenModulos"></div>
    <!-- MÃ“DULOS DESTINO -->
    <div class="bg-white rounded-2xl border border-slate-200 p-5 mb-4 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-black uppercase text-slate-600 tracking-widest">ğŸ“¦ MÃ³dulos destino</h3>
        <div class="flex gap-3 text-xs font-black uppercase">
          <button onclick="selTodosModulos()" class="text-emerald-600 hover:text-emerald-800">Todos</button>
          <span class="text-slate-300">Â·</span>
          <button onclick="selNingunoModulos()" class="text-slate-400 hover:text-slate-600">Ninguno</button>
        </div>
      </div>
      <div id="togglesModulos" class="flex flex-wrap gap-3"></div>
    </div>

    <div class="bg-white rounded-2xl border border-slate-200 p-5 mb-6 shadow-sm">
      <h3 class="text-sm font-black uppercase text-slate-600 tracking-widest mb-4">ğŸ“… Filtrar por dÃ­a de montaje</h3>
      <div id="tabsDias" class="flex flex-wrap gap-2"></div>
    </div>
    <div class="bg-white rounded-3xl shadow-sm border overflow-hidden mb-6">
      <div class="bg-slate-900 px-6 py-4 flex items-center justify-between flex-wrap gap-3">
        <div>
          <h3 class="text-white font-black uppercase text-sm tracking-widest">
            <span id="totalFilasVisible" class="text-yellow-400">0</span> series
            <span class="text-slate-400 font-normal normal-case text-xs ml-2" id="subtituloFiltro"></span>
          </h3>
          <p id="infoDuplicadosHeader" class="text-orange-400 text-[10px] font-bold mt-0.5 hidden"></p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button onclick="limpiarPreview()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl text-xs font-black uppercase">âœ• Cancelar</button>
          <button onclick="enviarDiaActual()" id="btnEnviarDia"  class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-black uppercase shadow hidden">ğŸ“… Enviar dÃ­a</button>
          <button onclick="enviarTodo()"      id="btnEnviarTodo" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2 rounded-xl text-xs font-black uppercase shadow-lg">ğŸš€ Enviar todo</button>
        </div>
      </div>
      <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
        <table class="w-full text-left text-xs">
          <thead class="bg-slate-100 text-slate-600 text-[11px] font-black uppercase sticky top-0">
            <tr>
              <th class="p-3 w-10">
                <button onclick="toggleTodasFilas()" title="Activar/desactivar todas" class="w-8 h-5 rounded-full bg-emerald-500 flex items-center px-0.5 transition-colors" id="toggleMaestro">
                  <div class="w-4 h-4 bg-white rounded-full shadow ml-auto transition-all"></div>
                </button>
              </th>
              <th class="p-3">MÃ³dulo</th><th class="p-3">ğŸ“… Fecha</th><th class="p-3">Pedido</th>
              <th class="p-3">CÃ³digo</th><th class="p-3">Serie</th><th class="p-3">Cliente</th>
              <th class="p-3">Notas</th><th class="p-3 text-center">Estado</th>
            </tr>
          </thead>
          <tbody id="tablaPreview"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LOG -->
  <div id="seccionLog" class="hidden">
    <div class="bg-slate-900 rounded-3xl p-6">
      <h3 class="text-white font-black uppercase text-sm tracking-widest mb-4">ğŸ“¡ Log de envÃ­o</h3>
      <div id="logContenido" class="space-y-1 max-h-72 overflow-y-auto font-mono text-xs"></div>
      <div id="resultadoFinal" class="hidden mt-4 bg-emerald-500 text-white rounded-2xl p-4 text-center font-black text-base"></div>
    </div>
  </div>

</div><!-- /container -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODULOS = {
  agitador:  { label:"Agitador",  color:"emerald", aliases:["agitador"],
    config:{ apiKey:"AIzaSyC4oVIS50zartNRGsYNG4zmDMPc6A102oE", authDomain:"agitador-e6584.firebaseapp.com", databaseURL:"https://agitador-e6584-default-rtdb.europe-west1.firebasedatabase.app", projectId:"agitador-e6584", storageBucket:"agitador-e6584.firebasestorage.app", messagingSenderId:"295479175763", appId:"1:295479175763:web:4d22a9b7a05744fe78b4a6" }},
  dostec40:  { label:"Dostec 40 OEM", color:"red",     aliases:["dostec40","dostec 40","d40"],
    config:{ apiKey:"AIzaSyDqmHebrFc5yDzzpwtiW33q4lDEfxQ_bWo", authDomain:"tempprod-2ecad.firebaseapp.com", databaseURL:"https://tempprod-2ecad-default-rtdb.europe-west1.firebasedatabase.app", projectId:"tempprod-2ecad", storageBucket:"tempprod-2ecad.firebasestorage.app", messagingSenderId:"791527902001", appId:"1:791527902001:web:75d104fba52a0dbfc33e10" }},
  dostec50:  { label:"Dostec 50", color:"orange",  aliases:["dostec50","dostec 50","d50"],
    config:{ apiKey:"AIzaSyC3-8SYYWCpn6aYflXFzaLSVurkLJ9gAm8", authDomain:"dostec-50.firebaseapp.com", databaseURL:"https://dostec-50-default-rtdb.europe-west1.firebasedatabase.app", projectId:"dostec-50", storageBucket:"dostec-50.firebasestorage.app", messagingSenderId:"581863827285", appId:"1:581863827285:web:b360b2f59cb95b6055b1dc" }},
  restyling: { label:"Restyling", color:"sky",  aliases:["restyling"],
    config:{ apiKey:"AIzaSyDn9Y-g7odI5T7rD1LVRSldkRwVnIyfPMg", authDomain:"d40restyling.firebaseapp.com", databaseURL:"https://d40restyling-default-rtdb.europe-west1.firebasedatabase.app", projectId:"d40restyling", storageBucket:"d40restyling.appspot.com", appId:"1:1085425091704:web:4ce5ab8af47546035b998d" }}
};

// Rutas locales de cada mÃ³dulo para la vista embebida
const MOD_URLS = {
  agitador: 'Agitador.html',
  dostec40: 'Dostec 40.html',
  dostec50: 'Dostec 50.html',
  restyling: 'Restyling.html'
};

const MOD_COLORS = {
  agitador:  { dot:'bg-emerald-500', pill:'bg-emerald-100 text-emerald-800', border:'border-emerald-300', dropCls:'drop-target',         label:'Agitador' },
  dostec40:  { dot:'bg-red-500',     pill:'bg-red-100 text-red-800',         border:'border-red-300',     dropCls:'drop-target-red',      label:'Dostec 40 OEM' },
  dostec50:  { dot:'bg-orange-500',  pill:'bg-orange-100 text-orange-800',   border:'border-orange-300',  dropCls:'drop-target-orange',   label:'Dostec 50' },
  restyling: { dot:'bg-sky-500',  pill:'bg-sky-100 text-sky-800',   border:'border-sky-300',  dropCls:'drop-target-sky',   label:'Restyling' }
};

const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

// â”€â”€ FIREBASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const apps={}, dbs={};
const planCache = { agitador:{}, dostec40:{}, dostec50:{}, restyling:{} };

for (const [key, mod] of Object.entries(MODULOS)) {
  try {
    apps[key] = initializeApp(mod.config, key);
    dbs[key]  = getDatabase(apps[key]);
    onValue(ref(dbs[key],'.info/connected'), snap=>{
      const on=snap.val()===true;
      const led=document.getElementById(`led-${key}`), txt=document.getElementById(`txt-${key}`);
      if(!led||!txt) return;
      led.className = on?'w-3 h-3 rounded-full bg-emerald-500 led-on':'w-3 h-3 rounded-full bg-red-400 animate-pulse';
      txt.textContent=on?'EN LÃNEA':'SIN CONEXIÃ“N';
      txt.className=on?'text-[10px] font-black uppercase text-emerald-600':'text-[10px] font-black uppercase text-red-500';
    });
    onValue(ref(dbs[key],'planificacion'), snap=>{
      const raw=snap.val()||{};
      planCache[key]=Object.fromEntries(Object.entries(raw).filter(([,v])=>v!==null));
      const el=document.getElementById(`count-${key}`);
      if(el) el.textContent=`${Object.keys(planCache[key]).length} pendientes`;
      if(calState.modulo===key && !document.getElementById('modalCal').classList.contains('hidden')) renderCalGrid();
      renderGlobalCal();
    });
  } catch(e){ console.error(key,e); }
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hoyISO = () => new Date().toISOString().slice(0,10);
function resolverModulo(s){ const v=String(s||'').trim().toLowerCase(); for(const [k,m] of Object.entries(MODULOS)) if(m.aliases.some(a=>a===v)) return k; return null; }
function parsearFecha(val){
  if(!val) return null; const s=String(val).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
  const n=parseFloat(s); if(!isNaN(n)&&n>40000){ const d=new Date(Math.round((n-25569)*86400000)); return d.toISOString().slice(0,10); }
  return null;
}
function formatLabel(iso){
  if(!iso||iso==='sin-fecha') return 'âš ï¸ Sin fecha';
  const hoy=hoyISO(), man=new Date(Date.now()+86400000).toISOString().slice(0,10);
  const base=new Date(iso+'T12:00:00').toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'});
  if(iso===hoy) return `ğŸŸ¢ Hoy â€” ${base}`; if(iso===man) return `ğŸ”µ MaÃ±ana â€” ${base}`; return `ğŸ“… ${base}`;
}
function formatFechaLarga(iso){
  return new Date(iso+'T12:00:00').toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}

// â”€â”€ DRAG & DROP EXCEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onDragOver = e=>{ e.preventDefault(); document.getElementById('dropZone').classList.add('drag-over'); };
window.onDragLeave= ()=> document.getElementById('dropZone').classList.remove('drag-over');
window.onDrop     = e=>{ e.preventDefault(); document.getElementById('dropZone').classList.remove('drag-over'); const f=e.dataTransfer.files[0]; if(f) procesarFile(f); };

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pedidos=[], diaActivo=null;
let seriesExcluidas = new Set(); // Ã­ndices globales de pedidos excluidos individualmente
// Set de mÃ³dulos activos para el envÃ­o (todos activos por defecto)
let modulosActivos = new Set(['agitador','dostec40','dostec50','restyling']);

// Estado de la operaciÃ³n drag de pedido (replanificaciÃ³n)
const dragOp = { moduloKey:null, pedidoId:null, fechaOrigen:null, fechaDestino:null, items:[] };
// â”€â”€ EXCEL PARSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.procesarExcel = e=>{ const f=e.target.files[0]; if(f) procesarFile(f); e.target.value=''; };
function procesarFile(file){
  const r=new FileReader();
  r.onload=async evt=>{
    try{
      const wb=XLSX.read(new Uint8Array(evt.target.result),{type:'array',cellDates:true,dateNF:'yyyy-mm-dd'});
      const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:'',raw:false});
      if(!json.length){alert('El archivo estÃ¡ vacÃ­o');return;}
      pedidos=[]; const errores=[];
      json.forEach((item,idx)=>{
        const row={}; Object.keys(item).forEach(k=>{ row[k.trim().toLowerCase()]=item[k]; });
        const pedido=String(row.pedido||row.orden||'').trim(), codigo=String(row['cÃ³digo']||row.codigo||'').trim();
        const sistema=String(row.sistema||'').trim(), fechaRaw=row.fecha||row['fecha montaje']||null;
        if(!pedido&&!codigo) return;
        const moduloKey=resolverModulo(sistema);
        if(!moduloKey) errores.push(`Fila ${idx+2}: Sistema desconocido "${sistema}"`);
        const fecha=parsearFecha(fechaRaw), cliente=String(row.cliente||row.client||'Sin cliente').trim();
        const notas=String(row.notas||row.observaciones||'').trim(), serieBase=String(row.serie||row['nÂº serie']||'').trim();
        const cantidad=parseInt(String(row.unidaes||row.unidades||row.cantidad||row.uds||row.qty||'1'))||1;
        const ms=serieBase.match(/^(.*?)(\d+)$/); let pref='',numBase=0,pad=0;
        if(ms){pref=ms[1];const n=ms[2];numBase=parseInt(n);pad=n.length;}
        for(let i=0;i<cantidad;i++){
          const serie=ms?pref+String(numBase+i).padStart(pad,'0'):(i===0?(serieBase||'--'):`${serieBase||'--'}-${i+1}`);
          pedidos.push({moduloKey,pedido:pedido||'S/P',codigo:codigo||'--',serie,cliente,notas,fecha,esDuplicado:false});
        }
      });
      const errEl=document.getElementById('alertaErrores');
      if(errores.length){errEl.classList.remove('hidden');errEl.innerHTML='âš ï¸ MÃ³dulos no reconocidos:<br>'+errores.join('<br>');}
      else errEl.classList.add('hidden');
      await comprobarDuplicados();
      const dias=[...new Set(pedidos.map(p=>p.fecha||'sin-fecha'))].sort();
      diaActivo=dias[0]||'todos';
      renderTogglesModulos(); renderTabs(dias); renderResumen(); renderTabla();
      document.getElementById('seccionPreview').classList.remove('hidden');
    }catch(e){alert('âŒ Error: '+e.message);}
  };
  r.readAsArrayBuffer(file);
}

async function comprobarDuplicados(){
  const modulos=[...new Set(pedidos.filter(p=>p.moduloKey).map(p=>p.moduloKey))];
  const existentes={};
  await Promise.all(modulos.map(async key=>{
    const data=Object.keys(planCache[key]).length?planCache[key]:await get(ref(dbs[key],'planificacion')).then(s=>s.val()||{});
    existentes[key]=new Set(Object.values(data).map(i=>String(i.serie||'').trim()).filter(Boolean));
  }));
  const dups=[];
  pedidos.forEach(p=>{ if(p.moduloKey&&existentes[p.moduloKey]?.has(p.serie)){p.esDuplicado=true;dups.push(`${MODULOS[p.moduloKey].label} â€” ${p.serie} (Ped.${p.pedido})`);} });
  const aEl=document.getElementById('alertaDuplicados'), lEl=document.getElementById('listaDuplicados'), hEl=document.getElementById('infoDuplicadosHeader');
  if(dups.length){aEl.classList.remove('hidden');lEl.innerHTML=dups.map(d=>`<div>â€¢ ${d}</div>`).join('');hEl.classList.remove('hidden');hEl.textContent=`âš ï¸ ${dups.length} duplicada${dups.length>1?'s':''} â€” no se enviarÃ¡n`;}
  else{aEl.classList.add('hidden');hEl.classList.add('hidden');}
}

function renderTabs(dias){
  const total=pedidos.filter(p=>!p.esDuplicado).length;
  let html=`<button id="tab-todos" class="day-tab px-4 py-2 rounded-xl text-xs font-black uppercase border border-slate-200 shadow-sm bg-white text-slate-600" onclick="selDia('todos')">ğŸ“‹ Todos <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full text-[10px]">${total}</span></button>`;
  dias.forEach(d=>{ const n=pedidos.filter(p=>(p.fecha||'sin-fecha')===d&&!p.esDuplicado).length;
    html+=`<button id="tab-${d.replace(/[^a-z0-9]/gi,'-')}" class="day-tab px-4 py-2 rounded-xl text-xs font-black border border-slate-200 shadow-sm bg-white text-slate-600" onclick="selDia('${d}')">${formatLabel(d)} <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full text-[10px]">${n}</span></button>`; });
  document.getElementById('tabsDias').innerHTML=html; actualizarTabActivo();
}
function actualizarTabActivo(){ document.querySelectorAll('.day-tab').forEach(b=>{ b.classList.toggle('active',!!b.getAttribute('onclick')?.includes(`'${diaActivo}'`)); }); }
window.selDia=dia=>{ diaActivo=dia; actualizarTabActivo(); renderTabla(); };

function renderResumen(){
  const c={}; pedidos.filter(p=>!p.esDuplicado).forEach(p=>{ const k=p.moduloKey||'error'; c[k]=(c[k]||0)+1; });
  const col={agitador:'emerald',dostec40:'red',dostec50:'orange',restyling:'sky',error:'slate'};
  document.getElementById('resumenModulos').innerHTML=Object.entries(c).map(([k,n])=>{
    const lbl=MODULOS[k]?MODULOS[k].label:'âš ï¸ Sin mÃ³dulo'; const cv=col[k]||'slate';
    return `<div class="bg-${cv}-50 border-2 border-${cv}-200 rounded-2xl p-4 text-center"><p class="text-2xl font-black text-${cv}-600">${n}</p><p class="text-xs font-black uppercase text-${cv}-500 mt-1">${lbl}</p></div>`;
  }).join('');
}

function renderTabla(){
  const filtrados=diaActivo==='todos'?pedidos:pedidos.filter(p=>(p.fecha||'sin-fecha')===diaActivo);
  const nuevos=filtrados.filter((p,_i)=>{ const gi=pedidos.indexOf(p); return !p.esDuplicado&&modulosActivos.has(p.moduloKey)&&!seriesExcluidas.has(gi); }).length;
  document.getElementById('totalFilasVisible').textContent=nuevos;
  document.getElementById('subtituloFiltro').textContent=diaActivo==='todos'?'(todos los dÃ­as)':`(${formatLabel(diaActivo)})`;
  const btnDia=document.getElementById('btnEnviarDia');
  if(diaActivo==='todos') btnDia.classList.add('hidden');
  else{ btnDia.classList.remove('hidden'); btnDia.textContent=`ğŸ“… Enviar ${formatLabel(diaActivo)}`; }
  const badge={ agitador:'<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-black text-[10px]">Agitador</span>', dostec40:'<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-black text-[10px]">Dostec 40 OEM</span>', dostec50:'<span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-black text-[10px]">Dostec 50</span>', restyling:'<span class="bg-sky-100 text-sky-700 px-2 py-0.5 rounded-full font-black text-[10px]">Restyling</span>' };
  const clsRow={agitador:'row-agitador',dostec40:'row-dostec40',dostec50:'row-dostec50',restyling:'row-restyling'};
  document.getElementById('tablaPreview').innerHTML=filtrados.map(p=>{
    const gi=pedidos.indexOf(p), isDup=p.esDuplicado;
    const isExcluido = p.moduloKey && !isDup && !modulosActivos.has(p.moduloKey);
    const isExcluidoIndividual = seriesExcluidas.has(gi);
    const fechaHtml=p.fecha?`<span class="bg-blue-50 text-blue-700 border border-blue-200 px-2 py-0.5 rounded font-bold text-[10px]">${formatLabel(p.fecha)}</span>`:'<span class="text-slate-300 text-[10px]">â€”</span>';
    const estadoHtml=isDup
      ?'<span class="bg-orange-100 text-orange-700 border border-orange-300 px-2 py-0.5 rounded-full text-[10px] font-black">âš ï¸ YA EXISTE</span>'
      :isExcluido
        ?'<span class="bg-slate-100 text-slate-400 border border-slate-200 px-2 py-0.5 rounded-full text-[10px] font-black">â›” MÃ“DULO OFF</span>'
        :isExcluidoIndividual
          ?'<span class="bg-slate-100 text-slate-400 border border-slate-200 px-2 py-0.5 rounded-full text-[10px] font-black">â›” EXCLUIDO</span>'
          :`<span class="bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full text-[10px] font-bold" id="estado-${gi}">PENDIENTE</span>`;
    const rowBg = isDup?'bg-orange-50 opacity-60':isExcluido?'bg-slate-50 opacity-40':'';
    const filaActiva = !isDup && !isExcluido && !isExcluidoIndividual;
    const toggleFila = isDup ? '' : `
      <td class="p-3 w-10">
        <button onclick="toggleFila(${gi})" class="w-8 h-5 rounded-full flex items-center px-0.5 transition-colors ${filaActiva ? 'bg-emerald-500' : 'bg-slate-300'}">
          <div class="w-4 h-4 bg-white rounded-full shadow transition-all ${filaActiva ? 'ml-auto' : 'ml-0'}"></div>
        </button>
      </td>`;
    return `<tr class="${isExcluidoIndividual?'opacity-40 bg-slate-50':rowBg} ${clsRow[p.moduloKey]||'row-unknown'} border-b border-slate-100 ${filaActiva?'hover:bg-slate-50':''}" id="row-${gi}">
      ${isDup ? '<td class="p-3 w-10"></td>' : toggleFila}
      <td class="p-3">${p.moduloKey?badge[p.moduloKey]:'<span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-black text-[10px]">âš ï¸ Sin mÃ³dulo</span>'}</td>
      <td class="p-3">${fechaHtml}</td><td class="p-3 font-bold text-slate-600 ${isDup?'line-through text-slate-400':''}">${p.pedido}</td>
      <td class="p-3 text-slate-500 font-mono text-[11px]">${p.codigo}</td>
      <td class="p-3"><span class="px-2 py-0.5 rounded font-mono font-black text-[11px] ${isDup?'bg-orange-100 text-orange-500':'bg-slate-100'}">${p.serie}</span></td>
      <td class="p-3 text-blue-600 font-bold text-[11px]">${p.cliente}</td>
      <td class="p-3 text-slate-400 text-[11px] max-w-xs truncate">${p.notas||'â€”'}</td>
      <td class="p-3 text-center">${estadoHtml}</td></tr>`;
  }).join('');
}

window.limpiarPreview=()=>{ pedidos=[];diaActivo=null; seriesExcluidas=new Set(); modulosActivos=new Set(['agitador','dostec40','dostec50','restyling']); document.getElementById('seccionPreview').classList.add('hidden'); document.getElementById('seccionLog').classList.add('hidden'); document.getElementById('alertaDuplicados').classList.add('hidden'); };
window.enviarDiaActual=()=>{ if(!diaActivo||diaActivo==='todos') return; enviarLote(pedidos.filter(p=>(p.fecha||'sin-fecha')===diaActivo),formatLabel(diaActivo)); };
window.enviarTodo=()=>enviarLote(pedidos,'todos los dÃ­as');

async function enviarLote(lote,desc){
  const validos=lote.filter(p=>{ const gi=pedidos.indexOf(p); return p.moduloKey&&!p.esDuplicado&&modulosActivos.has(p.moduloKey)&&!seriesExcluidas.has(gi); }); const omitidos=lote.filter(p=>p.esDuplicado).length, excluidos=lote.filter(p=>{ const gi=pedidos.indexOf(p); return p.moduloKey&&!p.esDuplicado&&(!modulosActivos.has(p.moduloKey)||seriesExcluidas.has(gi)); }).length;
  if(!validos.length){alert(omitidos>0?`âš ï¸ Todas las series ya estÃ¡n en Firebase (${omitidos} duplicadas).`:'No hay registros vÃ¡lidos');return;}
  ['btnEnviarTodo','btnEnviarDia'].forEach(id=>{ const b=document.getElementById(id); if(b) b.disabled=true; });
  document.getElementById('seccionLog').classList.remove('hidden');
  const log=document.getElementById('logContenido'); log.innerHTML=''; document.getElementById('resultadoFinal').classList.add('hidden');
  const addLog=(msg,cls='text-slate-300')=>{ log.innerHTML+=`<div class="${cls}">${msg}</div>`; log.scrollTop=log.scrollHeight; };
  if(excluidos) addLog(`â„¹ï¸ ${excluidos} series excluidas por mÃ³dulo desactivado`,'text-slate-400');
  addLog(`ğŸ“‹ Enviando ${validos.length} series (${desc})${omitidos?` â€” ${omitidos} duplicadas omitidas`:''}...`,'text-yellow-400');
  let ok=0,err=0;
  for(let i=0;i<pedidos.length;i++){
    const p=pedidos[i]; if(!validos.includes(p)) continue;
    try{ await push(ref(dbs[p.moduloKey],'planificacion'),{pedido:p.pedido,cliente:p.cliente,codigo:p.codigo,serie:p.serie,notas:p.notas,fecha:p.fecha||null,orden:Date.now()+i});
      addLog(`âœ… ${p.serie} â†’ <b>${MODULOS[p.moduloKey].label}</b>${p.fecha?` <span class="text-blue-300">${p.fecha}</span>`:''}`, 'text-emerald-400');
      setEstado(i,'enviado'); ok++;
    }catch(e){ addLog(`âŒ ${p.serie} â€” ${e.message}`,'text-red-400'); setEstado(i,'error'); err++; }
    if((ok+err)%10===0) await new Promise(r=>setTimeout(r,80));
  }
  if(omitidos) addLog(`âš ï¸ ${omitidos} duplicadas omitidas`,'text-orange-400');
  addLog(`\nğŸ“Š ${ok} enviados â€” ${err} errores`,'text-white font-bold');
  const res=document.getElementById('resultadoFinal'); res.classList.remove('hidden');
  res.className=`mt-4 ${err===0?'bg-emerald-500':'bg-amber-500'} text-white rounded-2xl p-4 text-center font-black text-base`;
  res.textContent=err===0?`âœ… ${ok} pedidos enviados${omitidos?` (${omitidos} duplicados omitidos)`:''}`:`âš ï¸ ${ok} enviados â€” ${err} errores`;
  ['btnEnviarTodo','btnEnviarDia'].forEach(id=>{ const b=document.getElementById(id); if(b) b.disabled=false; });
}
function setEstado(i,estado){
  const el=document.getElementById(`estado-${i}`); if(!el) return;
  const m={enviado:['bg-emerald-100 text-emerald-700','âœ… ENVIADO'],error:['bg-red-100 text-red-600','âŒ ERROR'],omitido:['bg-amber-100 text-amber-600','âš ï¸ OMITIDO']};
  const [cls,lbl]=m[estado]||m.omitido; el.outerHTML=`<span class="${cls} px-2 py-0.5 rounded-full text-[10px] font-black">${lbl}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP REPLANIFICACIÃ“N â€” lÃ³gica compartida
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Construye los datos de un drag: { moduloKey, pedidoId, fechaOrigen, ids:[], items:[] }
// pedidoId es el identificador de pedido (campo .pedido) que agrupa todas las series
function buildDragData(moduloKey, pedidoId, fechaOrigen){
  const data = planCache[moduloKey];
  const items = Object.entries(data)
    .filter(([,v]) => v.pedido === pedidoId && v.fecha === fechaOrigen)
    .map(([fbId, v]) => ({ fbId, ...v }));
  return { moduloKey, pedidoId, fechaOrigen, items };
}

// Aplica el cambio de fecha en Firebase para todas las series del pedido
async function aplicarCambioFecha(moduloKey, items, nuevaFecha){
  const updates={};
  items.forEach(item=>{ updates[`${item.fbId}/fecha`]=nuevaFecha; });
  await update(ref(dbs[moduloKey],'planificacion'), updates);
}

// AplicaciÃ³n directa sin confirmaciÃ³n
async function mostrarConfirm(movData){
  const { moduloKey, items, fechaDestino } = movData;
  await aplicarCambioFecha(moduloKey, items, fechaDestino);
}

// Eliminar pedido completo del calendario (y de Firebase)
window.eliminarPedidoCal = async (moduloKey, pedido, fecha, e) => {
  if(e) e.stopPropagation();
  const movData = buildDragData(moduloKey, pedido, fecha);
  if(!movData.items.length) return;
  const n = movData.items.length;
  if(!confirm(`Â¿Eliminar este pedido (${n} serie${n>1?'s':''}) de las tareas pendientes?`)) return;
  try {
    for(const item of movData.items) {
      await remove(ref(dbs[moduloKey], `planificacion/${item.fbId}`));
    }
    renderCalGrid();
    renderGlobalCal();
  } catch(err) {
    alert('Error al eliminar: ' + err.message);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDARIO INDIVIDUAL (modal) con drag & drop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const calState = { modulo:null, year:new Date().getFullYear(), month:new Date().getMonth(), dragData:null };

window.abrirCal = (moduloKey) => {
  calState.modulo=moduloKey; calState.year=new Date().getFullYear(); calState.month=new Date().getMonth(); calState.dragData=null;
  const mod=MODULOS[moduloKey], col=MOD_COLORS[moduloKey];
  const bgMap={emerald:'bg-emerald-600',red:'bg-red-600',orange:'bg-orange-500',sky:'bg-sky-500'};
  document.getElementById('modalCalHeader').className=`px-6 py-4 flex items-center justify-between ${bgMap[mod.color]} text-white`;
  document.getElementById('modalCalTitulo').textContent=`${mod.label} â€” PlanificaciÃ³n`;
  renderCalGrid();
  document.getElementById('modalCal').classList.remove('hidden');
  document.getElementById('modalCal').classList.add('flex');
};
window.cerrarCal=()=>{ document.getElementById('modalCal').classList.add('hidden'); document.getElementById('modalCal').classList.remove('flex'); calState.modulo=null; };
window.cambiarMesCal=(dir)=>{ calState.month+=dir; if(calState.month>11){calState.month=0;calState.year++;} if(calState.month<0){calState.month=11;calState.year--;} renderCalGrid(); };

function renderCalGrid(){
  const { modulo, year, month } = calState;
  if(!modulo) return;
  document.getElementById('modalCalMes').textContent=`${MESES[month]} ${year}`;
  const col=MOD_COLORS[modulo];
  const data=planCache[modulo];
  // Agrupar por fecha â†’ pedido â†’ items
  const porFecha={};
  Object.entries(data).forEach(([fbId,item])=>{
    const f=item.fecha||'sin-fecha'; if(!porFecha[f]) porFecha[f]={};
    const p=item.pedido||'S/P'; if(!porFecha[f][p]) porFecha[f][p]=[];
    porFecha[f][p].push({fbId,...item});
  });
  const hoy=hoyISO();
  const primerDia=new Date(year,month,1).getDay(); const offset=primerDia===0?6:primerDia-1;
  const diasMes=new Date(year,month+1,0).getDate();
  let html='';
  for(let i=0;i<offset;i++) html+=`<div class="cal-cell bg-slate-50/50 border border-slate-50"></div>`;
  for(let d=1;d<=diasMes;d++){
    const iso=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const grupos=porFecha[iso]||{};
    const esHoy=iso===hoy; const diaSem=new Date(iso+'T12:00:00').getDay(); const esFinSem=diaSem===0||diaSem===6;
    let bgCls=esFinSem?'bg-slate-50':'bg-white'; if(esHoy) bgCls='bg-blue-50';
    // Pills arrastrables por pedido
    const pillsHtml=Object.entries(grupos).map(([pedId,items])=>{
      const cliente=items[0].cliente||'â€”';
      const codigo=items[0].codigo||'â€”';
      const uds=items.length;
      const pedSafe=String(pedId).replace(/'/g,"\\'");
      return `
      <div class="pedido-pill ${col.pill} border ${col.border} rounded-xl px-3 py-2 mb-1.5 leading-tight flex justify-between items-start gap-2"
           draggable="true"
           data-modulo="${modulo}" data-pedido="${pedId}" data-fecha="${iso}"
           ondragstart="onPillDragStart(event)"
           ondragend="onPillDragEnd(event)">
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-1.5 mb-1">
            <span class="w-2 h-2 rounded-full ${col.dot} flex-shrink-0"></span>
            <span class="text-[11px] font-black truncate">Ped.${pedId}</span>
            <span class="text-[11px] font-black">${uds}u</span>
          </div>
          <div class="text-[10px] opacity-80 font-semibold truncate">${cliente}</div>
          <div class="text-[10px] opacity-60 font-mono truncate">${codigo}</div>
        </div>
        <button type="button" onclick="eliminarPedidoCal('${modulo}','${pedSafe}','${iso}',event)" class="flex-shrink-0 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded p-1 opacity-70 hover:opacity-100" title="Eliminar">ğŸ—‘ï¸</button>
      </div>`;
    }).join('');
    html+=`<div class="cal-cell ${bgCls} border border-slate-100 p-1.5"
               data-iso="${iso}"
               ondragover="onCalCellDragOver(event,'${modulo}')"
               ondragleave="onCalCellDragLeave(event)"
               ondrop="onCalCellDrop(event,'${modulo}')">
      <div class="text-[11px] font-black mb-1 ${esHoy?'text-blue-600':esFinSem?'text-slate-300':'text-slate-600'}">${d}</div>
      ${pillsHtml}
    </div>`;
  }
  const resto=(offset+diasMes)%7; if(resto>0) for(let i=0;i<7-resto;i++) html+=`<div class="cal-cell bg-slate-50/50 border border-slate-50"></div>`;
  document.getElementById('calGrid').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDARIO GLOBAL con drag & drop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const globalCal = { year:new Date().getFullYear(), month:new Date().getMonth(), diaSeleccionado:null };

function renderGlobalCal(){
  const { year, month } = globalCal;
  document.getElementById('globalCalMes').textContent=`${MESES[month]} ${year}`;
  // Mapa fecha â†’ modulo â†’ grupos de pedido
  const porFecha={};
  for(const [key,data] of Object.entries(planCache)){
    Object.entries(data).forEach(([fbId,item])=>{
      const f=item.fecha||'sin-fecha'; if(!porFecha[f]) porFecha[f]={};
      if(!porFecha[f][key]) porFecha[f][key]={};
      const p=item.pedido||'S/P'; if(!porFecha[f][key][p]) porFecha[f][key][p]=[];
      porFecha[f][key][p].push({fbId,...item});
    });
  }
  const hoy=hoyISO();
  const primerDia=new Date(year,month,1).getDay(); const offset=primerDia===0?6:primerDia-1;
  const diasMes=new Date(year,month+1,0).getDate();
  let html='';
  for(let i=0;i<offset;i++) html+=`<div class="cal-cell bg-slate-50/30 border-b border-r border-slate-50"></div>`;
  for(let d=1;d<=diasMes;d++){
    const iso=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const modsDia=porFecha[iso]||{};
    const esHoy=iso===hoy; const diaSem=new Date(iso+'T12:00:00').getDay(); const esFinSem=diaSem===0||diaSem===6;
    let bgCls=esFinSem?'bg-slate-50':'bg-white'; if(esHoy) bgCls='bg-blue-50';
    const totalDia=Object.values(modsDia).reduce((s,grupos)=>s+Object.values(grupos).reduce((s2,arr)=>s2+arr.length,0),0);
    // Pills por mÃ³dulo â†’ pedido
    const pillsHtml=Object.entries(modsDia).flatMap(([key,grupos])=>
      Object.entries(grupos).map(([pedId,items])=>{
        const col=MOD_COLORS[key];
        const cliente=items[0].cliente||'â€”';
        const codigo=items[0].codigo||'â€”';
        const uds=items.length;
        const pedSafe=String(pedId).replace(/'/g,"\\'");
        return `<div class="pedido-pill ${col.pill} border ${col.border} rounded-md px-1.5 py-1 mb-0.5 text-[9px] leading-tight w-full flex justify-between items-start gap-1"
             draggable="true"
             data-modulo="${key}" data-pedido="${pedId}" data-fecha="${iso}"
             ondragstart="onPillDragStart(event)"
             ondragend="onPillDragEnd(event)">
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-1 mb-0.5">
              <span class="w-1.5 h-1.5 rounded-full ${col.dot} flex-shrink-0"></span>
              <span class="font-black truncate">Ped.${pedId}</span>
              <span class="font-black">${uds}u</span>
            </div>
            <div class="text-[8px] opacity-75 font-semibold truncate">${cliente}</div>
            <div class="text-[8px] opacity-55 font-mono truncate">${codigo}</div>
          </div>
          <button type="button" onclick="eliminarPedidoCal('${key}','${pedSafe}','${iso}',event)" class="flex-shrink-0 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded p-0.5 opacity-70 hover:opacity-100 text-[10px]" title="Eliminar">ğŸ—‘ï¸</button>
        </div>`;
      })
    ).join('');
    html+=`<div class="cal-cell ${bgCls} border-b border-r border-slate-100 p-1.5"
               data-iso="${iso}"
               ondragover="onCalCellDragOver(event,null)"
               ondragleave="onCalCellDragLeave(event)"
               ondrop="onCalCellDrop(event,null)">
      <div class="flex items-center justify-between mb-1">
        <span class="text-[11px] font-black ${esHoy?'bg-blue-600 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px]':esFinSem?'text-slate-300':'text-slate-700'}">${d}</span>
        ${totalDia?`<span class="text-[9px] font-black text-slate-400">${totalDia}</span>`:''}
      </div>
      ${pillsHtml}
    </div>`;
  }
  const resto=(offset+diasMes)%7; if(resto>0) for(let i=0;i<7-resto;i++) html+=`<div class="cal-cell bg-slate-50/30 border-b border-r border-slate-50"></div>`;
  document.getElementById('globalCalGrid').innerHTML=html;
}
window.cambiarMesGlobal=(dir)=>{ globalCal.month+=dir; if(globalCal.month>11){globalCal.month=0;globalCal.year++;} if(globalCal.month<0){globalCal.month=11;globalCal.year--;} globalCal.diaSeleccionado=null; document.getElementById('globalCalDetalle').classList.add('hidden'); renderGlobalCal(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG HANDLERS COMPARTIDOS
// â€” Estado global persiste aunque el calendario se rerenderice â€”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeDragEl = null;
const activeDragState = { modulo: null, pedido: null, fecha: null };

// Temporizador para cambio automÃ¡tico de mes al mantener sobre la zona de borde
const monthNavTimer = { id: null, calType: null, dir: 0 };

function clearMonthNavTimer(){
  if(monthNavTimer.id){ clearTimeout(monthNavTimer.id); monthNavTimer.id=null; }
}

// Avanza o retrocede el mes del calendario correcto y re-renderiza
function navMes(calType, dir){
  if(calType==='cal'){
    calState.month += dir;
    if(calState.month > 11){ calState.month=0; calState.year++; }
    if(calState.month < 0 ){ calState.month=11; calState.year--; }
    renderCalGrid();
  } else {
    globalCal.month += dir;
    if(globalCal.month > 11){ globalCal.month=0; globalCal.year++; }
    if(globalCal.month < 0 ){ globalCal.month=11; globalCal.year--; }
    renderGlobalCal();
  }
}

// Cuando el cursor entra en la zona de borde durante un drag
window.onNavDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect='move'; };

window.onMonthNavEnter = (e, calType, dir) => {
  e.preventDefault();
  const zoneId = dir < 0
    ? (calType==='cal' ? 'calNavLeft'    : 'globalNavLeft')
    : (calType==='cal' ? 'calNavRight'   : 'globalNavRight');
  document.getElementById(zoneId)?.classList.add('hovering');
  clearMonthNavTimer();
  // Cambia el mes tras 600 ms de espera, y luego cada 900 ms si sigue ahÃ­
  const fire = () => { navMes(calType, dir); monthNavTimer.id = setTimeout(fire, 900); };
  monthNavTimer.id = setTimeout(fire, 600);
};

// Cuando el cursor sale de la zona de borde
window.onMonthNavLeave = (e, zoneId) => {
  document.getElementById(zoneId)?.classList.remove('hovering');
  clearMonthNavTimer();
};

window.onPillDragStart = (e) => {
  activeDragEl = e.currentTarget;
  try{ activeDragEl.classList.add('dragging'); }catch(_){}
  const { modulo, pedido, fecha } = e.currentTarget.dataset;
  activeDragState.modulo = modulo;
  activeDragState.pedido = pedido;
  activeDragState.fecha  = fecha;
  e.dataTransfer.setData('text/plain', JSON.stringify({ modulo, pedido, fecha }));
  e.dataTransfer.effectAllowed = 'move';
  // Mostrar zonas de navegaciÃ³n en todos los calendarios visibles
  document.body.classList.add('is-dragging');
};

window.onPillDragEnd = (e) => {
  document.body.classList.remove('is-dragging');
  clearMonthNavTimer();
  document.querySelectorAll('.month-nav-zone').forEach(z=>z.classList.remove('hovering'));
  if(activeDragEl){ try{ activeDragEl.classList.remove('dragging'); }catch(_){} }
  activeDragEl = null;
  document.querySelectorAll('.cal-cell').forEach(c=>
    c.classList.remove('drop-target','drop-target-red','drop-target-orange','drop-target-sky'));
};

window.onCalCellDragOver = (e, moduloContexto) => {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const cell = e.currentTarget;
  const m = activeDragState.modulo;
  const colorCls = (m && MOD_COLORS[m]?.dropCls) || 'drop-target';
  document.querySelectorAll('.cal-cell').forEach(c=>
    c.classList.remove('drop-target','drop-target-red','drop-target-orange','drop-target-sky'));
  cell.classList.add(colorCls);
};

window.onCalCellDragLeave = (e) => {
  e.currentTarget.classList.remove('drop-target','drop-target-red','drop-target-orange','drop-target-sky');
};

window.onCalCellDrop = (e, moduloContexto) => {
  e.preventDefault();
  e.currentTarget.classList.remove('drop-target','drop-target-red','drop-target-orange','drop-target-sky');
  clearMonthNavTimer();
  const fechaDestino = e.currentTarget.dataset.iso;
  if(!fechaDestino) return;
  // Leer datos del drag â€” activeDragState es la fuente mÃ¡s fiable
  let { modulo, pedido, fecha: fechaOrigen } = activeDragState;
  if(!modulo || !pedido || !fechaOrigen){
    try{
      const raw = JSON.parse(e.dataTransfer.getData('text/plain'));
      modulo=raw.modulo; pedido=raw.pedido; fechaOrigen=raw.fecha;
    }catch(_){}
  }
  if(!modulo || !pedido || !fechaOrigen) return;
  if(fechaDestino === fechaOrigen) return;
  const movData = buildDragData(modulo, pedido, fechaOrigen);
  movData.fechaDestino = fechaDestino;
  mostrarConfirm(movData);
};

// Inicializar
renderGlobalCal();

// â”€â”€ TOGGLE POR FILA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleFila = (gi) => {
  if(seriesExcluidas.has(gi)) seriesExcluidas.delete(gi);
  else seriesExcluidas.add(gi);
  renderTabla();
  actualizarToggleMaestro();
};

window.toggleTodasFilas = () => {
  // Obtener Ã­ndices de todas las filas visibles no duplicadas
  const filtrados = diaActivo==='todos' ? pedidos : pedidos.filter(p=>(p.fecha||'sin-fecha')===diaActivo);
  const indices = filtrados.filter(p=>!p.esDuplicado).map(p=>pedidos.indexOf(p));
  const todasActivas = indices.every(gi=>!seriesExcluidas.has(gi));
  if(todasActivas) indices.forEach(gi=>seriesExcluidas.add(gi));
  else indices.forEach(gi=>seriesExcluidas.delete(gi));
  renderTabla();
  actualizarToggleMaestro();
};

function actualizarToggleMaestro(){
  const filtrados = diaActivo==='todos' ? pedidos : pedidos.filter(p=>(p.fecha||'sin-fecha')===diaActivo);
  const indices = filtrados.filter(p=>!p.esDuplicado).map(p=>pedidos.indexOf(p));
  const todasActivas = indices.length > 0 && indices.every(gi=>!seriesExcluidas.has(gi));
  const btn = document.getElementById('toggleMaestro');
  if(!btn) return;
  btn.className = `w-8 h-5 rounded-full flex items-center px-0.5 transition-colors ${todasActivas?'bg-emerald-500':'bg-slate-300'}`;
  btn.querySelector('div').className = `w-4 h-4 bg-white rounded-full shadow transition-all ${todasActivas?'ml-auto':'ml-0'}`;
}

// â”€â”€ TOGGLES MÃ“DULOS DESTINO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOGGLE_COLORS = {
  agitador:  { on:'bg-emerald-500', ring:'ring-emerald-300', text:'text-emerald-700', border:'border-emerald-300' },
  dostec40:  { on:'bg-red-500',     ring:'ring-red-300',     text:'text-red-700',     border:'border-red-300' },
  dostec50:  { on:'bg-orange-500',  ring:'ring-orange-300',  text:'text-orange-700',  border:'border-orange-300' },
  restyling: { on:'bg-sky-500',  ring:'ring-sky-300',  text:'text-sky-700',  border:'border-sky-300' }
};

function renderTogglesModulos(){
  // Calcular cuÃ¡ntas series hay por mÃ³dulo (no duplicadas)
  const conteo={};
  pedidos.filter(p=>p.moduloKey&&!p.esDuplicado).forEach(p=>{ conteo[p.moduloKey]=(conteo[p.moduloKey]||0)+1; });

  const container = document.getElementById('togglesModulos');
  if(!container) return;

  container.innerHTML = Object.entries(MODULOS).map(([key, mod])=>{
    const n = conteo[key]||0;
    if(!n) return ''; // no mostrar mÃ³dulos sin tareas
    const activo = modulosActivos.has(key);
    const col = TOGGLE_COLORS[key];
    return `<button id="toggle-mod-${key}"
      onclick="toggleModulo('${key}')"
      class="flex items-center gap-2.5 px-4 py-2.5 rounded-2xl border-2 font-black text-xs uppercase transition-all ${activo ? `${col.border} ${col.text} bg-white ring-2 ${col.ring}` : 'border-slate-200 text-slate-400 bg-slate-50'}">
      <!-- Toggle pill -->
      <div class="relative w-9 h-5 rounded-full transition-colors ${activo ? col.on : 'bg-slate-300'}">
        <div class="absolute top-0.5 ${activo ? 'left-5' : 'left-0.5'} w-4 h-4 bg-white rounded-full shadow transition-all"></div>
      </div>
      <span>${mod.label}</span>
      <span class="ml-1 ${activo ? 'opacity-100' : 'opacity-40'} font-black">${n}</span>
    </button>`;
  }).join('');
}

window.toggleModulo = (key) => {
  if(modulosActivos.has(key)) modulosActivos.delete(key);
  else modulosActivos.add(key);
  renderTogglesModulos();
  renderTabla(); // actualizar tabla (filas excluidas se marcan)
  actualizarBotonesEnvio();
};

window.selTodosModulos = () => {
  modulosActivos = new Set(Object.keys(MODULOS));
  renderTogglesModulos(); renderTabla(); actualizarBotonesEnvio();
};

window.selNingunoModulos = () => {
  modulosActivos = new Set();
  renderTogglesModulos(); renderTabla(); actualizarBotonesEnvio();
};

function actualizarBotonesEnvio(){
  const hayActivos = modulosActivos.size > 0;
  const btnTodo = document.getElementById('btnEnviarTodo');
  const btnDia  = document.getElementById('btnEnviarDia');
  if(btnTodo) btnTodo.disabled = !hayActivos;
  if(btnDia)  btnDia.disabled  = !hayActivos;
}

// Cerrar modal individual al clic fuera
document.getElementById('modalCal').addEventListener('click', e=>{ if(e.target===document.getElementById('modalCal')) cerrarCal(); });

// â”€â”€ MODAL VISTA MÃ“DULO (IFRAME) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.abrirModuloIframe = (moduloKey) => {
  const url = MOD_URLS[moduloKey];
  if(!url) return;
  const modal  = document.getElementById('modalModulo');
  const iframe = document.getElementById('iframeModulo');
  const titulo = document.getElementById('tituloModuloIframe');
  const link   = document.getElementById('linkModuloNuevaPestaÃ±a');
  const mod    = MODULOS[moduloKey];
  if(titulo) titulo.textContent = mod ? `${mod.label} â€” MÃ³dulo` : 'MÃ³dulo';
  if(iframe) iframe.src = url;
  if(link)   link.href  = url;
  if(modal){
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
};

window.cerrarModuloIframe = () => {
  const modal  = document.getElementById('modalModulo');
  const iframe = document.getElementById('iframeModulo');
  if(iframe) iframe.src = 'about:blank';
  if(modal){
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
};

document.getElementById('modalModulo').addEventListener('click', e=>{
  if(e.target===document.getElementById('modalModulo')) cerrarModuloIframe();
});
</script>
</body>
</html>
