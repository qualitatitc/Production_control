<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assemblies Production - Control de Tareas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmv0Pffo50nfrrovo77TEqbr-oDZRpIVY",
            authDomain: "aseemblies.firebaseapp.com",
            projectId: "aseemblies",
            storageBucket: "aseemblies.firebasestorage.app",
            messagingSenderId: "471809973242",
            appId: "1:471809973242:web:b784e7e3eb03411bc2a243",
            measurementId: "G-QG9B8NSZJR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tareasRef = ref(db, 'tareas');
        const tareasHistorialRef = ref(db, 'historial_tareas');
        const pausaRef = ref(db, 'estadoPausa');
        const incidenciaRef = ref(db, 'estadoIncidencia');
        const estadoLineaRef = ref(db, 'estadoLinea');
        const mantenimientoRef = ref(db, 'tareas_mantenimiento');
        const incidenciasTextoRef = ref(db, 'incidencias_texto');

        let estaPausadoGlobal = false;
        let hayIncidenciaGlobal = false;
        let lineaIniciada = false;
        let operarioLineaActiva = null;
        let inicioPausaMS = 0;
        let inicioIncidenciaMS = 0;

        function actualizarEstadoBotones() {
            const btnPausa = document.getElementById('btnPausa');
            const btnIncidencia = document.getElementById('btnIncidencia');
            const btnIniciarTarea = document.getElementById('btnIniciarTarea');
            const btnEntrada = document.getElementById('btnEntrada');
            const btnSalida = document.getElementById('btnSalida');
            const indicadorLinea = document.getElementById('indicadorLinea');
            
            if (lineaIniciada) {
                btnPausa.disabled = false;
                btnPausa.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnIncidencia.disabled = false;
                btnIncidencia.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnIniciarTarea.disabled = false;
                btnIniciarTarea.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnEntrada.disabled = true;
                btnEntrada.classList.add('opacity-50', 'cursor-not-allowed');
                btnSalida.disabled = false;
                btnSalida.classList.remove('opacity-50', 'cursor-not-allowed');
                
                indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg animate-pulse">üü¢ L√≠nea Activa</span>';
            } else {
                btnPausa.disabled = true;
                btnPausa.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnIncidencia.disabled = true;
                btnIncidencia.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnIniciarTarea.disabled = true;
                btnIniciarTarea.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnEntrada.disabled = false;
                btnEntrada.classList.remove('opacity-50', 'cursor-not-allowed');
                btnSalida.disabled = true;
                btnSalida.classList.add('opacity-50', 'cursor-not-allowed');
                
                indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>';
            }
        }

        const obtenerFecha = () => {
            const hoy = new Date();
            const dia = String(hoy.getDate()).padStart(2, '0');
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const anio = hoy.getFullYear();
            return `${dia}/${mes}/${anio}`;
        };

        function formatTime(ms) {
            if (!ms || ms < 0) return "0m 0s";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            return `${min}m ${seg}s`;
        }

        // ==========================================
        // EXPONER FUNCIONES AL WINDOW GLOBAL
        // ==========================================
        
        window.registrarJornada = async function(tipo) {
            console.log(`üöÄ registrarJornada llamado con tipo: ${tipo}`);
            console.log(`üìä Estado actual - lineaIniciada: ${lineaIniciada}`);
            
            const operario = document.getElementById('selectOperario').value;
            const esEntrada = tipo === 'INICIO';
            
            if (esEntrada && lineaIniciada) {
                alert('‚ö†Ô∏è La l√≠nea ya est√° activa. Debes registrar SALIDA primero.');
                return;
            }
            
            if (!esEntrada && !lineaIniciada) {
                alert('‚ö†Ô∏è La l√≠nea ya est√° parada. Debes registrar ENTRADA primero.');
                return;
            }

            if (!esEntrada && operarioLineaActiva && operario !== operarioLineaActiva) {
                alert(`‚ö†Ô∏è La l√≠nea fue iniciada por ${operarioLineaActiva}.\nSolo ese operario puede registrar la salida.`);
                return;
            }
            
            await ejecutarRegistroJornada(tipo);
        };

        async function ejecutarRegistroJornada(tipo) {
            console.log(`‚öôÔ∏è ejecutarRegistroJornada iniciado - tipo: ${tipo}`);
            
            const operario = document.getElementById('selectOperario').value;
            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            const esEntrada = tipo === 'INICIO';
            const ahora = Date.now();
            
            try {
                if (esEntrada) {
                    console.log('üü¢ Procesando ENTRADA...');
                    
                    // 1. Actualizar estado local PRIMERO
                    lineaIniciada = true;
                    operarioLineaActiva = operario;
                    console.log(`‚úÖ Estado local actualizado - lineaIniciada: ${lineaIniciada}, operario: ${operarioLineaActiva}`);
                    
                    // 2. Actualizar UI inmediatamente
                    actualizarEstadoBotones();
                    console.log('‚úÖ UI actualizada');
                    
                    // 3. Guardar ENTRADA en tabla temporal (tareas)
                    console.log('üíæ Guardando ENTRADA en tareasRef...');
                    const nuevaTareaRef = push(tareasRef);
                    await set(nuevaTareaRef, { 
                        operario: operario, 
                        codigo: "üü¢ ENTRADA", 
                        fecha: fechaActual, 
                        inicio: horaActual, 
                        fin: "---", 
                        total: "REGISTRO",
                        cantidad: 0,
                        estado: "finalizado", 
                        tipo: "jornada"
                    });
                    console.log(`‚úÖ ENTRADA guardada en tareas con ID: ${nuevaTareaRef.key}`);
                    
                    // 4. Guardar en historial
                    console.log('üíæ Guardando ENTRADA en historial...');
                    await push(tareasHistorialRef, {
                        operario: operario,
                        codigo: "üü¢ ENTRADA",
                        fecha: fechaActual,
                        inicio: horaActual,
                        fin: "---",
                        total: 0,
                        cantidad: 0,
                        tipo: "jornada",
                        timestamp: Date.now()
                    });
                    console.log('‚úÖ ENTRADA guardada en historial');
                    
                    // 5. Actualizar estado en Firebase
                    console.log('üíæ Actualizando estadoLineaRef...');
                    await update(estadoLineaRef, {
                        activa: true,
                        operario: operario,
                        horaInicio: horaActual,
                        fecha: fechaActual
                    });
                    console.log('‚úÖ estadoLineaRef actualizado');
                    
                    // 6. Reactivar tareas pausadas si las hay
                    const snapTareas = await get(tareasRef);
                    const tareas = snapTareas.val() || {};
                    const updates = {};
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "pausa_salida_linea") {
                            updates[`tareas/${id}/estado`] = "activo";
                            updates[`tareas/${id}/inicioMS`] = ahora;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(ref(db), updates);
                        console.log('‚úÖ Tareas pausadas reactivadas');
                    }
                    
                    alert('‚úÖ Entrada registrada correctamente');
                    
                } else {
                    // ES SALIDA
                    console.log('üî¥ Procesando SALIDA...');
                    
                    // 1. Pausar tareas activas primero
                    const snapTareas = await get(tareasRef);
                    const tareas = snapTareas.val() || {};
                    const updates = {};
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "activo") {
                            const acumuladoSesion = ahora - tareas[id].inicioMS;
                            updates[`tareas/${id}/estado`] = "pausa_salida_linea";
                            updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(ref(db), updates);
                        console.log('‚úÖ Tareas activas pausadas');
                    }
                    
                    // 2. Guardar SALIDA en tabla temporal
                    console.log('üíæ Guardando SALIDA en tareasRef...');
                    await push(tareasRef, { 
                        operario: operario, 
                        codigo: "üî¥ SALIDA", 
                        fecha: fechaActual, 
                        inicio: horaActual, 
                        fin: "---", 
                        total: "REGISTRO",
                        cantidad: 0,
                        estado: "finalizado", 
                        tipo: "jornada"
                    });
                    console.log('‚úÖ SALIDA guardada en tareas');
                    
                    // 3. Guardar en historial
                    console.log('üíæ Guardando SALIDA en historial...');
                    await push(tareasHistorialRef, {
                        operario: operario,
                        codigo: "üî¥ SALIDA",
                        fecha: fechaActual,
                        inicio: horaActual,
                        fin: "---",
                        total: 0,
                        cantidad: 0,
                        tipo: "jornada",
                        timestamp: Date.now()
                    });
                    console.log('‚úÖ SALIDA guardada en historial');
                    
                    // 4. Actualizar estado local
                    lineaIniciada = false;
                    operarioLineaActiva = null;
                    console.log(`‚úÖ Estado local actualizado - lineaIniciada: ${lineaIniciada}`);
                    
                    // 5. Actualizar UI
                    actualizarEstadoBotones();
                    console.log('‚úÖ UI actualizada');
                    
                    // 6. Actualizar Firebase
                    await update(estadoLineaRef, {
                        activa: false,
                        operario: null
                    });
                    console.log('‚úÖ estadoLineaRef actualizado');
                    
                    alert('‚úÖ Salida registrada correctamente');
                }
                
            } catch (error) {
                console.error("‚ùå Error al registrar:", error);
                alert("‚ùå Error al registrar: " + error.message);
            }
        }

        window.iniciarTarea = async function() {
            console.log('üöÄ iniciarTarea llamado');
            console.log(`üìä Estado - lineaIniciada: ${lineaIniciada}`);
            
            if (!lineaIniciada) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de iniciar tareas');
                return;
            }
            
            const operario = document.getElementById('selectOperario').value;
            const cod = document.getElementById('codigo').value.trim().toUpperCase();
            
            if (!cod) {
                alert('‚ö†Ô∏è Debes introducir un c√≥digo');
                return;
            }
            
            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            
            try {
                console.log(`üíæ Guardando tarea - Operario: ${operario}, C√≥digo: ${cod}`);
                
                await push(tareasRef, { 
                    operario: operario, 
                    codigo: cod, 
                    fecha: fechaActual, 
                    inicio: horaActual, 
                    inicioMS: Date.now(), 
                    acumuladoMS: 0, 
                    estado: "activo", 
                    tipo: "produccion",
                    cantidad: 0
                });
                
                console.log('‚úÖ Tarea guardada correctamente');
                
                document.getElementById('codigo').value = ''; 
                document.getElementById('codigo').focus();
                
            } catch (error) {
                console.error("‚ùå Error al iniciar tarea:", error);
                alert("‚ùå Error al iniciar tarea: " + error.message);
            }
        };

        window.toggleIncidencia = async function() {
            console.log('üöÄ toggleIncidencia llamado');
            
            if (!lineaIniciada && !hayIncidenciaGlobal) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de reportar incidencias');
                return;
            }
            
            const ahora = Date.now();
            const operario = document.getElementById('selectOperario').value;
            
            try {
                const snapTareas = await get(tareasRef);
                const tareas = snapTareas.val() || {};
                const updates = {};
                
                if (!hayIncidenciaGlobal) {
                    const motivo = prompt("Motivo de la incidencia:"); 
                    if (!motivo) return;
                    
                    await push(incidenciasTextoRef, {
                        descripcion: motivo.trim(),
                        fecha: obtenerFecha(),
                        timestamp: Date.now()
                    });
                    
                    await update(incidenciaRef, { 
                        activa: true, 
                        inicioMS: ahora, 
                        horaTexto: new Date().toLocaleTimeString('es-ES'), 
                        fecha: obtenerFecha(), 
                        motivo: motivo.trim(), 
                        operario: operario 
                    });
                    
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "activo") {
                            const acumuladoSesion = ahora - tareas[id].inicioMS;
                            updates[`tareas/${id}/estado`] = "pausa_incidencia";
                            updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                        }
                    });
                    
                    console.log('‚úÖ Incidencia iniciada');
                } else {
                    const snapI = await get(incidenciaRef);
                    const infoInc = snapI.val();
                    const horaFin = new Date().toLocaleTimeString('es-ES');
                    const duracion = Math.round((ahora - infoInc.inicioMS) / 60000) || 1;
                    
                    await push(tareasRef, { 
                        operario: infoInc.operario || "SISTEMA", 
                        codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`, 
                        fecha: infoInc.fecha, 
                        inicio: infoInc.horaTexto, 
                        fin: horaFin, 
                        total: duracion, 
                        cantidad: 0,
                        estado: "finalizado", 
                        tipo: "incidencia" 
                    });
                    
                    await push(tareasHistorialRef, {
                        operario: infoInc.operario || "SISTEMA",
                        codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`,
                        fecha: infoInc.fecha,
                        inicio: infoInc.horaTexto,
                        fin: horaFin,
                        total: duracion,
                        cantidad: 0,
                        tipo: "incidencia",
                        timestamp: Date.now()
                    });
                    
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "pausa_incidencia") { 
                            updates[`tareas/${id}/estado`] = "activo"; 
                            updates[`tareas/${id}/inicioMS`] = ahora; 
                        }
                    });
                    
                    await update(incidenciaRef, { activa: false, inicioMS: 0 });
                    console.log('‚úÖ Incidencia finalizada');
                }
                
                if (Object.keys(updates).length > 0) await update(ref(db), updates);
                
            } catch (error) {
                console.error("‚ùå Error en incidencia:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        window.togglePausa = async function() {
            console.log('üöÄ togglePausa llamado');
            
            if (!lineaIniciada && !estaPausadoGlobal) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de tomar desayuno');
                return;
            }
            
            const ahora = Date.now();
            const operario = document.getElementById('selectOperario').value;
            
            try {
                const snapTareas = await get(tareasRef);
                const tareas = snapTareas.val() || {};
                const updates = {};
                
                if (!estaPausadoGlobal) {
                    await update(pausaRef, { 
                        activa: true, 
                        inicioMS: ahora, 
                        horaTexto: new Date().toLocaleTimeString('es-ES'), 
                        fecha: obtenerFecha(), 
                        operario: operario 
                    });
                    
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "activo") {
                            const acumuladoSesion = ahora - tareas[id].inicioMS;
                            updates[`tareas/${id}/estado`] = "pausado_desayuno";
                            updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                        }
                    });
                    
                    console.log('‚úÖ Pausa (desayuno) iniciada');
                } else {
                    const snapP = await get(pausaRef);
                    const infoP = snapP.val();
                    const horaFin = new Date().toLocaleTimeString('es-ES');
                    const duracion = Math.round((ahora - infoP.inicioMS) / 60000) || 1;
                    
                    await push(tareasRef, { 
                        operario: infoP.operario || "SISTEMA", 
                        codigo: "‚òï DESAYUNO", 
                        fecha: infoP.fecha, 
                        inicio: infoP.horaTexto, 
                        fin: horaFin, 
                        total: duracion, 
                        cantidad: 0,
                        estado: "finalizado", 
                        tipo: "descanso" 
                    });
                    
                    await push(tareasHistorialRef, {
                        operario: infoP.operario || "SISTEMA",
                        codigo: "‚òï DESAYUNO",
                        fecha: infoP.fecha,
                        inicio: infoP.horaTexto,
                        fin: horaFin,
                        total: duracion,
                        cantidad: 0,
                        tipo: "descanso",
                        timestamp: Date.now()
                    });
                    
                    Object.keys(tareas).forEach(id => {
                        if (tareas[id].estado === "pausado_desayuno") { 
                            updates[`tareas/${id}/estado`] = "activo"; 
                            updates[`tareas/${id}/inicioMS`] = ahora; 
                        }
                    });
                    
                    await update(pausaRef, { activa: false, inicioMS: 0 });
                    console.log('‚úÖ Pausa (desayuno) finalizada');
                }
                
                if (Object.keys(updates).length > 0) await update(ref(db), updates);
                
            } catch (error) {
                console.error("‚ùå Error en pausa:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        window.forzarParadaLinea = async function() {
            console.log('üöÄ forzarParadaLinea llamado');
            
            const operario = document.getElementById('selectOperario').value;
            
            if (lineaIniciada && operarioLineaActiva && operario !== operarioLineaActiva) {
                alert(`‚ö†Ô∏è La l√≠nea fue iniciada por ${operarioLineaActiva}.\nSolo ese operario puede forzar la parada.`);
                return;
            }

            if (!confirm('‚õî ¬øForzar parada de l√≠nea?\n\nSe registrar√° una SALIDA ahora mismo.')) return;

            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            const ahora = Date.now();

            try {
                const snapTareas = await get(tareasRef);
                const tareas = snapTareas.val() || {};
                const updates = {};

                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_salida_linea";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
                
                if (Object.keys(updates).length > 0) await update(ref(db), updates);

                await push(tareasRef, {
                    operario: operario,
                    codigo: "‚õî ENTRADA FORZADA",
                    fecha: fechaActual,
                    inicio: horaActual,
                    fin: "---",
                    total: "REGISTRO",
                    estado: "finalizado",
                    tipo: "jornada",
                    cantidad: 0
                });

                await push(tareasRef, {
                    operario: operario,
                    codigo: "üî¥ SALIDA FORZADA",
                    fecha: fechaActual,
                    inicio: horaActual,
                    fin: "---",
                    total: "REGISTRO",
                    estado: "finalizado",
                    tipo: "jornada",
                    cantidad: 0
                });

                lineaIniciada = false;
                operarioLineaActiva = null;
                
                actualizarEstadoBotones();
                
                await update(estadoLineaRef, {
                    activa: false,
                    operario: null
                });
                
                console.log('‚úÖ Parada forzada ejecutada');
                alert('‚úÖ Parada forzada registrada');
                
            } catch (error) {
                console.error("‚ùå Error al forzar parada:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        window.finalizarTarea = async function(id) {
            console.log(`üöÄ finalizarTarea llamado - ID: ${id}`);
            
            const cantidad = prompt("¬øQu√© cantidad has montado?");
            if (cantidad === null) return;
            if (isNaN(cantidad) || cantidad === "") {
                alert("Por favor, introduce un n√∫mero v√°lido.");
                return;
            }
            
            try {
                const snap = await get(ref(db, `tareas/${id}`));
                const t = snap.val();
                let totalMS = (t.acumuladoMS || 0);
                if(t.estado === "activo") totalMS += (Date.now() - t.inicioMS);
                
                const tiempoTotal = Math.max(1, Math.round(totalMS / 60000));
                const horaFin = new Date().toLocaleTimeString('es-ES');
                
                await update(ref(db, `tareas/${id}`), { 
                    fin: horaFin, 
                    total: tiempoTotal, 
                    cantidad: parseInt(cantidad),
                    estado: "finalizado" 
                });
                
                await push(tareasHistorialRef, {
                    operario: t.operario,
                    codigo: t.codigo,
                    fecha: t.fecha,
                    inicio: t.inicio,
                    fin: horaFin,
                    total: tiempoTotal,
                    cantidad: parseInt(cantidad),
                    tipo: "produccion",
                    timestamp: Date.now()
                });
                
                console.log('‚úÖ Tarea finalizada');
                
            } catch (error) {
                console.error("‚ùå Error al finalizar tarea:", error);
                alert("‚ùå Error: " + error.message);
            }
        };

        window.borrarTarea = async function(id) {
            console.log(`üöÄ borrarTarea llamado - ID: ${id}`);
            if (confirm('¬øBorrar tarea de la tabla temporal?')) {
                try {
                    await remove(ref(db, `tareas/${id}`));
                    console.log('‚úÖ Tarea borrada');
                } catch (error) {
                    console.error("‚ùå Error al borrar:", error);
                }
            }
        };
        
        window.borrarTodoElRegistro = async function() {
            console.log('üöÄ borrarTodoElRegistro llamado');
            if (confirm("¬øBORRAR TODA LA TABLA TEMPORAL?\n\nLos datos del historial NO se borrar√°n.")) {
                try {
                    await remove(tareasRef);
                    console.log('‚úÖ Tabla temporal borrada');
                } catch (error) {
                    console.error("‚ùå Error al borrar todo:", error);
                }
            }
        };

        window.borrarHistorialGrafico = async function() {
            console.log('üöÄ borrarHistorialGrafico llamado');
            if (confirm("‚ö†Ô∏è ¬øBORRAR PERMANENTEMENTE EL HISTORIAL?\n\nEsto borrar√° todos los datos hist√≥ricos.")) {
                try {
                    await remove(tareasHistorialRef);
                    console.log('‚úÖ Historial borrado');
                } catch (error) {
                    console.error("‚ùå Error al borrar historial:", error);
                }
            }
        };

        window.agregarMantenimiento = async function() {
            console.log('üöÄ agregarMantenimiento llamado');
            const descripcion = prompt("Descripci√≥n de la tarea de mantenimiento:");
            if (!descripcion || !descripcion.trim()) return;
            
            try {
                await push(mantenimientoRef, {
                    descripcion: descripcion.trim(),
                    fecha: obtenerFecha(),
                    completada: false,
                    timestamp: Date.now()
                });
                console.log('‚úÖ Mantenimiento a√±adido');
            } catch (error) {
                console.error("‚ùå Error:", error);
            }
        };

        window.completarMantenimiento = async function(id) {
            console.log(`üöÄ completarMantenimiento llamado - ID: ${id}`);
            if (!confirm('¬øMarcar tarea como realizada?')) return;
            
            try {
                const tareaRef = ref(db, `tareas_mantenimiento/${id}`);
                await update(tareaRef, { 
                    completada: true,
                    fechaCompletada: obtenerFecha(),
                    horaCompletada: new Date().toLocaleTimeString('es-ES')
                });
                console.log('‚úÖ Mantenimiento completado');
            } catch (error) {
                console.error("‚ùå Error:", error);
            }
        };

        window.borrarMantenimiento = async function(id) {
            console.log(`üöÄ borrarMantenimiento llamado - ID: ${id}`);
            if (!confirm('¬øEliminar esta tarea de mantenimiento?')) return;
            
            try {
                await remove(ref(db, `tareas_mantenimiento/${id}`));
                console.log('‚úÖ Mantenimiento borrado');
            } catch (error) {
                console.error("‚ùå Error:", error);
            }
        };

        window.borrarIncidenciaTexto = async function(id) {
            console.log(`üöÄ borrarIncidenciaTexto llamado - ID: ${id}`);
            if (!confirm('¬øEliminar esta incidencia?')) return;
            
            try {
                await remove(ref(db, `incidencias_texto/${id}`));
                console.log('‚úÖ Incidencia borrada');
            } catch (error) {
                console.error("‚ùå Error:", error);
            }
        };

        window.handleKeyPress = function(e, nextId) { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (nextId) document.getElementById(nextId).focus(); 
                else window.iniciarTarea(); 
            } 
        };
        
        window.exportarExcel = function() { 
            try {
                XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tablaProduccion")), "Assemblies_Production.xlsx");
                console.log('‚úÖ Excel exportado');
            } catch (error) {
                console.error("‚ùå Error al exportar:", error);
            }
        };

        window.togglePausaTarea = async function(id) {
            console.log(`üöÄ togglePausaTarea llamado - ID: ${id}`);
            const ahora = Date.now();
            
            try {
                const snap = await get(ref(db, `tareas/${id}`));
                const t = snap.val();
                
                if (t.estado === "activo") {
                    const nuevoAcumulado = (t.acumuladoMS || 0) + (ahora - t.inicioMS);
                    await update(ref(db, `tareas/${id}`), { 
                        estado: "pausa_manual", 
                        acumuladoMS: nuevoAcumulado 
                    });
                    console.log('‚úÖ Tarea pausada');
                } else if (t.estado === "pausa_manual") {
                    await update(ref(db, `tareas/${id}`), { 
                        estado: "activo", 
                        inicioMS: ahora 
                    });
                    console.log('‚úÖ Tarea reanudada');
                }
            } catch (error) {
                console.error("‚ùå Error:", error);
            }
        };

        // ==========================================
        // LISTENERS DE FIREBASE
        // ==========================================

        onValue(mantenimientoRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoMantenimiento');
            cuerpo.innerHTML = "";
            const datos = snapshot.val();
            
            if (!datos) {
                cuerpo.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">No hay tareas de mantenimiento</td></tr>';
                return;
            }
            
            const tareasPendientes = [];
            const tareasCompletadas = [];
            
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                if (t.completada) {
                    tareasCompletadas.push({ id, ...t });
                } else {
                    tareasPendientes.push({ id, ...t });
                }
            });
            
            tareasPendientes.sort((a, b) => b.timestamp - a.timestamp);
            tareasCompletadas.sort((a, b) => b.timestamp - a.timestamp);
            
            tareasPendientes.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-white border-b border-slate-100 hover:bg-blue-50 transition-all">
                        <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
                        <td class="p-4 text-slate-800 font-semibold">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                                ${t.descripcion}
                            </span>
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="completarMantenimiento('${t.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase shadow-sm transition-colors">
                                ‚úì Realizada
                            </button>
                            <button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
            
            tareasCompletadas.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-green-50 border-b border-slate-100 opacity-60">
                        <td class="p-4 text-slate-500 font-medium text-sm line-through">${t.fecha}</td>
                        <td class="p-4 text-slate-600 font-semibold line-through">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                ${t.descripcion}
                            </span>
                            <div class="text-xs text-green-600 mt-1">‚úì Completada el ${t.fechaCompletada} a las ${t.horaCompletada}</div>
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        onValue(incidenciasTextoRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoIncidencias');
            cuerpo.innerHTML = "";
            const datos = snapshot.val();
            
            if (!datos) {
                cuerpo.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-slate-400 italic">No hay incidencias registradas</td></tr>';
                return;
            }
            
            const incidenciasArray = Object.keys(datos).map(id => ({ id, ...datos[id] }));
            incidenciasArray.sort((a, b) => b.timestamp - a.timestamp);
            
            incidenciasArray.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-white border-b border-slate-100 hover:bg-red-50 transition-all">
                        <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
                        <td class="p-4 text-slate-800 font-semibold">${t.descripcion}</td>
                    </tr>`;
            });
        });

        onValue(tareasRef, (snapshot) => {
            console.log('üìä onValue tareasRef disparado');
            const cuerpo = document.getElementById('cuerpoTabla'); 
            cuerpo.innerHTML = "";
            const datos = snapshot.val(); 
            
            console.log(`üìä Datos recibidos: ${datos ? Object.keys(datos).length : 0} tareas`);
            
            if (!datos) return;
            
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                const activo = t.estado === "activo";
                let rowClass = "bg-white";
                if(activo) rowClass = "bg-amber-50";
                if(t.estado === "pausa_manual") rowClass = "bg-blue-50";
                if(t.estado === "pausa_salida_linea") rowClass = "bg-purple-50";
                if(t.estado === "pausa_incidencia") rowClass = "bg-red-50";
                if(t.estado === "pausado_desayuno") rowClass = "bg-orange-50";

                let tiempoMostrado;
                if (activo) {
                    tiempoMostrado = `<span class="contador-vivo text-amber-600" data-inicio="${t.inicioMS}" data-acumulado="${t.acumuladoMS}">...</span>`;
                } else if (t.estado === "pausa_manual") {
                    tiempoMostrado = `<span class="text-blue-500 italic">‚è∏Ô∏è ${formatTime(t.acumuladoMS)}</span>`;
                } else if (t.estado === "pausa_salida_linea") {
                    tiempoMostrado = `<span class="text-purple-500 italic">üö™ L√≠nea Parada</span>`;
                } else if (t.estado === "pausa_incidencia") {
                    tiempoMostrado = `<span class="text-red-400 italic">üõ†Ô∏è En Incidencia</span>`;
                } else if (t.estado === "pausado_desayuno") {
                    tiempoMostrado = `<span class="text-orange-400 italic">‚òï En Desayuno</span>`;
                } else if (t.tipo === 'jornada') {
                    tiempoMostrado = `<span class="text-slate-500 font-bold text-xs">REGISTRO</span>`;
                } else {
                    tiempoMostrado = `${t.total} min`;
                }

                const cantidadMostrada = t.cantidad > 0 ? t.cantidad : '-';

                cuerpo.innerHTML += `
                    <tr class="${rowClass} border-b border-slate-100 transition-all">
                        <td class="p-4 font-bold text-slate-700">${t.operario}</td>
                        <td class="p-4 text-slate-600 font-medium">${t.fecha || '-'}</td>
                        <td class="p-4 font-bold text-slate-800">${t.codigo}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.inicio}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.fin || '--:--'}</td>
                        <td class="p-4 font-black text-center">${tiempoMostrado}</td>
                        <td class="p-4 font-bold text-center text-slate-700">${cantidadMostrada}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            ${activo ? `
                                <button onclick="finalizarTarea('${id}')" class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">Fin</button>
                            ` : (t.estado && t.estado.includes('pausa_') ? '‚è∏Ô∏è' : '‚úì')}
                            <button onclick="borrarTarea('${id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        onValue(incidenciaRef, s => {
            const d = s.val(); 
            hayIncidenciaGlobal = d?.activa || false; 
            inicioIncidenciaMS = d?.inicioMS || 0;
            document.getElementById('btnIncidencia').innerHTML = hayIncidenciaGlobal ? "üõ†Ô∏è SOLUCIONAR" : "üö® INCIDENCIA";
            document.getElementById('cajaIncidencia').classList.toggle('hidden', !hayIncidenciaGlobal);
            actualizarEstadoBotones();
        });
        
        onValue(pausaRef, s => {
            const d = s.val(); 
            estaPausadoGlobal = d?.activa || false; 
            inicioPausaMS = d?.inicioMS || 0;
            document.getElementById('btnPausa').innerHTML = estaPausadoGlobal ? "‚òï VOLVER" : "ü•ê DESAYUNO";
            document.getElementById('cajaDesayuno').classList.toggle('hidden', !estaPausadoGlobal);
            actualizarEstadoBotones();
        });

        onValue(estadoLineaRef, s => {
            console.log('üìä onValue estadoLineaRef disparado');
            const d = s.val();
            
            if (d) {
                lineaIniciada = d.activa || false;
                operarioLineaActiva = d.operario || null;
            } else {
                lineaIniciada = false;
                operarioLineaActiva = null;
            }
            
            console.log(`üìä Estado l√≠nea - Activa: ${lineaIniciada}, Operario: ${operarioLineaActiva}`);
            actualizarEstadoBotones();
        });

        // Inicializar UI
        console.log('üöÄ Aplicaci√≥n inicializada');
        actualizarEstadoBotones();
    </script>
<base target="_blank">
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs uppercase transition-colors flex items-center gap-2">
                    ‚Üê Volver
                </a>
                <h1 class="text-4xl font-black uppercase italic tracking-tighter">Assemblies <span class="text-blue-600">Production</span></h1>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <div id="cajaIncidencia" class="hidden bg-red-100 p-2 rounded-xl text-right"><span id="tiempoIncidencia" class="font-mono font-bold text-red-700"></span></div>
                <div id="cajaDesayuno" class="hidden bg-orange-100 p-2 rounded-xl text-right"><span id="tiempoDesayuno" class="font-mono font-bold text-orange-700"></span></div>
                
                <button id="btnIncidencia" class="bg-rose-100 text-rose-600 px-4 py-2 rounded-xl font-bold text-xs">üö® INCIDENCIA</button>
                <button id="btnPausa" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs">ü•ê DESAYUNO</button>
                <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase">Exportar a Excel</button>
            </div>
        </div>

        <!-- Botones Entrada/Salida -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="btnEntrada" class="bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-emerald-600 transition-colors">‚òÄÔ∏è Entrada</button>
            <button id="btnSalida" class="bg-rose-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-rose-600 transition-colors opacity-50 cursor-not-allowed" disabled>üåô Salida</button>
        </div>

        <!-- Formulario Nueva Tarea -->
        <div class="bg-white rounded-[2rem] shadow-xl p-6 mb-8 border-b-4 border-blue-500 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Operario Actual</label>
                <select id="selectOperario" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    <option>Ekain</option>
                    <option>Alfredo</option>
                    <option>Sergio</option>
                    <option>Aitor</option>
                    <option>Jordi</option>
                    <option>Miki</option>
                    <option>Albert</option>
                    <option>Adrian</option>
                    <option>Carol</option>
                    <option>Jona</option>
                </select>
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">C√≥digo</label>
                <input id="codigo" type="text" onkeypress="handleKeyPress(event, null)" oninput="this.value = this.value.toUpperCase()" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500 uppercase">
            </div>
            <button id="btnIniciarTarea" class="bg-blue-600 text-white font-black rounded-xl h-[56px] mt-5 hover:bg-slate-900 transition-all uppercase italic">Iniciar</button>
        </div>

        <!-- Indicador Estado L√≠nea -->
        <div id="indicadorLinea" class="flex justify-center mb-6">
            <span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>
        </div>

        <!-- TABLA TEMPORAL -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200 mb-8">
            <div class="bg-slate-900 p-4 flex justify-between items-center">
                <h3 class="text-blue-400 font-black uppercase text-sm">Tabla de Tareas (Temporal)</h3>
                <span class="text-slate-400 text-xs">Se puede borrar sin afectar el historial</span>
            </div>
            <table id="tablaProduccion" class="w-full text-left">
                <thead class="bg-slate-800 text-blue-400 text-[10px] font-black uppercase">
                    <tr>
                        <th class="p-4">Operario</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">C√≥digo</th>
                        <th class="p-4">H. Inicio</th>
                        <th class="p-4">H. Fin</th>
                        <th class="p-4 text-center">Tiempo</th>
                        <th class="p-4 text-center">Cantidad</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <!-- BOT√ìN FORZAR PARADA -->
        <div class="flex justify-end mb-6">
            <button onclick="forzarParadaLinea()" id="btnForzarParada" class="bg-slate-700 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl font-black text-xs uppercase shadow flex items-center gap-2 transition-colors">
                ‚õî Forzar Parada de L√≠nea
            </button>
        </div>

        <!-- TABLAS DE MANTENIMIENTO E INCIDENCIAS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
            <!-- TABLA MANTENIMIENTO -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-blue-200">
                <div class="bg-blue-500 p-4 flex items-center justify-between">
                    <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">
                        üîß Mantenimiento
                    </h3>
                    <button onclick="agregarMantenimiento()" class="bg-white text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg font-black text-xs uppercase shadow-sm transition-colors flex items-center gap-1">
                        + A√±adir tarea
                    </button>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-blue-100 text-blue-800 text-[10px] font-black uppercase sticky top-0">
                            <tr>
                                <th class="p-4 w-32">Fecha</th>
                                <th class="p-4">Descripci√≥n</th>
                                <th class="p-4 text-right w-40">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoMantenimiento" class="divide-y divide-slate-100">
                            <tr><td colspan="3" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TABLA INCIDENCIAS -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-orange-200">
                <div class="bg-orange-500 p-4">
                    <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">
                        ‚ö†Ô∏è Registro de Incidencias
                    </h3>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-orange-100 text-orange-800 text-[10px] font-black uppercase sticky top-0">
                            <tr>
                                <th class="p-4 w-32">Fecha</th>
                                <th class="p-4">Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoIncidencias" class="divide-y divide-slate-100">
                            <tr><td colspan="2" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para asignar event listeners despu√©s de que el DOM est√© listo -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã DOM cargado, asignando event listeners...');
            
            // Asignar eventos a botones principales
            document.getElementById('btnEntrada').onclick = function() {
                window.registrarJornada('INICIO');
            };
            
            document.getElementById('btnSalida').onclick = function() {
                window.registrarJornada('FIN');
            };
            
            document.getElementById('btnIniciarTarea').onclick = function() {
                window.iniciarTarea();
            };
            
            document.getElementById('btnIncidencia').onclick = function() {
                window.toggleIncidencia();
            };
            
            document.getElementById('btnPausa').onclick = function() {
                window.togglePausa();
            };
            
            console.log('‚úÖ Event listeners asignados');
        });
    </script>
</body>
</html>