<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dosmart Production - Control de Tareas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCl2FTFnVh0QbAzwQS_hrGbbXcn3O1MsVw",
            authDomain: "dosmart-2f395.firebaseapp.com",
            databaseURL: "https://dosmart-2f395-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dosmart-2f395",
            storageBucket: "dosmart-2f395.appspot.com",
            appId: "1:854942502621:web:5c1a7428f7492c3a382664"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tareasRef = ref(db, 'tareas');
        const tareasHistorialRef = ref(db, 'historial_tareas');
        const pausaRef = ref(db, 'estadoPausa');
        const incidenciaRef = ref(db, 'estadoIncidencia');
        const reposicionRef = ref(db, 'estadoReposicion');

        let estaPausadoGlobal = false;
        let hayIncidenciaGlobal = false;
        let hayReposicionGlobal = false;
        let inicioPausaMS = 0;
        let inicioIncidenciaMS = 0;
        let inicioReposicionMS = 0;
        let chartInstance = null;
        let chartProductividad = null;
        let todasLasTareas = {};

        const obtenerFecha = () => new Date().toLocaleDateString('es-ES');
        const obtenerOperarioActual = () => document.getElementById('selectOperario').value;

        function formatTime(ms) {
            if (!ms || ms < 0) return "0m 0s";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            return `${min}m ${seg}s`;
        }

        function convertirFechaHTML(fechaHTML) {
            const partes = fechaHTML.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        function convertirHoraAMinutos(horaStr) {
            if (!horaStr || horaStr === '--:--' || horaStr === '---') return 0;
            const [horas, minutos, segundos] = horaStr.split(':').map(Number);
            if (isNaN(horas) || isNaN(minutos)) return 0;
            return horas * 60 + minutos + (segundos || 0) / 60;
        }

        function parsearFecha(fechaStr) {
            if (!fechaStr || !fechaStr.includes('/')) return null;
            const [dia, mes, anio] = fechaStr.split('/').map(Number);
            return new Date(anio, mes - 1, dia);
        }

        // GR√ÅFICO 1: TAREAS INDIVIDUALES - Muestra cada tarea con su tiempo
        function actualizarGraficoPuntos(fechaFiltro = null) {
            const tareasAdrian = [];
            const tareasAlberto = [];
            
            if (todasLasTareas) {
                // Filtrar solo tareas de producci√≥n finalizadas
                const tareasProduccion = Object.entries(todasLasTareas)
                    .filter(([id, t]) => {
                        // Debe ser producci√≥n y tener tiempo num√©rico v√°lido
                        const esProduccion = t.tipo === 'produccion';
                        const tieneTiempo = t.total && !isNaN(parseInt(t.total)) && parseInt(t.total) > 0;
                        const cumpleFecha = !fechaFiltro || t.fecha === fechaFiltro;
                        return esProduccion && tieneTiempo && cumpleFecha;
                    })
                    .map(([id, t]) => ({
                        id: id,
                        ...t,
                        tiempoNum: parseInt(t.total),
                        horaMinutos: convertirHoraAMinutos(t.inicio)
                    }));
                
                // Ordenar por hora de inicio
                tareasProduccion.sort((a, b) => a.horaMinutos - b.horaMinutos);
                
                // Asignar √≠ndice secuencial a cada tarea
                tareasProduccion.forEach((t, index) => {
                    const punto = {
                        x: index, // √çndice de la tarea en orden cronol√≥gico
                        y: t.tiempoNum, // Tiempo en minutos (eje Y)
                        tarea: t.codigo,
                        serie: t.numSerie,
                        hora: t.inicio,
                        fecha: t.fecha,
                        firebaseId: t.id,
                        operario: t.operario
                    };
                    
                    if (t.operario === 'Adrian Garc√≠a') {
                        tareasAdrian.push(punto);
                    } else if (t.operario === 'Alberto Colmenero') {
                        tareasAlberto.push(punto);
                    }
                });
            }

            const ctx = document.getElementById('graficoTareas').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Si no hay datos, mostrar mensaje
            if (tareasAdrian.length === 0 && tareasAlberto.length === 0) {
                document.getElementById('contadorTareas').textContent = 
                    fechaFiltro ? `Sin datos para ${fechaFiltro}` : 'Sin tareas en el historial';
            } else {
                const totalTareas = tareasAdrian.length + tareasAlberto.length;
                document.getElementById('contadorTareas').textContent = 
                    fechaFiltro ? `${totalTareas} tareas el ${fechaFiltro}` : `${totalTareas} tareas totales`;
            }

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Adrian Garc√≠a',
                            data: tareasAdrian,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12
                        },
                        {
                            label: 'Alberto Colmenero',
                            data: tareasAlberto,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e) => {
                        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const datasetIndex = firstPoint.datasetIndex;
                            const index = firstPoint.index;
                            const dataset = chartInstance.data.datasets[datasetIndex];
                            const punto = dataset.data[index];
                            mostrarModalEliminar(punto);
                        }
                    },
                    onHover: (e, activeElements) => {
                        e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Tarea #${context[0].parsed.x + 1}`;
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    const operario = context.datasetIndex === 0 ? 'Adrian' : 'Alberto';
                                    return [
                                        `Operario: ${operario}`,
                                        `Tarea: ${point.tarea}`,
                                        `Serie: ${point.serie}`,
                                        `Hora: ${point.hora}`,
                                        `Tiempo: ${point.y} minutos`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { 
                                display: true, 
                                text: 'N√∫mero de tarea (orden cronol√≥gico)',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + 1;
                                }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tiempo (minutos)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        // GR√ÅFICO 2: PRODUCTIVIDAD MENSUAL
        function calcularProductividadMes(anio, mes) {
            const diasDelMes = new Date(anio, mes, 0).getDate();
            const datosAdrian = new Array(diasDelMes).fill(null);
            const datosAlberto = new Array(diasDelMes).fill(null);
            
            const tareasPorDia = {};
            const jornadasPorDia = {};
            
            if (todasLasTareas) {
                Object.values(todasLasTareas).forEach(t => {
                    const fecha = parsearFecha(t.fecha);
                    if (!fecha) return;
                    
                    if (fecha.getFullYear() === anio && fecha.getMonth() === mes - 1) {
                        const dia = fecha.getDate();
                        const key = `${dia}-${t.operario}`;
                        
                        if (t.tipo === 'produccion') {
                            if (!tareasPorDia[key]) tareasPorDia[key] = 0;
                            tareasPorDia[key]++;
                        } else if (t.tipo === 'jornada') {
                            if (!jornadasPorDia[key]) jornadasPorDia[key] = {};
                            if (t.codigo && t.codigo.includes('ENTRADA')) {
                                jornadasPorDia[key].entrada = t.inicio;
                            } else if (t.codigo && t.codigo.includes('SALIDA')) {
                                jornadasPorDia[key].salida = t.inicio;
                            }
                        }
                    }
                });
            }
            
            for (let dia = 1; dia <= diasDelMes; dia++) {
                // Adrian
                const keyAdrian = `${dia}-Adrian Garc√≠a`;
                const tareasAdrianCount = tareasPorDia[keyAdrian] || 0;
                const jornadaAdrian = jornadasPorDia[keyAdrian] || {};
                
                if (jornadaAdrian.entrada && jornadaAdrian.salida && tareasAdrianCount > 0) {
                    const entradaMin = convertirHoraAMinutos(jornadaAdrian.entrada);
                    const salidaMin = convertirHoraAMinutos(jornadaAdrian.salida);
                    const horasTrabajadas = (salidaMin - entradaMin) / 60;
                    
                    if (horasTrabajadas > 0) {
                        datosAdrian[dia - 1] = (tareasAdrianCount * 7) / horasTrabajadas;
                    }
                }
                
                // Alberto
                const keyAlberto = `${dia}-Alberto Colmenero`;
                const tareasAlbertoCount = tareasPorDia[keyAlberto] || 0;
                const jornadaAlberto = jornadasPorDia[keyAlberto] || {};
                
                if (jornadaAlberto.entrada && jornadaAlberto.salida && tareasAlbertoCount > 0) {
                    const entradaMin = convertirHoraAMinutos(jornadaAlberto.entrada);
                    const salidaMin = convertirHoraAMinutos(jornadaAlberto.salida);
                    const horasTrabajadas = (salidaMin - entradaMin) / 60;
                    
                    if (horasTrabajadas > 0) {
                        datosAlberto[dia - 1] = (tareasAlbertoCount * 7) / horasTrabajadas;
                    }
                }
            }
            
            return { datosAdrian, datosAlberto, diasDelMes };
        }

        function actualizarGraficoProductividad() {
            const anio = parseInt(document.getElementById('selectAnioProductividad').value);
            const mes = parseInt(document.getElementById('selectMesProductividad').value);
            
            const { datosAdrian, datosAlberto, diasDelMes } = calcularProductividadMes(anio, mes);
            
            const todosLosValores = [...datosAdrian, ...datosAlberto].filter(v => v !== null && !isNaN(v));
            const media = todosLosValores.length > 0 ? 
                todosLosValores.reduce((a, b) => a + b, 0) / todosLosValores.length : 0;
            
            const lineaMedia = new Array(diasDelMes).fill(media);
            const labels = Array.from({length: diasDelMes}, (_, i) => `D√≠a ${i + 1}`);
            
            const ctx = document.getElementById('graficoProductividad').getContext('2d');
            
            if (chartProductividad) {
                chartProductividad.destroy();
            }

            chartProductividad = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Media',
                            data: lineaMedia,
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            order: 1
                        },
                        {
                            label: 'Adrian Garc√≠a',
                            data: datosAdrian,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: '#3b82f6',
                            fill: false,
                            tension: 0.3,
                            spanGaps: true,
                            order: 2
                        },
                        {
                            label: 'Alberto Colmenero',
                            data: datosAlberto,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: '#ef4444',
                            fill: false,
                            tension: 0.3,
                            spanGaps: true,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null || isNaN(value)) return `${context.dataset.label}: Sin datos`;
                                    return `${context.dataset.label}: ${value.toFixed(2)} tareas/hora`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: 'D√≠as del mes', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Productividad (tareas√ó7 / horas)', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } }
                    }
                }
            });

            const diasConDatos = todosLosValores.length > 0 ? Math.ceil(todosLosValores.length / 2) : 0;
            document.getElementById('mediaProductividad').textContent = `Media del mes: ${media.toFixed(2)}`;
            document.getElementById('diasConDatos').textContent = `D√≠as con datos: ${diasConDatos}`;
        }

        window.cambiarMesProductividad = function() {
            actualizarGraficoProductividad();
        };

        window.mostrarModalEliminar = function(punto) {
            const modal = document.getElementById('modalEliminar');
            const info = document.getElementById('infoTareaEliminar');
            const btnEliminar = document.getElementById('btnConfirmarEliminar');
            
            const colorOperario = punto.operario === 'Adrian Garc√≠a' ? 'text-blue-600' : 'text-red-600';
            
            info.innerHTML = `
                <div class="space-y-2">
                    <p><span class="font-bold text-slate-600">Operario:</span> <span class="${colorOperario} font-bold">${punto.operario}</span></p>
                    <p><span class="font-bold text-slate-600">Tarea:</span> ${punto.tarea}</p>
                    <p><span class="font-bold text-slate-600">Serie:</span> ${punto.serie}</p>
                    <p><span class="font-bold text-slate-600">Fecha:</span> ${punto.fecha}</p>
                    <p><span class="font-bold text-slate-600">Hora:</span> ${punto.hora}</p>
                    <p><span class="font-bold text-slate-600">Tiempo:</span> ${punto.y} minutos</p>
                </div>
            `;
            
            btnEliminar.onclick = () => eliminarPuntoGrafico(punto.firebaseId);
            modal.classList.remove('hidden');
        };

        window.cerrarModalEliminar = function() {
            document.getElementById('modalEliminar').classList.add('hidden');
        };

        window.eliminarPuntoGrafico = async function(firebaseId) {
            if (!confirm('¬øEst√°s seguro de eliminar este punto del historial?')) return;
            try {
                await remove(ref(db, `historial_tareas/${firebaseId}`));
                cerrarModalEliminar();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        window.filtrarPorFecha = function() {
            const fechaInput = document.getElementById('filtroFecha').value;
            if (fechaInput) {
                actualizarGraficoPuntos(convertirFechaHTML(fechaInput));
            } else {
                actualizarGraficoPuntos(null);
            }
        };

        window.mostrarTodas = function() {
            document.getElementById('filtroFecha').value = '';
            actualizarGraficoPuntos(null);
        };

        setInterval(() => {
            const ahora = Date.now();
            if (!estaPausadoGlobal && !hayIncidenciaGlobal && !hayReposicionGlobal) {
                document.querySelectorAll('.contador-vivo').forEach(el => {
                    const inicioMS = parseInt(el.dataset.inicio);
                    const acumuladoPrevio = parseInt(el.dataset.acumulado || 0);
                    el.innerText = formatTime((ahora - inicioMS) + acumuladoPrevio);
                });
            }
            if (estaPausadoGlobal) {
                const caja = document.getElementById('tiempoDesayuno');
                if(caja) caja.innerText = formatTime(ahora - inicioPausaMS);
            }
            if (hayIncidenciaGlobal) {
                const cajaInc = document.getElementById('tiempoIncidencia');
                if(cajaInc) cajaInc.innerText = formatTime(ahora - inicioIncidenciaMS);
            }
            if (hayReposicionGlobal) {
                const cajaRep = document.getElementById('tiempoReposicion');
                if(cajaRep) cajaRep.innerText = formatTime(ahora - inicioReposicionMS);
            }
        }, 1000);

        window.togglePausaTarea = async function(id) {
            const ahora = Date.now();
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            if (t.estado === "activo") {
                const nuevoAcumulado = (t.acumuladoMS || 0) + (ahora - t.inicioMS);
                update(ref(db, `tareas/${id}`), { estado: "pausa_manual", acumuladoMS: nuevoAcumulado });
            } else if (t.estado === "pausa_manual") {
                update(ref(db, `tareas/${id}`), { estado: "activo", inicioMS: ahora });
            }
        };

        // FINALIZAR TAREA - Guarda en historial
        window.finalizarTarea = async function(id) {
            if(!confirm('¬øFinalizar tarea?')) return;
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            let totalMS = (t.acumuladoMS || 0);
            if(t.estado === "activo") totalMS += (Date.now() - t.inicioMS);
            
            const tiempoTotal = Math.max(1, Math.round(totalMS / 60000));
            const horaFin = new Date().toLocaleTimeString('es-ES');
            
            // Actualizar tabla temporal
            await update(ref(db, `tareas/${id}`), { 
                fin: horaFin, 
                total: tiempoTotal, 
                estado: "finalizado" 
            });
            
            // Guardar en HISTORIAL para gr√°ficos
            await push(tareasHistorialRef, {
                operario: t.operario,
                numSerie: t.numSerie,
                codigo: t.codigo,
                fecha: t.fecha,
                inicio: t.inicio,
                fin: horaFin,
                total: tiempoTotal,
                tipo: "produccion",
                timestamp: Date.now()
            });
        };

        window.borrarTarea = (id) => { 
            if (confirm('¬øBorrar tarea de la tabla temporal?')) remove(ref(db, `tareas/${id}`)); 
        };
        
        window.borrarTodoElRegistro = () => { 
            if (confirm("¬øBORRAR TODA LA TABLA TEMPORAL?\n\nLos datos de los gr√°ficos NO se borrar√°n.")) {
                remove(tareasRef);
            }
        };

        window.borrarHistorialGrafico = () => {
            if (confirm("‚ö†Ô∏è ¬øBORRAR PERMANENTEMENTE EL HISTORIAL?\n\nEsto borrar√° todos los datos de los gr√°ficos.")) {
                remove(tareasHistorialRef);
            }
        };

        window.toggleReposicion = async function() {
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};

            if (!hayReposicionGlobal) {
                update(reposicionRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_reposicion";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapR = await get(reposicionRef);
                const infoR = snapR.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoR.inicioMS) / 60000) || 1;
                
                // Tabla temporal
                push(tareasRef, { 
                    operario: infoR.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: "üì¶ REPOSICI√ìN", 
                    fecha: infoR.fecha, 
                    inicio: infoR.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "reposicion" 
                });
                
                // Historial
                push(tareasHistorialRef, {
                    operario: infoR.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: "üì¶ REPOSICI√ìN",
                    fecha: infoR.fecha,
                    inicio: infoR.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "reposicion",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_reposicion") {
                        updates[`tareas/${id}/estado`] = "activo";
                        updates[`tareas/${id}/inicioMS`] = ahora;
                    }
                });
                update(reposicionRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.toggleIncidencia = async function() {
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};
            
            if (!hayIncidenciaGlobal) {
                const motivo = prompt("Motivo de la incidencia:"); 
                if (!motivo) return;
                update(incidenciaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), motivo: motivo.trim(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_incidencia";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapI = await get(incidenciaRef);
                const infoInc = snapI.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoInc.inicioMS) / 60000) || 1;
                
                push(tareasRef, { 
                    operario: infoInc.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`, 
                    fecha: infoInc.fecha, 
                    inicio: infoInc.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "incidencia" 
                });
                
                push(tareasHistorialRef, {
                    operario: infoInc.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`,
                    fecha: infoInc.fecha,
                    inicio: infoInc.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "incidencia",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_incidencia") { 
                        updates[`tareas/${id}/estado`] = "activo"; 
                        updates[`tareas/${id}/inicioMS`] = ahora; 
                    }
                });
                update(incidenciaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.togglePausa = async function() {
            const ahora = Date.now(); 
            const snapTareas = await get(tareasRef); 
            const tareas = snapTareas.val() || {}; 
            const updates = {};
            
            if (!estaPausadoGlobal) {
                update(pausaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausado_desayuno";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapP = await get(pausaRef);
                const infoP = snapP.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoP.inicioMS) / 60000) || 1;
                
                push(tareasRef, { 
                    operario: infoP.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: "‚òï DESAYUNO", 
                    fecha: infoP.fecha, 
                    inicio: infoP.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "descanso" 
                });
                
                push(tareasHistorialRef, {
                    operario: infoP.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: "‚òï DESAYUNO",
                    fecha: infoP.fecha,
                    inicio: infoP.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "descanso",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausado_desayuno") { 
                        updates[`tareas/${id}/estado`] = "activo"; 
                        updates[`tareas/${id}/inicioMS`] = ahora; 
                    }
                });
                update(pausaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.registrarJornada = async (tipo) => {
            const operario = document.getElementById('selectOperario').value;
            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            const esEntrada = tipo === 'INICIO';
            
            // Tabla temporal
            await push(tareasRef, { 
                operario, 
                numSerie: "---", 
                codigo: esEntrada ? "üü¢ ENTRADA" : "üî¥ SALIDA", 
                fecha: fechaActual, 
                inicio: horaActual, 
                fin: "---", 
                total: "REGISTRO",
                estado: "finalizado", 
                tipo: "jornada" 
            });
            
            // Historial persistente
            await push(tareasHistorialRef, {
                operario: operario,
                numSerie: "---",
                codigo: esEntrada ? "üü¢ ENTRADA" : "üî¥ SALIDA",
                fecha: fechaActual,
                inicio: horaActual,
                fin: "---",
                total: 0,
                tipo: "jornada",
                timestamp: Date.now()
            });
        };

        window.iniciarTarea = function() {
            const operario = document.getElementById('selectOperario').value;
            const serie = document.getElementById('numSerie').value.trim();
            const cod = document.getElementById('codigo').value.trim();
            if (!serie || !cod) return;
            push(tareasRef, { 
                operario, 
                numSerie: serie, 
                codigo: cod, 
                fecha: obtenerFecha(), 
                operarios: document.getElementById('numOperarios').value, 
                inicio: new Date().toLocaleTimeString('es-ES'), 
                inicioMS: Date.now(), 
                acumuladoMS: 0, 
                estado: "activo", 
                tipo: "produccion" 
            });
            document.getElementById('numSerie').value = ''; 
            document.getElementById('codigo').value = ''; 
            document.getElementById('numSerie').focus();
        };

        // ESCUCHADOR: HISTORIAL (persistente) - Actualiza ambos gr√°ficos
        onValue(tareasHistorialRef, (snapshot) => {
            todasLasTareas = snapshot.val() || {};
            
            // Actualizar gr√°fico de tareas individuales
            const fechaInput = document.getElementById('filtroFecha').value;
            const fechaFiltro = fechaInput ? convertirFechaHTML(fechaInput) : null;
            actualizarGraficoPuntos(fechaFiltro);
            
            // Actualizar gr√°fico de productividad
            actualizarGraficoProductividad();
        });

        // ESCUCHADOR: TAREAS (temporal) - Solo actualiza la tabla
        onValue(tareasRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoTabla'); 
            cuerpo.innerHTML = "";
            const datos = snapshot.val(); 
            
            if (!datos) return;
            
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                const activo = t.estado === "activo";
                let rowClass = "bg-white";
                if(activo) rowClass = "bg-amber-50";
                if(t.estado === "pausa_manual") rowClass = "bg-blue-50";
                if(t.estado === "pausa_incidencia") rowClass = "bg-red-50";
                if(t.estado === "pausado_desayuno") rowClass = "bg-orange-50";
                if(t.estado === "pausa_reposicion") rowClass = "bg-yellow-50";

                let tiempoMostrado;
                if (activo) {
                    tiempoMostrado = `<span class="contador-vivo text-amber-600" data-inicio="${t.inicioMS}" data-acumulado="${t.acumuladoMS}">...</span>`;
                } else if (t.estado === "pausa_manual") {
                    tiempoMostrado = `<span class="text-blue-500 italic">‚è∏Ô∏è ${formatTime(t.acumuladoMS)}</span>`;
                } else if (t.estado === "pausa_incidencia") {
                    tiempoMostrado = `<span class="text-red-400 italic">üõ†Ô∏è En Incidencia</span>`;
                } else if (t.estado === "pausa_reposicion") {
                    tiempoMostrado = `<span class="text-yellow-600 italic">üì¶ En Reposici√≥n</span>`;
                } else if (t.estado === "pausado_desayuno") {
                    tiempoMostrado = `<span class="text-orange-400 italic">‚òï En Desayuno</span>`;
                } else if (t.tipo === 'jornada') {
                    tiempoMostrado = `<span class="text-slate-500 font-bold text-xs">REGISTRO</span>`;
                } else {
                    tiempoMostrado = `${t.total} min`;
                }

                cuerpo.innerHTML += `
                    <tr class="${rowClass} border-b border-slate-100 transition-all">
                        <td class="p-4 font-bold text-slate-700">${t.operario}</td>
                        <td class="p-4 text-slate-600 font-medium">${t.fecha || '-'}</td>
                        <td class="p-4 font-mono text-slate-500">${t.numSerie}</td>
                        <td class="p-4 font-bold text-slate-800">${t.codigo}</td>
                        <td class="p-4 text-center font-bold text-xs">${t.operarios || '-'}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.inicio}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.fin || '--:--'}</td>
                        <td class="p-4 font-black text-center">${tiempoMostrado}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            ${(activo || t.estado === "pausa_manual") ? `
                                <button onclick="togglePausaTarea('${id}')" class="${activo ? 'bg-blue-500' : 'bg-emerald-500'} text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">
                                    ${activo ? 'Pausa' : 'Seguir'}
                                </button>
                                <button onclick="finalizarTarea('${id}')" class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">Fin</button>
                            ` : (t.estado && t.estado.includes('pausa_') ? '‚è∏Ô∏è' : '‚úì')}
                            <button onclick="borrarTarea('${id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        onValue(incidenciaRef, s => {
            const d = s.val(); hayIncidenciaGlobal = d?.activa; inicioIncidenciaMS = d?.inicioMS;
            document.getElementById('btnIncidencia').innerHTML = hayIncidenciaGlobal ? "üõ†Ô∏è SOLUCIONAR" : "üö® INCIDENCIA";
            document.getElementById('cajaIncidencia').classList.toggle('hidden', !hayIncidenciaGlobal);
        });
        
        onValue(pausaRef, s => {
            const d = s.val(); estaPausadoGlobal = d?.activa; inicioPausaMS = d?.inicioMS;
            document.getElementById('btnPausa').innerHTML = estaPausadoGlobal ? "‚òï VOLVER" : "ü•ê DESAYUNO";
            document.getElementById('cajaDesayuno').classList.toggle('hidden', !estaPausadoGlobal);
        });
        
        onValue(reposicionRef, s => {
            const d = s.val(); hayReposicionGlobal = d?.activa; inicioReposicionMS = d?.inicioMS;
            document.getElementById('btnReposicion').innerHTML = hayReposicionGlobal ? "üì¶ LISTO" : "üì¶ REPOSICI√ìN";
            document.getElementById('cajaReposicion').classList.toggle('hidden', !hayReposicionGlobal);
        });

        window.handleKeyPress = (e, nextId) => { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (nextId) document.getElementById(nextId).focus(); 
                else window.iniciarTarea(); 
            } 
        };
        
        window.exportarExcel = () => { 
            XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tablaProduccion")), "Dosmart_Produccion.xlsx"); 
        };
    </script>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
    <!-- Modal para eliminar punto -->
    <div id="modalEliminar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <h3 class="text-xl font-black uppercase italic text-slate-800 mb-4">üóëÔ∏è Eliminar del Historial</h3>
            <div id="infoTareaEliminar" class="bg-slate-50 rounded-xl p-4 mb-6 text-sm"></div>
            <div class="flex gap-3">
                <button onclick="cerrarModalEliminar()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">
                    Cancelar
                </button>
                <button id="btnConfirmarEliminar" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold uppercase transition-colors">
                    Eliminar Permanentemente
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-4xl font-black uppercase italic tracking-tighter">Dosmart <span class="text-amber-500">Production</span></h1>
            <div class="flex flex-wrap justify-center gap-3">
                <div id="cajaIncidencia" class="hidden bg-red-100 p-2 rounded-xl text-right"><span id="tiempoIncidencia" class="font-mono font-bold text-red-700"></span></div>
                <div id="cajaDesayuno" class="hidden bg-orange-100 p-2 rounded-xl text-right"><span id="tiempoDesayuno" class="font-mono font-bold text-orange-700"></span></div>
                <div id="cajaReposicion" class="hidden bg-yellow-100 p-2 rounded-xl text-right"><span id="tiempoReposicion" class="font-mono font-bold text-yellow-700"></span></div>
                
                <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-rose-100 text-rose-600 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button id="btnReposicion" onclick="toggleReposicion()" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-yellow-500 transition-colors"></button>
                <button id="btnPausa" onclick="togglePausa()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase">Excel</button>
            </div>
        </div>

        <!-- Botones Entrada/Salida -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="registrarJornada('INICIO')" class="bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-emerald-600 transition-colors">‚òÄÔ∏è Entrada</button>
            <button onclick="registrarJornada('FIN')" class="bg-rose-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-rose-600 transition-colors">üåô Salida</button>
        </div>

        <!-- Formulario Nueva Tarea -->
        <div class="bg-white rounded-[2rem] shadow-xl p-6 mb-8 border-b-4 border-amber-400 grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Operario Actual</label>
                <select id="selectOperario" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400">
                    <option>Adrian Garc√≠a</option>
                    <option>Alberto Colmenero</option>
                </select>
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">N¬∫ Serie</label>
                <input id="numSerie" type="text" onkeypress="handleKeyPress(event, 'codigo')" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Tarea</label>
                <input id="codigo" type="text" onkeypress="handleKeyPress(event, null)" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Equipo</label>
                <select id="numOperarios" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none">
                    <option value="1">1 Pers.</option>
                    <option value="2">2 Pers.</option>
                    <option value="3">3 Pers.</option>
                </select>
            </div>
            <button onclick="iniciarTarea()" class="bg-amber-400 text-slate-900 font-black rounded-xl h-[56px] mt-5 hover:bg-slate-900 hover:text-white transition-all uppercase italic">Iniciar</button>
        </div>

        <!-- TABLA TEMPORAL -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200 mb-8">
            <div class="bg-slate-900 p-4 flex justify-between items-center">
                <h3 class="text-amber-400 font-black uppercase text-sm">Tabla de Tareas (Temporal)</h3>
                <span class="text-slate-400 text-xs">Se puede borrar sin afectar los gr√°ficos</span>
            </div>
            <table id="tablaProduccion" class="w-full text-left">
                <thead class="bg-slate-800 text-amber-400 text-[10px] font-black uppercase">
                    <tr>
                        <th class="p-4">Operario</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">Serie</th>
                        <th class="p-4">Tarea</th>
                        <th class="p-4 text-center">EQ</th>
                        <th class="p-4">H. Inicio</th>
                        <th class="p-4">H. Fin</th>
                        <th class="p-4 text-center">Tiempo</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <!-- GR√ÅFICO 1: TAREAS INDIVIDUALES -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-slate-800">Tiempo por Tarea Individual</h2>
                    <p class="text-xs text-slate-500 mt-1">Cada punto = una tarea | Eje Y = tiempo en minutos | Eje X = orden cronol√≥gico</p>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 uppercase">Filtrar fecha:</label>
                    <input type="date" id="filtroFecha" onchange="filtrarPorFecha()" 
                           class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                    <button onclick="mostrarTodas()" 
                            class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-2 rounded-lg text-xs font-bold uppercase transition-colors">
                        Todas
                    </button>
                </div>
            </div>
            
            <div class="h-96 w-full">
                <canvas id="graficoTareas"></canvas>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <div class="flex justify-center gap-8">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="font-bold text-slate-700">Adrian Garc√≠a</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="font-bold text-slate-700">Alberto Colmenero</span>
                    </div>
                </div>
                <div id="contadorTareas" class="text-sm font-bold text-slate-500 bg-slate-100 px-4 py-2 rounded-lg">
                    Cargando...
                </div>
            </div>
        </div>

        <!-- GR√ÅFICO 2: PRODUCTIVIDAD MENSUAL -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-slate-800">üìà Productividad Mensual</h2>
                    <p class="text-xs text-slate-500 mt-1">F√≥rmula: (Tareas √ó 7) / Horas trabajadas</p>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 uppercase">Per√≠odo:</label>
                    <select id="selectMesProductividad" onchange="cambiarMesProductividad()" 
                            class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                    <select id="selectAnioProductividad" onchange="cambiarMesProductividad()" 
                            class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>
            
            <div class="h-96 w-full">
                <canvas id="graficoProductividad"></canvas>
            </div>
            
            <div class="flex justify-between items-center mt-4 bg-slate-50 p-4 rounded-xl">
                <div class="flex justify-center gap-8">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="font-bold text-slate-700">Adrian Garc√≠a</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="font-bold text-slate-700">Alberto Colmenero</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-1 bg-yellow-400 border-2 border-yellow-400 border-dashed"></div>
                        <span class="font-bold text-slate-700">Media</span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="mediaProductividad" class="text-lg font-black text-amber-500">
                        Media del mes: 0.00
                    </div>
                    <div id="diasConDatos" class="text-xs font-bold text-slate-500">
                        D√≠as con datos: 0
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de borrado -->
        <div class="flex justify-center gap-4 p-8">
            <button onclick="borrarTodoElRegistro()" class="text-red-400 font-bold text-[10px] uppercase tracking-widest hover:text-red-600 transition-colors border border-red-200 px-4 py-2 rounded-lg">
                üóëÔ∏è Borrar Tabla Temporal
            </button>
            <button onclick="borrarHistorialGrafico()" class="text-orange-600 font-bold text-[10px] uppercase tracking-widest hover:text-orange-800 transition-colors bg-orange-50 border border-orange-200 px-4 py-2 rounded-lg">
                ‚ö†Ô∏è Borrar Historial Permanente
            </button>
        </div>
    </div>
</body>
</html>