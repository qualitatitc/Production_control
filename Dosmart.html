<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dosmart Production - Control de Tareas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCl2FTFnVh0QbAzwQS_hrGbbXcn3O1MsVw",
            authDomain: "dosmart-2f395.firebaseapp.com",
            databaseURL: "https://dosmart-2f395-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dosmart-2f395",
            storageBucket: "dosmart-2f395.appspot.com",
            appId: "1:854942502621:web:5c1a7428f7492c3a382664"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tareasRef = ref(db, 'tareas');
        const tareasHistorialRef = ref(db, 'historial_tareas');
        const pausaRef = ref(db, 'estadoPausa');
        const incidenciaRef = ref(db, 'estadoIncidencia');
        const reposicionRef = ref(db, 'estadoReposicion');
        const mantenimientoRef = ref(db, 'tareas_mantenimiento');
        const incidenciasTextoRef = ref(db, 'incidencias_texto');

        let estaPausadoGlobal = false;
        let hayIncidenciaGlobal = false;
        let hayReposicionGlobal = false;
        let lineaIniciada = false; // Nueva variable para controlar si hay entrada registrada
        let numOperariosActivos = 1; // N√∫mero de operarios trabajando (1 o 2)
        let inicioPausaMS = 0;
        let inicioIncidenciaMS = 0;
        let inicioReposicionMS = 0;
        let chartInstance = null;
        let chartProductividad = null;
        let todasLasTareas = {};
        let primeraVez = true; // Para establecer filtro inicial

        function actualizarEstadoBotones() {
            const btnPausa = document.getElementById('btnPausa');
            const btnIncidencia = document.getElementById('btnIncidencia');
            const btnReposicion = document.getElementById('btnReposicion');
            const btnIniciarTarea = document.getElementById('btnIniciarTarea');
            const btnEntrada = document.getElementById('btnEntrada');
            const btnSalida = document.getElementById('btnSalida');
            const btnForzarParada = document.getElementById('btnForzarParada');
            const indicadorLinea = document.getElementById('indicadorLinea');
            
            if (lineaIniciada) {
                btnPausa.disabled = false;
                btnPausa.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnIncidencia.disabled = false;
                btnIncidencia.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnReposicion.disabled = true;
                btnReposicion.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnIniciarTarea.disabled = false;
                btnIniciarTarea.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnEntrada.disabled = true;
                btnEntrada.classList.add('opacity-50', 'cursor-not-allowed');
                btnSalida.disabled = false;
                btnSalida.classList.remove('opacity-50', 'cursor-not-allowed');

                // Forzar parada solo activo cuando la l√≠nea est√° activa
                btnForzarParada.disabled = false;
                btnForzarParada.classList.remove('opacity-50', 'cursor-not-allowed');
                
                indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg animate-pulse">üü¢ L√≠nea Activa</span>';
            } else {
                btnPausa.disabled = true;
                btnPausa.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnIncidencia.disabled = true;
                btnIncidencia.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnReposicion.disabled = false;
                btnReposicion.classList.remove('opacity-50', 'cursor-not-allowed');
                
                btnIniciarTarea.disabled = true;
                btnIniciarTarea.classList.add('opacity-50', 'cursor-not-allowed');
                
                btnEntrada.disabled = false;
                btnEntrada.classList.remove('opacity-50', 'cursor-not-allowed');
                btnSalida.disabled = true;
                btnSalida.classList.add('opacity-50', 'cursor-not-allowed');

                // Forzar parada desactivado cuando la l√≠nea ya est√° parada
                btnForzarParada.disabled = true;
                btnForzarParada.classList.add('opacity-50', 'cursor-not-allowed');
                
                indicadorLinea.innerHTML = '<span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>';
            }
        }

        // FORZAR PARADA DE L√çNEA
        window.forzarParadaLinea = async function() {
            if (!lineaIniciada) return;
            
            if (!confirm('‚õî ¬øForzar parada de l√≠nea?\n\nSe registrar√° una SALIDA ahora mismo para poder calcular la productividad del d√≠a.')) return;

            const operario = document.getElementById('selectOperario').value;
            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            const ahora = Date.now();

            // Pausar tareas activas
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};

            Object.keys(tareas).forEach(id => {
                if (tareas[id].estado === "activo") {
                    const acumuladoSesion = ahora - tareas[id].inicioMS;
                    updates[`tareas/${id}/estado`] = "pausa_salida_linea";
                    updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                }
            });
            if (Object.keys(updates).length > 0) await update(ref(db), updates);

            // Registrar SALIDA en tabla temporal
            await push(tareasRef, {
                operario,
                numSerie: "---",
                codigo: "‚õî SALIDA FORZADA",
                fecha: fechaActual,
                inicio: horaActual,
                fin: "---",
                total: "REGISTRO",
                estado: "finalizado",
                tipo: "jornada",
                numOperarios: 0
            });

            // Registrar SALIDA en historial (para que el c√°lculo de productividad lo tome)
            await push(tareasHistorialRef, {
                operario,
                numSerie: "---",
                codigo: "üî¥ SALIDA",
                fecha: fechaActual,
                inicio: horaActual,
                fin: "---",
                total: 0,
                tipo: "jornada",
                numOperarios: 0,
                timestamp: Date.now()
            });

            // Actualizar estado local
            lineaIniciada = false;
            numOperariosActivos = 1;
            actualizarEstadoBotones();
        };

        const obtenerFecha = () => {
            const hoy = new Date();
            const dia = String(hoy.getDate()).padStart(2, '0');
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const anio = hoy.getFullYear();
            return `${dia}/${mes}/${anio}`;
        };
        const obtenerOperarioActual = () => document.getElementById('selectOperario').value;

        // NUEVA FUNCI√ìN: Obtener fecha de hoy en formato HTML (YYYY-MM-DD)
        function obtenerFechaHoy() {
            const hoy = new Date();
            const anio = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const dia = String(hoy.getDate()).padStart(2, '0');
            return `${anio}-${mes}-${dia}`;
        }

        function formatTime(ms) {
            if (!ms || ms < 0) return "0m 0s";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            return `${min}m ${seg}s`;
        }

        function convertirFechaHTML(fechaHTML) {
            const partes = fechaHTML.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        function convertirHoraAMinutos(horaStr) {
            if (!horaStr || horaStr === '--:--' || horaStr === '---') return 0;
            const [horas, minutos, segundos] = horaStr.split(':').map(Number);
            if (isNaN(horas) || isNaN(minutos)) return 0;
            return horas * 60 + minutos + (segundos || 0) / 60;
        }

        function parsearFecha(fechaStr) {
            if (!fechaStr || !fechaStr.includes('/')) return null;
            const [dia, mes, anio] = fechaStr.split('/').map(Number);
            return new Date(anio, mes - 1, dia);
        }

        // GR√ÅFICO 1: TAREAS INDIVIDUALES - Muestra cada tarea con su tiempo
        function actualizarGraficoPuntos(fechaFiltro = null) {
            const tareasAdrian = [];
            const tareasAlberto = [];
            
            console.log('=== DEBUG GR√ÅFICO TAREAS ===');
            console.log('Fecha filtro:', fechaFiltro);
            console.log('Total tareas en historial:', Object.keys(todasLasTareas).length);
            
            if (todasLasTareas) {
                // Filtrar solo tareas de producci√≥n finalizadas
                const tareasProduccion = Object.entries(todasLasTareas)
                    .filter(([id, t]) => {
                        // Debe ser producci√≥n y tener tiempo num√©rico v√°lido
                        const esProduccion = t.tipo === 'produccion';
                        const tieneTiempo = t.total && !isNaN(parseInt(t.total)) && parseInt(t.total) > 0;
                        const cumpleFecha = !fechaFiltro || t.fecha === fechaFiltro;
                        
                        if (esProduccion && !cumpleFecha) {
                            console.log('Tarea producci√≥n descartada por fecha:', t.fecha, 'vs filtro:', fechaFiltro);
                        }
                        
                        return esProduccion && tieneTiempo && cumpleFecha;
                    })
                    .map(([id, t]) => ({
                        id: id,
                        ...t,
                        tiempoNum: parseInt(t.total),
                        horaMinutos: convertirHoraAMinutos(t.inicio)
                    }));
                
                console.log('Tareas producci√≥n filtradas:', tareasProduccion.length);
                
                // Ordenar por hora de inicio
                tareasProduccion.sort((a, b) => a.horaMinutos - b.horaMinutos);
                
                // Asignar √≠ndice secuencial a cada tarea
                tareasProduccion.forEach((t, index) => {
                    const punto = {
                        x: index, // √çndice de la tarea en orden cronol√≥gico
                        y: t.tiempoNum, // Tiempo en minutos (eje Y)
                        tarea: t.codigo,
                        serie: t.numSerie,
                        hora: t.inicio,
                        fecha: t.fecha,
                        firebaseId: t.id,
                        operario: t.operario
                    };
                    
                    if (t.operario === 'Adrian Garc√≠a') {
                        tareasAdrian.push(punto);
                    } else if (t.operario === 'Alberto Colmenero') {
                        tareasAlberto.push(punto);
                    }
                });
                
                console.log('Adrian:', tareasAdrian.length, 'Alberto:', tareasAlberto.length);
            }

            const ctx = document.getElementById('graficoTareas').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Si no hay datos, mostrar mensaje
            if (tareasAdrian.length === 0 && tareasAlberto.length === 0) {
                document.getElementById('contadorTareas').textContent = 
                    fechaFiltro ? `Sin datos para ${fechaFiltro}` : 'Sin tareas en el historial';
            } else {
                const totalTareas = tareasAdrian.length + tareasAlberto.length;
                document.getElementById('contadorTareas').textContent = 
                    fechaFiltro ? `${totalTareas} tareas el ${fechaFiltro}` : `${totalTareas} tareas totales`;
            }

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Adrian Garc√≠a',
                            data: tareasAdrian,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12
                        },
                        {
                            label: 'Alberto Colmenero',
                            data: tareasAlberto,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e) => {
                        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const datasetIndex = firstPoint.datasetIndex;
                            const index = firstPoint.index;
                            const dataset = chartInstance.data.datasets[datasetIndex];
                            const punto = dataset.data[index];
                            mostrarModalEliminar(punto);
                        }
                    },
                    onHover: (e, activeElements) => {
                        e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Tarea #${context[0].parsed.x + 1}`;
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    const operario = context.datasetIndex === 0 ? 'Adrian' : 'Alberto';
                                    return [
                                        `Operario: ${operario}`,
                                        `Tarea: ${point.tarea}`,
                                        `Serie: ${point.serie}`,
                                        `Hora: ${point.hora}`,
                                        `Tiempo: ${point.y} minutos`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { 
                                display: true, 
                                text: 'N√∫mero de tarea (orden cronol√≥gico)',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + 1;
                                }
                            },
                            grid: { color: '#e2e8f0' }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tiempo (minutos)',
                                font: { weight: 'bold' }
                            },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        // Funci√≥n para calcular l√≠nea de tendencia (regresi√≥n lineal)
        function calcularTendencia(datos) {
            const puntos = datos
                .map((y, x) => ({ x, y }))
                .filter(p => p.y !== null && !isNaN(p.y));
            
            if (puntos.length < 2) return { tendencia: [], pendiente: 0 };
            
            const n = puntos.length;
            const sumaX = puntos.reduce((sum, p) => sum + p.x, 0);
            const sumaY = puntos.reduce((sum, p) => sum + p.y, 0);
            const sumaXY = puntos.reduce((sum, p) => sum + p.x * p.y, 0);
            const sumaX2 = puntos.reduce((sum, p) => sum + p.x * p.x, 0);
            
            const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
            const intercept = (sumaY - pendiente * sumaX) / n;
            
            const tendencia = datos.map((_, x) => {
                if (datos[x] === null) return null;
                return pendiente * x + intercept;
            });
            
            return { tendencia, pendiente };
        }

        // GR√ÅFICO 2: PRODUCTIVIDAD DIARIA (de un mes) - Media de ambos operarios
        function calcularProductividadDiaria(anio, mes) {
            const diasDelMes = new Date(anio, mes, 0).getDate();
            const datosProductividad = new Array(diasDelMes).fill(null);
            
            const tareasPorDia = {};
            const jornadasPorDia = {};
            
            if (todasLasTareas) {
                Object.values(todasLasTareas).forEach(t => {
                    const fecha = parsearFecha(t.fecha);
                    if (!fecha) return;
                    
                    if (fecha.getFullYear() === anio && fecha.getMonth() === mes - 1) {
                        const dia = fecha.getDate();
                        const key = `${dia}-${t.operario}`;
                        
                        if (t.tipo === 'produccion') {
                            if (!tareasPorDia[key]) tareasPorDia[key] = 0;
                            tareasPorDia[key]++;
                        } else if (t.tipo === 'jornada') {
                            if (!jornadasPorDia[key]) jornadasPorDia[key] = { entradas: [] };
                            if (t.codigo && t.codigo.includes('ENTRADA')) {
                                jornadasPorDia[key].entradas.push({
                                    hora: t.inicio,
                                    numOperarios: t.numOperarios || 1
                                });
                            } else if (t.codigo && t.codigo.includes('SALIDA')) {
                                jornadasPorDia[key].salida = t.inicio;
                            }
                        }
                    }
                });
            }
            
            for (let dia = 1; dia <= diasDelMes; dia++) {
                const productividadesDia = [];
                
                // Procesar Adrian
                const keyAdrian = `${dia}-Adrian Garc√≠a`;
                const tareasAdrianCount = tareasPorDia[keyAdrian] || 0;
                const jornadaAdrian = jornadasPorDia[keyAdrian] || {};
                
                if (jornadaAdrian.salida && jornadaAdrian.entradas && jornadaAdrian.entradas.length > 0 && tareasAdrianCount > 0) {
                    const salidaMin = convertirHoraAMinutos(jornadaAdrian.salida);
                    
                    let horas1Op = 0;
                    let horas2Op = 0;
                    
                    // Calcular horas por cada configuraci√≥n de operarios
                    jornadaAdrian.entradas.forEach((entrada, index) => {
                        const entradaMin = convertirHoraAMinutos(entrada.hora);
                        let finPeriodoMin;
                        
                        if (index < jornadaAdrian.entradas.length - 1) {
                            finPeriodoMin = convertirHoraAMinutos(jornadaAdrian.entradas[index + 1].hora);
                        } else {
                            finPeriodoMin = salidaMin;
                        }
                        
                        const horasPeriodo = (finPeriodoMin - entradaMin) / 60;
                        
                        if (entrada.numOperarios === 1) {
                            horas1Op += horasPeriodo;
                        } else if (entrada.numOperarios === 2) {
                            horas2Op += horasPeriodo;
                        }
                    });
                    
                    // F√≥rmula: (Tareas √ó 7) / (Horas1Op + (Horas2Op √ó 2))
                    const denominador = horas1Op + (horas2Op * 2);
                    if (denominador > 0) {
                        const prodAdrian = (tareasAdrianCount * 7) / denominador;
                        productividadesDia.push(prodAdrian);
                    }
                }
                
                // Procesar Alberto
                const keyAlberto = `${dia}-Alberto Colmenero`;
                const tareasAlbertoCount = tareasPorDia[keyAlberto] || 0;
                const jornadaAlberto = jornadasPorDia[keyAlberto] || {};
                
                if (jornadaAlberto.salida && jornadaAlberto.entradas && jornadaAlberto.entradas.length > 0 && tareasAlbertoCount > 0) {
                    const salidaMin = convertirHoraAMinutos(jornadaAlberto.salida);
                    
                    let horas1Op = 0;
                    let horas2Op = 0;
                    
                    // Calcular horas por cada configuraci√≥n de operarios
                    jornadaAlberto.entradas.forEach((entrada, index) => {
                        const entradaMin = convertirHoraAMinutos(entrada.hora);
                        let finPeriodoMin;
                        
                        if (index < jornadaAlberto.entradas.length - 1) {
                            finPeriodoMin = convertirHoraAMinutos(jornadaAlberto.entradas[index + 1].hora);
                        } else {
                            finPeriodoMin = salidaMin;
                        }
                        
                        const horasPeriodo = (finPeriodoMin - entradaMin) / 60;
                        
                        if (entrada.numOperarios === 1) {
                            horas1Op += horasPeriodo;
                        } else if (entrada.numOperarios === 2) {
                            horas2Op += horasPeriodo;
                        }
                    });
                    
                    // F√≥rmula: (Tareas √ó 7) / (Horas1Op + (Horas2Op √ó 2))
                    const denominador = horas1Op + (horas2Op * 2);
                    if (denominador > 0) {
                        const prodAlberto = (tareasAlbertoCount * 7) / denominador;
                        productividadesDia.push(prodAlberto);
                    }
                }
                
                // Calcular media del d√≠a (ambos operarios)
                if (productividadesDia.length > 0) {
                    datosProductividad[dia - 1] = productividadesDia.reduce((a, b) => a + b, 0) / productividadesDia.length;
                }
            }
            
            return { datosProductividad, diasDelMes };
        }

        function actualizarGraficoProductividadDiaria() {
            const inputMes = document.getElementById('filtroMesProductividadDiaria').value;
            if (!inputMes) return;
            
            const [anio, mes] = inputMes.split('-').map(Number);
            
            const { datosProductividad, diasDelMes } = calcularProductividadDiaria(anio, mes);
            
            const todosLosValores = datosProductividad.filter(v => v !== null && !isNaN(v));
            const media = todosLosValores.length > 0 ? 
                todosLosValores.reduce((a, b) => a + b, 0) / todosLosValores.length : 0;
            
            const lineaMedia = new Array(diasDelMes).fill(media);
            const labels = Array.from({length: diasDelMes}, (_, i) => i + 1);
            
            const ctx = document.getElementById('graficoProductividadDiaria').getContext('2d');
            
            if (chartProductividad) {
                chartProductividad.destroy();
            }

            chartProductividad = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Productividad',
                            data: datosProductividad,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#3b82f6',
                            fill: true,
                            tension: 0.3,
                            spanGaps: true,
                            order: 2
                        },
                        {
                            label: 'Media',
                            data: lineaMedia,
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: async (e) => {
                        const points = chartProductividad.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const datasetIndex = firstPoint.datasetIndex;
                            
                            // No hacer nada si es la l√≠nea de media (datasetIndex === 1)
                            if (datasetIndex === 1) return;
                            
                            const index = firstPoint.index;
                            const dia = index + 1;
                            
                            const inputMes = document.getElementById('filtroMesProductividadDiaria').value;
                            const [anioSel, mesSel] = inputMes.split('-').map(Number);
                            const fechaBuscar = `${String(dia).padStart(2, '0')}/${String(mesSel).padStart(2, '0')}/${anioSel}`;
                            
                            mostrarModalEliminarDiaTodos(dia, mesSel, anioSel, fechaBuscar);
                        }
                    },
                    onHover: (e, activeElements) => {
                        e.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null || isNaN(value)) return `${context.dataset.label}: Sin datos`;
                                    return `${context.dataset.label}: ${value.toFixed(2)} tareas/hora`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: 'D√≠as del mes', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Productividad (tareas√ó7 / (h√óop))', font: { weight: 'bold' } }, grid: { color: '#e2e8f0' } }
                    }
                }
            });

            const diasConDatos = todosLosValores.length;
            const nombreMes = new Date(anio, mes - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('mediaProductividadDiaria').textContent = `Media de ${nombreMes}: ${media.toFixed(2)}`;
            document.getElementById('diasConDatosDiaria').textContent = `D√≠as con datos: ${diasConDatos}`;
        }

        window.cambiarMesProductividadDiaria = function() {
            actualizarGraficoProductividadDiaria();
        };

        // GR√ÅFICO 3: PRODUCTIVIDAD MENSUAL - Media de productividad diaria de cada mes
        let chartProductividadMensual = null;

        function calcularProductividadMensual(anio) {
            const meses = Array.from({length: 12}, (_, i) => i + 1);
            const datosProductividad = new Array(12).fill(null);
            
            meses.forEach(mes => {
                // Obtener los datos de productividad diaria del mes
                const { datosProductividad: diasMes } = calcularProductividadDiaria(anio, mes);
                
                // Calcular la media simple de los d√≠as con datos
                const valoresMes = diasMes.filter(v => v !== null && !isNaN(v));
                if (valoresMes.length > 0) {
                    datosProductividad[mes - 1] = valoresMes.reduce((a, b) => a + b, 0) / valoresMes.length;
                }
            });
            
            return { datosProductividad };
        }

        function actualizarGraficoProductividadMensual() {
            const anio = parseInt(document.getElementById('selectAnioProductividadMensual').value);
            
            const { datosProductividad } = calcularProductividadMensual(anio);
            
            const todosLosValores = datosProductividad.filter(v => v !== null && !isNaN(v));
            const media = todosLosValores.length > 0 ? 
                todosLosValores.reduce((a, b) => a + b, 0) / todosLosValores.length : 0;
            
            // Calcular l√≠nea de tendencia
            const { tendencia, pendiente } = calcularTendencia(datosProductividad);
            const esTendenciaPositiva = pendiente > 0;
            const colorTendencia = esTendenciaPositiva ? '#10b981' : '#ef4444'; // Verde si positivo, rojo si negativo
            
            const lineaMedia = new Array(12).fill(media);
            const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            const ctx = document.getElementById('graficoProductividadMensual').getContext('2d');
            
            if (chartProductividadMensual) {
                chartProductividadMensual.destroy();
            }

            chartProductividadMensual = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Productividad Mensual',
                            data: datosProductividad,
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 2,
                            borderRadius: 8,
                            order: 3
                        },
                        {
                            label: 'Media Anual',
                            data: lineaMedia,
                            type: 'line',
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            order: 1
                        },
                        {
                            label: esTendenciaPositiva ? 'Tendencia ‚Üó' : 'Tendencia ‚Üò',
                            data: tendencia,
                            type: 'line',
                            borderColor: colorTendencia,
                            backgroundColor: esTendenciaPositiva ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null || isNaN(value)) return `${context.dataset.label}: Sin datos`;
                                    return `${context.dataset.label}: ${value.toFixed(2)} tareas/hora`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: true, 
                            title: { display: true, text: 'Meses del a√±o', font: { weight: 'bold' } }, 
                            grid: { color: '#e2e8f0' } 
                        },
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Productividad Media (tareas√ó7 / (h√óop))', font: { weight: 'bold' } }, 
                            grid: { color: '#e2e8f0' } 
                        }
                    }
                }
            });

            const mesesConDatos = todosLosValores.length;
            const tendenciaTexto = esTendenciaPositiva ? 
                `<span class="text-green-600">‚Üó Tendencia positiva</span>` : 
                `<span class="text-red-600">‚Üò Tendencia negativa</span>`;
            
            document.getElementById('mediaProductividadAnual').textContent = `Media de ${anio}: ${media.toFixed(2)}`;
            document.getElementById('mesesConDatos').innerHTML = `Meses: ${mesesConDatos} | ${tendenciaTexto}`;
        }

        window.cambiarAnioProductividadMensual = function() {
            actualizarGraficoProductividadMensual();
        };

        window.mostrarModalEliminar = function(punto) {
            const modal = document.getElementById('modalEliminar');
            const info = document.getElementById('infoTareaEliminar');
            const btnEliminar = document.getElementById('btnConfirmarEliminar');
            
            const colorOperario = punto.operario === 'Adrian Garc√≠a' ? 'text-blue-600' : 'text-red-600';
            
            info.innerHTML = `
                <div class="space-y-2">
                    <p><span class="font-bold text-slate-600">Operario:</span> <span class="${colorOperario} font-bold">${punto.operario}</span></p>
                    <p><span class="font-bold text-slate-600">Tarea:</span> ${punto.tarea}</p>
                    <p><span class="font-bold text-slate-600">Serie:</span> ${punto.serie}</p>
                    <p><span class="font-bold text-slate-600">Fecha:</span> ${punto.fecha}</p>
                    <p><span class="font-bold text-slate-600">Hora:</span> ${punto.hora}</p>
                    <p><span class="font-bold text-slate-600">Tiempo:</span> ${punto.y} minutos</p>
                </div>
            `;
            
            btnEliminar.onclick = () => eliminarPuntoGrafico(punto.firebaseId);
            modal.classList.remove('hidden');
        };

        window.mostrarModalEliminarDia = function(dia, mes, anio, operario, fecha) {
            const modal = document.getElementById('modalEliminar');
            const info = document.getElementById('infoTareaEliminar');
            const btnEliminar = document.getElementById('btnConfirmarEliminar');
            
            const colorOperario = operario === 'Adrian Garc√≠a' ? 'text-blue-600' : 'text-red-600';
            const nombreMes = new Date(anio, mes - 1).toLocaleDateString('es-ES', { month: 'long' });
            
            // Contar cu√°ntas tareas hay ese d√≠a
            let contadorTareas = 0;
            if (todasLasTareas) {
                Object.values(todasLasTareas).forEach(t => {
                    if (t.tipo === 'produccion' && t.fecha === fecha && t.operario === operario) {
                        contadorTareas++;
                    }
                });
            }
            
            info.innerHTML = `
                <div class="space-y-2">
                    <p><span class="font-bold text-slate-600">Operario:</span> <span class="${colorOperario} font-bold">${operario}</span></p>
                    <p><span class="font-bold text-slate-600">Fecha:</span> ${dia} de ${nombreMes} ${anio}</p>
                    <p><span class="font-bold text-slate-600">Tareas a borrar:</span> <span class="text-red-600 font-bold">${contadorTareas} tareas de producci√≥n</span></p>
                    <p class="text-amber-600 text-xs mt-4">‚ö†Ô∏è Esto eliminar√° todas las tareas de producci√≥n de este d√≠a</p>
                </div>
            `;
            
            btnEliminar.onclick = () => eliminarTareasDia(fecha, operario);
            modal.classList.remove('hidden');
        };

        window.eliminarTareasDia = async function(fecha, operario) {
            if (!confirm(`¬øEst√°s seguro de eliminar TODAS las tareas de ${operario} del ${fecha}?`)) {
                cerrarModalEliminar();
                return;
            }
            
            try {
                const snapshot = await get(tareasHistorialRef);
                const tareas = snapshot.val() || {};
                let eliminadas = 0;
                
                for (const [id, tarea] of Object.entries(tareas)) {
                    if (tarea.tipo === 'produccion' && tarea.fecha === fecha && tarea.operario === operario) {
                        await remove(ref(db, `historial_tareas/${id}`));
                        eliminadas++;
                    }
                }
                
                alert(`‚úì Se eliminaron ${eliminadas} tareas del historial`);
                cerrarModalEliminar();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        window.mostrarModalEliminarDiaTodos = function(dia, mes, anio, fecha) {
            const modal = document.getElementById('modalEliminar');
            const info = document.getElementById('infoTareaEliminar');
            const btnEliminar = document.getElementById('btnConfirmarEliminar');
            
            const nombreMes = new Date(anio, mes - 1).toLocaleDateString('es-ES', { month: 'long' });
            
            // Contar cu√°ntas tareas hay ese d√≠a (ambos operarios)
            let contadorTareas = 0;
            if (todasLasTareas) {
                Object.values(todasLasTareas).forEach(t => {
                    if (t.tipo === 'produccion' && t.fecha === fecha) {
                        contadorTareas++;
                    }
                });
            }
            
            info.innerHTML = `
                <div class="space-y-2">
                    <p><span class="font-bold text-slate-600">Fecha:</span> ${dia} de ${nombreMes} ${anio}</p>
                    <p><span class="font-bold text-slate-600">Tareas a borrar:</span> <span class="text-red-600 font-bold">${contadorTareas} tareas de producci√≥n (todos los operarios)</span></p>
                    <p class="text-amber-600 text-xs mt-4">‚ö†Ô∏è Esto eliminar√° todas las tareas de producci√≥n de este d√≠a</p>
                </div>
            `;
            
            btnEliminar.onclick = () => eliminarTareasDiaTodos(fecha);
            modal.classList.remove('hidden');
        };

        window.eliminarTareasDiaTodos = async function(fecha) {
            if (!confirm(`¬øEst√°s seguro de eliminar TODAS las tareas del ${fecha}?`)) {
                cerrarModalEliminar();
                return;
            }
            
            try {
                const snapshot = await get(tareasHistorialRef);
                const tareas = snapshot.val() || {};
                let eliminadas = 0;
                
                for (const [id, tarea] of Object.entries(tareas)) {
                    if (tarea.tipo === 'produccion' && tarea.fecha === fecha) {
                        await remove(ref(db, `historial_tareas/${id}`));
                        eliminadas++;
                    }
                }
                
                alert(`‚úì Se eliminaron ${eliminadas} tareas del historial`);
                cerrarModalEliminar();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        window.cerrarModalEliminar = function() {
            document.getElementById('modalEliminar').classList.add('hidden');
        };

        window.eliminarPuntoGrafico = async function(firebaseId) {
            if (!confirm('¬øEst√°s seguro de eliminar este punto del historial?')) return;
            try {
                await remove(ref(db, `historial_tareas/${firebaseId}`));
                cerrarModalEliminar();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        window.filtrarPorFecha = function() {
            const fechaInput = document.getElementById('filtroFecha').value;
            if (fechaInput) {
                actualizarGraficoPuntos(convertirFechaHTML(fechaInput));
            } else {
                // Si se borra la fecha, volver a mostrar hoy
                document.getElementById('filtroFecha').value = obtenerFechaHoy();
                actualizarGraficoPuntos(obtenerFecha());
            }
        };

        setInterval(() => {
            const ahora = Date.now();
            if (!estaPausadoGlobal && !hayIncidenciaGlobal && !hayReposicionGlobal) {
                document.querySelectorAll('.contador-vivo').forEach(el => {
                    const inicioMS = parseInt(el.dataset.inicio);
                    const acumuladoPrevio = parseInt(el.dataset.acumulado || 0);
                    el.innerText = formatTime((ahora - inicioMS) + acumuladoPrevio);
                });
            }
            if (estaPausadoGlobal) {
                const caja = document.getElementById('tiempoDesayuno');
                if(caja) caja.innerText = formatTime(ahora - inicioPausaMS);
            }
            if (hayIncidenciaGlobal) {
                const cajaInc = document.getElementById('tiempoIncidencia');
                if(cajaInc) cajaInc.innerText = formatTime(ahora - inicioIncidenciaMS);
            }
            if (hayReposicionGlobal) {
                const cajaRep = document.getElementById('tiempoReposicion');
                if(cajaRep) cajaRep.innerText = formatTime(ahora - inicioReposicionMS);
            }
        }, 1000);

        window.togglePausaTarea = async function(id) {
            const ahora = Date.now();
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            if (t.estado === "activo") {
                const nuevoAcumulado = (t.acumuladoMS || 0) + (ahora - t.inicioMS);
                update(ref(db, `tareas/${id}`), { estado: "pausa_manual", acumuladoMS: nuevoAcumulado });
            } else if (t.estado === "pausa_manual") {
                update(ref(db, `tareas/${id}`), { estado: "activo", inicioMS: ahora });
            }
        };

        // FINALIZAR TAREA - Guarda en historial
        window.finalizarTarea = async function(id) {
            if(!confirm('¬øFinalizar tarea?')) return;
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            let totalMS = (t.acumuladoMS || 0);
            if(t.estado === "activo") totalMS += (Date.now() - t.inicioMS);
            
            const tiempoTotal = Math.max(1, Math.round(totalMS / 60000));
            const horaFin = new Date().toLocaleTimeString('es-ES');
            
            // Actualizar tabla temporal
            await update(ref(db, `tareas/${id}`), { 
                fin: horaFin, 
                total: tiempoTotal, 
                estado: "finalizado" 
            });
            
            // Guardar en HISTORIAL para gr√°ficos
            await push(tareasHistorialRef, {
                operario: t.operario,
                numSerie: t.numSerie,
                codigo: t.codigo,
                fecha: t.fecha,
                inicio: t.inicio,
                fin: horaFin,
                total: tiempoTotal,
                tipo: "produccion",
                timestamp: Date.now()
            });
        };

        window.borrarTarea = (id) => { 
            if (confirm('¬øBorrar tarea de la tabla temporal?')) remove(ref(db, `tareas/${id}`)); 
        };
        
        window.borrarTodoElRegistro = () => { 
            if (confirm("¬øBORRAR TODA LA TABLA TEMPORAL?\n\nLos datos de los gr√°ficos NO se borrar√°n.")) {
                remove(tareasRef);
            }
        };

        window.borrarHistorialGrafico = () => {
            if (confirm("‚ö†Ô∏è ¬øBORRAR PERMANENTEMENTE EL HISTORIAL?\n\nEsto borrar√° todos los datos de los gr√°ficos.")) {
                remove(tareasHistorialRef);
            }
        };

        window.toggleReposicion = async function() {
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};

            if (!hayReposicionGlobal) {
                update(reposicionRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_reposicion";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapR = await get(reposicionRef);
                const infoR = snapR.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoR.inicioMS) / 60000) || 1;
                
                // Tabla temporal
                await push(tareasRef, { 
                    operario: infoR.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: "üì¶ REPOSICI√ìN", 
                    fecha: infoR.fecha, 
                    inicio: infoR.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "reposicion" 
                });
                
                // Historial
                await push(tareasHistorialRef, {
                    operario: infoR.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: "üì¶ REPOSICI√ìN",
                    fecha: infoR.fecha,
                    inicio: infoR.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "reposicion",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_reposicion") {
                        updates[`tareas/${id}/estado`] = "activo";
                        updates[`tareas/${id}/inicioMS`] = ahora;
                    }
                });
                update(reposicionRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.toggleIncidencia = async function() {
            if (!lineaIniciada && !hayIncidenciaGlobal) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de reportar incidencias');
                return;
            }
            
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};
            
            if (!hayIncidenciaGlobal) {
                const motivo = prompt("Motivo de la incidencia:"); 
                if (!motivo) return;
                
                // Guardar en tabla de incidencias (registro permanente)
                await push(incidenciasTextoRef, {
                    descripcion: motivo.trim(),
                    fecha: obtenerFecha(),
                    timestamp: Date.now()
                });
                
                update(incidenciaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), motivo: motivo.trim(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_incidencia";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapI = await get(incidenciaRef);
                const infoInc = snapI.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoInc.inicioMS) / 60000) || 1;
                
                await push(tareasRef, { 
                    operario: infoInc.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`, 
                    fecha: infoInc.fecha, 
                    inicio: infoInc.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "incidencia" 
                });
                
                await push(tareasHistorialRef, {
                    operario: infoInc.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`,
                    fecha: infoInc.fecha,
                    inicio: infoInc.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "incidencia",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_incidencia") { 
                        updates[`tareas/${id}/estado`] = "activo"; 
                        updates[`tareas/${id}/inicioMS`] = ahora; 
                    }
                });
                update(incidenciaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.togglePausa = async function() {
            if (!lineaIniciada && !estaPausadoGlobal) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de tomar desayuno');
                return;
            }
            
            const ahora = Date.now(); 
            const snapTareas = await get(tareasRef); 
            const tareas = snapTareas.val() || {}; 
            const updates = {};
            
            if (!estaPausadoGlobal) {
                update(pausaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausado_desayuno";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapP = await get(pausaRef);
                const infoP = snapP.val();
                const horaFin = new Date().toLocaleTimeString('es-ES');
                const duracion = Math.round((ahora - infoP.inicioMS) / 60000) || 1;
                
                await push(tareasRef, { 
                    operario: infoP.operario || "SISTEMA", 
                    numSerie: "---", 
                    codigo: "‚òï DESAYUNO", 
                    fecha: infoP.fecha, 
                    inicio: infoP.horaTexto, 
                    fin: horaFin, 
                    total: duracion, 
                    estado: "finalizado", 
                    tipo: "descanso" 
                });
                
                await push(tareasHistorialRef, {
                    operario: infoP.operario || "SISTEMA",
                    numSerie: "---",
                    codigo: "‚òï DESAYUNO",
                    fecha: infoP.fecha,
                    inicio: infoP.horaTexto,
                    fin: horaFin,
                    total: duracion,
                    tipo: "descanso",
                    timestamp: Date.now()
                });
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausado_desayuno") { 
                        updates[`tareas/${id}/estado`] = "activo"; 
                        updates[`tareas/${id}/inicioMS`] = ahora; 
                    }
                });
                update(pausaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.registrarJornada = async (tipo) => {
            const esEntrada = tipo === 'INICIO';
            
            // Validaciones
            if (esEntrada && lineaIniciada) {
                alert('‚ö†Ô∏è La l√≠nea ya est√° activa. Debes registrar SALIDA primero.');
                return;
            }
            
            if (!esEntrada && !lineaIniciada) {
                alert('‚ö†Ô∏è La l√≠nea ya est√° parada. Debes registrar ENTRADA primero.');
                return;
            }
            
            // Si es entrada, mostrar modal para seleccionar operarios
            if (esEntrada) {
                document.getElementById('modalOperarios').classList.remove('hidden');
            } else {
                // Si es salida, registrar directamente
                await ejecutarRegistroJornada('FIN', 0);
            }
        };

        window.confirmarEntradaOperarios = async function(numOperarios) {
            cerrarModalOperarios();
            await ejecutarRegistroJornada('INICIO', numOperarios);
        };

        window.cerrarModalOperarios = function() {
            document.getElementById('modalOperarios').classList.add('hidden');
        };

        async function ejecutarRegistroJornada(tipo, numOperarios) {
            const operario = document.getElementById('selectOperario').value;
            const horaActual = new Date().toLocaleTimeString('es-ES');
            const fechaActual = obtenerFecha();
            const esEntrada = tipo === 'INICIO';
            const ahora = Date.now();
            
            // Si es entrada, activar la l√≠nea y reactivar tareas pausadas
            if (esEntrada) {
                numOperariosActivos = numOperarios;
                lineaIniciada = true;
                
                // Reactivar todas las tareas que fueron pausadas por salida de l√≠nea
                const snapTareas = await get(tareasRef);
                const tareas = snapTareas.val() || {};
                const updates = {};
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_salida_linea") {
                        updates[`tareas/${id}/estado`] = "activo";
                        updates[`tareas/${id}/inicioMS`] = ahora;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await update(ref(db), updates);
                }
            } else {
                // Si es salida, pausar todas las tareas activas
                const snapTareas = await get(tareasRef);
                const tareas = snapTareas.val() || {};
                const updates = {};
                
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_salida_linea";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await update(ref(db), updates);
                }
                
                // Desactivar la l√≠nea
                lineaIniciada = false;
                numOperariosActivos = 1; // Reset
            }
            
            // Actualizar estado de botones
            actualizarEstadoBotones();
            
            // Tabla temporal
            await push(tareasRef, { 
                operario, 
                numSerie: "---", 
                codigo: esEntrada ? `üü¢ ENTRADA (${numOperariosActivos} op.)` : "üî¥ SALIDA", 
                fecha: fechaActual, 
                inicio: horaActual, 
                fin: "---", 
                total: "REGISTRO",
                estado: "finalizado", 
                tipo: "jornada",
                numOperarios: esEntrada ? numOperariosActivos : 0
            });
            
            // Historial persistente
            await push(tareasHistorialRef, {
                operario: operario,
                numSerie: "---",
                codigo: esEntrada ? `üü¢ ENTRADA (${numOperariosActivos} op.)` : "üî¥ SALIDA",
                fecha: fechaActual,
                inicio: horaActual,
                fin: "---",
                total: 0,
                tipo: "jornada",
                numOperarios: esEntrada ? numOperariosActivos : 0,
                timestamp: Date.now()
            });
        }

        window.iniciarTarea = function() {
            // Verificar que la l√≠nea est√© iniciada
            if (!lineaIniciada) {
                alert('‚ö†Ô∏è Debes registrar la ENTRADA antes de iniciar tareas');
                return;
            }
            
            const operario = document.getElementById('selectOperario').value;
            const serie = document.getElementById('numSerie').value.trim().toUpperCase();
            const cod = document.getElementById('codigo').value.trim().toUpperCase();
            if (!serie || !cod) return;
            
            push(tareasRef, { 
                operario, 
                numSerie: serie, 
                codigo: cod, 
                fecha: obtenerFecha(), 
                inicio: new Date().toLocaleTimeString('es-ES'), 
                inicioMS: Date.now(), 
                acumuladoMS: 0, 
                estado: "activo", 
                tipo: "produccion" 
            });
            
            document.getElementById('numSerie').value = ''; 
            document.getElementById('codigo').value = ''; 
            document.getElementById('numSerie').focus();
        };

        // MANTENIMIENTO
        window.agregarMantenimiento = async function() {
            const descripcion = prompt("Descripci√≥n de la tarea de mantenimiento:");
            if (!descripcion || !descripcion.trim()) return;
            
            await push(mantenimientoRef, {
                descripcion: descripcion.trim(),
                fecha: obtenerFecha(),
                completada: false,
                timestamp: Date.now()
            });
        };

        window.completarMantenimiento = async function(id) {
            if (!confirm('¬øMarcar tarea como realizada?')) return;
            const tareaRef = ref(db, `tareas_mantenimiento/${id}`);
            await update(tareaRef, { 
                completada: true,
                fechaCompletada: obtenerFecha(),
                horaCompletada: new Date().toLocaleTimeString('es-ES')
            });
        };

        window.borrarMantenimiento = async function(id) {
            if (!confirm('¬øEliminar esta tarea de mantenimiento?')) return;
            await remove(ref(db, `tareas_mantenimiento/${id}`));
        };

        window.borrarIncidenciaTexto = async function(id) {
            if (!confirm('¬øEliminar esta incidencia?')) return;
            await remove(ref(db, `incidencias_texto/${id}`));
        };

        // ESCUCHADOR: MANTENIMIENTO
        onValue(mantenimientoRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoMantenimiento');
            cuerpo.innerHTML = "";
            const datos = snapshot.val();
            
            if (!datos) {
                cuerpo.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400 italic">No hay tareas de mantenimiento</td></tr>';
                return;
            }
            
            // Separar pendientes y completadas
            const tareasPendientes = [];
            const tareasCompletadas = [];
            
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                if (t.completada) {
                    tareasCompletadas.push({ id, ...t });
                } else {
                    tareasPendientes.push({ id, ...t });
                }
            });
            
            // Ordenar por timestamp (m√°s recientes primero)
            tareasPendientes.sort((a, b) => b.timestamp - a.timestamp);
            tareasCompletadas.sort((a, b) => b.timestamp - a.timestamp);
            
            // Mostrar pendientes primero
            tareasPendientes.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-white border-b border-slate-100 hover:bg-blue-50 transition-all">
                        <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
                        <td class="p-4 text-slate-800 font-semibold">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                                ${t.descripcion}
                            </span>
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="completarMantenimiento('${t.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase shadow-sm transition-colors">
                                ‚úì Realizada
                            </button>
                            <button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
            
            // Mostrar completadas
            tareasCompletadas.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-green-50 border-b border-slate-100 opacity-60">
                        <td class="p-4 text-slate-500 font-medium text-sm line-through">${t.fecha}</td>
                        <td class="p-4 text-slate-600 font-semibold line-through">
                            <span class="inline-flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                ${t.descripcion}
                            </span>
                            <div class="text-xs text-green-600 mt-1">‚úì Completada el ${t.fechaCompletada} a las ${t.horaCompletada}</div>
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="borrarMantenimiento('${t.id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        // ESCUCHADOR: INCIDENCIAS
        onValue(incidenciasTextoRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoIncidencias');
            cuerpo.innerHTML = "";
            const datos = snapshot.val();
            
            if (!datos) {
                cuerpo.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-slate-400 italic">No hay incidencias registradas</td></tr>';
                return;
            }
            
            const incidenciasArray = Object.keys(datos).map(id => ({ id, ...datos[id] }));
            incidenciasArray.sort((a, b) => b.timestamp - a.timestamp);
            
            incidenciasArray.forEach(t => {
                cuerpo.innerHTML += `
                    <tr class="bg-white border-b border-slate-100 hover:bg-red-50 transition-all">
                        <td class="p-4 text-slate-600 font-medium text-sm">${t.fecha}</td>
                        <td class="p-4 text-slate-800 font-semibold">${t.descripcion}</td>
                    </tr>`;
            });
        });

        // ESCUCHADOR: HISTORIAL (persistente) - Actualiza ambos gr√°ficos
        onValue(tareasHistorialRef, (snapshot) => {
            todasLasTareas = snapshot.val() || {};
            
            // MODIFICACI√ìN: Establecer filtro de fecha de hoy la primera vez
            if (primeraVez) {
                const inputFecha = document.getElementById('filtroFecha');
                if (inputFecha) {
                    inputFecha.value = obtenerFechaHoy();
                }
                
                // Establecer mes actual para productividad diaria
                const inputMes = document.getElementById('filtroMesProductividadDiaria');
                if (inputMes) {
                    const hoy = new Date();
                    const anio = hoy.getFullYear();
                    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
                    inputMes.value = `${anio}-${mes}`;
                }
                
                primeraVez = false;
            }
            
            // Actualizar gr√°fico de tareas individuales con el filtro actual
            const fechaInput = document.getElementById('filtroFecha').value;
            const fechaFiltro = fechaInput ? convertirFechaHTML(fechaInput) : null;
            actualizarGraficoPuntos(fechaFiltro);
            
            // Actualizar gr√°fico de productividad diaria
            actualizarGraficoProductividadDiaria();
            
            // Actualizar gr√°fico de productividad mensual
            actualizarGraficoProductividadMensual();
        });

        // ESCUCHADOR: TAREAS (temporal) - Solo actualiza la tabla
        onValue(tareasRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoTabla'); 
            cuerpo.innerHTML = "";
            const datos = snapshot.val(); 
            
            if (!datos) return;
            
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                const activo = t.estado === "activo";
                let rowClass = "bg-white";
                if(activo) rowClass = "bg-amber-50";
                if(t.estado === "pausa_manual") rowClass = "bg-blue-50";
                if(t.estado === "pausa_salida_linea") rowClass = "bg-purple-50";
                if(t.estado === "pausa_incidencia") rowClass = "bg-red-50";
                if(t.estado === "pausado_desayuno") rowClass = "bg-orange-50";
                if(t.estado === "pausa_reposicion") rowClass = "bg-yellow-50";

                let tiempoMostrado;
                if (activo) {
                    tiempoMostrado = `<span class="contador-vivo text-amber-600" data-inicio="${t.inicioMS}" data-acumulado="${t.acumuladoMS}">...</span>`;
                } else if (t.estado === "pausa_manual") {
                    tiempoMostrado = `<span class="text-blue-500 italic">‚è∏Ô∏è ${formatTime(t.acumuladoMS)}</span>`;
                } else if (t.estado === "pausa_salida_linea") {
                    tiempoMostrado = `<span class="text-purple-500 italic">üö™ L√≠nea Parada</span>`;
                } else if (t.estado === "pausa_incidencia") {
                    tiempoMostrado = `<span class="text-red-400 italic">üõ†Ô∏è En Incidencia</span>`;
                } else if (t.estado === "pausa_reposicion") {
                    tiempoMostrado = `<span class="text-yellow-600 italic">üì¶ En Reposici√≥n</span>`;
                } else if (t.estado === "pausado_desayuno") {
                    tiempoMostrado = `<span class="text-orange-400 italic">‚òï En Desayuno</span>`;
                } else if (t.tipo === 'jornada') {
                    tiempoMostrado = `<span class="text-slate-500 font-bold text-xs">REGISTRO</span>`;
                } else {
                    tiempoMostrado = `${t.total} min`;
                }

                cuerpo.innerHTML += `
                    <tr class="${rowClass} border-b border-slate-100 transition-all">
                        <td class="p-4 font-bold text-slate-700">${t.operario}</td>
                        <td class="p-4 text-slate-600 font-medium">${t.fecha || '-'}</td>
                        <td class="p-4 font-mono text-slate-500">${t.numSerie}</td>
                        <td class="p-4 font-bold text-slate-800">${t.codigo}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.inicio}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.fin || '--:--'}</td>
                        <td class="p-4 font-black text-center">${tiempoMostrado}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            ${activo ? `
                                <button onclick="finalizarTarea('${id}')" class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">Fin</button>
                            ` : (t.estado && t.estado.includes('pausa_') ? '‚è∏Ô∏è' : '‚úì')}
                            <button onclick="borrarTarea('${id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        onValue(incidenciaRef, s => {
            const d = s.val(); hayIncidenciaGlobal = d?.activa; inicioIncidenciaMS = d?.inicioMS;
            document.getElementById('btnIncidencia').innerHTML = hayIncidenciaGlobal ? "üõ†Ô∏è SOLUCIONAR" : "üö® INCIDENCIA";
            document.getElementById('cajaIncidencia').classList.toggle('hidden', !hayIncidenciaGlobal);
            actualizarEstadoBotones();
        });
        
        onValue(pausaRef, s => {
            const d = s.val(); estaPausadoGlobal = d?.activa; inicioPausaMS = d?.inicioMS;
            document.getElementById('btnPausa').innerHTML = estaPausadoGlobal ? "‚òï VOLVER" : "ü•ê DESAYUNO";
            document.getElementById('cajaDesayuno').classList.toggle('hidden', !estaPausadoGlobal);
            actualizarEstadoBotones();
        });
        
        onValue(reposicionRef, s => {
            const d = s.val(); hayReposicionGlobal = d?.activa; inicioReposicionMS = d?.inicioMS;
            document.getElementById('btnReposicion').innerHTML = hayReposicionGlobal ? "üì¶ LISTO" : "üì¶ REPOSICI√ìN";
            document.getElementById('cajaReposicion').classList.toggle('hidden', !hayReposicionGlobal);
            actualizarEstadoBotones();
        });

        // Inicializar estado de botones al cargar la p√°gina
        setTimeout(() => {
            actualizarEstadoBotones();
        }, 500);

        window.handleKeyPress = (e, nextId) => { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (nextId) document.getElementById(nextId).focus(); 
                else window.iniciarTarea(); 
            } 
        };
        
        window.exportarExcel = () => { 
            XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tablaProduccion")), "Dosmart_Produccion.xlsx"); 
        };
    </script>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
    <!-- Modal para eliminar punto -->
    <div id="modalEliminar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <h3 class="text-xl font-black uppercase italic text-slate-800 mb-4">üóëÔ∏è Eliminar del Historial</h3>
            <div id="infoTareaEliminar" class="bg-slate-50 rounded-xl p-4 mb-6 text-sm"></div>
            <div class="flex gap-3">
                <button onclick="cerrarModalEliminar()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">
                    Cancelar
                </button>
                <button id="btnConfirmarEliminar" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold uppercase transition-colors">
                    Eliminar Permanentemente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para seleccionar n√∫mero de operarios -->
    <div id="modalOperarios" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 transform transition-all">
            <h3 class="text-2xl font-black uppercase italic text-slate-800 mb-2 text-center">üë• Registro de Entrada</h3>
            <p class="text-slate-600 text-center mb-8">¬øCu√°ntos operarios van a trabajar?</p>
            
            <div class="grid grid-cols-2 gap-6">
                <!-- 1 Operario -->
                <button onclick="confirmarEntradaOperarios(1)" class="group relative bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200">
                    <div class="flex flex-col items-center gap-4">
                        <div class="text-6xl">üë§</div>
                        <div class="text-3xl font-black">1</div>
                        <div class="text-sm font-bold uppercase tracking-wider">Operario</div>
                    </div>
                    <div class="absolute inset-0 rounded-2xl ring-4 ring-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </button>
                
                <!-- 2 Operarios -->
                <button onclick="confirmarEntradaOperarios(2)" class="group relative bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200">
                    <div class="flex flex-col items-center gap-4">
                        <div class="text-6xl">üë•</div>
                        <div class="text-3xl font-black">2</div>
                        <div class="text-sm font-bold uppercase tracking-wider">Operarios</div>
                    </div>
                    <div class="absolute inset-0 rounded-2xl ring-4 ring-emerald-400 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </button>
            </div>
            
            <button onclick="cerrarModalOperarios()" class="w-full mt-6 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold uppercase transition-colors">
                Cancelar
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs uppercase transition-colors flex items-center gap-2">
                    ‚Üê Volver
                </a>
                <h1 class="text-4xl font-black uppercase italic tracking-tighter">Dosmart <span class="text-amber-500">Production</span></h1>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <div id="cajaIncidencia" class="hidden bg-red-100 p-2 rounded-xl text-right"><span id="tiempoIncidencia" class="font-mono font-bold text-red-700"></span></div>
                <div id="cajaDesayuno" class="hidden bg-orange-100 p-2 rounded-xl text-right"><span id="tiempoDesayuno" class="font-mono font-bold text-orange-700"></span></div>
                <div id="cajaReposicion" class="hidden bg-yellow-100 p-2 rounded-xl text-right"><span id="tiempoReposicion" class="font-mono font-bold text-yellow-700"></span></div>
                
                <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-rose-100 text-rose-600 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button id="btnReposicion" onclick="toggleReposicion()" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-yellow-500 transition-colors"></button>
                <button id="btnPausa" onclick="togglePausa()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase">Exportar a Excel</button>
            </div>
        </div>

        <!-- Botones Entrada/Salida -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="btnEntrada" onclick="registrarJornada('INICIO')" class="bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-emerald-600 transition-colors">‚òÄÔ∏è Entrada</button>
            <button id="btnSalida" onclick="registrarJornada('FIN')" class="bg-rose-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-rose-600 transition-colors opacity-50 cursor-not-allowed" disabled>üåô Salida</button>
        </div>

        <!-- Formulario Nueva Tarea -->
        <div class="bg-white rounded-[2rem] shadow-xl p-6 mb-8 border-b-4 border-amber-400 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Operario Actual</label>
                <select id="selectOperario" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400">
                    <option>Adrian Garc√≠a</option>
                    <option>Alberto Colmenero</option>
                </select>
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">N¬∫ Serie</label>
                <input id="numSerie" type="text" onkeypress="handleKeyPress(event, 'codigo')" oninput="this.value = this.value.toUpperCase()" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Tarea</label>
                <input id="codigo" type="text" onkeypress="handleKeyPress(event, null)" oninput="this.value = this.value.toUpperCase()" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <button id="btnIniciarTarea" onclick="iniciarTarea()" class="bg-amber-400 text-slate-900 font-black rounded-xl h-[56px] mt-5 hover:bg-slate-900 hover:text-white transition-all uppercase italic">Iniciar</button>
        </div>

        <!-- Indicador Estado L√≠nea -->
        <div id="indicadorLinea" class="flex justify-center mb-6">
            <span class="inline-flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-xl font-black text-xs uppercase shadow-lg">üî¥ L√≠nea Parada</span>
        </div>

        <!-- TABLA TEMPORAL -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200 mb-8">
            <div class="bg-slate-900 p-4 flex justify-between items-center">
                <h3 class="text-amber-400 font-black uppercase text-sm">Tabla de Tareas (Temporal)</h3>
                <span class="text-slate-400 text-xs">Se puede borrar sin afectar los gr√°ficos</span>
            </div>
            <table id="tablaProduccion" class="w-full text-left">
                <thead class="bg-slate-800 text-amber-400 text-[10px] font-black uppercase">
                    <tr>
                        <th class="p-4">Operario</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">Serie</th>
                        <th class="p-4">Tarea</th>
                        <th class="p-4">H. Inicio</th>
                        <th class="p-4">H. Fin</th>
                        <th class="p-4 text-center">Tiempo</th>
                        <th class="p-4 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <!-- BOT√ìN FORZAR PARADA -->
        <div class="flex justify-end mb-6">
            <button onclick="forzarParadaLinea()" id="btnForzarParada" class="opacity-50 cursor-not-allowed bg-slate-700 text-white px-5 py-2.5 rounded-xl font-black text-xs uppercase shadow flex items-center gap-2 hover:bg-red-700 transition-colors" disabled>
                ‚õî Forzar Parada de L√≠nea
            </button>
        </div>

        <!-- GR√ÅFICO 1: TAREAS INDIVIDUALES -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-slate-800">Tiempo por Tarea Individual</h2>
                    <p class="text-xs text-slate-500 mt-1">Cada punto = una tarea | Eje Y = tiempo en minutos | Eje X = orden cronol√≥gico</p>
                    <p class="text-xs text-amber-600 font-bold mt-1">üí° Solo muestra tareas finalizadas con el bot√≥n "Fin"</p>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 uppercase">üìÖ Fecha:</label>
                    <input type="date" id="filtroFecha" onchange="filtrarPorFecha()" 
                           class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                </div>
            </div>
            
            <div class="h-96 w-full">
                <canvas id="graficoTareas"></canvas>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <div class="flex justify-center gap-8">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="font-bold text-slate-700">Adrian Garc√≠a</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-red-500"></div>
                        <span class="font-bold text-slate-700">Alberto Colmenero</span>
                    </div>
                </div>
                <div id="contadorTareas" class="text-sm font-bold text-slate-500 bg-slate-100 px-4 py-2 rounded-lg">
                    Cargando...
                </div>
            </div>
        </div>

        <!-- GR√ÅFICO 2: PRODUCTIVIDAD DIARIA -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-slate-800">üìä Productividad Diaria</h2>
                    <p class="text-xs text-slate-500 mt-1">F√≥rmula: (Tareas √ó 7) / ((Salida - Entrada) √ó N¬∫ Operarios)</p>
                    <p class="text-xs text-amber-600 font-bold mt-1">üí° Haz clic en un punto para eliminar TODAS las tareas de ese d√≠a</p>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 uppercase">üìÖ Mes:</label>
                    <input type="month" id="filtroMesProductividadDiaria" onchange="cambiarMesProductividadDiaria()" 
                            class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                </div>
            </div>
            
            <div class="h-96 w-full">
                <canvas id="graficoProductividadDiaria"></canvas>
            </div>
            
            <div class="flex justify-between items-center mt-4 bg-slate-50 p-4 rounded-xl">
                <div class="flex justify-center gap-8">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                        <span class="font-bold text-slate-700">Productividad</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-1 bg-yellow-400 border-2 border-yellow-400 border-dashed"></div>
                        <span class="font-bold text-slate-700">Media</span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="mediaProductividadDiaria" class="text-lg font-black text-amber-500">
                        Media del mes: 0.00
                    </div>
                    <div id="diasConDatosDiaria" class="text-xs font-bold text-slate-500">
                        D√≠as con datos: 0
                    </div>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICO 3: PRODUCTIVIDAD MENSUAL -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-slate-800">üìà Productividad Mensual</h2>
                    <p class="text-xs text-slate-500 mt-1">Media de productividad de cada mes completo</p>
                </div>
                
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 uppercase">A√±o:</label>
                    <select id="selectAnioProductividadMensual" onchange="cambiarAnioProductividadMensual()" 
                            class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
            </div>
            
            <div class="h-96 w-full">
                <canvas id="graficoProductividadMensual"></canvas>
            </div>
            
            <div class="flex justify-between items-center mt-4 bg-slate-50 p-4 rounded-xl">
                <div class="flex justify-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-blue-500"></div>
                        <span class="font-bold text-slate-700 text-sm">Productividad</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-1 bg-yellow-400 border-2 border-yellow-400 border-dashed"></div>
                        <span class="font-bold text-slate-700 text-sm">Media</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-1 bg-gradient-to-r from-green-500 to-red-500"></div>
                        <span class="font-bold text-slate-700 text-sm">Tendencia</span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="mediaProductividadAnual" class="text-lg font-black text-amber-500">
                        Media del a√±o: 0.00
                    </div>
                    <div id="mesesConDatos" class="text-xs font-bold text-slate-500">
                        Meses con datos: 0
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLAS DE MANTENIMIENTO E INCIDENCIAS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
            <!-- TABLA MANTENIMIENTO -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-blue-200">
                <div class="bg-blue-500 p-4 flex items-center justify-between">
                    <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">
                        üîß Mantenimiento
                    </h3>
                    <button onclick="agregarMantenimiento()" class="bg-white text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-lg font-black text-xs uppercase shadow-sm transition-colors flex items-center gap-1">
                        + A√±adir tarea
                    </button>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-blue-100 text-blue-800 text-[10px] font-black uppercase sticky top-0">
                            <tr>
                                <th class="p-4 w-32">Fecha</th>
                                <th class="p-4">Descripci√≥n</th>
                                <th class="p-4 text-right w-40">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoMantenimiento" class="divide-y divide-slate-100">
                            <tr><td colspan="3" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TABLA INCIDENCIAS -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-orange-200">
                <div class="bg-orange-500 p-4">
                    <h3 class="text-white font-black uppercase text-sm flex items-center gap-2">
                        ‚ö†Ô∏è Registro de Incidencias
                    </h3>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-orange-100 text-orange-800 text-[10px] font-black uppercase sticky top-0">
                            <tr>
                                <th class="p-4 w-32">Fecha</th>
                                <th class="p-4">Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoIncidencias" class="divide-y divide-slate-100">
                            <tr><td colspan="2" class="p-8 text-center text-slate-400 italic">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
