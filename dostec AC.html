<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dostec AC Production - Control de Tareas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJAp5Zx4nmf0336aucWsQy8jB2L3LIsNM",
            authDomain: "dostecac.firebaseapp.com",
            databaseURL: "https://dostecac-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "dostecac",
            storageBucket: "dostecac.appspot.com",
            appId: "1:180048271313:web:35bdfb8a43e35fa28ab2f0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tareasRef = ref(db, 'tareas');
        const pausaRef = ref(db, 'estadoPausa');
        const incidenciaRef = ref(db, 'estadoIncidencia');
        const reposicionRef = ref(db, 'estadoReposicion');

        let estaPausadoGlobal = false;
        let hayIncidenciaGlobal = false;
        let hayReposicionGlobal = false;
        let inicioPausaMS = 0;
        let inicioIncidenciaMS = 0;
        let inicioReposicionMS = 0;

        const obtenerFecha = () => new Date().toLocaleDateString('es-ES');
        const obtenerOperarioActual = () => document.getElementById('selectOperario').value;

        function formatTime(ms) {
            if (!ms || ms < 0) return "0m 0s";
            const min = Math.floor(ms / 60000);
            const seg = Math.floor((ms % 60000) / 1000);
            return `${min}m ${seg}s`;
        }

        setInterval(() => {
            const ahora = Date.now();
            if (!estaPausadoGlobal && !hayIncidenciaGlobal && !hayReposicionGlobal) {
                document.querySelectorAll('.contador-vivo').forEach(el => {
                    const inicioMS = parseInt(el.dataset.inicio);
                    const acumuladoPrevio = parseInt(el.dataset.acumulado || 0);
                    el.innerText = formatTime((ahora - inicioMS) + acumuladoPrevio);
                });
            }
            if (estaPausadoGlobal) {
                const caja = document.getElementById('tiempoDesayuno');
                if(caja) caja.innerText = formatTime(ahora - inicioPausaMS);
            }
            if (hayIncidenciaGlobal) {
                const cajaInc = document.getElementById('tiempoIncidencia');
                if(cajaInc) cajaInc.innerText = formatTime(ahora - inicioIncidenciaMS);
            }
            if (hayReposicionGlobal) {
                const cajaRep = document.getElementById('tiempoReposicion');
                if(cajaRep) cajaRep.innerText = formatTime(ahora - inicioReposicionMS);
            }
        }, 1000);

        window.togglePausaTarea = async function(id) {
            const ahora = Date.now();
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            if (t.estado === "activo") {
                const nuevoAcumulado = (t.acumuladoMS || 0) + (ahora - t.inicioMS);
                update(ref(db, `tareas/${id}`), { estado: "pausa_manual", acumuladoMS: nuevoAcumulado });
            } else if (t.estado === "pausa_manual") {
                update(ref(db, `tareas/${id}`), { estado: "activo", inicioMS: ahora });
            }
        };

        window.finalizarTarea = async function(id) {
            if(!confirm('¬øFinalizar tarea?')) return;
            const snap = await get(ref(db, `tareas/${id}`));
            const t = snap.val();
            let totalMS = (t.acumuladoMS || 0);
            if(t.estado === "activo") totalMS += (Date.now() - t.inicioMS);
            update(ref(db, `tareas/${id}`), { 
                fin: new Date().toLocaleTimeString('es-ES'), 
                total: Math.max(1, Math.round(totalMS / 60000)), 
                estado: "finalizado" 
            });
        };

        window.borrarTarea = (id) => { if (confirm('¬øBorrar tarea?')) remove(ref(db, `tareas/${id}`)); };
        window.borrarTodoElRegistro = () => { if (confirm("¬øBORRAR TODO EL REGISTRO?")) remove(tareasRef); };

        window.toggleReposicion = async function() {
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};

            if (!hayReposicionGlobal) {
                update(reposicionRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_reposicion";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapR = await get(reposicionRef);
                const infoR = snapR.val();
                push(tareasRef, { operario: infoR.operario || "SISTEMA", numSerie: "---", codigo: "üì¶ REPOSICI√ìN", fecha: infoR.fecha, inicio: infoR.horaTexto, fin: new Date().toLocaleTimeString('es-ES'), total: Math.round((ahora - infoR.inicioMS) / 60000) || 1, estado: "finalizado", tipo: "reposicion" });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_reposicion") {
                        updates[`tareas/${id}/estado`] = "activo";
                        updates[`tareas/${id}/inicioMS`] = ahora;
                    }
                });
                update(reposicionRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.toggleIncidencia = async function() {
            const ahora = Date.now();
            const snapTareas = await get(tareasRef);
            const tareas = snapTareas.val() || {};
            const updates = {};
            if (!hayIncidenciaGlobal) {
                const motivo = prompt("Motivo de la incidencia:"); 
                if (!motivo) return;
                update(incidenciaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), motivo: motivo.trim(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausa_incidencia";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapI = await get(incidenciaRef);
                const infoInc = snapI.val();
                push(tareasRef, { operario: infoInc.operario || "SISTEMA", numSerie: "---", codigo: `‚ö†Ô∏è INCIDENCIA: ${infoInc.motivo}`, fecha: infoInc.fecha, inicio: infoInc.horaTexto, fin: new Date().toLocaleTimeString('es-ES'), total: Math.round((ahora - infoInc.inicioMS) / 60000) || 1, estado: "finalizado", tipo: "incidencia" });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausa_incidencia") { updates[`tareas/${id}/estado`] = "activo"; updates[`tareas/${id}/inicioMS`] = ahora; }
                });
                update(incidenciaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.togglePausa = async function() {
            const ahora = Date.now(); 
            const snapTareas = await get(tareasRef); 
            const tareas = snapTareas.val() || {}; 
            const updates = {};
            if (!estaPausadoGlobal) {
                // Al iniciar el desayuno, guardamos qu√© operario lo activ√≥
                update(pausaRef, { activa: true, inicioMS: ahora, horaTexto: new Date().toLocaleTimeString('es-ES'), fecha: obtenerFecha(), operario: obtenerOperarioActual() });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "activo") {
                        const acumuladoSesion = ahora - tareas[id].inicioMS;
                        updates[`tareas/${id}/estado`] = "pausado_desayuno";
                        updates[`tareas/${id}/acumuladoMS`] = (tareas[id].acumuladoMS || 0) + acumuladoSesion;
                    }
                });
            } else {
                const snapP = await get(pausaRef);
                const infoP = snapP.val();
                // Al finalizar, usamos el nombre guardado previamente
                push(tareasRef, { operario: infoP.operario || "SISTEMA", numSerie: "---", codigo: "‚òï DESAYUNO", fecha: infoP.fecha, inicio: infoP.horaTexto, fin: new Date().toLocaleTimeString('es-ES'), total: Math.round((ahora - infoP.inicioMS) / 60000) || 1, estado: "finalizado", tipo: "descanso" });
                Object.keys(tareas).forEach(id => {
                    if (tareas[id].estado === "pausado_desayuno") { updates[`tareas/${id}/estado`] = "activo"; updates[`tareas/${id}/inicioMS`] = ahora; }
                });
                update(pausaRef, { activa: false, inicioMS: 0 });
            }
            if (Object.keys(updates).length > 0) update(ref(db), updates);
        };

        window.iniciarTarea = function() {
            const operario = document.getElementById('selectOperario').value;
            const serie = document.getElementById('numSerie').value.trim();
            const cod = document.getElementById('codigo').value.trim();
            if (!serie || !cod) return;
            push(tareasRef, { operario, numSerie: serie, codigo: cod, fecha: obtenerFecha(), operarios: document.getElementById('numOperarios').value, inicio: new Date().toLocaleTimeString('es-ES'), inicioMS: Date.now(), acumuladoMS: 0, estado: "activo", tipo: "produccion" });
            document.getElementById('numSerie').value = ''; document.getElementById('codigo').value = ''; document.getElementById('numSerie').focus();
        };

        window.registrarJornada = (tipo) => {
            const operario = document.getElementById('selectOperario').value;
            push(tareasRef, { operario, numSerie: "---", codigo: tipo === 'INICIO' ? "üü¢ ENTRADA" : "üî¥ SALIDA", fecha: obtenerFecha(), inicio: new Date().toLocaleTimeString('es-ES'), fin: "---", total: "REGISTRO", estado: "finalizado", tipo: "jornada" });
        };

        onValue(tareasRef, (snapshot) => {
            const cuerpo = document.getElementById('cuerpoTabla'); cuerpo.innerHTML = "";
            const datos = snapshot.val(); if (!datos) return;
            Object.keys(datos).forEach(id => {
                const t = datos[id];
                const activo = t.estado === "activo";
                let rowClass = "bg-white";
                if(activo) rowClass = "bg-amber-50";
                if(t.estado === "pausa_manual") rowClass = "bg-blue-50";
                if(t.estado === "pausa_incidencia") rowClass = "bg-red-50";
                if(t.estado === "pausado_desayuno") rowClass = "bg-orange-50";
                if(t.estado === "pausa_reposicion") rowClass = "bg-yellow-50";

                cuerpo.innerHTML += `
                    <tr class="${rowClass} border-b border-slate-100 transition-all">
                        <td class="p-4 font-bold text-slate-700">${t.operario}</td>
                        <td class="p-4 text-slate-600 font-medium">${t.fecha || '-'}</td>
                        <td class="p-4 font-mono text-slate-500">${t.numSerie}</td>
                        <td class="p-4 font-bold text-slate-800">${t.codigo}</td>
                        <td class="p-4 text-center font-bold text-xs">${t.operarios || '-'}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.inicio}</td>
                        <td class="p-4 font-mono text-[10px] text-slate-400">${t.fin || '--:--'}</td>
                        <td class="p-4 font-black">
                            ${activo ? `<span class="contador-vivo text-amber-600" data-inicio="${t.inicioMS}" data-acumulado="${t.acumuladoMS}">...</span>` : 
                             (t.estado === "pausa_manual" ? `<span class="text-blue-500 italic">‚è∏Ô∏è ${formatTime(t.acumuladoMS)}</span>` : 
                             (t.estado === "pausa_incidencia" ? `<span class="text-red-400 italic">üõ†Ô∏è En Incidencia</span>` :
                             (t.estado === "pausa_reposicion" ? `<span class="text-yellow-600 italic">üì¶ En Reposici√≥n</span>` :
                             (t.estado === "pausado_desayuno" ? `<span class="text-orange-400 italic">‚òï En Desayuno</span>` : 
                             `${t.total} min`))))}
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            ${(activo || t.estado === "pausa_manual") ? `
                                <button onclick="togglePausaTarea('${id}')" class="${activo ? 'bg-blue-500' : 'bg-emerald-500'} text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">
                                    ${activo ? 'Pausa' : 'Seguir'}
                                </button>
                                <button onclick="finalizarTarea('${id}')" class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase shadow-sm">Fin</button>
                            ` : (t.estado.includes('pausa_') ? '‚è∏Ô∏è' : '‚úì')}
                            <button onclick="borrarTarea('${id}')" class="text-slate-300 hover:text-red-500 ml-2">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        });

        onValue(incidenciaRef, s => {
            const d = s.val(); hayIncidenciaGlobal = d?.activa; inicioIncidenciaMS = d?.inicioMS;
            document.getElementById('btnIncidencia').innerHTML = hayIncidenciaGlobal ? "üõ†Ô∏è SOLUCIONAR" : "üö® INCIDENCIA";
            document.getElementById('cajaIncidencia').classList.toggle('hidden', !hayIncidenciaGlobal);
        });
        onValue(pausaRef, s => {
            const d = s.val(); estaPausadoGlobal = d?.activa; inicioPausaMS = d?.inicioMS;
            document.getElementById('btnPausa').innerHTML = estaPausadoGlobal ? "‚òï VOLVER" : "ü•ê DESAYUNO";
            document.getElementById('cajaDesayuno').classList.toggle('hidden', !estaPausadoGlobal);
        });
        onValue(reposicionRef, s => {
            const d = s.val(); hayReposicionGlobal = d?.activa; inicioReposicionMS = d?.inicioMS;
            document.getElementById('btnReposicion').innerHTML = hayReposicionGlobal ? "üì¶ LISTO" : "üì¶ REPOSICI√ìN";
            document.getElementById('cajaReposicion').classList.toggle('hidden', !hayReposicionGlobal);
        });

        window.handleKeyPress = (e, nextId) => { if (e.key === 'Enter') { e.preventDefault(); if (nextId) document.getElementById(nextId).focus(); else window.iniciarTarea(); } };
        window.exportarExcel = () => { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("tablaProduccion")), "DostecAC_Produccion.xlsx"); };
    </script>
</head>
<body class="bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-4xl font-black uppercase italic tracking-tighter">Dostec AC <span class="text-amber-500">Production</span></h1>
            <div class="flex flex-wrap justify-center gap-3">
                <div id="cajaIncidencia" class="hidden bg-red-100 p-2 rounded-xl text-right"><span id="tiempoIncidencia" class="font-mono font-bold text-red-700"></span></div>
                <div id="cajaDesayuno" class="hidden bg-orange-100 p-2 rounded-xl text-right"><span id="tiempoDesayuno" class="font-mono font-bold text-orange-700"></span></div>
                <div id="cajaReposicion" class="hidden bg-yellow-100 p-2 rounded-xl text-right"><span id="tiempoReposicion" class="font-mono font-bold text-yellow-700"></span></div>
                
                <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-rose-100 text-rose-600 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button id="btnReposicion" onclick="toggleReposicion()" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-yellow-500 transition-colors"></button>
                <button id="btnPausa" onclick="togglePausa()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs"></button>
                <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold text-xs uppercase">Excel</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="registrarJornada('INICIO')" class="bg-emerald-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg">‚òÄÔ∏è Entrada</button>
            <button onclick="registrarJornada('FIN')" class="bg-rose-500 text-white p-4 rounded-2xl font-black uppercase shadow-lg">üåô Salida</button>
        </div>

        <div class="bg-white rounded-[2rem] shadow-xl p-6 mb-8 border-b-4 border-amber-400 grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="flex flex-col"><label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Operario Actual</label>
                <select id="selectOperario" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400">
                    <option>Adrian Garc√≠a</option>
                    <option>Aitor Bautista</option>
                </select>
            </div>
            <div class="flex flex-col"><label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">N¬∫ Serie</label>
                <input id="numSerie" type="text" onkeypress="handleKeyPress(event, 'codigo')" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <div class="flex flex-col"><label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Tarea</label>
                <input id="codigo" type="text" onkeypress="handleKeyPress(event, null)" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-amber-400 uppercase">
            </div>
            <div class="flex flex-col"><label class="text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">Equipo</label>
                <select id="numOperarios" class="bg-slate-50 p-4 rounded-xl font-bold border-none outline-none">
                    <option value="1">1 Pers.</option>
                    <option value="2">2 Pers.</option>
                    <option value="3">3 Pers.</option>
                </select>
            </div>
            <button onclick="iniciarTarea()" class="bg-amber-400 text-slate-900 font-black rounded-xl h-[56px] mt-5 hover:bg-slate-900 hover:text-white transition-all uppercase italic">Iniciar</button>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200">
            <table id="tablaProduccion" class="w-full text-left">
                <thead class="bg-slate-900 text-amber-400 text-[10px] font-black uppercase">
                    <tr>
                        <th class="p-5">Operario</th><th class="p-5">Fecha</th><th class="p-5">Serie</th><th class="p-5">Tarea</th><th class="p-5 text-center">EQ</th><th class="p-5">H. Inicio</th><th class="p-5">H. Fin</th><th class="p-5">Tiempo</th><th class="p-5 text-right">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div class="flex justify-center p-8">
            <button onclick="borrarTodoElRegistro()" class="text-red-400 font-bold text-[10px] uppercase tracking-widest hover:text-red-600 transition-colors">üóëÔ∏è Borrar Todo el Registro</button>
        </div>
    </div>
</body>
</html>