<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dostec 40 - Cloud MES</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDqmHebrFc5yDzzpwtiW33q4lDEfxQ_bWo",
    authDomain: "tempprod-2ecad.firebaseapp.com",
    databaseURL: "https://tempprod-2ecad-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "tempprod-2ecad",
    storageBucket: "tempprod-2ecad.firebasestorage.app",
    messagingSenderId: "791527902001",
    appId: "1:791527902001:web:75d104fba52a0dbfc33e10",
    measurementId: "G-EEZ4G15HEJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tareasRef = ref(db, 'tareas');
const planRef = ref(db, 'planificacion');
const productividadDiariaRef = ref(db, 'productividadDiaria');
const estadoSesionRef = ref(db, 'estadoSesion');
const preferenciasRef = ref(db, 'preferencias');
const tiempoPorTareaRef = ref(db, 'tiempoPorTarea');
const mantenimientoRef = ref(db, 'mantenimiento');
const incidenciasLogRef = ref(db, 'incidenciasLog');

const state = {
    operarios: 0,
    pausaDesayuno: false,
    incidencia: false,
    reposicion: false,
    ids: { pausa: null, incidencia: null, reposicion: null },
    modo: "entrada",
    pedidosOrdenados: [],
    chart: null,
    chartDiario: null,
    chartMensual: null,
    chartTiempoMensual: null,
    mesTiempoMensual: null,
    sortable: null,
    entradaLineaHoy: null,
    salidaLineaHoy: null,
    mesSeleccionado: null,
    fechaProdSeleccionada: null,
    anioSeleccionado: null,
    inicializado: false,
    modoEdicionGrafico: false,
    filtroFechaTareas: null,
    firebaseConectado: false,
    modoPrueba: false,
    filtroPlanFecha: 'hoy',
    planDataCache: {},
};

// Listener para estado de conexi√≥n con Firebase
const conexionRef = ref(db, '.info/connected');
onValue(conexionRef, (snap) => {
    const conectado = snap.val() === true;
    state.firebaseConectado = conectado;
    actualizarIndicadorConexion(conectado);
});

const actualizarIndicadorConexion = (conectado) => {
    if (state.modoPrueba) return; // No sobreescribir si est√° en modo prueba
    const indicador = document.getElementById('indicadorFirebase');
    const led = document.getElementById('ledFirebase');
    const texto = document.getElementById('textoFirebase');
    if (!indicador || !led || !texto) return;

    // Limpiar todas las clases de color posibles
    indicador.classList.remove('bg-red-100','border-red-300','bg-emerald-100','border-emerald-400','bg-orange-100','border-orange-400');
    led.classList.remove('bg-red-500','animate-pulse','bg-emerald-500','shadow-emerald-500/60','led-conectado','bg-orange-500');
    texto.classList.remove('text-red-700','text-emerald-800','text-orange-700');

    if (conectado) {
        indicador.classList.add('bg-emerald-100', 'border-emerald-400');
        led.classList.add('bg-emerald-500', 'shadow-emerald-500/60', 'led-conectado');
        texto.textContent = 'EN L√çNEA';
        texto.classList.add('text-emerald-800');
    } else {
        indicador.classList.add('bg-red-100', 'border-red-300');
        led.classList.add('bg-red-500', 'animate-pulse');
        texto.textContent = 'SIN CONEXI√ìN';
        texto.classList.add('text-red-700');
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODO PRUEBA ‚Äî bloquea todas las escrituras
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.toggleModoPrueba = () => {
    state.modoPrueba = !state.modoPrueba;
    const btn = document.getElementById('btnModoPrueba');
    const indicador = document.getElementById('indicadorFirebase');
    const led = document.getElementById('ledFirebase');
    const texto = document.getElementById('textoFirebase');
    const banner = document.getElementById('bannerModoPrueba');

    if (state.modoPrueba) {
        btn.textContent = 'üî¥ Desactivar prueba';
        btn.classList.replace('bg-slate-100', 'bg-orange-100');
        btn.classList.replace('text-slate-600', 'text-orange-700');
        btn.classList.replace('border-slate-200', 'border-orange-300');
        indicador.classList.remove('bg-emerald-100', 'border-emerald-400');
        indicador.classList.add('bg-orange-100', 'border-orange-400');
        led.classList.remove('bg-emerald-500', 'led-conectado');
        led.classList.add('bg-orange-500');
        texto.textContent = 'MODO PRUEBA';
        texto.classList.remove('text-emerald-800');
        texto.classList.add('text-orange-700');
        if (banner) banner.classList.remove('hidden');
    } else {
        btn.textContent = 'üß™ Modo prueba';
        btn.classList.replace('bg-orange-100', 'bg-slate-100');
        btn.classList.replace('text-orange-700', 'text-slate-600');
        btn.classList.replace('border-orange-300', 'border-slate-200');
        actualizarIndicadorConexion(state.firebaseConectado);
        texto.classList.remove('text-orange-700');
        if (banner) banner.classList.add('hidden');
    }
};

const puedeEscribir = () => {
    if (state.modoPrueba) {
        console.warn('[MODO PRUEBA] Escritura bloqueada');
        return false;
    }
    return true;
};

const guardarEstadoSesion = async (datos) => {
    if (!puedeEscribir()) return;
    await update(estadoSesionRef, datos);
};

const obtenerEstadoSesion = async () => {
    const snapshot = await get(estadoSesionRef);
    return snapshot.val() || {};
};

const guardarPreferencias = async (clave, valor) => {
    if (!puedeEscribir()) return;
    await update(ref(db, `preferencias/${clave}`), { valor });
};

const obtenerPreferencias = async () => {
    const snapshot = await get(preferenciasRef);
    return snapshot.val() || {};
};

const obtenerProductividadDiaria = async () => {
    const snapshot = await get(productividadDiariaRef);
    return snapshot.val() || {};
};

const guardarTiempoPorTarea = async (fecha, serie, tiempo, finMS) => {
    if (!puedeEscribir()) return;
    const fechaKey = fechaToKey(fecha);
    // Verificar si ya existe un registro para esta serie en esta fecha (evitar duplicados)
    const snapshot = await get(ref(db, `tiempoPorTarea/${fechaKey}`));
    const existentes = snapshot.val() || {};
    const yaDuplicado = Object.values(existentes).some(e => e.serie === serie);
    if (yaDuplicado) return; // No guardar si ya existe un punto para esta serie hoy
    await push(ref(db, `tiempoPorTarea/${fechaKey}`), {
        serie, tiempo, finMS, timestamp: Date.now()
    });
};

const obtenerTiempoPorTarea = async (fecha) => {
    const fechaKey = fechaToKey(fecha);
    const snapshot = await get(ref(db, `tiempoPorTarea/${fechaKey}`));
    return snapshot.val() || {};
};

const calcularProductividadDiaria = (totalTareas, horasPonderadas) => {
    // horasPonderadas = suma de (horas_sesion √ó operarios_sesion)
    if (horasPonderadas <= 0) return 0;
    const prod = (totalTareas * 7) / horasPonderadas;
    return isFinite(prod) ? Math.round(prod * 10) / 10 : 0;
};

const guardarSesionDiaria = async (fecha, operarios, tareasEnSesion, horasEnSesion) => {
    if (!puedeEscribir()) return;
    const fechaKey = fechaToKey(fecha);
    const snapDia = await get(ref(db, `productividadDiaria/${fechaKey}`));
    const diaActual = snapDia.val() || { totalTareas: 0, horasPonderadas: 0 };
    
    diaActual.totalTareas     = (diaActual.totalTareas     || 0) + tareasEnSesion;
    diaActual.horasPonderadas = (diaActual.horasPonderadas || 0) + (horasEnSesion * operarios);
    diaActual.productividad   = calcularProductividadDiaria(diaActual.totalTareas, diaActual.horasPonderadas);
    
    await update(ref(db, `productividadDiaria/${fechaKey}`), diaActual);
};

window.recalcularProductividadHoy = async () => {
    const hoy = tsToFechaLocal(Date.now());
    const fechaKey = fechaToKey(hoy);
    const snapshot = await get(tareasRef);
    if (!snapshot.exists()) return;

    const tareas = Object.values(snapshot.val());

    // Encontrar todos los pares ENTRADA/SALIDA del d√≠a de hoy
    const entradas = tareas
        .filter(t => t.numSerie === 'ENTRADA L√çNEA' && tsToFechaLocal(t.inicioMS) === hoy)
        .sort((a, b) => a.inicioMS - b.inicioMS);

    const salidas = tareas
        .filter(t => t.numSerie === 'SALIDA L√çNEA' && tsToFechaLocal(t.inicioMS) === hoy)
        .sort((a, b) => a.inicioMS - b.inicioMS);

    // Emparejar cada entrada con su salida m√°s cercana posterior
    let horasPonderadas = 0;
    let totalTareas = 0;
    let resumenSesiones = '';

    entradas.forEach(entrada => {
        const operariosSesion = entrada.operarios || 1;
        const salidaCorrespondiente = salidas.find(s => s.inicioMS > entrada.inicioMS);
        const hastaMS = salidaCorrespondiente ? salidaCorrespondiente.inicioMS : Date.now();
        const horasSesion = (hastaMS - entrada.inicioMS) / (1000 * 3600);
        horasPonderadas += horasSesion * operariosSesion;
        resumenSesiones += `\nSesi√≥n ${operariosSesion} op: ${horasSesion.toFixed(2)}h √ó ${operariosSesion} = ${(horasSesion * operariosSesion).toFixed(2)}h`;

        // Contar tareas finalizadas en esta sesi√≥n
        tareas.forEach(t => {
            if (t.estado === 'finalizado' && t.codigo !== 'SISTEMA' && t.total > 0
                && t.finMS && t.finMS >= entrada.inicioMS && t.finMS <= hastaMS) {
                totalTareas++;
            }
        });
    });

    const productividad = calcularProductividadDiaria(totalTareas, horasPonderadas);

    await update(ref(db, `productividadDiaria/${fechaKey}`), {
        totalTareas,
        horasPonderadas: Math.round(horasPonderadas * 1000) / 1000,
        productividad
    });

    await actualizarGraficoDiario(state.mesSeleccionado);

    alert(`‚úÖ Productividad del ${hoy} recalculada${resumenSesiones}\n\nHoras ponderadas totales: ${horasPonderadas.toFixed(2)}h\nTareas: ${totalTareas}\nProductividad: ${productividad}`);
};

const festivosEspa = [
    [1, 1], [1, 6], [5, 1], [8, 15], [10, 12], [11, 1], [12, 25]
];

const esFestivo = (year, month, day) => {
    return festivosEspa.some(([m, d]) => m === (month + 1) && d === day);
};

const esFinDeSemana = (year, month, day) => {
    const fecha = new Date(year, month, day);
    const diaSemana = fecha.getDay();
    return diaSemana === 0 || diaSemana === 6;
};

const tsToFechaLocal = (ms) => {
    const d = new Date(Number(ms));
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const fechaToKey = (fecha) => fecha.replace(/-/g, '_');

// ‚úÖ CORREGIDO: Sintaxis correcta para Chart.js
const actualizarGraficoProd = (datosProd, fechaSeleccionada = null) => {
    let ctx = document.getElementById('graficoProd');
    const container = document.getElementById('graficoContainer');
    if (!ctx || !container) return;
    
    const tituloFecha = document.getElementById('tituloFechaProd');
    if (tituloFecha && fechaSeleccionada) {
        const hoy = tsToFechaLocal(Date.now());
        tituloFecha.textContent = fechaSeleccionada === hoy ? 'Hoy' :
            new Date(fechaSeleccionada + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
    }
    
    if (!datosProd || datosProd.length === 0) {
        if (state.chart) state.chart.destroy();
        const mediaIndicator = document.getElementById('mediaValor');
        if (mediaIndicator) mediaIndicator.textContent = '--';
        
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Tiempo (min)',
                    data: [],
                    borderColor: 'rgba(99, 102, 241, 1)',
                    pointBackgroundColor: 'rgba(99, 102, 241, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Sin datos para la fecha seleccionada',
                        font: { size: 12, weight: 'bold' },
                        color: '#94a3b8'
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'N√∫mero de Serie', font: { size: 11, weight: 'bold' } },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Minutos', font: { size: 11, weight: 'bold' } }
                    }
                }
            }
        });
        return;
    }
    
    const tiempos = datosProd.map(d => d.tiempo);
    const series = datosProd.map(d => d.serie);
    const media = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
    
    const mediaIndicator = document.getElementById('mediaValor');
    if (mediaIndicator) {
        mediaIndicator.textContent = media.toFixed(1) + ' min';
        mediaIndicator.className = 'font-black text-lg text-yellow-700';
    }
    
    if (state.chart) {
        state.chart.destroy();
        state.chart = null;
        // Resetear el canvas para evitar instancias hu√©rfanas de Chart.js
        const parent = ctx.parentNode;
        const newCanvas = document.createElement('canvas');
        newCanvas.id = ctx.id;
        newCanvas.className = ctx.className;
        parent.replaceChild(newCanvas, ctx);
        ctx = newCanvas;
    }
    
    state.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: series.map((s, i) => i + 1),
            datasets: [{
                label: 'Tiempo (min)',
                data: tiempos,
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                order: 2
            }, {
                label: `Media (${media.toFixed(1)} min)`,
                data: Array(series.length).fill(media),
                borderColor: 'rgba(250, 204, 21, 1)',
                borderWidth: 3,
                borderDash: [6, 4],
                pointRadius: 0,
                fill: false,
                order: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        title: (items) => `Serie: ${series[items[0].dataIndex]}`,
                        label: (item) => {
                            if (item.dataset.label.includes('Media')) return item.dataset.label;
                            const tiempo = item.parsed.y;
                            const productividad = (420 / tiempo).toFixed(1);
                            return [
                                `Tiempo: ${tiempo.toFixed(1)} min`,
                                `Productividad: ${productividad}`,
                                `vs Media: ${(tiempo - media).toFixed(1)} min`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Orden de finalizaci√≥n', font: { size: 11, weight: 'bold' } },
                    grid: { display: false },
                    ticks: {
                        font: { size: 9, weight: 'bold' },
                        maxTicksLimit: 40,
                        autoSkip: true
                    }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Minutos', font: { size: 11, weight: 'bold' } },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                }
            }
        }
    });
};

const actualizarGraficoTiempoMensual = async (mesObj = null) => {
    const ctx = document.getElementById('graficoTiempoMensual');
    if (!ctx) return;

    const hoy = new Date();
    const m = mesObj || { year: hoy.getFullYear(), month: hoy.getMonth() };

    // Actualizar texto del filtro
    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const nombreMes = document.getElementById('nombreMesTiempoMensual');
    const anioMes   = document.getElementById('anioMesTiempoMensual');
    if (nombreMes) nombreMes.textContent = MESES[m.month];
    if (anioMes)   anioMes.textContent   = m.year;

    const diasDelMes = new Date(m.year, m.month + 1, 0).getDate();
    const dias = Array.from({ length: diasDelMes }, (_, i) => i + 1);

    // Para cada d√≠a, calcular la media de tiempos de las tareas
    const medias = await Promise.all(dias.map(async dia => {
        const mes   = String(m.month + 1).padStart(2, '0');
        const diaS  = String(dia).padStart(2, '0');
        const fecha = `${m.year}-${mes}-${diaS}`;
        const snap  = await get(ref(db, `tiempoPorTarea/${fechaToKey(fecha)}`));
        const datos = snap.val();
        if (!datos) return null;
        const tiempos = Object.values(datos).map(t => t.tiempo).filter(t => t > 0);
        return tiempos.length > 0 ? tiempos.reduce((a, b) => a + b, 0) / tiempos.length : null;
    }));

    const conDatos   = medias.filter(v => v !== null);
    const mediaTotal = conDatos.length > 0 ? conDatos.reduce((a, b) => a + b, 0) / conDatos.length : 0;

    // Tendencia lineal sobre d√≠as con datos
    const idxConDatos = medias.map((v, i) => v !== null ? i : null).filter(i => i !== null);
    const valConDatos = idxConDatos.map(i => medias[i]);
    let tendenciaDatos = null;
    let tendenciaDescendente = false;
    if (idxConDatos.length >= 2) {
        const n = idxConDatos.length;
        const sx  = idxConDatos.reduce((a, b) => a + b, 0);
        const sy  = valConDatos.reduce((a, b) => a + b, 0);
        const sxy = idxConDatos.reduce((s, x, i) => s + x * valConDatos[i], 0);
        const sx2 = idxConDatos.reduce((s, x) => s + x * x, 0);
        const pendiente = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
        const intercept = (sy - pendiente * sx) / n;
        tendenciaDescendente = pendiente <= 0;
        tendenciaDatos = dias.map((_, i) => Math.max(0, pendiente * i + intercept));
    }

    if (state.chartTiempoMensual) state.chartTiempoMensual.destroy();

    const dsTM = [
        {
            label: 'Tiempo medio (min)',
            data: medias,
            spanGaps: true,
            borderColor: 'rgba(99,102,241,1)',
            backgroundColor: 'rgba(99,102,241,0.1)',
            pointBackgroundColor: (c) => c.raw === null ? 'transparent' : 'rgba(99,102,241,1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: (c) => c.raw === null ? 0 : 5,
            pointHoverRadius: 7,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            order: 2
        },
        {
            label: `Media (${mediaTotal.toFixed(1)} min)`,
            data: Array(diasDelMes).fill(mediaTotal > 0 ? mediaTotal : null),
            borderColor: 'rgba(250,204,21,1)',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            order: 1
        }
    ];
    if (tendenciaDatos) {
        dsTM.push({
            label: tendenciaDescendente ? 'Tendencia ‚Üò Mejora' : 'Tendencia ‚Üó Empeora',
            data: tendenciaDatos,
            borderColor: tendenciaDescendente ? 'rgba(16,185,129,1)' : 'rgba(239,68,68,1)',
            borderWidth: 2,
            borderDash: [8, 4],
            pointRadius: 0,
            fill: false,
            tension: 0,
            order: 0
        });
    }

    state.chartTiempoMensual = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dias.map(d => `${d}`),
            datasets: dsTM
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: { usePointStyle: true, boxWidth: 10, font: { size: 10, weight: 'bold' } }
                },
                tooltip: {
                    callbacks: {
                        title: (items) => `D√≠a ${dias[items[0].dataIndex]}`,
                        label: (item) => item.raw !== null ? `${item.dataset.label.includes('Media') ? item.dataset.label : `Tiempo medio: ${item.raw.toFixed(1)} min`}` : ''
                    }
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, title: { display: true, text: 'Minutos', font: { size: 10, weight: 'bold' } } }
            }
        }
    });
};

window.cambiarMesTiempoMensual = (dir) => {
    const m = state.mesTiempoMensual || { year: new Date().getFullYear(), month: new Date().getMonth() };
    let mes  = m.month + dir;
    let anio = m.year;
    if (mes > 11) { mes = 0;  anio++; }
    if (mes < 0)  { mes = 11; anio--; }
    state.mesTiempoMensual = { year: anio, month: mes };
    actualizarGraficoTiempoMensual(state.mesTiempoMensual);
};

window.seleccionarFechaProd = async (fecha) => {
    state.fechaProdSeleccionada = fecha;
    await guardarPreferencias('fechaProdSeleccionada', fecha);
    const datosGuardados = await obtenerTiempoPorTarea(fecha);
    const datosProd = Object.values(datosGuardados)
        .sort((a, b) => (a.finMS || 0) - (b.finMS || 0))
        .map(t => ({ serie: t.serie, tiempo: t.tiempo }));
    actualizarGraficoProd(datosProd, fecha);
    renderizarListaPuntos(fecha);
    
    // Sincronizar tabla de tareas con la misma fecha (sin bucle)
    if (state.filtroFechaTareas === fecha) return;
    state.filtroFechaTareas = fecha;
    const btnFiltro = document.getElementById('btnFiltroFechaTareas');
    const tituloTabla = document.getElementById('tituloTablaTareas');
    if (btnFiltro && tituloTabla) {
        const hoy = new Date().toISOString().split('T')[0];
        const esHoy = fecha === hoy;
        btnFiltro.classList.replace('bg-slate-800', 'bg-emerald-600');
        btnFiltro.innerHTML = `üìÖ ${esHoy ? 'Hoy' : new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}`;
        tituloTabla.textContent = 'Pedidos en proceso';
    }
    await renderizarTablaTareas();
};

const renderizarListaPuntos = async (fecha) => {
    const lista = document.getElementById('listaPuntosTiempo');
    if (!lista || lista.classList.contains('hidden')) return;
    
    const datos = await obtenerTiempoPorTarea(fecha);
    const items = Object.entries(datos).sort((a, b) => (a[1].finMS || 0) - (b[1].finMS || 0));
    
    if (items.length === 0) {
        lista.innerHTML = '<p class="text-[10px] font-black text-red-600 uppercase mb-2 flex items-center gap-1">Modo edici√≥n ‚Äî sin puntos para este d√≠a</p>';
        return;
    }
    
    lista.innerHTML = `
        <p class="text-[10px] font-black text-red-600 uppercase mb-2">Modo edici√≥n ‚Äî pulsa üóëÔ∏è para borrar un punto</p>
        <table class="w-full text-xs">
            <thead><tr class="bg-slate-100 text-slate-500 font-black uppercase text-[9px]">
                <th class="p-1.5 text-left">#</th>
                <th class="p-1.5 text-left">Serie</th>
                <th class="p-1.5 text-center">Tiempo</th>
                <th class="p-1.5"></th>
            </tr></thead>
            <tbody>
                ${items.map(([id, t], i) => `
                    <tr class="border-b border-slate-100 hover:bg-red-50">
                        <td class="p-1.5 text-slate-400 font-bold">${i + 1}</td>
                        <td class="p-1.5 font-black text-slate-700">${t.serie || '‚Äî'}</td>
                        <td class="p-1.5 text-center"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-black">${t.tiempo} min</span></td>
                        <td class="p-1.5 text-right">
                            <button onclick="borrarPuntoTiempo('${fecha}', '${id}')" class="bg-red-100 hover:bg-red-600 text-red-500 hover:text-white p-1 rounded-lg transition-all">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
};

// Utilidad para limpiar duplicados en Firebase (ejecutar desde consola)
window.limpiarDuplicadosTiempoPorTarea = async (fecha = null) => {
    const f = fecha || tsToFechaLocal(Date.now());
    const fechaKey = fechaToKey(f);
    const snap = await get(ref(db, `tiempoPorTarea/${fechaKey}`));
    const datos = snap.val() || {};
    const vistos = {};
    const aEliminar = [];
    for (const [id, t] of Object.entries(datos)) {
        if (vistos[t.serie]) {
            aEliminar.push(id); // duplicado, conservar el primero
        } else {
            vistos[t.serie] = true;
        }
    }
    for (const id of aEliminar) {
        await remove(ref(db, `tiempoPorTarea/${fechaKey}/${id}`));
    }
    console.log(`Limpieza completada para ${f}: ${aEliminar.length} duplicados eliminados.`);
    alert(`‚úÖ ${aEliminar.length} duplicados eliminados para ${f}`);
};

window.borrarPuntoTiempo = async (fecha, puntoId) => {
    const fechaKey = fechaToKey(fecha);
    await remove(ref(db, `tiempoPorTarea/${fechaKey}/${puntoId}`));
    const datosGuardados = await obtenerTiempoPorTarea(fecha);
    const datosProd = Object.values(datosGuardados)
        .sort((a, b) => (a.finMS || 0) - (b.finMS || 0))
        .map(d => ({ serie: d.serie, tiempo: d.tiempo }));
    actualizarGraficoProd(datosProd, fecha);
    renderizarListaPuntos(fecha);
};

window.toggleModoEdicionGrafico = () => {
    state.modoEdicionGrafico = !state.modoEdicionGrafico;
    const btn = document.getElementById('btnEditarGrafico');
    const lista = document.getElementById('listaPuntosTiempo');
    
    if (state.modoEdicionGrafico) {
        btn.classList.replace('bg-slate-100', 'bg-red-100');
        btn.classList.replace('text-slate-600', 'text-red-600');
        btn.classList.replace('border-slate-200', 'border-red-300');
        btn.innerHTML = '‚ùå Salir edici√≥n';
        lista.classList.remove('hidden');
        renderizarListaPuntos(state.fechaProdSeleccionada || tsToFechaLocal(Date.now()));
    } else {
        btn.classList.replace('bg-red-100', 'bg-slate-100');
        btn.classList.replace('text-red-600', 'text-slate-600');
        btn.classList.replace('border-red-300', 'border-slate-200');
        btn.innerHTML = '‚úèÔ∏è Editar puntos';
        lista.classList.add('hidden');
    }
};

window.mostrarSelectorFechaProd = () => {
    const fechaGuardada = state.fechaProdSeleccionada || new Date().toISOString().split('T')[0];
    const input = document.getElementById('inputFechaProd');
    if (input) {
        input.value = fechaGuardada;
        input.showPicker();
    }
};

// ‚úÖ CORREGIDO: Sintaxis correcta para Chart.js
const actualizarGraficoDiario = async (mesSeleccionado = null) => {
    const ctx = document.getElementById('graficoDiario');
    if (!ctx) return;
    
    const productividadDiaria = await obtenerProductividadDiaria();
    const hoy = new Date();
    const mesAMostrar = mesSeleccionado || { year: hoy.getFullYear(), month: hoy.getMonth() };
    const dias = Array.from({ length: 31 }, (_, i) => i + 1);
    
    const valores = dias.map(dia => {
        const mes = String(mesAMostrar.month + 1).padStart(2, '0');
        const diaStr = String(dia).padStart(2, '0');
        const fechaStr = `${mesAMostrar.year}-${mes}-${diaStr}`;
        const fechaKey = fechaStr.replace(/-/g, '_');
        return productividadDiaria[fechaKey]?.productividad || 0;
    });
    
    const valoresConDatos = valores.filter(v => v > 0);
    const media = valoresConDatos.length > 0 ? valoresConDatos.reduce((a, b) => a + b, 0) / valoresConDatos.length : 0;
    
    // Convertir 0s en null para unir puntos reales con spanGaps sin bajar a 0
    const valoresConNull = valores.map(v => v === 0 ? null : v);

    if (state.chartDiario) state.chartDiario.destroy();
    
    state.chartDiario = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dias.map(d => `${d}`),
            datasets: [{
                label: 'Productividad Diaria',
                data: valoresConNull,
                spanGaps: true,
                borderColor: 'rgba(37, 99, 235, 1)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                pointBackgroundColor: (ctx) => {
                    if (ctx.raw === null) return 'transparent';
                    const dia = dias[ctx.dataIndex];
                    const val = ctx.raw;
                    if (esFestivo(mesAMostrar.year, mesAMostrar.month, dia) || esFinDeSemana(mesAMostrar.year, mesAMostrar.month, dia)) {
                        return 'rgba(180, 180, 180, 0.7)';
                    }
                    return val >= 19 ? 'rgba(16, 185, 129, 1)' : 'rgba(37, 99, 235, 1)';
                },
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: (ctx) => ctx.raw === null ? 0 : 5,
                pointHoverRadius: 7,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                order: 2
            }, {
                label: 'Objetivo (19)',
                data: Array(31).fill(19),
                borderColor: 'rgba(239, 68, 68, 1)',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                order: 3
            }, {
                label: `Media (${media.toFixed(1)})`,
                data: Array(31).fill(media),
                borderColor: 'rgba(250, 204, 21, 1)',
                borderWidth: 3,
                borderDash: [6, 4],
                pointRadius: 0,
                fill: false,
                order: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, suggestedMax: 30 }
            }
        }
    });
};

const calcularTendencia = (valores) => {
    const n = valores.length;
    const indices = valores.map((_, i) => i);
    const sumaX = indices.reduce((a, b) => a + b, 0);
    const sumaY = valores.reduce((a, b) => a + b, 0);
    const sumaXY = indices.reduce((sum, x, i) => sum + x * valores[i], 0);
    const sumaX2 = indices.reduce((sum, x) => sum + x * x, 0);
    const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
    const intercept = (sumaY - pendiente * sumaX) / n;
    return { pendiente, datos: indices.map(x => pendiente * x + intercept) };
};

// ‚úÖ CORREGIDO: Sintaxis correcta para Chart.js
const actualizarGraficoMensual = async (anioSeleccionado = null) => {
    const ctx = document.getElementById('graficoMensual');
    if (!ctx) return;
    
    const productividadDiaria = await obtenerProductividadDiaria();
    const anio = anioSeleccionado || new Date().getFullYear();
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const valoresMensuales = [];
    
    for (let mes = 0; mes < 12; mes++) {
        const diasDelMes = new Date(anio, mes + 1, 0).getDate();
        let suma = 0, diasConDatos = 0;
        for (let dia = 1; dia <= diasDelMes; dia++) {
            const mesStr = String(mes + 1).padStart(2, '0');
            const diaStr = String(dia).padStart(2, '0');
            const fechaStr = `${anio}-${mesStr}-${diaStr}`;
            const fechaKey = fechaStr.replace(/-/g, '_');
            const prod = productividadDiaria[fechaKey]?.productividad || 0;
            if (prod > 0) { suma += prod; diasConDatos++; }
        }
        valoresMensuales.push(diasConDatos > 0 ? suma / diasConDatos : 0);
    }
    
    const mesesConDatos = valoresMensuales.filter(v => v > 0);
    const tendencia = mesesConDatos.length >= 2 ? calcularTendencia(valoresMensuales) : null;
    const esTendenciaPositiva = tendencia && tendencia.pendiente >= 0;
    
    const tendenciaPos = document.getElementById('tendenciaPositiva');
    const tendenciaNeg = document.getElementById('tendenciaNegativa');
    if (tendencia) {
        if (tendenciaPos) tendenciaPos.style.display = esTendenciaPositiva ? 'flex' : 'none';
        if (tendenciaNeg) tendenciaNeg.style.display = esTendenciaPositiva ? 'none' : 'flex';
    } else {
        if (tendenciaPos) tendenciaPos.style.display = 'none';
        if (tendenciaNeg) tendenciaNeg.style.display = 'none';
    }
    
    if (state.chartMensual) state.chartMensual.destroy();
    
    const datasets = [
        {
            label: `Media Mensual (${mesesConDatos.length > 0 ? (mesesConDatos.reduce((a,b)=>a+b,0)/mesesConDatos.length).toFixed(1) : '--'})`,
            data: valoresMensuales,
            borderColor: 'rgba(37, 99, 235, 1)',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(37, 99, 235, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            fill: true,
            tension: 0.4,
            order: 2
        },
        {
            label: 'Objetivo (19)',
            data: Array(12).fill(19),
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            order: 3
        }
    ];
    
    if (tendencia) {
        const colorTendencia = esTendenciaPositiva ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
        datasets.push({
            label: esTendenciaPositiva ? 'Tendencia ‚Üó Positiva' : 'Tendencia ‚Üò Negativa',
            data: tendencia.datos,
            borderColor: colorTendencia,
            backgroundColor: esTendenciaPositiva ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)',
            borderWidth: 3,
            borderDash: [10, 5],
            pointRadius: 0,
            fill: false,
            order: 1,
            tension: 0
        });
    }
    
    state.chartMensual = new Chart(ctx, {
        type: 'line',
        data: { labels: meses, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 10,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, suggestedMax: 25 }
            }
        }
    });
};

window.cambiarAnio = async (direccion) => {
    const nuevoAnio = state.anioSeleccionado + direccion;
    state.anioSeleccionado = nuevoAnio;
    await guardarPreferencias('anioMensualSeleccionado', nuevoAnio);
    await actualizarGraficoMensual(nuevoAnio);
    const anioEl = document.getElementById('anioMensual');
    if (anioEl) anioEl.textContent = nuevoAnio;
};

window.cambiarMes = async (direccion) => {
    const mesActual = state.mesSeleccionado || { year: new Date().getFullYear(), month: new Date().getMonth() };
    let nuevoMes = mesActual.month + direccion;
    let nuevoAnio = mesActual.year;
    if (nuevoMes > 11) { nuevoMes = 0; nuevoAnio++; }
    if (nuevoMes < 0) { nuevoMes = 11; nuevoAnio--; }
    const mesSeleccionado = { year: nuevoAnio, month: nuevoMes };
    state.mesSeleccionado = mesSeleccionado;
    await guardarPreferencias('mesDiarioSeleccionado', mesSeleccionado);
    await actualizarGraficoDiario(mesSeleccionado);
    actualizarTextoMiniCalendario(mesSeleccionado);
};

const actualizarTextoMiniCalendario = (mes) => {
    const fecha = new Date(mes.year, mes.month, 1);
    const nombreMes = fecha.toLocaleString('es-ES', { month: 'long' });
    const nombreMesEl = document.getElementById('nombreMesDiario');
    const anioMesEl = document.getElementById('anioMesDiario');
    if (nombreMesEl) nombreMesEl.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);
    if (anioMesEl) anioMesEl.textContent = mes.year;
};

// Timer para tareas activas
setInterval(() => {
    document.querySelectorAll('[data-inicio-ms]').forEach(el => {
        const inicioMS = parseInt(el.getAttribute('data-inicio-ms'));
        const diff = Date.now() - inicioMS;
        const min = Math.floor(diff / 60000);
        const sec = Math.floor((diff % 60000) / 1000);
        el.innerText = `${min}m ${sec}s`;
    });
}, 1000);

// ‚úÖ Verificar cambio de d√≠a autom√°ticamente
let ultimoDiaCargado = tsToFechaLocal(Date.now());
setInterval(async () => {
    const diaActual = tsToFechaLocal(Date.now());
    if (diaActual !== ultimoDiaCargado) {
        ultimoDiaCargado = diaActual;
        state.filtroFechaTareas = diaActual;
        await aplicarFiltroFechaTareas(diaActual);
        console.log('üîÑ Filtro actualizado al nuevo d√≠a:', diaActual);
    }
}, 60000);

const actualizarEstadoLineaUI = () => {
    const indicador = document.getElementById('estadoLineaIndicador');
    const btns = {
        entrada: document.getElementById('btnEntradaLinea'),
        salida: document.getElementById('btnSalidaLinea'),
        desayuno: document.getElementById('btnDesayuno'),
        incidencia: document.getElementById('btnIncidencia'),
        reposicion: document.getElementById('btnReposicion')
    };
    
    if (state.operarios > 0) {
        indicador.innerHTML = `<span class="flex items-center gap-2 bg-emerald-100 text-emerald-700 px-4 py-1.5 rounded-full border border-emerald-300 animate-pulse"><span class="w-3 h-3 bg-emerald-600 rounded-full"></span> L√çNEA ACTIVA (${state.operarios} Op.)</span>`;
        
        if (btns.entrada) btns.entrada.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        if (btns.salida) btns.salida.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        
        if (btns.desayuno) btns.desayuno.classList.remove('opacity-50', 'cursor-not-allowed');
        if (btns.incidencia) btns.incidencia.classList.remove('opacity-50', 'cursor-not-allowed');
        if (btns.reposicion) btns.reposicion.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        indicador.innerHTML = `<span class="flex items-center gap-2 bg-slate-200 text-slate-600 px-4 py-1.5 rounded-full border border-slate-300"><span class="w-3 h-3 bg-slate-400 rounded-full"></span> L√çNEA PARADA</span>`;
        
        if (btns.entrada) btns.entrada.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        if (btns.salida) btns.salida.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
        
        if (btns.desayuno) btns.desayuno.classList.add('opacity-50', 'cursor-not-allowed');
        if (btns.incidencia) btns.incidencia.classList.add('opacity-50', 'cursor-not-allowed');
        if (btns.reposicion) btns.reposicion.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // Actualizar iconos de botones seg√∫n estado
    if (state.reposicion && btns.reposicion) {
        btns.reposicion.innerHTML = '‚èπÔ∏è Fin Reposici√≥n';
        btns.reposicion.classList.replace('bg-purple-600', 'bg-blue-600');
    } else if (btns.reposicion) {
        btns.reposicion.innerHTML = 'üîÑ Reposici√≥n';
        btns.reposicion.classList.replace('bg-blue-600', 'bg-purple-600');
    }
    
    if (state.pausaDesayuno && btns.desayuno) {
        btns.desayuno.innerHTML = '‚òï Fin Desayuno';
        btns.desayuno.classList.replace('bg-orange-500', 'bg-blue-600');
    } else if (btns.desayuno) {
        btns.desayuno.innerHTML = '‚òï Desayuno';
        btns.desayuno.classList.replace('bg-blue-600', 'bg-orange-500');
    }
    
    if (state.incidencia && btns.incidencia) {
        btns.incidencia.innerHTML = '‚ö†Ô∏è Fin Incidencia';
        btns.incidencia.classList.replace('bg-red-600', 'bg-blue-600');
    } else if (btns.incidencia) {
        btns.incidencia.innerHTML = '‚ö†Ô∏è Incidencia';
        btns.incidencia.classList.replace('bg-blue-600', 'bg-red-600');
    }
};

window.mostrarSelectorOperarios = async (modo = "entrada") => {
    if (modo === "entrada") {
        if (state.operarios > 0) {
            alert("‚ö†Ô∏è ATENCI√ìN: La l√≠nea ya est√° activa.");
            return;
        }
        
        // Validar entrada/salida 1:1
        const snapshot = await get(tareasRef);
        let entradaSinSalida = false;
        if (snapshot.exists()) {
            const tareas = snapshot.val();
            const entradas = Object.entries(tareas)
                .filter(([id, t]) => t.numSerie === "ENTRADA L√çNEA")
                .sort((a, b) => a[1].inicioMS - b[1].inicioMS);
            const salidas = Object.entries(tareas)
                .filter(([id, t]) => t.numSerie === "SALIDA L√çNEA")
                .sort((a, b) => a[1].inicioMS - b[1].inicioMS);
            
            if (entradas.length > salidas.length) {
                entradaSinSalida = true;
            }
        }
        
        if (entradaSinSalida) {
            alert("‚ö†Ô∏è ATENCI√ìN: Debes registrar SALIDA L√çNEA antes de una nueva entrada.");
            return;
        }
    }
    
    if (modo === "reposicion") {
        if (state.operarios > 0) {
            alert("‚ö†Ô∏è ATENCI√ìN: Solo se puede reponer con la l√≠nea parada.");
            return;
        }
        if (state.reposicion) {
            finalizarReposicion();
            return;
        }
    }
    
    state.modo = modo;
    document.getElementById('tituloModal').innerText = modo === "reposicion" ? "Operarios para Reposici√≥n" : "Seleccione Operarios en L√≠nea";
    document.getElementById('modalOperarios').classList.remove('hidden');
    document.getElementById('modalOperarios').classList.add('flex');
};

const finalizarReposicion = async () => {
    const snapshot = await get(ref(db, `tareas/${state.ids.reposicion}`));
    if (snapshot.exists()) {
        const minutos = Math.max(1, Math.round((Date.now() - snapshot.val().inicioMS) / 60000));
        await update(ref(db, `tareas/${state.ids.reposicion}`), {
            fin: new Date().toLocaleTimeString('es-ES'),
            total: minutos,
            estado: "finalizado"
        });
    }
    state.reposicion = false;
    state.ids.reposicion = null;
    actualizarEstadoLineaUI();
};

window.cerrarSelector = () => {
    document.getElementById('modalOperarios').classList.add('hidden');
    document.getElementById('modalOperarios').classList.remove('flex');
};

window.seleccionarOperarios = async (num) => {
    if (state.modo === "entrada") {
        state.operarios = num;
        const ahoraMSTime = Date.now();
        state.entradaLineaHoy = ahoraMSTime;
        await guardarEstadoSesion({ operarios: num, entradaLineaHoy: ahoraMSTime, salidaLineaHoy: null });
        await push(tareasRef, {
            numSerie: "ENTRADA L√çNEA",
            codigo: "SISTEMA",
            notas: "",
            operarios: num,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: ahoraMSTime,
            fin: "--:--",
            total: 0,
            estado: "finalizado"
        });
    } else if (state.modo === "reposicion") {
        const nuevaRep = await push(tareasRef, {
            numSerie: "REPOSICI√ìN",
            codigo: "SISTEMA",
            notas: "",
            operarios: num,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_reposicion_sistema"
        });
        state.ids.reposicion = nuevaRep.key;
        state.reposicion = true;
    }
    actualizarEstadoLineaUI();
    cerrarSelector();
};

window.registrarSalida = async () => {
    if (state.operarios === 0) {
        alert("La l√≠nea ya est√° cerrada.");
        return;
    }
    
    const ahoraMSTime = Date.now();
    const fechaHoy = tsToFechaLocal(ahoraMSTime);
    
    await push(tareasRef, {
        numSerie: "SALIDA L√çNEA",
        codigo: "SISTEMA",
        notas: "",
        operarios: state.operarios,
        inicio: new Date().toLocaleTimeString('es-ES'),
        inicioMS: ahoraMSTime,
        fin: "--:--",
        total: 0,
        estado: "finalizado"
    });
    
    const snapshot = await get(tareasRef);
    const entradaMS = state.entradaLineaHoy;
    const operariosSesion = state.operarios;
    let tareasEnSesion = 0;
    
    if (snapshot.exists()) {
        Object.values(snapshot.val()).forEach(t => {
            const fechaTarea = tsToFechaLocal(t.inicioMS);
            // Contar tareas finalizadas en esta sesi√≥n (entre entradaMS y ahoraMSTime)
            if (fechaTarea === fechaHoy && t.estado === 'finalizado' && t.codigo !== 'SISTEMA' && t.total > 0
                && t.finMS && t.finMS >= entradaMS && t.finMS <= ahoraMSTime) {
                tareasEnSesion++;
            }
        });
    }
    
    const horasEnSesion = entradaMS ? (ahoraMSTime - entradaMS) / (1000 * 3600) : 0;
    await guardarSesionDiaria(fechaHoy, operariosSesion, tareasEnSesion, horasEnSesion);
    
    state.operarios = 0;
    state.entradaLineaHoy = null;
    state.salidaLineaHoy = null;
    await guardarEstadoSesion({ operarios: 0, entradaLineaHoy: null, salidaLineaHoy: null });
    
    actualizarEstadoLineaUI();
    
    if (state.inicializado) {
        await actualizarGraficoDiario(state.mesSeleccionado);
        await actualizarGraficoMensual(state.anioSeleccionado);
    }
};

window.pausaDesayuno = async () => {
    if (state.operarios === 0 || state.incidencia) return;
    
    const snapshot = await get(tareasRef);
    const updates = {};
    
    if (!state.pausaDesayuno) {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "activo") {
                    updates[`${child.key}/estado`] = "pausa";
                    updates[`${child.key}/tiempoAcumuladoMS`] = Date.now() - child.val().inicioMS;
                }
            });
        }
        const nuevaPausa = await push(tareasRef, {
            numSerie: "PAUSA DESAYUNO",
            codigo: "SISTEMA",
            notas: "",
            operarios: state.operarios,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_pausa_sistema"
        });
        state.ids.pausa = nuevaPausa.key;
        state.pausaDesayuno = true;
    } else {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "pausa") {
                    const acumulado = child.val().tiempoAcumuladoMS || 0;
                    updates[`${child.key}/inicioMS`] = Date.now() - acumulado;
                    updates[`${child.key}/estado`] = "activo";
                }
                if (child.key === state.ids.pausa) {
                    const minutos = Math.max(1, Math.round((Date.now() - child.val().inicioMS) / 60000));
                    updates[`${child.key}/fin`] = new Date().toLocaleTimeString('es-ES');
                    updates[`${child.key}/total`] = minutos;
                    updates[`${child.key}/estado`] = "finalizado";
                }
            });
        }
        state.pausaDesayuno = false;
        state.ids.pausa = null;
    }
    
    await update(tareasRef, updates);
    actualizarEstadoLineaUI();
};

window.toggleIncidencia = async () => {
    if (state.operarios === 0 || state.pausaDesayuno) return;
    
    const snapshot = await get(tareasRef);
    const updates = {};
    
    if (!state.incidencia) {
        const motivo = prompt("Indique el motivo de la incidencia:");
        if (!motivo) return;
        
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "activo") {
                    updates[`${child.key}/estado`] = "incidencia_pausa";
                    updates[`${child.key}/tiempoAcumuladoMS`] = Date.now() - child.val().inicioMS;
                }
            });
        }
        
        const nuevaInc = await push(tareasRef, {
            numSerie: "INCIDENCIA",
            codigo: "SISTEMA",
            notas: motivo,
            operarios: state.operarios,
            inicio: new Date().toLocaleTimeString('es-ES'),
            inicioMS: Date.now(),
            fin: "--:--",
            total: 0,
            estado: "en_incidencia_sistema"
        });
        state.ids.incidencia = nuevaInc.key;
        state.incidencia = true;
        
        push(incidenciasLogRef, {
            texto: motivo,
            fecha: tsToFechaLocal(Date.now()),
            hora: new Date().toLocaleTimeString('es-ES'),
            timestamp: Date.now()
        });
    } else {
        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                if (child.val().estado === "incidencia_pausa") {
                    const acumulado = child.val().tiempoAcumuladoMS || 0;
                    updates[`${child.key}/inicioMS`] = Date.now() - acumulado;
                    updates[`${child.key}/estado`] = "activo";
                }
                if (child.key === state.ids.incidencia) {
                    const minutos = Math.max(1, Math.round((Date.now() - child.val().inicioMS) / 60000));
                    updates[`${child.key}/fin`] = new Date().toLocaleTimeString('es-ES');
                    updates[`${child.key}/total`] = minutos;
                    updates[`${child.key}/estado`] = "finalizado";
                }
            });
        }
        state.incidencia = false;
        state.ids.incidencia = null;
    }
    
    await update(tareasRef, updates);
    actualizarEstadoLineaUI();
};

window.dispararSelector = () => document.getElementById('file-input').click();

window.procesarArchivo = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
            
            if (json.length === 0) {
                alert("El archivo est√° vac√≠o");
                return;
            }
            
            let count = 0;
            let resumen = [];
            json.forEach(item => {
                const cleanItem = {};
                Object.keys(item).forEach(key => {
                    cleanItem[key.trim().toLowerCase()] = String(item[key]).trim();
                });
                
                // Saltar filas vac√≠as (sin pedido ni c√≥digo)
                const pedido = cleanItem["pedido"] || cleanItem["orden"] || "";
                const codigo = cleanItem["c√≥digo"] || cleanItem["codigo"] || "";
                if (!pedido && !codigo) return;
                
                const cliente = cleanItem["cliente"] || cleanItem["client"] || "Sin cliente";
                const notas = cleanItem["notas"] || cleanItem["observaciones"] || "";
                const serieBase = cleanItem["serie"] || cleanItem["n¬∫ serie"] || "";
                // Acepta: unidades, unidaes (typo), cantidad, uds, qty
                const cantidad = parseInt(cleanItem["unidaes"] || cleanItem["unidades"] || cleanItem["cantidad"] || cleanItem["uds"] || cleanItem["qty"] || "1") || 1;
                
                // Separar prefijo (letras) de la parte num√©rica del n¬∫ de serie
                // Ej: "D456872" ‚Üí prefijo="D", numero=456872, padding=6
                // Ej: "RS-00152" ‚Üí prefijo="RS-", numero=152, padding=5
                const matchSerie = serieBase.match(/^(.*?)(\d+)$/);
                let prefijo = "";
                let numeroBase = 0;
                let padding = 0;
                
                if (matchSerie) {
                    prefijo = matchSerie[1];
                    const parteNumerica = matchSerie[2];
                    numeroBase = parseInt(parteNumerica);
                    padding = parteNumerica.length;
                }
                
                for (let i = 0; i < cantidad; i++) {
                    let serieGenerada;
                    if (matchSerie) {
                        serieGenerada = prefijo + String(numeroBase + i).padStart(padding, '0');
                    } else {
                        serieGenerada = i === 0 ? (serieBase || "--") : `${serieBase || "--"}-${i + 1}`;
                    }
                    
                    push(planRef, {
                        pedido: pedido || "S/P",
                        cliente,
                        codigo: codigo || "--",
                        serie: serieGenerada,
                        notas,
                        orden: Date.now() + count++
                    });
                }
                resumen.push(`Pedido ${pedido || "S/P"}: ${cantidad} uds (${serieBase} ‚Üí ${prefijo}${String(numeroBase + cantidad - 1).padStart(padding, '0')})`);
            });
            
            alert(`‚úÖ ${count} series cargadas\n\n${resumen.join('\n')}`);
        } catch (error) {
            alert("‚ùå Error: " + error.message);
        }
        e.target.value = "";
    };
    reader.readAsArrayBuffer(file);
};

window.mostrarModalExportar = () => {
    const modal = document.getElementById('modalExportar');
    const hoy = new Date().toISOString().split('T')[0];
    const hace7Dias = new Date();
    hace7Dias.setDate(hace7Dias.getDate() - 7);
    const fechaInicio = hace7Dias.toISOString().split('T')[0];
    
    document.getElementById('fechaInicioExport').value = fechaInicio;
    document.getElementById('fechaFinExport').value = hoy;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

window.cerrarModalExportar = () => {
    const modal = document.getElementById('modalExportar');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.exportarAExcelRango = async () => {
    const fechaInicio = document.getElementById('fechaInicioExport').value;
    const fechaFin = document.getElementById('fechaFinExport').value;
    
    if (!fechaInicio || !fechaFin) {
        alert("‚ö†Ô∏è Por favor selecciona ambas fechas");
        return;
    }
    
    if (fechaInicio > fechaFin) {
        alert("‚ö†Ô∏è La fecha de inicio no puede ser posterior a la fecha fin");
        return;
    }
    
    const snapshot = await get(tareasRef);
    if (!snapshot.exists()) {
        alert("‚ùå No hay datos para exportar");
        cerrarModalExportar();
        return;
    }
    
    const todasLasTareas = snapshot.val();
    const tareasFiltradas = [];
    
    Object.entries(todasLasTareas).forEach(([id, tarea]) => {
        const fechaTarea = tsToFechaLocal(tarea.inicioMS);
        if (fechaTarea >= fechaInicio && fechaTarea <= fechaFin) {
            tareasFiltradas.push({
                'Fecha': fechaTarea,
                'Hora Inicio': tarea.inicio,
                'Hora Fin': tarea.fin,
                'Serie': tarea.numSerie,
                'C√≥digo': tarea.codigo,
                'Operarios': tarea.operarios,
                'Notas': tarea.notas,
                'Total (min)': tarea.total,
                'Productividad': tarea.total > 0 ? (420 / tarea.total).toFixed(2) : '-',
                'Estado': tarea.estado
            });
        }
    });
    
    if (tareasFiltradas.length === 0) {
        alert(`‚ùå No hay tareas entre ${fechaInicio} y ${fechaFin}`);
        cerrarModalExportar();
        return;
    }
    
    const ws = XLSX.utils.json_to_sheet(tareasFiltradas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Producci√≥n");
    
    const colWidths = [
        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 20 }, { wch: 15 },
        { wch: 10 }, { wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 15 }
    ];
    ws['!cols'] = colWidths;
    
    const nombreArchivo = `Produccion_${fechaInicio}_a_${fechaFin}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
    
    alert(`‚úÖ Exportadas ${tareasFiltradas.length} tareas`);
    cerrarModalExportar();
};

window.exportarAExcel = () => {
    mostrarModalExportar();
};

window.abrirMantenimiento = () => {
    const texto = prompt("üìù Descripci√≥n de la tarea de mantenimiento:");
    if (!texto || !texto.trim()) return;
    const fecha = tsToFechaLocal(Date.now());
    push(mantenimientoRef, { texto: texto.trim(), fecha, realizado: false, timestamp: Date.now() });
};

window.toggleMantenimiento = async (id, actual) => {
    await update(ref(db, `mantenimiento/${id}`), { realizado: !actual });
};

window.borrarMantenimiento = async (id) => {
    if (confirm("¬øEliminar esta tarea de mantenimiento?")) {
        await remove(ref(db, `mantenimiento/${id}`));
    }
};

window.borrarIncidenciaLog = async (id) => {
    if (confirm("¬øEliminar este registro de incidencia?")) {
        await remove(ref(db, `incidenciasLog/${id}`));
    }
};

window.editarIncidenciaLog = async (id, textoActual) => {
    const nuevoTexto = prompt("Editar motivo de la incidencia:", textoActual);
    if (nuevoTexto === null || nuevoTexto.trim() === '') return;
    await update(ref(db, `incidenciasLog/${id}`), { texto: nuevoTexto.trim() });
};

window.toggleGrupo = (pedidoId) => {
    const rows = document.querySelectorAll(`.grupo-${pedidoId}`);
    const icon = document.getElementById(`icon-${pedidoId}`);
    rows.forEach(row => row.classList.toggle('hidden'));
    if (icon) icon.classList.toggle('rotate-90');
};

window.borrarSeriePendiente = (id, e) => {
    e.stopPropagation();
    if (confirm("¬øEliminar serie?")) {
        remove(ref(db, `planificacion/${id}`));
    }
};

window.borrarPedidoCompleto = (ids, e) => {
    e.stopPropagation();
    if (confirm(`¬øEliminar todo el pedido (${ids.length} series)?`)) {
        ids.forEach(id => remove(ref(db, `planificacion/${id}`)));
    }
};

window.iniciarDesdePlan = (id, serie, cod, notas, pedido, cliente) => {
    if (!state.operarios || state.operarios === 0) {
        alert("‚ö†Ô∏è ATENCI√ìN: Debes pulsar 'ENTRADA L√çNEA' primero.");
        return;
    }
    remove(ref(db, `planificacion/${id}`));
    push(tareasRef, {
        numSerie: serie,
        codigo: cod,
        notas: notas,
        pedido: pedido || "",
        cliente: cliente || "",
        operarios: state.operarios,
        inicio: new Date().toLocaleTimeString('es-ES'),
        inicioMS: Date.now(),
        fin: "--:--",
        total: 0,
        estado: "activo"
    });
};

window.finalizarTarea = async (id, inicioMS) => {
    // Guardia anti-doble clic: verificar que la tarea no est√© ya finalizada
    const snapCheck = await get(ref(db, `tareas/${id}`));
    if (!snapCheck.exists()) return;
    if (snapCheck.val().estado === "finalizado") return;

    const inicioMSNum = Number(inicioMS);
    const minutos = Math.max(1, Math.round((Date.now() - inicioMSNum) / 60000));
    const finMS = Date.now();
    
    const snapshot = await get(ref(db, `tareas/${id}`));
    if (!snapshot.exists()) return;
    
    const tarea = snapshot.val();
    const fecha = tsToFechaLocal(tarea.inicioMS);
    
    if (tarea.codigo !== "SISTEMA") {
        await guardarTiempoPorTarea(fecha, tarea.numSerie, minutos, finMS);
        // ‚ö†Ô∏è No llamar actualizarGraficoProd aqu√≠: el onValue listener ya lo hace
        // al detectar el cambio en Firebase, evitando llamadas dobles que generan puntos fantasma
    }
    
    await update(ref(db, `tareas/${id}`), {
        fin: new Date().toLocaleTimeString('es-ES'),
        finMS,
        total: minutos,
        estado: "finalizado"
    });
};

window.borrarRegistro = (id) => {
    if (confirm("¬øEliminar?")) {
        remove(ref(db, `tareas/${id}`));
    }
};

const guardarOrdenPedidos = async () => {
    const updates = {};
    state.pedidosOrdenados.forEach((pedidoId, index) => {
        updates[`${pedidoId}/orden`] = index;
    });
    await update(planRef, updates);
};

const inicializarDragDrop = () => {
    const tbody = document.getElementById('cuerpoPlan');
    if (tbody && !state.sortable) {
        state.sortable = new Sortable(tbody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            filter: '.grupo-item',
            onEnd: async function(evt) {
                const newOrder = [];
                tbody.querySelectorAll('.pedido-header').forEach(row => {
                    const pedidoKey = row.getAttribute('data-pedido-key');
                    if (pedidoKey) newOrder.push(pedidoKey);
                });
                state.pedidosOrdenados = newOrder;
                await guardarOrdenPedidos();
            }
        });
    }
};

window.mostrarFiltroFechaTareas = () => {
    const input = document.getElementById('inputFiltroFechaTareas');
    const hoy = new Date().toISOString().split('T')[0];
    input.value = state.filtroFechaTareas || hoy;
    input.showPicker();
};

window.aplicarFiltroFechaTareas = async (fecha) => {
    state.filtroFechaTareas = fecha;
    const btnFiltro = document.getElementById('btnFiltroFechaTareas');
    const tituloTabla = document.getElementById('tituloTablaTareas');
    
    if (fecha) {
        const hoy = new Date().toISOString().split('T')[0];
        const esHoy = fecha === hoy;
        btnFiltro.classList.replace('bg-slate-800', 'bg-emerald-600');
        btnFiltro.innerHTML = `üìÖ ${esHoy ? 'Hoy' : new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}`;
        tituloTabla.textContent = 'Pedidos en proceso';
    } else {
        resetFiltroFechaTareas();
    }
    
    await renderizarTablaTareas();
    
    // Sincronizar gr√°fico de tiempo por tarea con la misma fecha (sin bucle)
    if (fecha && state.fechaProdSeleccionada !== fecha) await seleccionarFechaProd(fecha);
};

window.resetFiltroFechaTareas = () => {
    state.filtroFechaTareas = null;
    const btnFiltro = document.getElementById('btnFiltroFechaTareas');
    const tituloTabla = document.getElementById('tituloTablaTareas');
    
    btnFiltro.classList.replace('bg-emerald-600', 'bg-slate-800');
    btnFiltro.innerHTML = 'üìÖ Filtrar fecha';
    tituloTabla.textContent = 'Pedidos en proceso';
    
    renderizarTablaTareas();
};

const renderizarTablaTareas = async () => {
    const snapshot = await get(tareasRef);
    const cuerpo = document.getElementById('cuerpoActividad');
    cuerpo.innerHTML = "";
    
    if (!snapshot.exists()) {
        cuerpo.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">No hay tareas registradas</td></tr>';
        return;
    }
    
    const data = snapshot.val();
    const tareas = Object.entries(data);
    let tareasFiltradas = tareas;
    
    if (state.filtroFechaTareas) {
        tareasFiltradas = tareas.filter(([id, t]) => {
            const fechaTarea = tsToFechaLocal(t.inicioMS);
            return fechaTarea === state.filtroFechaTareas;
        });
    }
    
    tareasFiltradas.sort((a, b) => (a[1].inicioMS || 0) - (b[1].inicioMS || 0));
    
    // Actualizar estados del sistema
    state.pausaDesayuno = !!tareas.find(([id, t]) => t.estado === "en_pausa_sistema");
    state.incidencia = !!tareas.find(([id, t]) => t.estado === "en_incidencia_sistema");
    state.reposicion = !!tareas.find(([id, t]) => t.estado === "en_reposicion_sistema");
    
    if (state.pausaDesayuno) state.ids.pausa = tareas.find(([id, t]) => t.estado === "en_pausa_sistema")?.[0];
    if (state.incidencia) state.ids.incidencia = tareas.find(([id, t]) => t.estado === "en_incidencia_sistema")?.[0];
    if (state.reposicion) state.ids.reposicion = tareas.find(([id, t]) => t.estado === "en_reposicion_sistema")?.[0];
    
    actualizarEstadoLineaUI();
    
    if (tareasFiltradas.length === 0) {
        if (state.filtroFechaTareas) {
            cuerpo.innerHTML = `
                <tr>
                    <td colspan="7" class="p-8 text-center text-slate-400">
                        <p class="font-bold text-sm">No hay tareas para ${state.filtroFechaTareas}</p>
                        <button onclick="resetFiltroFechaTareas()" class="text-emerald-600 hover:text-emerald-700 font-black text-xs uppercase mt-2">Ver todas</button>
                    </td>
                </tr>
            `;
        } else {
            cuerpo.innerHTML = `
                <tr>
                    <td colspan="7" class="p-10 text-center">
                        <p class="text-2xl mb-2">‚úÖ</p>
                        <p class="font-black text-sm text-slate-500 uppercase tracking-wide">Sin pedidos en proceso</p>
                        <p class="text-xs text-slate-300 mt-1">A la espera de nuevos pedidos</p>
                    </td>
                </tr>
            `;
        }
        return;
    }
    
    tareasFiltradas.forEach(([id, t]) => {
        const esActivo = t.estado === "activo";
        const esPausado = t.estado === "pausa" || t.estado === "incidencia_pausa";
        const esPausaSistema = t.estado === "en_pausa_sistema" || t.estado === "en_incidencia_sistema" || t.estado === "en_reposicion_sistema";
        const esHito = t.codigo === "SISTEMA";
        
        let tiempoTexto = "";
        if (esActivo) {
            tiempoTexto = '<span class="animate-pulse">0m 0s</span>';
        } else if (esPausado) {
            const m = Math.floor((t.tiempoAcumuladoMS || 0) / 60000);
            const s = Math.floor(((t.tiempoAcumuladoMS || 0) % 60000) / 1000);
            tiempoTexto = `${m}m ${s}s <span class="text-[9px] text-blue-600">(PAUSA)</span>`;
        } else if (esPausaSistema) {
            tiempoTexto = "EN CURSO...";
        } else if (esHito) {
            tiempoTexto = `<span class="font-mono text-slate-600">${t.inicio}</span>`;
        } else {
            tiempoTexto = `${t.total}m`;
        }
        
        const esIncidencia = t.numSerie === "INCIDENCIA";
        const esDesayuno = t.numSerie === "PAUSA DESAYUNO";
        const esReposicion = t.numSerie === "REPOSICI√ìN";
        const esEntrada = t.numSerie === "ENTRADA L√çNEA";
        const esSalida = t.numSerie === "SALIDA L√çNEA";
        
        const filaClase = esEntrada ? "bg-emerald-50 border-emerald-200" :
            esSalida ? "bg-red-50 border-red-200" :
            esDesayuno ? "bg-orange-50 border-orange-200" :
            esIncidencia ? "bg-red-50 border-red-200" :
            esReposicion ? "bg-purple-50 border-purple-200" :
            esActivo ? "bg-red-50 border-red-100" :
            esPausado ? "bg-blue-50 border-blue-100" : "bg-white hover:bg-stone-50";
        
        const serieColorClase = esIncidencia ? "text-red-600" :
            esDesayuno ? "text-orange-500" :
            esReposicion ? "text-purple-600" :
            esEntrada ? "text-emerald-600" :
            esSalida ? "text-red-600" : "";
        
        const clienteHtml = (!esHito && t.cliente && t.cliente.trim() && t.cliente !== "Sin cliente")
            ? `<span class="ml-2 text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">üë§ ${t.cliente}</span>` : '';
        
        const pedidoHtml = (!esHito && t.pedido)
            ? `<span class="ml-1 text-[10px] text-slate-400">PED: ${t.pedido}</span>` : '';
        
        const prodHtml = (!esHito && t.total > 0)
            ? `<span class="${(420/t.total) >= 19 ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'} px-2 py-1 rounded font-black text-sm">${(420 / t.total).toFixed(1)}</span>`
            : '<span class="text-stone-300">‚Äî</span>';
        
        let accionHtml = '';
        if (esActivo) {
            accionHtml = `<button onclick="finalizarTarea('${id}', ${t.inicioMS})" class="flex items-center gap-1.5 bg-red-50 hover:bg-red-500 text-red-500 hover:text-white px-3 py-1.5 rounded-full border border-red-200 hover:border-red-500 transition-all font-black text-[10px] uppercase tracking-wide" title="Finalizar"><span class="text-xs">‚ñ†</span> Fin</button>`;
        } else if (esPausado) {
            accionHtml = '<span class="text-[10px] font-black text-blue-600 uppercase">PAUSADA</span>';
        } else if (esHito) {
            accionHtml = '<span class="text-[10px] font-bold text-stone-400 uppercase">REGISTRO</span>';
        } else {
            accionHtml = '<span class="text-[10px] font-black text-emerald-600 uppercase">‚úÖ HECHO</span>';
        }
        
        cuerpo.innerHTML += `
            <tr class="${filaClase} border-b">
                <td class="p-3 font-black text-[15px] ${serieColorClase}">${t.numSerie} ${pedidoHtml} ${clienteHtml}</td>
                <td class="p-3 font-bold text-sm">${t.codigo}</td>
                <td class="p-3 text-center"><span class="bg-slate-100 px-2 py-1 rounded font-black text-xs">${t.operarios || 0}</span></td>
                <td class="p-3">${t.notas && t.notas.trim() ? `<div class="bg-yellow-100 border-yellow-500 p-2 rounded text-[12px] font-black">‚ö†Ô∏è ${t.notas}</div>` : '<span class="text-stone-300 text-[10px]">-</span>'}</td>
                <td class="p-3 font-[1000] text-lg ${esActivo ? 'text-red-600' : esPausado || esPausaSistema ? 'text-blue-600' : ''}" ${esActivo || esPausaSistema ? `data-inicio-ms="${t.inicioMS}"` : ''}>${tiempoTexto}</td>
                <td class="p-3 text-center">${prodHtml}</td>
                <td class="p-3 text-right flex gap-3">${accionHtml} <button onclick="borrarRegistro('${id}')" class="bg-red-100 hover:bg-red-600 text-red-600 hover:text-white p-2 rounded-lg">üóëÔ∏è</button></td>
            </tr>
        `;
    });
};

// Listener para tareas
onValue(tareasRef, () => {
    renderizarTablaTareas();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLANIFICACI√ìN CON FILTRO POR FECHA DE MONTAJE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const hoyISO = () => new Date().toISOString().slice(0, 10);

const formatFechaTab = (iso) => {
    if (!iso) return '‚Äî';
    const hoy    = hoyISO();
    const manana = new Date(Date.now() + 86400000).toISOString().slice(0, 10);
    const d = new Date(iso + 'T12:00:00');
    const base = d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
    if (iso === hoy)    return `üü¢ Hoy`;
    if (iso === manana) return `üîµ Ma√±ana`;
    return `üìÖ ${base}`;
};

const renderTabsFecha = (data) => {
    const container = document.getElementById('tabsFechaPlan');
    if (!container) return;
    const dias = [...new Set(Object.values(data).map(i => i.fecha || 'sin-fecha'))].sort();
    const hoy  = hoyISO();
    const fAct = state.filtroPlanFecha;

    let html = `<button onclick="selFiltroPlan('todos')" class="plan-tab ${fAct==='todos'?'active':''} px-3 py-1.5 rounded-xl text-[10px] font-black uppercase border border-slate-200 bg-white text-slate-600 transition-all">
        üìã Todos <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full">${Object.keys(data).length}</span>
    </button>`;

    // Tab "Hoy" siempre visible si hay pedidos hoy o si filtroPlanFecha es 'hoy'
    const countHoy = Object.values(data).filter(i => (i.fecha || 'sin-fecha') === hoy).length;
    html += `<button onclick="selFiltroPlan('hoy')" class="plan-tab ${fAct==='hoy'?'active':''} px-3 py-1.5 rounded-xl text-[10px] font-black uppercase border border-slate-200 bg-white text-slate-600 transition-all">
        üü¢ Hoy <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full">${countHoy}</span>
    </button>`;

    dias.filter(d => d !== hoy && d !== 'sin-fecha').forEach(d => {
        const n = Object.values(data).filter(i => i.fecha === d).length;
        if (!n) return;
        const label = formatFechaTab(d);
        html += `<button onclick="selFiltroPlan('${d}')" class="plan-tab ${fAct===d?'active':''} px-3 py-1.5 rounded-xl text-[10px] font-black uppercase border border-slate-200 bg-white text-slate-600 transition-all">
            ${label} <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full">${n}</span>
        </button>`;
    });

    // Sin fecha
    const sinFecha = Object.values(data).filter(i => !i.fecha).length;
    if (sinFecha > 0) {
        html += `<button onclick="selFiltroPlan('sin-fecha')" class="plan-tab ${fAct==='sin-fecha'?'active':''} px-3 py-1.5 rounded-xl text-[10px] font-black uppercase border border-slate-200 bg-white text-slate-500 transition-all">
            ‚ö†Ô∏è Sin fecha <span class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded-full">${sinFecha}</span>
        </button>`;
    }

    container.innerHTML = html;

    // Aplicar estilos active
    container.querySelectorAll('.plan-tab.active').forEach(b => {
        b.style.background = '#1e293b';
        b.style.color = 'white';
        b.style.borderColor = '#1e293b';
    });
};

window.selFiltroPlan = (filtro) => {
    state.filtroPlanFecha = filtro;
    renderPlanificacion(state.planDataCache);
};

const renderPlanificacion = (data) => {
    state.planDataCache = data;
    const cuerpo = document.getElementById('cuerpoPlan');
    document.getElementById('sec-plan').classList.remove('hidden');

    // Actualizar tabs
    renderTabsFecha(data);

    // Aplicar filtro
    const hoy = hoyISO();
    let dataFiltrada = {};
    if (state.filtroPlanFecha === 'todos') {
        dataFiltrada = data;
    } else if (state.filtroPlanFecha === 'hoy') {
        dataFiltrada = Object.fromEntries(Object.entries(data).filter(([,v]) => (v.fecha || 'sin-fecha') === hoy));
    } else if (state.filtroPlanFecha === 'sin-fecha') {
        dataFiltrada = Object.fromEntries(Object.entries(data).filter(([,v]) => !v.fecha));
    } else {
        dataFiltrada = Object.fromEntries(Object.entries(data).filter(([,v]) => v.fecha === state.filtroPlanFecha));
    }

    // Actualizar t√≠tulo con conteo
    const tituloPlan = document.getElementById('tituloPlanPendientes');
    if (tituloPlan) {
        const n = Object.keys(dataFiltrada).length;
        tituloPlan.textContent = `üìã Pedidos pendientes ‚Äî ${n} serie${n!==1?'s':''}`;
    }

    cuerpo.innerHTML = "";

    if (Object.keys(dataFiltrada).length === 0) {
        const msgFiltro = state.filtroPlanFecha === 'hoy' ? 'No hay pedidos para hoy' : 'Sin pedidos para este d√≠a';
        cuerpo.innerHTML = `
            <tr>
                <td colspan="5" class="p-8 text-center">
                    <p class="text-2xl mb-2">üìã</p>
                    <p class="font-black text-sm text-slate-400 uppercase tracking-wide">${msgFiltro}</p>
                </td>
            </tr>`;
        setTimeout(inicializarDragDrop, 100);
        return;
    }

    if (state.sortable) { state.sortable.destroy(); state.sortable = null; }

    const grupos = {}, ordenMap = {};
    Object.keys(dataFiltrada).forEach(id => {
        const item = dataFiltrada[id];
        if (!grupos[item.pedido]) { grupos[item.pedido] = []; ordenMap[item.pedido] = item.orden || 999999; }
        grupos[item.pedido].push({ ...item, id });
    });

    const pedidosOrdenadosKeys = Object.keys(grupos).sort((a, b) => (ordenMap[a] || 999999) - (ordenMap[b] || 999999));
    state.pedidosOrdenados = pedidosOrdenadosKeys;

    pedidosOrdenadosKeys.forEach((pedido, index) => {
        const pedidoId = `pedido-${index}`;
        const items = grupos[pedido];
        const cliente = items[0].cliente || "Sin cliente";
        const fechaItem = items[0].fecha;
        const fechaBadge = fechaItem
            ? `<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-black ml-2">üìÖ ${formatFechaTab(fechaItem)}</span>`
            : '';

        cuerpo.innerHTML += `
            <tr class="pedido-header bg-stone-50 cursor-pointer" data-pedido-key="${items[0].id}">
                <td class="p-3 flex items-center gap-3 flex-wrap" onclick="toggleGrupo('${pedidoId}')">
                    <svg class="drag-handle w-5 h-5 text-slate-400 cursor-grab flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 2zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 7 14zm6-8a2 2 0 1 0-.001-4.001A2 2 0 0 0 13 6zm0 2a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 8zm0 6a2 2 0 1 0 .001 4.001A2 2 0 0 0 13 14z"></path>
                    </svg>
                    <svg id="icon-${pedidoId}" class="w-4 h-4 transition-transform transform text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-xs uppercase tracking-tighter text-slate-700">PEDIDO: ${pedido}</span>
                        <span class="text-xs text-blue-700 font-black bg-blue-100 px-2 py-0.5 rounded">üë§ ${cliente}</span>
                        ${fechaBadge}
                    </div>
                    <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-[10px] font-bold">${items.length} UNID.</span>
                </td>
                <td colspan="3"></td>
                <td class="p-3 text-right">
                    <button onclick='borrarPedidoCompleto(${JSON.stringify(items.map(i => i.id))}, event)' class="text-stone-400 hover:text-red-600 p-1">üóëÔ∏è</button>
                </td>
            </tr>
        `;

        items.forEach(item => {
            const tieneNota = item.notas && item.notas.trim() !== "";
            cuerpo.innerHTML += `
                <tr class="grupo-${pedidoId} grupo-item hidden border-b border-stone-100 bg-white hover:bg-stone-50">
                    <td class="p-2 pl-12 font-bold text-slate-500 text-base">‚Ü≥ ${item.codigo}</td>
                    <td class="p-2">
                        <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded font-mono font-black text-[15px]">${item.serie}</span>
                    </td>
                    <td class="p-2 w-1/2">
                        ${tieneNota
                            ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 p-2 rounded">
                                <p class="text-[10px] font-black uppercase text-yellow-700">‚ö†Ô∏è NOTA:</p>
                                <p class="text-sm font-bold">${item.notas}</p>
                            </div>`
                            : '<span class="text-stone-300 italic text-[10px]">Sin observaciones</span>'}
                    </td>
                    <td class="p-2 text-right" colspan="2">
                        <div class="flex items-center justify-end gap-3">
                            <button onclick="iniciarDesdePlan('${item.id}', '${item.serie}', '${item.codigo}', '${item.notas}', '${pedido}', '${item.cliente}')"
                                class="group flex items-center gap-1.5 bg-emerald-50 hover:bg-emerald-500 text-emerald-600 hover:text-white px-3 py-1.5 rounded-full border border-emerald-200 hover:border-emerald-500 transition-all font-black text-[10px] uppercase tracking-wide" title="Iniciar">
                                <span class="text-xs">‚ñ∂</span> Iniciar
                            </button>
                            <button onclick="borrarSeriePendiente('${item.id}', event)" class="text-stone-300 hover:text-red-500">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        });
    });

    setTimeout(inicializarDragDrop, 100);
};

// Listener para planificaci√≥n
onValue(planRef, (snap) => {
    const rawData = snap.val() || {};
    const data = Object.fromEntries(Object.entries(rawData).filter(([, v]) => v !== null));
    renderPlanificacion(data);
});

// Listener para estado de sesi√≥n
onValue(estadoSesionRef, (snap) => {
    const estadoSesion = snap.val() || {};
    state.operarios = estadoSesion.operarios || 0;
    state.entradaLineaHoy = estadoSesion.entradaLineaHoy || null;
    state.salidaLineaHoy = estadoSesion.salidaLineaHoy || null;
    if (state.inicializado) actualizarEstadoLineaUI();
});

// Listener para preferencias
onValue(preferenciasRef, (snap) => {
    const preferencias = snap.val() || {};
    state.mesSeleccionado = preferencias.mesDiarioSeleccionado?.valor || { year: new Date().getFullYear(), month: new Date().getMonth() };
    state.fechaProdSeleccionada = preferencias.fechaProdSeleccionada?.valor || new Date().toISOString().split('T')[0];
    state.anioSeleccionado = preferencias.anioMensualSeleccionado?.valor || new Date().getFullYear();
    
    if (state.inicializado) {
        if (state.mesSeleccionado) actualizarTextoMiniCalendario(state.mesSeleccionado);
        const anioEl = document.getElementById('anioMensual');
        if (anioEl && state.anioSeleccionado) anioEl.textContent = state.anioSeleccionado;
    }
});

// Listener para productividad diaria
onValue(productividadDiariaRef, async () => {
    if (!state.inicializado) return;
    await actualizarGraficoDiario(state.mesSeleccionado);
    await actualizarGraficoMensual(state.anioSeleccionado);
});

// Listener para mantenimiento
onValue(mantenimientoRef, (snap) => {
    const data = snap.val() || {};
    const tbody = document.getElementById('tablaMantenimientoBody');
    if (!tbody) return;
    
    const items = Object.entries(data).sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
    
    tbody.innerHTML = items.length === 0
        ? '<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs italic">Sin tareas de mantenimiento</td></tr>'
        : items.map(([id, t]) => `
            <tr class="border-b border-slate-100 ${t.realizado ? 'bg-emerald-50' : 'bg-white'} hover:bg-slate-50">
                <td class="p-2 text-[10px] text-slate-500">${t.fecha || ''}</td>
                <td class="p-2 text-xs font-bold ${t.realizado ? 'line-through text-slate-400' : 'text-slate-700'}">${t.texto || ''}</td>
                <td class="p-2 text-center">
                    <button onclick="toggleMantenimiento('${id}', ${t.realizado})" class="text-[9px] font-black px-2 py-0.5 rounded-full border ${t.realizado ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">
                        ${t.realizado ? '‚úÖ Hecho' : '‚¨ú Pendiente'}
                    </button>
                </td>
                <td class="p-2 text-right">
                    <button onclick="borrarMantenimiento('${id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
});

// Cache global de incidencias para filtrado
let _incidenciasCache = [];

const esc = (str) => String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,' ');

const renderIncidencias = (items) => {
    const tbody = document.getElementById('tablaIncidenciasBody');
    if (!tbody) return;
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs italic">Sin incidencias para este per√≠odo</td></tr>';
        return;
    }
    tbody.innerHTML = items.map(([id, t]) =>
        '<tr class="border-b border-slate-100 bg-white hover:bg-red-50">' +
        '<td class="p-2 text-[10px] text-slate-500 whitespace-nowrap">' + esc(t.fecha) + '</td>' +
        '<td class="p-2 text-[10px] text-slate-400 whitespace-nowrap">' + esc(t.hora) + '</td>' +
        '<td class="p-2 text-xs font-bold text-slate-700 cursor-pointer hover:text-red-600" onclick="editarIncidenciaLog(\'' + id + '\', \'' + esc(t.texto).replace(/\'/g, "\\'" ) + '\')" title="Pulsa para editar">' + esc(t.texto) + ' <span class="text-[9px] text-slate-300 font-normal">‚úèÔ∏è</span></td>' +
        '<td class="p-2 text-right"><button onclick="borrarIncidenciaLog(\'' + id + '\')" class="text-slate-300 hover:text-red-500 text-base leading-none">üóëÔ∏è</button></td>' +
        '</tr>'
    ).join('');
};

const poblarFiltroMeses = (items) => {
    // Con input[type=month] no hace falta poblar opciones
};

const MESES_ES = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];

// Estado del filtro de incidencias
const _filtroInc = { mes: new Date().getMonth(), anio: new Date().getFullYear() };

const actualizarFiltroIncidencias = () => {
    const label = document.getElementById('textoFiltroIncidencias');
    if (label) label.textContent = `${MESES_ES[_filtroInc.mes]} ${_filtroInc.anio}`;
    const prefijo = `${_filtroInc.anio}-${String(_filtroInc.mes + 1).padStart(2, '0')}`;
    const filtrados = _incidenciasCache.filter(([, t]) => t.fecha && t.fecha.startsWith(prefijo));
    renderIncidencias(filtrados);
};

window.cambiarMesIncidencias = (dir) => {
    _filtroInc.mes += dir;
    if (_filtroInc.mes > 11) { _filtroInc.mes = 0; _filtroInc.anio++; }
    if (_filtroInc.mes < 0)  { _filtroInc.mes = 11; _filtroInc.anio--; }
    actualizarFiltroIncidencias();
};

const initFiltroIncidencias = () => {
    actualizarFiltroIncidencias();
};

// Listener para incidencias
onValue(incidenciasLogRef, (snap) => {
    const data = snap.val() || {};
    _incidenciasCache = Object.entries(data).sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
    poblarFiltroMeses(_incidenciasCache);
    initFiltroIncidencias();
    filtrarIncidenciasPorMes();
});

// Listener para tiempo por tarea
onValue(tiempoPorTareaRef, (snap) => {
    if (!state.inicializado) return;
    const fecha = state.fechaProdSeleccionada || tsToFechaLocal(Date.now());
    const fechaKey = fechaToKey(fecha);
    const todosDatos = snap.val() || {};
    const datosFecha = todosDatos[fechaKey] || {};
    const datosProd = Object.values(datosFecha)
        .sort((a, b) => (a.finMS || 0) - (b.finMS || 0))
        .map(t => ({ serie: t.serie, tiempo: t.tiempo }));
    actualizarGraficoProd(datosProd, fecha);
});

// Carga inicial
window.addEventListener('load', async () => {
    actualizarEstadoLineaUI();
    
    const preferencias = await obtenerPreferencias();
    const mesGuardado = preferencias.mesDiarioSeleccionado?.valor || { year: new Date().getFullYear(), month: new Date().getMonth() };
    state.mesSeleccionado = mesGuardado;
    
    const fechaProdGuardada = preferencias.fechaProdSeleccionada?.valor || tsToFechaLocal(Date.now());
    state.fechaProdSeleccionada = fechaProdGuardada;
    
    const anioGuardado = preferencias.anioMensualSeleccionado?.valor || new Date().getFullYear();
    state.anioSeleccionado = anioGuardado;
    
    await actualizarGraficoDiario(mesGuardado);
    await actualizarGraficoMensual(anioGuardado);
    
    const datosGuardados = await obtenerTiempoPorTarea(fechaProdGuardada);
    const datosProd = Object.values(datosGuardados)
        .sort((a, b) => (a.finMS || 0) - (b.finMS || 0))
        .map(t => ({ serie: t.serie, tiempo: t.tiempo }));
    actualizarGraficoProd(datosProd, fechaProdGuardada);
    
    actualizarTextoMiniCalendario(mesGuardado);
    
    const anioEl = document.getElementById('anioMensual');
    if (anioEl) anioEl.textContent = anioGuardado;
    
    // ‚úÖ APLICAR FILTRO DE HOY POR DEFECTO
    const hoy = tsToFechaLocal(Date.now());
    state.filtroFechaTareas = hoy;
    await aplicarFiltroFechaTareas(hoy);
    
    state.mesTiempoMensual = { year: new Date().getFullYear(), month: new Date().getMonth() };
    await actualizarGraficoTiempoMensual(state.mesTiempoMensual);

    state.inicializado = true;
});
</script>
<style>
.sortable-ghost { opacity: 0.4; background: #f3f4f6; }
.sortable-drag { opacity: 1; cursor: grabbing !important; }
.drag-handle { cursor: grab; }
.drag-handle:active { cursor: grabbing; }

@keyframes pulse-soft {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    50% { opacity: 0.85; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
}
.led-conectado {
    animation: pulse-soft 2s infinite;
}
</style>
</head>
<body class="bg-stone-100 min-h-screen p-2 md:p-6 font-sans text-slate-800 pb-24">

<!-- Modal Operarios -->
<div id="modalOperarios" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center border-4 border-emerald-500">
        <h3 id="tituloModal" class="text-xl font-black uppercase mb-6">Seleccione Operarios</h3>
        <div class="grid grid-cols-3 gap-4 mb-6">
            <button onclick="seleccionarOperarios(1)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">1</button>
            <button onclick="seleccionarOperarios(2)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">2</button>
            <button onclick="seleccionarOperarios(3)" class="bg-emerald-100 hover:bg-emerald-500 hover:text-white text-emerald-700 font-black p-6 rounded-2xl text-2xl transition-all border-2">3</button>
        </div>
        <button onclick="cerrarSelector()" class="text-slate-400 font-bold uppercase text-[10px] hover:text-red-500">Cancelar</button>
    </div>
</div>

<!-- Modal Exportar -->
<div id="modalExportar" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl border-2 border-slate-200">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-black uppercase text-slate-800">üìä Exportar a Excel</h3>
            <button onclick="cerrarModalExportar()" class="text-slate-400 hover:text-red-500">‚úï</button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-1">Fecha inicio</label>
                <input type="date" id="fechaInicioExport" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-1">Fecha fin</label>
                <input type="date" id="fechaFinExport" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold">
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="cerrarModalExportar()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 font-black text-xs uppercase py-3 rounded-xl">Cancelar</button>
                <button onclick="exportarAExcelRango()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black text-xs uppercase py-3 rounded-xl">üì• Exportar</button>
            </div>
        </div>
    </div>
</div>

<div class="max-w-6xl mx-auto space-y-6">
    <!-- Fila superior: Volver + EN L√çNEA -->
    <div class="flex items-center justify-between">
        <a href="index.html" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border">Volver</a>
        <div class="flex items-center gap-2">
            <button id="btnModoPrueba" onclick="toggleModoPrueba()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full text-[10px] font-black uppercase border border-slate-200">üß™ Modo prueba</button>
            <div id="indicadorFirebase" class="flex items-center gap-2 bg-emerald-100 border-2 border-emerald-400 px-4 py-2 rounded-full shadow-md">
                <div id="ledFirebase" class="w-3 h-3 rounded-full bg-emerald-500 led-conectado shadow-lg"></div>
                <span id="textoFirebase" class="text-[11px] font-black uppercase tracking-wider text-emerald-800">EN L√çNEA</span>
            </div>
        </div>
    </div>

    <!-- Banner modo prueba -->
    <div id="bannerModoPrueba" class="hidden bg-orange-500 text-white text-center text-[11px] font-black uppercase tracking-widest py-2 rounded-xl">
        ‚ö†Ô∏è MODO PRUEBA ACTIVO ‚Äî Ning√∫n cambio se guardar√° en Firebase
    </div>

    <!-- Header Principal -->
    <div class="bg-white p-5 rounded-3xl shadow-sm flex flex-wrap items-center justify-between gap-4 border">
        <div class="flex items-center gap-4">
            <h1 class="text-4xl font-[1000] uppercase italic leading-none"><span class="text-black">Dostec 40</span> <span class="text-red-600">Production</span></h1>
            <p class="text-[9px] font-bold text-slate-400 tracking-[0.2em] uppercase mt-1">Cloud MES System v2.1</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
            <button id="btnReposicion" onclick="mostrarSelectorOperarios('reposicion')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">üîÑ Reposici√≥n</button>
            <button id="btnIncidencia" onclick="toggleIncidencia()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">‚ö†Ô∏è Incidencia</button>
            <button id="btnDesayuno" onclick="pausaDesayuno()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-xl font-black text-[10px] uppercase">‚òï Desayuno</button>
        </div>
    </div>
    
    <!-- Botones Entrada/Salida -->
    <div class="flex flex-wrap items-center gap-4">
        <button id="btnEntradaLinea" onclick="mostrarSelectorOperarios('entrada')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">‚ö´ Entrada L√≠nea</button>
        <button id="btnSalidaLinea" onclick="registrarSalida()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">‚ö´ Salida L√≠nea</button>
        <div class="flex-grow"></div>
        <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(event)">
        <button onclick="dispararSelector()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-3 rounded-2xl font-black text-xs uppercase shadow-lg">üìÅ Cargar Excel</button>
    </div>
    
    <!-- Pedidos Pendientes -->
    <div id="sec-plan" class="hidden">
        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
            <h2 id="tituloPlanPendientes" class="text-base font-black uppercase tracking-widest text-red-600">üìã Pedidos pendientes</h2>
        </div>
        <!-- Filtro por fecha de montaje -->
        <div class="flex flex-wrap gap-2 mb-3" id="tabsFechaPlan"></div>
        <div class="bg-white rounded-3xl shadow-sm overflow-hidden border">
            <table class="w-full text-left text-xs">
                <tbody id="cuerpoPlan"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Pedidos en Proceso -->
    <div>
        <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
            <div class="flex items-center gap-3">
                <h2 id="tituloTablaTareas" class="text-base font-black uppercase tracking-widest text-emerald-600">‚úÖ Pedidos en proceso</h2>
                <button id="btnFiltroFechaTareas" onclick="mostrarFiltroFechaTareas()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded-lg font-black text-[10px] uppercase">üìÖ Filtrar fecha</button>
                <input type="date" id="inputFiltroFechaTareas" class="hidden" onchange="aplicarFiltroFechaTareas(this.value)">
            </div>
            <div class="flex items-center gap-2">
                <div id="estadoLineaIndicador" class="text-[11px] font-black uppercase"></div>
                <button onclick="exportarAExcel()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase">üìä Exportar</button>
            </div>
        </div>
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
            <table class="w-full text-left text-xs">
                <thead class="bg-slate-900 text-white text-[13px] font-black uppercase">
                    <tr>
                        <th class="p-4">Serie</th>
                        <th class="p-4">C√≥digo</th>
                        <th class="p-4 text-center">Op.</th>
                        <th class="p-4">Notas</th>
                        <th class="p-4">Tiempo</th>
                        <th class="p-4">Prod.</th>
                        <th class="p-4 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="cuerpoActividad"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Gr√°fico Tiempo por Bomba -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <h3 class="text-sm font-black uppercase tracking-widest text-indigo-600">‚è±Ô∏è Tiempo por Bomba</h3>
            <div class="flex items-center gap-3">
                <button id="btnEditarGrafico" onclick="toggleModoEdicionGrafico()" class="bg-slate-100 hover:bg-red-100 text-slate-600 hover:text-red-600 px-3 py-1 rounded-lg font-black text-[10px] border">‚úèÔ∏è Editar puntos</button>
                <button onclick="mostrarSelectorFechaProd()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1.5 rounded-lg font-black text-xs border-2 border-indigo-300">üìÖ <span id="tituloFechaProd">Hoy</span></button>
                <input type="date" id="inputFechaProd" class="hidden" onchange="seleccionarFechaProd(this.value)">
            </div>
        </div>
        <div class="relative h-64 bg-slate-50 rounded-xl p-2" id="graficoContainer">
            <canvas id="graficoProd"></canvas>
        </div>
        <div id="listaPuntosTiempo" class="hidden mt-3 border border-red-200 rounded-xl overflow-hidden bg-red-50/30 p-2"></div>
    </div>
    
    <!-- Gr√°fico Tiempo Medio por D√≠a (Mensual) -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <h3 class="text-sm font-black uppercase tracking-widest text-indigo-600">üìÖ Tiempo Medio por Bomba Diario</h3>
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 border-2 border-indigo-300 rounded-xl px-2 py-1.5">
                <div class="flex items-center gap-2">
                    <button onclick="cambiarMesTiempoMensual(-1)" class="text-indigo-600 hover:text-indigo-800 font-black text-base leading-none px-1">‚óÄ</button>
                    <div class="flex items-center gap-1.5 bg-white rounded-lg px-2.5 py-1">
                        <span class="text-sm font-black text-indigo-900 uppercase" id="nombreMesTiempoMensual">Febrero</span>
                        <span class="text-sm font-black text-indigo-900" id="anioMesTiempoMensual">2026</span>
                    </div>
                    <button onclick="cambiarMesTiempoMensual(1)" class="text-indigo-600 hover:text-indigo-800 font-black text-base leading-none px-1">‚ñ∂</button>
                </div>
            </div>
        </div>
        <div class="relative h-64 bg-slate-50 rounded-xl p-2">
            <canvas id="graficoTiempoMensual"></canvas>
        </div>
    </div>

    <!-- Gr√°fico Productividad Diaria -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <h3 class="text-sm font-black uppercase tracking-widest text-blue-600">üìà Productividad Diaria</h3>
            <div class="flex items-center gap-3">
                <button onclick="recalcularProductividadHoy()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase border border-blue-300">üîÑ Recalcular hoy</button>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl px-2 py-1.5">
                    <div class="flex items-center gap-2">
                        <button onclick="cambiarMes(-1)" class="text-blue-600 hover:text-blue-800 font-black text-base leading-none px-1">‚óÄ</button>
                        <div class="flex items-center gap-1.5 bg-white rounded-lg px-2.5 py-1">
                            <span class="text-sm font-black text-blue-900 uppercase" id="nombreMesDiario">Febrero</span>
                            <span class="text-sm font-black text-blue-900" id="anioMesDiario">2026</span>
                        </div>
                        <button onclick="cambiarMes(1)" class="text-blue-600 hover:text-blue-800 font-black text-base leading-none px-1">‚ñ∂</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="relative h-64 bg-slate-50 rounded-xl p-2">
            <canvas id="graficoDiario"></canvas>
        </div>
    </div>
    
    <!-- Gr√°fico Productividad Mensual -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border mt-6 p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <h3 class="text-sm font-black uppercase tracking-widest text-blue-600">üìä Productividad Mensual</h3>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-4 text-[10px] font-bold">
                    <div class="flex items-center gap-1 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-200" id="tendenciaPositiva" style="display:none;">
                        <span class="w-4 h-1 bg-emerald-500 rounded"></span>
                        <span class="text-emerald-700">Tendencia ‚Üó</span>
                    </div>
                    <div class="flex items-center gap-1 bg-red-50 px-2 py-1 rounded-lg border border-red-200" id="tendenciaNegativa" style="display:none;">
                        <span class="w-4 h-1 bg-red-500 rounded"></span>
                        <span class="text-red-700">Tendencia ‚Üò</span>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl px-2 py-1.5">
                    <div class="flex items-center gap-2">
                        <button onclick="cambiarAnio(-1)" class="text-blue-600 hover:text-blue-800 font-black text-base leading-none px-1">‚óÄ</button>
                        <span class="text-sm font-black text-blue-900 bg-white rounded-lg px-2.5 py-1" id="anioMensual">2026</span>
                        <button onclick="cambiarAnio(1)" class="text-blue-600 hover:text-blue-800 font-black text-base leading-none px-1">‚ñ∂</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="relative h-72 bg-slate-50 rounded-xl p-2">
            <canvas id="graficoMensual"></canvas>
        </div>
    </div>
</div>

<!-- Tablas Mantenimiento e Incidencias -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 max-w-6xl mx-auto">
    <div class="bg-white rounded-3xl shadow-lg border overflow-hidden">
        <div class="bg-blue-600 px-5 py-3 flex items-center justify-between">
            <h3 class="text-white font-black uppercase text-sm tracking-widest">üîß Mantenimiento</h3>
            <button onclick="abrirMantenimiento()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg font-black text-[10px] uppercase"><span class="text-white font-black text-sm leading-none">+</span> A√±adir</button>
        </div>
        <div class="overflow-auto max-h-64">
            <table class="w-full text-left text-xs">
                <thead class="bg-blue-50 text-blue-700 font-black uppercase text-[10px]">
                    <tr>
                        <th class="p-2">Fecha</th>
                        <th class="p-2">Descripci√≥n</th>
                        <th class="p-2 text-center">Estado</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="tablaMantenimientoBody"></tbody>
            </table>
        </div>
    </div>
    
    <div class="bg-white rounded-3xl shadow-lg border overflow-hidden">
        <div class="bg-red-600 px-5 py-3 flex items-center justify-between">
            <h3 class="text-white font-black uppercase text-sm tracking-widest">‚ö†Ô∏è Registro de Incidencias</h3>
            <div class="flex items-center gap-1">
                <button onclick="cambiarMesIncidencias(-1)" class="bg-transparent border-0 outline-none text-white font-black text-base leading-none px-1 cursor-pointer focus:outline-none">‚óÄ</button>
                <span class="text-white font-black text-[10px] uppercase tracking-wider min-w-[100px] text-center" id="textoFiltroIncidencias">FEBRERO 2026</span>
                <button onclick="cambiarMesIncidencias(1)" class="bg-transparent border-0 outline-none text-white font-black text-base leading-none px-1 cursor-pointer focus:outline-none">‚ñ∂</button>
            </div>
        </div>
        <div class="overflow-auto max-h-72">
            <table class="w-full text-left text-xs">
                <thead class="bg-red-50 text-red-700 font-black uppercase text-[10px] sticky top-0">
                    <tr>
                        <th class="p-2 whitespace-nowrap">Fecha</th>
                        <th class="p-2 whitespace-nowrap">Hora</th>
                        <th class="p-2 w-full">Motivo</th>
                        <th class="p-2"></th>
                    </tr>
                </thead>
                <tbody id="tablaIncidenciasBody"></tbody>
            </table>
        </div>
    </div>
</div>

</body>
</html>